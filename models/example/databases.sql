{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE maplemonk.zouk_FACEBOOK_CONSOLIDATED_Intermediate AS select Adset_Name ,Adset_ID ,FB.ad_id ,FB.ad_name ,\'Facebook_Custom_Facebook_Marketing_Zouk_Meta\' as Account_Name ,Account_ID ,Campaign_Name ,Campaign_ID ,cast(Fb.date_start as date) Date ,SUM(CLICKS) Clicks ,sum(ifnull(inline_link_clicks,0)) Link_Clicks ,SUM(SPEND) Spend ,SUM(IMPRESSIONS) Impressions ,SUM(ifnull(Fc.Conversions,0)) Conversions ,SUM(ifnull(Fcv.Conversion_Value,0)) Conversion_Value ,sum(ifnull(fd.add_to_carts,0)) Add_to_carts ,sum(ifnull(fdv.add_to_cart_value,0)) Add_to_cart_value ,sum(ifnull(fe.landing_page_views,0)) Landing_page_views ,sum(ifnull(ff.initiate_checkouts,0)) Initiate_checkouts ,sum(ifnull(ffv.initiate_checkouts_value,0)) Initiate_checkouts_value ,\'Facebook\' Channel ,\'Facebook_Custom_Facebook_Marketing_Zouk_Meta\' Account from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data FB left join ( select ad_id ,ad_name ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) Conversions from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTIONS) C where JSON_EXTRACT_SCALAR(C,\'$.action_type\')=\'offsite_conversion.fb_pixel_purchase\' group by ad_id ,ad_name ,date_start having SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) is not null )Fc ON Fb.ad_id = Fc.ad_id and Fb.date_start=Fc.date_start left join ( select ad_id ,ad_name ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(CV,\'$.value\') as FLOAT64)) Conversion_Value from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTION_VALUES) CV where JSON_EXTRACT_SCALAR(Cv,\'$.action_type\')=\'offsite_conversion.fb_pixel_purchase\' group by ad_id ,ad_name ,date_start having SUM(cast(JSON_EXTRACT_SCALAR(CV,\'$.value\') as FLOAT64)) is not null )Fcv ON Fb.ad_id = Fcv.ad_id and Fb.date_start=Fcv.date_start left join ( select ad_id ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) add_to_carts from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTIONS) C where JSON_EXTRACT_SCALAR(C,\'$.action_type\')=\'offsite_conversion.fb_pixel_add_to_cart\' group by ad_id,date_start having SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) is not null )Fd ON Fb.ad_id = Fd.ad_id and Fb.date_start=Fd.date_start left join ( select ad_id ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(CV,\'$.value\') as FLOAT64)) Add_to_cart_Value from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTION_VALUES) CV where JSON_EXTRACT_SCALAR(Cv,\'$.action_type\')=\'offsite_conversion.fb_pixel_add_to_cart\' group by ad_id,date_start having SUM(cast(JSON_EXTRACT_SCALAR(CV,\'$.value\') as FLOAT64)) is not null )Fdv ON Fb.ad_id = Fdv.ad_id and Fb.date_start=Fdv.date_start left join ( select ad_id ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) Landing_page_views from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTIONS) C where JSON_EXTRACT_SCALAR(C,\'$.action_type\')=\'landing_page_view\' group by ad_id,date_start having SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) is not null )Fe ON Fb.ad_id = Fe.ad_id and Fb.date_start=Fe.date_start left join ( select ad_id ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) Initiate_checkouts from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTIONS) C where JSON_EXTRACT_SCALAR(C,\'$.action_type\')=\'offsite_conversion.fb_pixel_initiate_checkout\' group by ad_id,date_start having SUM(cast(JSON_EXTRACT_SCALAR(C,\'$.value\') as FLOAT64)) is not null )Ff ON Fb.ad_id = Ff.ad_id and Fb.date_start=Ff.date_start left join ( select ad_id ,date_start ,SUM(cast(JSON_EXTRACT_SCALAR(CV,\'$.value\') as FLOAT64)) Initiate_checkouts_Value from maplemonk.Custom_Facebook_Marketing_Zouk_Meta_CustomCampaigns_data left join UNNEST(ACTION_VALUES) CV where JSON_EXTRACT_SCALAR(Cv,\'$.action_type\')=\'offsite_conversion.fb_pixel_initiate_checkout\' group by ad_id,date_start having SUM(cast(JSON_EXTRACT_SCALAR(CV,\'$.value\') as FLOAT64)) is not null )Ffv ON Fb.ad_id = Ffv.ad_id and Fb.date_start=Ffv.date_start group by Adset_Name, Adset_ID,fb.ad_id,fb.AD_NAME, Account_Name, Account_ID, Campaign_Name, Campaign_ID,Fb.date_start ; CREATE OR REPLACE TABLE maplemonk.zouk_FACEBOOK_CONSOLIDATED as With Facebook as ( select Adset_Name ,Adset_ID ,ad_id ,ad_name ,Account_Name ,Account_ID ,Campaign_Name ,Campaign_ID ,Date ,Channel ,Account ,CATEGORY ,COLLECTION ,safe_divide(ifnull(Clicks,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Clicks ,safe_divide(ifnull(Link_Clicks,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Link_Clicks ,safe_divide(ifnull(Spend,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Spend ,safe_divide(ifnull(Impressions,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Impressions ,safe_divide(ifnull(Conversions,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Conversions ,safe_divide(ifnull(Conversion_Value,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Conversion_Value ,safe_divide(ifnull(Add_to_carts,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Add_to_carts ,safe_divide(ifnull(Add_to_cart_value,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Add_to_cart_value ,safe_divide(ifnull(Landing_page_views,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Landing_page_views ,safe_divide(ifnull(Initiate_checkouts,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Initiate_checkouts ,safe_divide(ifnull(Initiate_checkouts_value,0), count(*) over(partition by date,ad_id,lower(ifnull(ad_name,\'\')))) Initiate_checkouts_value from maplemonk.zouk_FACEBOOK_CONSOLIDATED_Intermediate mc left join ( select * from ( select CATEGORY ,COLLECTION ,row_number() over(partition by lower(CATEGORY),lower(COLLECTION) order by 1)rw from `MapleMonk.FINAL_SKU_MASTER` where category is not null and category != \'\' )where rw = 1 )fsm on lower(replace(ifnull(mc.ad_name,\'\'),\'_\',\'&\')) like \'%&\' || lower(fsm.category) || \'&%\' ), facebook_category as ( select Adset_Name ,Adset_ID ,mc.ad_id ,mc.ad_name ,Account_Name ,Account_ID ,Campaign_Name ,Campaign_ID ,Date ,Channel ,Account ,fsm.CATEGORY ,fsm.collection ,safe_divide(ifnull(Clicks,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Clicks ,safe_divide(ifnull(Link_Clicks,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Link_Clicks ,safe_divide(ifnull(Spend,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Spend ,safe_divide(ifnull(Impressions,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Impressions ,safe_divide(ifnull(Conversions,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Conversions ,safe_divide(ifnull(Conversion_Value,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Conversion_Value ,safe_divide(ifnull(Add_to_carts,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Add_to_carts ,safe_divide(ifnull(Add_to_cart_value,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Add_to_cart_value ,safe_divide(ifnull(Landing_page_views,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Landing_page_views ,safe_divide(ifnull(Initiate_checkouts,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Initiate_checkouts ,safe_divide(ifnull(Initiate_checkouts_value,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Initiate_checkouts_value from (select * from facebook where category is null)mc left join ( select * from ( select replace(cast(ad_id as string),\'`\',\'\') ad_id,AD_NAME,category,collection from `MapleMonk.zouk_db_Marketing_Campaigns_Category_FCEBOOK` where category is not null and category != \'\' ) qualify row_number() over(partition by lower(ifnull(ad_id,\'\')), lower(ifnull(AD_NAME,\'\')) order by 1) = 1 )fsm on lower(fsm.ad_id) = lower(mc.ad_id) and lower(fsm.AD_NAME) = lower(mc.AD_NAME) ), facebook_collection as ( select Adset_Name ,Adset_ID ,mc.ad_id ,mc.ad_name ,Account_Name ,Account_ID ,Campaign_Name ,Campaign_ID ,Date ,Channel ,Account ,fsm.CATEGORY ,fsm.collection ,safe_divide(ifnull(Clicks,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Clicks ,safe_divide(ifnull(Link_Clicks,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Link_Clicks ,safe_divide(ifnull(Spend,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Spend ,safe_divide(ifnull(Impressions,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Impressions ,safe_divide(ifnull(Conversions,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Conversions ,safe_divide(ifnull(Conversion_Value,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Conversion_Value ,safe_divide(ifnull(Add_to_carts,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Add_to_carts ,safe_divide(ifnull(Add_to_cart_value,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Add_to_cart_value ,safe_divide(ifnull(Landing_page_views,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Landing_page_views ,safe_divide(ifnull(Initiate_checkouts,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Initiate_checkouts ,safe_divide(ifnull(Initiate_checkouts_value,0), count(*) over(partition by date,mc.ad_id,lower(ifnull(mc.ad_name,\'\')))) Initiate_checkouts_value from (select * from facebook_category where category is null)mc left join ( select * from ( select replace(cast(ad_id as string),\'`\',\'\') ad_id,AD_NAME,category,collection from `MapleMonk.zouk_db_Marketing_Campaigns_Category_FCEBOOK` where (category is null or category = \'\') and collection is not null and collection != \'\' ) qualify row_number() over(partition by lower(ifnull(ad_id,\'\')), lower(ifnull(AD_NAME,\'\')) order by 1) = 1 )fsm on lower(fsm.ad_id) = lower(mc.ad_id) and lower(fsm.AD_NAME) = lower(mc.AD_NAME) ) select * from facebook where category is not null union all select * from facebook_category where category is not null union all select * from facebook_collection ;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from maplemonk.INFORMATION_SCHEMA.TABLES
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            