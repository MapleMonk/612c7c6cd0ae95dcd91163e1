{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table snitch_db.maplemonk.Inventory_summary_snitch as with last180_days as ( select a.sku ,product_name ,category ,collection ,b.first_order_date::date first_order_date ,dateadd(month,1,b.first_order_date::date) First_order_date_plus_1month ,case when right(a.sku,2) not in (\'XL\',\'36\',\'38\') then sum(quantity) end as quantity ,max(case when order_timestamp::date < dateadd(month,1,b.first_order_date::date) and right(a.sku,2) not in (\'XL\',\'36\',\'38\') then order_timestamp::date end ) max_sale_date ,datediff(day,b.first_order_date::date, max_sale_Date) days ,sum(case when order_timestamp::date < dateadd(month,1,b.first_order_date::date) then ifnull(quantity,0) end) quantity_in_first_month from snitch_db.maplemonk.fact_items_snitch a left join (select sku, min(order_timestamp) first_order_date from snitch_db.maplemonk.fact_items_snitch group by 1) b on a.sku = b.sku where order_timestamp::date <= current_timestamp()::date and lower(order_status) <> \'cancelled\' group by 1,2,3,4,5 ) ,last90_days as ( select sku ,product_name ,sum(quantity) as quantity from snitch_db.maplemonk.fact_items_snitch where order_timestamp::date <= current_timestamp()::date and order_timestamp::date >= dateadd(\'day\',-90,current_timestamp()::date) and lower(order_status) <> \'cancelled\' group by 1,2 ) ,last30_days as ( select sku ,product_name ,sum(quantity) as quantity from snitch_db.maplemonk.fact_items_snitch where order_timestamp::date <= current_timestamp()::date and order_timestamp::date >= dateadd(\'day\',-30,current_timestamp()::date) and lower(order_status) <> \'cancelled\' group by 1,2 ), last7_days as( select sku ,product_name ,sum(quantity) as quantity from snitch_db.maplemonk.fact_items_snitch where order_timestamp::date <= current_timestamp()::date and order_timestamp::date >= dateadd(\'day\',-7,current_timestamp()::date) and lower(order_status) <> \'cancelled\' group by 1,2 ), last3_days as( select sku ,product_name ,sum(quantity) as quantity from snitch_db.maplemonk.fact_items_snitch where order_timestamp::date <= current_timestamp()::date and order_timestamp::date >= dateadd(\'day\',-3,current_timestamp()::date) and lower(order_status) <> \'cancelled\' group by 1,2 ), inventory as( select distinct a.sku, a.inventory_quantity, a.updated_at from (select * from snitch_db.maplemonk.shopifyindia_products_variants where inventory_item_id in (select distinct inventory_item_id from (select sku, inventory_item_id, row_number() over(partition by sku order by updated_at desc) rw from snitch_db.maplemonk.shopifyindia_products_variants) where rw=1)) a left join (select sku, max(updated_at) date from (select * from snitch_db.maplemonk.shopifyindia_products_variants where inventory_item_id in (select distinct inventory_item_id from (select sku, inventory_item_id, row_number() over(partition by sku order by updated_at desc) rw from snitch_db.maplemonk.shopifyindia_products_variants) where rw=1)) group by sku) b on a.sku=b.sku and a.updated_at = b.date where b.date is not null ) select max(i.updated_at ::date) Inventory_last_updated_at, min(first_order_Date) first_order_date ,case when right(z.sku,2) = \'-S\' then left(z.sku,len(a.sku)-2) else replace(z.sku,concat(\'-\',split_part(z.sku,\'-\',-1)),\'\') end as SKU_group ,a.product_name product_name ,category ,collection ,max(ifnull(z.days,0)) days ,sum(ifnull(z.quantity_in_first_month,0)) quantity_in_firsT_month ,sum(ifnull(z.quantity,0)) as units_sold_L180 ,sum(ifnull(a.quantity,0)) as units_sold_L90 ,sum(ifnull(b.quantity,0)) as units_sold_L30 ,sum(ifnull(c.quantity,0)) as units_sold_L7 ,sum(ifnull(d.quantity,0)) as units_sold_L3 ,sum(inventory_quantity) as inventory_available ,case when sum(ifnull(a.quantity,0))=0 then 0 else round(sum(inventory_quantity)/((sum(a.quantity) /90)*7),2) end as Weeks_of_Supply_L90 ,case when sum(ifnull(b.quantity,0))=0 then 0 else round(sum(inventory_quantity)/((sum(b.quantity) /30)*7),2) end as Weeks_of_Supply_L30 ,case when sum(ifnull(c.quantity,0))=0 then 0 else round(sum(inventory_quantity)/((sum(c.quantity) /7)*7),2) end as Weeks_of_Supply_L7 from last180_days z left join last90_days a on z.sku = a.sku left join inventory i on z.sku = i.sku left join last30_days b on z.sku = b.sku left join last7_days c on z.sku = c.sku left join last3_days d on z.sku = d.sku group by 3,4,5,6 order by 1 desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        