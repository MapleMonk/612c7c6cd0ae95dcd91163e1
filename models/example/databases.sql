{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table hox_db.maplemonk.HOX_BLANKO_GA_PDP as with abc as ( select order_date, case when SKU_CODE in (\'BLKBE100\', \'BLKBE20\') then \'billionaire\' when SKU_CODE in (\'BLKDK100\', \'BLKDK20\') then \'dusk\' when SKU_CODE in (\'BLKEE100\', \'BLKEE20\') then \'empire\' when SKU_CODE in (\'BLKODMY100\', \'BLKODMY20\') then \'old money\' when SKU_CODE in (\'BLKSS100\', \'BLKSS20\') then \'sports\' when SKU_CODE in (\'BLKINOD100\', \'BLKINOD20\') then \'indian oud\' when SKU_CODE in (\'BLKRLCN-P4_20\') then \'royal collection\' when SKU_CODE in (\'BLKPRMNCN-P4_20\') then \'powerful man collection\' end as SKU_CODE, count(distinct REFERENCE_CODE)as total_orders, sum(QUANTITY)as total_quantity, sum(case when lower(status) = \'non cancel\' then QUANTITY end )as non_cancel_quantity from ( select o.order_date, o.REFERENCE_CODE, o.status, o.SKU_CODE, Sum(o.total_quantity) as QUANTITY from ( select date(order_date)as order_date, REFERENCE_CODE, case when lower(FINAL_SHIPPING_STATUS) like \'%cancel%\' then \'cancel\' else \'non cancel\' end as status, SKU_CODE, sum(QUANTITY) as total_quantity from hox_db.maplemonk.HOX_DB_sales_consolidated where lower(MARKETPLACE) like \'%shopify%\' group by 1,2,3,4 )as o where o.SKU_CODE in (\'BLKBE100\', \'BLKBE20\', \'BLKDK100\', \'BLKDK20\', \'BLKEE100\', \'BLKEE20\', \'BLKODMY100\', \'BLKODMY20\', \'BLKSS100\', \'BLKSS20\', \'BLKINOD100\', \'BLKINOD20\', \'BLKRLCN-P4_20\', \'BLKPRMNCN-P4_20\') group by 1,2,3,4 )as o group by 1 , 2 order by 1 desc ), final as ( select distinct o.*, total_orders, total_quantity, non_cancel_quantity from ( select to_date(date, \'YYYYMMDD\')as event_date, case when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-billionaire-long-lasting-fragrance%\' then \'billionaire\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-royal-collection-long-lasting-perfume%\' then \'royal collection\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-powerful-man-collection-long-lasting-perfume%\' then \'powerful man collection\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-dusk-long-lasting-fragrance%\' then \'dusk\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-empire-long-lasting-fragrance%\' then \'empire\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-old-money-long-lasting-fragrance%\' then \'old money\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-sports-long-lasting-fragrance%\' then \'sports\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%/best-men-perfume/blanko-indian-oud-long-lasting-fragrance%\' then \'indian oud\' end as page, sum(Sessions)as pdp_sessions, sum(ADDTOCARTS) as ADDTOCARTS, sum(ENGAGEDSESSIONS) as ENGAGEDSESSIONS from hox_db.maplemonk.BLANKO_GA_PDP_DATA where lower(UNIFIEDPAGEPATHSCREEN) like any (\'%/best-men-perfume/blanko-billionaire-long-lasting-fragrance%\', \'%/best-men-perfume/blanko-royal-collection-long-lasting-perfume%\', \'%/best-men-perfume/blanko-powerful-man-collection-long-lasting-perfume%\', \'%/best-men-perfume/blanko-dusk-long-lasting-fragrance%\', \'%/best-men-perfume/blanko-empire-long-lasting-fragrance%\', \'%/best-men-perfume/blanko-old-money-long-lasting-fragrance%\', \'%/best-men-perfume/blanko-sports-long-lasting-fragrance%\', \'%/best-men-perfume/blanko-indian-oud-long-lasting-fragrance%\') group by 1 , 2 order by 1 desc , 2 ) as o left join abc on o.event_date = abc.order_date and lower(o.page) = lower(abc.SKU_CODE) ), base as ( select to_date(date, \'YYYYMMDD\')as event_date, case when lower(UNIFIEDPAGEPATHSCREEN) like \'%billionaire%\' then \'billionaire\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%royal-collection%\' then \'royal collection\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%powerful-man-collection%\' then \'powerful man collection\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%dusk%\' then \'dusk\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%empire%\' then \'empire\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%old-money%\' then \'old money\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%sports%\' then \'sports\' when lower(UNIFIEDPAGEPATHSCREEN) like \'%indian-oud%\' then \'indian oud\' end as page, sum(Sessions)as overall_sessions, sum(ADDTOCARTS) as overall_ADDTOCARTS, sum(ENGAGEDSESSIONS) as overall_ENGAGEDSESSIONS from hox_db.maplemonk.BLANKO_GA_PDP_DATA where lower(UNIFIEDPAGEPATHSCREEN) like any (\'%billionaire%\', \'%royal-collection%\', \'%powerful-man-collection%\', \'%dusk%\', \'%empire%\', \'%old-money%\', \'%sports%\', \'%indian-oud%\') group by 1 , 2 order by 1 desc , 2 ) select distinct a.*, b.pdp_sessions, b.ADDTOCARTS, b.ENGAGEDSESSIONS, total_orders, total_quantity, non_cancel_quantity from base a left join final b on a.event_date = b.event_date and lower(a.page) = lower(b.page)",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from HOX_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        