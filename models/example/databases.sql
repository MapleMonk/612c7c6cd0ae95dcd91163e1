{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.clicks_itemid AS WITH GA_DATA AS ( SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'Web\' AS type, sum(itemsViewed) AS CLICKS FROM snitch_db.maplemonk.ga4_web_jan24_clicks_impressions_by_itemid WHERE GA_DATE > \'2024-02-27\' group by 1,2 UNION SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'App\' AS type, sum(itemsViewed) AS CLICKS FROM snitch_db.maplemonk.ga4_APP_clicks_impressions_by_itemid where ga_date >= \'2024-03-01\' group by 1,2 UNION SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'Snitch_IOS\' AS type, ifnull(sum(itemsViewed),0) AS CLICKS from snitch_db.maplemonk.app2_clicks_itemid where operatingsystem = \'iOS\' group by 1,2 union SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'Snitch_Android\' AS type, ifnull(sum(itemsViewed),0) AS CLICKS from snitch_db.maplemonk.app2_clicks_itemid where operatingsystem = \'Android\' group by 1,2 ), sku_group as ( select a.id, b.sku_group, c.category, c.sellable_inventory as inventory, c.sku_class from snitch_db.maplemonk.shopifyindia_new_products a left join snitch_db.maplemonk.availability_master_v2 b on a.id = b.id left join snitch_db.maplemonk.availability_master_v2 c on a.id = c.id ), main_data as ( select a.*,b.sku_group,b.category,b.inventory,b.sku_class from ga_data a left join sku_group b on cast(a.itemid as varchar) = cast(b.id as varchar) where ga_date >= \'2024-06-01\' and itemid not in (\'(other)\',\'(not set)\') and sku_group is not null and sku_class != \'Draft\' ), sales_data as ( select CASE when webshopney = \'Web\' then \'Web\' WHEN webshopney in (\'Shopney\',\'Appbrew\') then \'App\' when webshopney = \'Snitch_IOS\' and tags like \'%Snitch_IOS%\' then \'Snitch_IOS\' when webshopney = \'Snitch_IOS\' and tags like \'%Snitch_Android%\' then \'Snitch_Android\' ELSE webshopney end as type, order_timestamp::date as date, sku_group, sum(quantity) as total_quantity from snitch_db.maplemonk.fact_items_snitch where lower(ifnull(discount_code,\'n\')) not like \'%eco%\' and lower(ifnull(discount_code,\'n\')) not like \'%influ%\' and order_name not in (\'2431093\',\'2422140\',\'2425364\',\'2430652\',\'2422237\',\'2420623\',\'2429832\',\'2422378\',\'2428311\',\'2429064\',\'2428204\',\'2421343\',\'2431206\',\'2430491\',\'2426682\',\'2426487\',\'2426458\',\'2423575\',\'2422431\',\'2423612\',\'2426625\',\'2428117\',\'2426894\',\'2425461\',\'2426570\',\'2423455\',\'2430777\',\'2426009\',\'2428245\',\'2427269\',\'2430946\',\'2425821\',\'2429986\',\'2429085\',\'2422047\',\'2430789\',\'2420219\',\'2428341\',\'2430444\',\'2426866\',\'2431230\',\'2425839\',\'2430980\',\'2427048\',\'2430597\',\'2420499\',\'2431050\',\'2420271\',\'2426684\',\'2428747\',\'2423523\',\'2431171\',\'2430830\',\'2425325\',\'2428414\',\'2429054\',\'2423596\') and tags not in (\'FLITS_LOGICERP\') and order_timestamp::date >= \'2024-06-01\' group by 1,2,3 ), live_date as ( select a.id, a.status, a.published_at as live_date, b.price, b.sku_group, b.price from snitch_db.maplemonk.shopifyindia_new_products a left join snitch_db.maplemonk.availability_master_v2 b on a.id = b.id ), first_order_date as ( select sku_group, min(order_timestamp::date) as first_order_date from snitch_db.maplemonk.fact_items_snitch group by 1 ), final_first_live_date as ( select a.sku_group,a.status, case when a.live_date <= b.first_order_date then a.live_date else b.first_order_date end as live_date_final from live_date a left join first_order_date b on a.sku_group = b.sku_group ) select a.*, coalesce(ifnull(sales.total_quantity,0),0) as total_quantity, case when datediff(day,b.live_date_final,current_date) <= 30 then \'New\' else a.sku_class end as class, a.CLICKS / NULLIF(SUM(a.CLICKS) OVER (PARTITION BY a.ga_date, a.type), 0) AS clicks_share, SUM(a.CLICKS) OVER (PARTITION BY a.ga_date, a.type ORDER BY a.CLICKS DESC) / NULLIF(SUM(a.CLICKS) OVER (PARTITION BY a.ga_date, a.type), 0) AS cumulative_clicks_share from main_data a left join sales_data sales on a.ga_date = sales.date and a.type = sales.type and a.sku_group = sales.sku_group left join final_first_live_date b on a.sku_group = b.sku_group ;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            