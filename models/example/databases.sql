{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table solara_db.maplemonk.amazon_sc_gst_sales_fact_items_intermediate as select Null as customer_id ,upper(\'AMAZON SC\') Shop_name ,\'AMAZON SC\' as marketplace ,\'AMAZON\' AS CHANNEL ,\'AMAZON SC\' AS SOURCE ,\"Order Id\" order_id ,\"Order Id\" reference_code ,Null as PHONE ,NAME ,null AS EMAIL ,null AS SHIPPING_LAST_UPDATE_DATE ,afi.SKU ,afi.asin PRODUCT_ID ,null PRODUCT_NAME ,null CURRENCY ,null CITY ,null AS State ,case when UPPER(\"Transaction Type\") = \'REFUND\' then \'RETURN\' else UPPER(\"Transaction Type\") end Order_Status ,afi.report_date AS Order_Date ,case when \"Invoice Amount\"::float < 0 then -1*afi.QUANTITY else afi.quantity end quantity ,\"Tax Exclusive Gross\" AS GROSS_SALES_BEFORE_TAX ,null AS DISCOUNT ,\"Total Tax Amount\" tax ,(e.mrp*(afi.quantity::int))-((e.mrp*(afi.quantity::int))/(1+e.tax_rate)) mrp_tax ,\"Shipping Amount\" SHIPPING_PRICE ,\"Invoice Amount\" AS SELLING_PRICE ,upper(coalesce(EEFI.order_status,UFI.order_status)) as OMS_order_status ,upper(coalesce(EEFI.shipping_status,UFI.shipping_status)) AS SHIPPING_STATUS ,upper(coalesce(shipmap.final_shipping_status,EEFI.shipping_status,UFI.shipping_status)) FINAL_SHIPPING_STATUS ,concat(afi.\"Order Id\",\'-\',afi.asin) as SALEORDERITEMCODE ,concat(afi.\"Order Id\",\'-\',afi.asin) as SALES_ORDER_ITEM_ID ,coalesce(EEFI.awb,UFI.awb) AWB ,NULL Payment_Gateway ,upper(coalesce(EEFI.payment_mode,UFI.payment_mode)) Payment_Mode ,Upper(coalesce(EEFI.Courier,UFI.courier)) AS COURIER ,coalesce(EEFI.manifest_date,UFI.dispatch_date) AS DISPATCH_DATE ,coalesce(EEFI.delivered_date,UFI.delivered_date) AS DELIVERED_DATE ,case when lower(coalesce(shipmap.final_shipping_status,ufi.shipping_status, eefi.shipping_status)) = \'delivered\' then 1 else 0 end AS DELIVERED_STATUS ,0 AS RETURN_FLAG ,case when RETURN_FLAG = 1 then quantity::int end returned_quantity ,case when RETURN_FLAG = 1 then \"Invoice Amount\" end returned_sales ,case when RETURN_FLAG = 0 and lower(UPPER(\'Shipped\')) in (\'cancelled\') then quantity::int end cancelled_quantity ,NULL as NEW_CUSTOMER_FLAG ,NULL as ACQUISITION_PRODUCT ,case when lower(coalesce(shipmap.final_shipping_status,EEFI.shipping_status,UFI.shipping_status)) in (\'delivered\',\'delivered to origin\') then datediff(day,date(afi.report_date),date(coalesce(ufi.shipping_last_update_date::datetime, eefi.shipping_last_update_date::datetime))) when lower(coalesce( shipmap.final_shipping_status,EEFI.shipping_status,UFI.shipping_status)) in (\'in transit\', \'shipment created\') then datediff(day,date(afi.report_date), getdate()) end::int as Days_in_Shipment ,NULL AS ACQUSITION_DATE ,coalesce(afi.SKU,ufi.PRODUCT_ID,eefi.SKU) as SKU_CODE ,UPPER(p.name) PRODUCT_NAME_FINAL ,UPPER(p.category) PRODUCT_CATEGORY ,upper(p.sub_category) PRODUCT_SUB_CATEGORY ,upper(EEFI.warehouse_name) WAREHOUSE ,p.skucode commonskucode ,e.mrp*(afi.quantity::int) mrp_sales ,e.discount*(afi.quantity::int) mrp_discount ,e.cogs*(afi.quantity::int) cogs ,0 as margin from SOLARA_DB.MAPLEMONK.amazon_sc_gst_sales AFI left join (select * from (select skucode, marketplace, marketplace_sku, name, category, sub_category, row_number() over (partition by MARKETPLACE_SKU order by 1) rw from SOLARA_DB.MAPLEMONK.FINAL_SKU_MASTER) where rw = 1 and lower(marketplace) like \'%amazon%\' ) p on afi.asin = p.MARKETPLACE_SKU left join (select * from ( select * ,row_number()over(partition by reference_code, SKU order by last_update_date desc) rw from SOLARA_DB.MAPLEMONK.SOLARA_DB_EasyEcom_FACT_ITEMS ) z where z.rw = 1 and lower(marketplace) like any (\'%amazon%\') ) EEFI on AFI.\"Order Id\" = EEFI.reference_code and AFI.SKU = EEFI.sku left join (select * from (select order_id ,city ,state ,product_id ,shippingpackagecode ,SHIPPINGPACKAGESTATUS ,shipping_status ,order_status ,Courier ,Dispatch_Date ,Delivered_date ,Return_flag ,Return_quantity ,cancelled_quantity ,shipping_last_update_date ,days_in_shipment ,awb ,payment_method ,payment_mode ,email ,row_number() over (partition by order_id, product_id order by shipping_last_update_date desc) rw from SOLARA_DB.MAPLEMONK.SOLARA_DB_UNICOMMERCE_FACT_ITEMS where lower(marketplace) like any (\'%amazon%\')) where rw=1 ) UFI on AFI.\"Order Id\" = UFI.order_id and AFI.SKU = UFI.PRODUCT_ID left join ( select * from ( select upper(Shipping_status) shipping_status ,upper(mapped_status) final_shipping_status ,row_number() over (partition by lower(shipping_Status) order by 1) rw from SOLARA_DB.MAPLEMONK.shipment_status_mapping ) where rw = 1 ) ShipMap on lower(coalesce(EEFI.shipping_status,UFI.shipping_status)) = lower(ShipMap.shipping_status) left join (select * from (select sku_code , try_to_date(start_date,\'DD-MON-YY\') start_Date , try_to_date(end_date,\'DD-MON-YY\') End_date , try_to_double(bau_Asp) mrp , try_to_double(\"COGS(Excluding Tax)\") cogs , AMAZON_SC_DISCOUNT::float discount , replace(tax, \'%\',\'\')/100 tax_rate , row_number() over (partition by sku_code, start_date, end_date order by bau_asp desc) rw from SOLARA_DB.MAPLEMONK.MAPPING_SKU_MRP_COGS ) where rw=1 ) e on lower(replace(e.sku_code,\' \',\'\')) = lower(coalesce(afi.SKU,ufi.PRODUCT_ID,eefi.SKU)) and afi.report_date::date >= e.start_date and afi.report_date::date <= e.end_date ; create or replace table solara_db.maplemonk.amazon_sc_gst_sales_fact_items as select customer_id CUSTOMER_ID_FINAL, null ACQUISITION_DATE, null FIRST_COMPLETE_ORDER_DATE, null MAPLE_MONK_ID_PHONE, CUSTOMER_ID, SHOP_NAME, MARKETPLACE, CHANNEL, SOURCE, ORDER_ID, REFERENCE_CODE, PHONE, NAME, EMAIL, SHIPPING_LAST_UPDATE_DATE, SKU, PRODUCT_ID, PRODUCT_NAME, CURRENCY, CITY, STATE, ORDER_STATUS, ORDER_DATE, QUANTITY, GROSS_SALES_BEFORE_TAX, DISCOUNT, TAX, MRP_TAX, SHIPPING_PRICE, SELLING_PRICE, OMS_ORDER_STATUS, SHIPPING_STATUS, FINAL_SHIPPING_STATUS, SALEORDERITEMCODE, SALES_ORDER_ITEM_ID, AWB, PAYMENT_GATEWAY, PAYMENT_MODE, COURIER, DISPATCH_DATE, DELIVERED_DATE, DELIVERED_STATUS, RETURN_FLAG, RETURNED_QUANTITY, RETURNED_SALES, CANCELLED_QUANTITY, DAYS_IN_SHIPMENT, ACQUSITION_DATE, SKU_CODE, PRODUCT_NAME_FINAL, PRODUCT_CATEGORY, PRODUCT_SUB_CATEGORY, WAREHOUSE, COMMONSKUCODE, MRP_SALES, MRP_DISCOUNT, COGS, MARGIN, NEW_CUSTOMER_FLAG, null NEW_CUSTOMER_FLAG_MONTH, null ACQUISITION_PRODUCT, null ACQUISITION_CHANNEL, null ACQUISITION_MARKETPLACE from solara_db.maplemonk.amazon_sc_gst_sales_fact_items_intermediate ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from SOLARA_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        