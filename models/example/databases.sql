{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE maplemonk.zouk_RFM_SCORE ( LOWER_LIMIT FLOAT64, UPPER_LIMIT FLOAT64, SCORE FLOAT64 ); INSERT INTO maplemonk.zouk_RFM_SCORE (LOWER_LIMIT, UPPER_LIMIT, SCORE) VALUES (0, 0.1, 10), (0.1, 0.2, 9),(0.2, 0.3, 8),(0.3, 0.4, 7),(0.4, 0.5, 6), (0.5, 0.6, 5), (0.6, 0.7, 4), (0.7, 0.8, 3), (0.8, 0.9, 2), (0.9, 1, 1); CREATE OR REPLACE TABLE maplemonk.zouk_RFM_CUSTOMER_CATEGORY_MAPPING ( R_START FLOAT64, R_END FLOAT64, F_START FLOAT64, F_END FLOAT64, M_START FLOAT64, M_END FLOAT64, CATEGORY STRING ); INSERT INTO maplemonk.zouk_RFM_CUSTOMER_CATEGORY_MAPPING (R_START, R_END, F_START, F_END, M_START, M_END, CATEGORY) VALUES (8, 10, 8, 10, 6, 10, \'Champion\'), (8, 10, 8, 10, 4, 6, \'Frequent Customer with medium spend\'), (8, 10, 8, 10, 0, 4, \'Frequent Customer with low spend\'), (6, 8, 8, 10, 0, 10, \'Loyal Customers\'), (8, 10, 6, 8, 0, 10, \'Loyal Customers\'), (4, 6, 0, 6, 0, 10, \'Potential to become inactive\'), (0, 4, 4, 6, 0, 10, \'Potential to become inactive\'), (6, 8, 6, 8, 0, 10, \'Potential to become loyal Customers\'), (8, 10, 4, 6, 0, 10, \'Needs more engagement\'), (6, 8, 0, 6, 0, 10, \'Needs more engagement\'), (8, 10, 0, 4, 0, 10, \'New Customer/Promising Customers\'), (0, 6, 6, 10, 0, 10, \'Initiate re-engagement\'), (0, 4, 0, 4, 0, 10, \'Inactive Customers\'); CREATE OR REPLACE TABLE maplemonk.zouk_NEXT_PURCHASE_INTERMEDIATE AS SELECT LAST_PRODUCT, NEXT_PRODUCT, NUMBER, LIST, SHARE FROM ( SELECT *, ROW_NUMBER() OVER (PARTITION BY LAST_PRODUCT ORDER BY NUMBER DESC) AS LIST, NUMBER / SUM(NUMBER) OVER (PARTITION BY LAST_PRODUCT) AS SHARE FROM ( SELECT b.PRODUCT_NAME AS LAST_PRODUCT, a.PRODUCT_NAME AS NEXT_PRODUCT, COUNT(*) AS NUMBER FROM ( SELECT ROW_NUMBER() OVER (PARTITION BY CUSTOMER_ID_FINAL ORDER BY ORDER_ID) AS ORDER_NUMBER, * FROM ( SELECT DENSE_RANK() OVER (PARTITION BY ORDER_ID ORDER BY SELLING_PRICE, PRODUCT_ID DESC) AS RW, * FROM maplemonk.zouk_SALES_CONSOLIDATED WHERE LOWER(SHOP_NAME) LIKE \'%shopify%\' OR LOWER(SHOP_NAME) LIKE \'%woocommerce%\' ) WHERE RW = 1 ) a LEFT JOIN ( SELECT DISTINCT CUSTOMER_ID_FINAL, ORDER_NUMBER, PRODUCT_NAME FROM ( SELECT ROW_NUMBER() OVER (PARTITION BY CUSTOMER_ID_FINAL ORDER BY ORDER_ID) AS ORDER_NUMBER, * FROM ( SELECT DENSE_RANK() OVER (PARTITION BY ORDER_ID ORDER BY SELLING_PRICE, PRODUCT_ID DESC) AS RW, * FROM maplemonk.zouk_SALES_CONSOLIDATED WHERE LOWER(SHOP_NAME) LIKE \'%shopify%\' OR LOWER(SHOP_NAME) LIKE \'%woocommerce%\' ) WHERE RW = 1 ) ) b ON a.ORDER_NUMBER = (b.ORDER_NUMBER + 1) AND a.CUSTOMER_ID_FINAL = b.CUSTOMER_ID_FINAL WHERE b.ORDER_NUMBER IS NOT NULL AND b.CUSTOMER_ID_FINAL IS NOT NULL GROUP BY b.PRODUCT_NAME, a.PRODUCT_NAME ORDER BY 3 DESC ) ) WHERE LIST IN (1, 2, 3); CREATE OR REPLACE TABLE maplemonk.zouk_NEXT_PURCHASE AS SELECT a.LAST_PRODUCT, NEXT_PRODUCT1, NEXT_PRODUCT2, NEXT_PRODUCT3, SHARE1, SHARE2, SHARE3 FROM ( SELECT LAST_PRODUCT, NEXT_PRODUCT AS NEXT_PRODUCT1, SHARE AS SHARE1 FROM maplemonk.zouk_NEXT_PURCHASE_INTERMEDIATE WHERE LIST = 1 ) a LEFT JOIN ( SELECT LAST_PRODUCT, NEXT_PRODUCT AS NEXT_PRODUCT2, SHARE AS SHARE2 FROM maplemonk.zouk_NEXT_PURCHASE_INTERMEDIATE WHERE LIST = 2 ) b ON a.LAST_PRODUCT = b.LAST_PRODUCT LEFT JOIN ( SELECT LAST_PRODUCT, NEXT_PRODUCT AS NEXT_PRODUCT3, SHARE AS SHARE3 FROM maplemonk.zouk_NEXT_PURCHASE_INTERMEDIATE WHERE LIST = 3 ) c ON a.LAST_PRODUCT = c.LAST_PRODUCT; CREATE OR REPLACE TABLE maplemonk.zouk_CUSTOMER_MASTER_INTERMEDIATE AS SELECT fi.CUSTOMER_ID_FINAL AS MM_CUSTOMER_ID, MAX(fi.NAME) AS NAME, MAX(fi.EMAIL) AS EMAIL, fi.PHONE AS PHONE, MIN(ACQUISITION_DATE) AS ACQUISITION_DATE, MIN(CASE WHEN fi.ORDER_DATE = ACQUISITION_DATE THEN SHOP_NAME END) AS ACQUISITION_MARKETPLACE, MIN(CASE WHEN fi.ORDER_DATE = ACQUISITION_DATE THEN SOURCE END) AS ACQUISITION_MARKETING_CHANNEL, fi.ACQUISITION_PRODUCT AS ACQUISITION_PRODUCT, DATE_DIFF(CURRENT_DATE(), MIN(ORDER_DATE), DAY) AS DAYS_SINCE_FIRST_PURCHASE, MAX(CASE WHEN fi.ORDER_DATE = fi1.MAX_ORDER_DATE THEN PRODUCT_NAME END) AS LAST_PRODUCT, IFNULL(SUM(fi.SELLING_PRICE), 0) AS TOTAL_SALES_INR, COUNT(DISTINCT fi.ORDER_ID) AS TOTAL_ORDERS, COUNT(DISTINCT CASE WHEN LOWER(ORDER_STATUS) IN (\'cancelled\', \'returned\', \'rto\') THEN fi.ORDER_ID END) AS CANCELLED_ORDERS, COUNT(DISTINCT CASE WHEN LOWER(ORDER_STATUS) IN (\'returned\', \'rto\') THEN fi.ORDER_ID END) AS RETURNED_ORDERS, COUNT(DISTINCT CASE WHEN LOWER(SHOP_NAME) LIKE \'%shopify%\' THEN fi.ORDER_ID END) AS TOTAL_SHOPIFY_ORDERS, COUNT(DISTINCT CASE WHEN LOWER(SHOP_NAME) LIKE \'%cred%\' THEN fi.ORDER_ID END) AS TOTAL_CRED_ORDERS, COUNT(DISTINCT fi.SALEORDERITEMCODE) AS TOTAL_ITEMS, MAX(CASE WHEN fi.ORDER_DATE = fi1.MAX_ORDER_DATE THEN ORDER_ID END) AS LAST_ORDER_ID, DATE_DIFF(CURRENT_DATE(), MAX(fi.ORDER_DATE), DAY) AS DAYS_SINCE_LAST_PURCHASE, CASE WHEN COUNT(DISTINCT ORDER_ID) = 0 THEN NULL ELSE DATE_DIFF(MAX(ORDER_DATE), MIN(ORDER_DATE), DAY) / COUNT(DISTINCT ORDER_ID) END AS AVG_DAYS_BETWEEN_PURCHASES, SUM(fi.DISCOUNT) AS DISCOUNT_INR, CASE WHEN SUM(fi.SELLING_PRICE) = 0 THEN NULL ELSE SUM(fi.DISCOUNT) / SUM(fi.SELLING_PRICE) END AS DISCOUNT_PERCENT, SUM(IFNULL(DAYS_IN_SHIPMENT, 0)) AS DAYS_IN_SHIPMENT FROM maplemonk.zouk_SALES_CONSOLIDATED fi LEFT JOIN ( SELECT CUSTOMER_ID_FINAL, MAX(ORDER_DATE) AS MAX_ORDER_DATE FROM maplemonk.zouk_SALES_CONSOLIDATED GROUP BY CUSTOMER_ID_FINAL ) fi1 ON fi.CUSTOMER_ID_FINAL = fi1.CUSTOMER_ID_FINAL WHERE fi.CUSTOMER_ID_FINAL IS NOT NULL AND ORDER_DATE IS NOT NULL GROUP BY fi.CUSTOMER_ID_FINAL, fi.PHONE, fi.ACQUISITION_PRODUCT; CREATE OR REPLACE TABLE maplemonk.zouk_CUSTOMER_MASTER AS SELECT x.*, np.NEXT_PRODUCT1, np.NEXT_PRODUCT2, np.NEXT_PRODUCT3, np.SHARE1, np.SHARE2, np.SHARE3, rcm.CATEGORY AS CUSTOMER_SEGMENT FROM ( SELECT c.*, m.SCORE AS M_SCORE, r.SCORE AS R_SCORE, f.SCORE AS F_SCORE, (r.SCORE * 1/3 + f.SCORE * 1/3 + m.SCORE * 1/3) AS RFM_SCORE FROM ( SELECT *, ROW_NUMBER() OVER (ORDER BY TOTAL_SALES_INR DESC) / (SELECT COUNT(DISTINCT MM_CUSTOMER_ID) FROM maplemonk.zouk_CUSTOMER_MASTER_INTERMEDIATE) AS PERCENTILE_M, ROW_NUMBER() OVER (ORDER BY DAYS_SINCE_LAST_PURCHASE ASC, MM_CUSTOMER_ID) / (SELECT COUNT(DISTINCT MM_CUSTOMER_ID) FROM maplemonk.zouk_CUSTOMER_MASTER_INTERMEDIATE) AS PERCENTILE_R, CASE WHEN AVG_DAYS_BETWEEN_PURCHASES = 0 THEN 0.4 ELSE ROW_NUMBER() OVER (PARTITION BY CASE WHEN AVG_DAYS_BETWEEN_PURCHASES = 0 THEN 0 ELSE 1 END ORDER BY AVG_DAYS_BETWEEN_PURCHASES ASC, MM_CUSTOMER_ID) / (SELECT COUNT(DISTINCT MM_CUSTOMER_ID) FROM maplemonk.zouk_CUSTOMER_MASTER_INTERMEDIATE) END AS PERCENTILE_F FROM maplemonk.zouk_CUSTOMER_MASTER_INTERMEDIATE ) c LEFT JOIN maplemonk.zouk_RFM_SCORE m ON c.PERCENTILE_M > m.LOWER_LIMIT AND c.PERCENTILE_M <= m.UPPER_LIMIT LEFT JOIN maplemonk.zouk_RFM_SCORE r ON c.PERCENTILE_R > r.LOWER_LIMIT AND c.PERCENTILE_R <= r.UPPER_LIMIT LEFT JOIN maplemonk.zouk_RFM_SCORE f ON c.PERCENTILE_F > f.LOWER_LIMIT AND c.PERCENTILE_F <= f.UPPER_LIMIT ) x LEFT JOIN maplemonk.zouk_RFM_CUSTOMER_CATEGORY_MAPPING rcm ON CAST(x.M_SCORE AS INT64) > rcm.M_START AND CAST(x.M_SCORE AS INT64) <= rcm.M_END AND CAST(x.R_SCORE AS INT64) > rcm.R_START AND CAST(x.R_SCORE AS INT64) <= rcm.R_END AND CAST(x.F_SCORE AS INT64) > rcm.F_START AND CAST(x.F_SCORE AS INT64) <= rcm.F_END LEFT JOIN maplemonk.zouk_NEXT_PURCHASE np ON np.LAST_PRODUCT = x.LAST_PRODUCT;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from maplemonk.INFORMATION_SCHEMA.TABLES
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            