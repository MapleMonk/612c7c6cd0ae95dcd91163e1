{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.sku_group_sample_to_live as with live_date as ( SELECT sku_group,published_at as live_date,status FROM ( SELECT *, REVERSE(SUBSTRING(REVERSE(REPLACE(A.value:sku, \'\"\"\', \'\')), CHARINDEX(\'-\', REVERSE(REPLACE(A.value:sku, \'\"\"\', \'\'))) + 1)) AS sku_group, ROW_NUMBER() OVER (PARTITION BY sku_group ORDER BY updated_at DESC) AS rw FROM snitch_db.maplemonk.shopify_all_products, LATERAL FLATTEN (input => variants) A ) WHERE rw = 1 ), catalog AS ( SELECT SKU_GROUP, status, latest_inward_date::date as latest_inward_date, new_inward_flag, ifnull(SUM(units_on_hand),0) AS units_on_hand FROM snitch_db.maplemonk.Inventory_planning_summary_snitch GROUP BY SKU_GROUP, new_inward_flag, status, latest_inward_date HAVING SUM(units_on_hand) > 0 ), PSLJ AS( SELECT a.SKU as sku_group, b.live_date, b.status, a.\"Factory_\'\", a.owner as editor_owner, max(try_to_date(a.Sample_Received_Date, \'DD/MM/YYYY\')) as Sample_Received_Date, a.Photoshoot_Status, a.IMAGE_SELECTION, max(try_to_date(a.Recevied_Date_)) as edit_received_date, max(try_to_date(a.Completion_Date)) as edit_completed_date, max(try_to_date(a.\"Catalogix Batch Share Date\")) as catalogix_sent_timestamp, max(try_to_date(a.\"Catalogix Batch Recevied Date\")) as catalogix_received_timestamp, max(try_to_date(a.live_on_shopify_date, \'DD/MM/YYYY\')) as live_on_shopify_date, max(try_to_date(a.final_shoot_date, \'DD/MM/YYYY\')) as shoot_date, from snitch_db.maplemonk.PSLJ a left join live_date b on a.sku = b.sku_group group by 1,2,3,4,5,7,8 ), RTS AS ( SELECT SKU as sku_group, CLASS, REPEAT, VENDOR, WAEHOUSE, DESCIPTON, to_date(DELIVEY_DATE_, \'DD/MM/YYYY\') AS DELIVERY_DATE, online_qty, QC_STATUS, QC_REPORT FROM snitch_db.maplemonk.catalog_main where to_date(DELIVEY_DATE_, \'DD/MM/YYYY\') >= current_date ), main_data as ( select coalesce(a.sku_group,c.SKU_GROUP,r.sku_group) as sku_group, a.Sample_Received_Date::date as sample_received_date, a.live_date::date as live_date, a.Photoshoot_Status, a.shoot_date::date as shoot_date, a.edit_received_date, a.editor_owner, a.edit_completed_date, a.catalogix_sent_timestamp, a.catalogix_received_timestamp, r.delivery_date, coalesce(c.units_on_hand,r.online_qty,0) as units_on_hand, c.latest_inward_date as inward_date, coalesce(a.status,c.status) as status, DATEDIFF(day, a.Sample_Received_Date, a.live_date) AS sr_live_tat, DATEDIFF(day, a.Sample_Received_Date, a.shoot_date) AS shoot_tat, datediff(day,a.shoot_date,a.edit_received_date) as shootdone_editreceived_tat, datediff(day,a.edit_received_date,a.edit_completed_date) as edit_tat, datediff(day,a.edit_completed_date,a.catalogix_sent_timestamp) as editdone_catalogixsent_tat, datediff(day,a.catalogix_sent_timestamp,a.catalogix_received_timestamp) as catalogix_tat, datediff(day,a.catalogix_received_timestamp,a.live_date) as live_tat from PSLJ a full outer join catalog c on a.sku_group=c.sku_group full outer join rts r on a.sku_group = r.sku_group ) select *, CASE when status = \'active\' then \'no_issues\' when delivery_date is not null then \'ready_to_dispatch\' when sample_received_date is null and shoot_date is null then \'SAMPLE_NOT_RECEIVED\' when shoot_date is null then \'SHOOT_NOT_DONE\' when shoot_date is not null and edit_received_date is null then \'NOT_SEND_TO_EDIT\' when shoot_date is not null and edit_received_date is not null and edit_completed_date is null then \'EDITING\' when shoot_date is not null and edit_received_date is not null and edit_completed_date is not null and catalogix_sent_timestamp is null then \'NOT_SEND_TO_CATALOGIX\' when shoot_date is not null and edit_received_date is not null and edit_completed_date is not null and catalogix_sent_timestamp is not null and catalogix_received_timestamp is null then \'CATALOGIX\' when shoot_date is not null and edit_received_date is not null and edit_completed_date is not null and catalogix_sent_timestamp is not null and catalogix_received_timestamp is not null and inward_date is not null then \'QC\' when shoot_date is not null and edit_received_date is not null and edit_completed_date is not null and catalogix_sent_timestamp is not null and catalogix_received_timestamp is not null and inward_date is null then \'CATALOGING_DONE_BUT_NOT_INWARDED\' else \'others\' end as final_status from main_data where sku_group not in (\'4MSS2466-02\', \'4MSN1021-White\', \'4MSN1059-01-Shirt\', \'4MSR5053-04\', \'4MSS1318-03\', \'4MSK8513-03\', \'4MSR5054-01\', \'4MST0160-Beige-T-Shirt\', \'4MSS1860-05\', \'4MSS2067-02\', \'4MSS1926-01\', \'4MSN0990-01-Shirt\', \'4MSS1907-07\', \'4MSW9001-02\', \'4MSW9001-04\', \'4MSS1697-06\', \'4MSS2495-05\', \'4MSR5054-02\', \'4MSR5054-04\', \'4MSS2301-02\', \'4MSR5046-04\', \'4MSR5032-04\', \'4MSS2509-01\', \'4MSD3516-01\', \'4MSN1021-Black\', \'4MSS1339-01\', \'4MSS1801-13\', \'4MSCR7266-05\', \'4MSS1539-01\', \'4MSS1971-04\', \'4MSS1642-01\', \'4MSS2110-03\', \'4MSR5054-05\', \'4MSK8570-03\', \'4MSS2420-02\', \'4MSS2420-03\', \'4MSS1962-05\', \'4MSK8540-03\', \'4MSS1944-06\', \'4MST2022-04\', \'4MSK8513-02\', \'4MSR5022-05\', \'4MSR5053-01\', \'4MST2237-11\', \'4MST2237-10\', \'4MSR5028-02\', \'4MSR5038-08\', \'4MST2237-09\', \'4MST2237-04\', \'4MST2237-12\', \'4MST2237-02\', \'4MST2237-07\', \'4MST2237-01\', \'4MSC4008-02\', \'4MTP0011-04\', \'4MSR5033-05\', \'4MSR5054-03\', \'4MSK8507-03\', \'4MSNJ0098-01-Denim\', \'4MSS1642-04\', \'4MSR5053-03\', \'4MSS2417-01\', \'4MSS2445-01\', \'4MSS2358-06\', \'4MSS2417-02\', \'4MSS2000-06\', \'4MSS2382-01\', \'4MSS2447-06\', \'4MSS2525-07\', \'4MSS2245-03\', \'4MSS2097-01\', \'4MSS2329-02\', \'4MSS2452-02\', \'4MSS1960-01\', \'4MST2022-03\', \'4MSS1878-04\', \'4MSS2417-03\', \'4MSS1697-12\', \'4MST2104-01\', \'4MSS2172-02\', \'4MSBX9202-27\', \'4MSS2648-5\', \'4MST0048_49-05-T-Shirt\', \'4MPJP013-01-Pyjama\', \'4MSBX9202-16\', \'4MSBX9202-19\', \'4MSS1718-01\', \'4MSK8570-05\', \'4MSK8570-04\', \'4MSC4006-02\', \'4MSR5053-02\', \'4MSFR0901\', \'4MTR0112-04-Trouser\', \'4MSNJ0055-04-Jeans\', \'4MSS2594-03\', \'4MSBX9202-01\', \'4MST0017-04-T-Shirt\', \'4MST0217-06-T-Shirt\', \'4MSNJ0055-01-Jeans\', \'4MST0217-03-T-Shirt\', \'4MSNJ0031-03-Jeans\', \'4MSFR0903\', \'4MSC4006-08\', \'4MSS2495-07\', \'4MST0028-01-T-Shirt\', \'4MSS1226-02\', \'4MTR0112-05-Trouser\', \'4MST0175-04-Sweater\', \'4MSN1256-01-Co-Ords\', \'4MSNJ0025-03-Jeans\', \'4MSD3506-02\', \'4MST0232-03-Co-Ords\', \'4MSD3506-03\', \'4MSS2594-04\', \'4MSS1481-09\', \'4MSS1116-02\', \'4MSS2199-03\', \'4MSS1681-01\', \'4MSS1222-02\', \'4MSD3506-01\', \'4MSS1226-03\', \'4MSH0030-05-Shorts\', \'4MSN1021-Navy\', \'4MSS2441-03\', \'4MSS2338-01\', \'4MST0166-06-T-Shirt\', \'4MSZ0011-01-Co-Ords\', \'4MSS1226-01\')",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            