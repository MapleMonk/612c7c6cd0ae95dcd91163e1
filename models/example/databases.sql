{{ config(
            materialized='table',
                post_hook={
                    "sql": "create or replace table ANDAMEN_DB.MAPLEMONK.ANDAMEN_DB_EASYECOM_TAX_SALES_FACTITEMS AS select TS.\"MP Ref No\" MARKETPLACE_REFERENCE_CODE ,TS.\"Reference Code\" Reference_Code ,TS.\"Suborder No\" SUBORDER_NUMBER ,TS.\"EE Invoice No\" INVOICE_NUMBER ,TS.\"Invoice ERP Transaction ID\" Invoice_ERP_Transaction_ID ,upper(replace(TS.\"Sales Channel\",\'`\',\'\')) EE_SALES_CHANNEL ,upper(TS.\"MP Name\") MARKETPLACE ,MM.MAPPED_MARKETPLACE ,MM.SALES_CHANNEL ,TS.\"Order Type\" Order_Type ,try_to_timestamp(TS.\"Order Date\") Order_Date ,try_to_timestamp(TS.\"Import Date\") Import_Date ,try_to_timestamp(TS.\"Invoice Date\") Invoice_Date ,try_to_timestamp(TS.\"Manifest Date\") Manifest_Date ,UPPER(replace(TS.\"Parent SKU\",\'`\',\'\')) Parent_SKU ,skumasterP.skucode Parent_Common_SKU ,upper(REGEXP_SUBSTR(Parent_SKU, \'-(S|M|L|XL|XXL|30|31|32|33|34|36|38)(-|$)\', 1, 1, \'e\', 1)) PARENT_SKU_SIZE ,upper(case when PARENT_SKU_SIZE in (\'30\',\'31\') then \'S\' when PARENT_SKU_SIZE in (\'32\',\'33\') then \'M\' when PARENT_SKU_SIZE in (\'34\') then \'L\' when PARENT_SKU_SIZE in (\'36\') then \'XL\' when PARENT_SKU_SIZE in (\'38\') then \'XXL\' else PARENT_SKU_SIZE end) PARENT_SKU_FINAL_SIZE ,skumasterP.name Parent_SKU_Name ,skumasterP.category Parent_SKU_Category ,skumasterP.SUB_CATEGORY Parent_SKU_SUB_CATEGORY ,skumasterP.COLLECTION Parent_SKU_COLLECTION ,skumasterP.SEASON Parent_SKU_SEASON ,skumasterP.LAUNCH_DATE Parent_LAUNCH_DATE ,UPPER(TS.\"Parent SKU Weight\") Parent_SKU_Weight ,UPPER(replace(TS.\"Component SKU\",\'`\',\'\')) Component_SKU ,skumaster.skucode Component_Common_SKU ,upper(REGEXP_SUBSTR(Component_SKU, \'-(S|M|L|XL|XXL|30|31|32|33|34|36|38)(-|$)\', 1, 1, \'e\', 1)) COMPONENT_SKU_SIZE ,upper(case when COMPONENT_SKU_SIZE in (\'30\',\'31\') then \'S\' when COMPONENT_SKU_SIZE in (\'32\',\'33\') then \'M\' when COMPONENT_SKU_SIZE in (\'34\') then \'L\' when COMPONENT_SKU_SIZE in (\'36\') then \'XL\' when COMPONENT_SKU_SIZE in (\'38\') then \'XXL\' else COMPONENT_SKU_SIZE end) COMPONENT_SKU_FINAL_SIZE ,upper(coalesce(skumaster.name,TS.\"Component SKU Name\")) Component_SKU_Name ,Upper(coalesce(skumaster.category,TS.\"Component SKU Category\")) Component_SKU_Category ,skumaster.SUB_CATEGORY COMPONENT_SKU_SUB_CATEGORY ,skumaster.COLLECTION COMPONENT_SKU_COLLECTION ,skumaster.SEASON COMPONENT_SKU_SEASON ,skumaster.LAUNCH_DATE COMPONENT_LAUNCH_DATE ,upper(TS.\"Component SKU Brand\") Component_SKU_Brand ,upper(TS.\"Component SKU Weight\") Component_SKU_Weight ,upper(TS.\"Component SKU Description\") Component_SKU_Description ,upper(TS.\"Order Status\") Order_Status ,upper(TS.\"Invoice Status\") Invoice_Status ,upper(TS.\"Payment Mode\") Payment_Mode ,UPPER(TS.\"Customer Name\") NAME ,TS.\"Mobile No\" PHONE ,TS.\"Customer Email\" EMAIL ,Upper(TS.state) STATE ,upper(TS.CITY) CITY ,TS.\"Zip Code\" PINCODE ,upper(TS.\"Company Name\") WAREHOUSE_NAME ,upper(TS.\"Parent Courier Partner\") PARENT_COURIER_PARTNER ,upper(TS.courier) COURIER ,TS.\"AWB No\" AWB ,try_to_timestamp(TS.\"Eway Bill Date\") Eway_Bill_Date ,TS.\"Eway Bill Number\" Eway_Bill_Number ,try_cast(TS.\"Parent Quantity\" as float) PARENT_SKU_QUANTITY ,try_cast(TS.\"Item Quantity\" as float) QUANTITY ,try_cast(TS.\"Component SKU MRP\" as float) Component_SKU_MRP ,case when lower(marketplace) like \'%shopify%\' and try_cast(TS.\"Selling Price\" as float) = 0 then 0 else Component_SKU_MRP*QUANTITY end MRP_SALES ,try_cast(TS.\"Selling Price\" as float) SELLING_PRICE ,try_cast(TS.\"Wallet Discount\" as float) WALLET_DISCOUNT ,case when lower(marketplace) like \'%ajio%\' then SELLING_PRICE/0.664 else SELLING_PRICE - WALLET_DISCOUNT end FINAL_SELLING_PRICE ,MRP_SALES - FINAL_SELLING_PRICE FINAL_DISCOUNT ,try_cast(TS.\"Item Price(Excluding Tax)\" as float) Item_Price_Excluding_Tax ,try_cast(TS.\"Prepaid Discount(Excluding Tax)\" as float) PREPAID_DISCOUNT_EXCLUDING_TAX ,try_cast(TS.\"Shipping Charge(Excluding Tax)\" as float) Shipping_Charge_Excluding_Tax ,try_cast(TS.\"Shipping Discount(Excluding Tax)\" as float) Shipping_Discount_Excluding_Tax ,try_cast(TS.\"Gift Wrap Charges(Excluding Tax)\" as float) Gift_Wrap_Charges_Excluding_Tax ,try_cast(TS.\"Promocode Discount(Excluding Tax)\" as float) Promocode_Discount_Excluding_Tax ,try_cast(TS.\"Promotion Discount(Excluding Tax)\" as float) Promotion_Discount_Excluding_Tax ,try_cast(TS.\"Miscellaneous(Excluding Tax)\" as float) Miscellaneous_Excluding_Tax ,try_cast(TS.\"COD(Excluding Tax)\" as float) COD_Excluding_Tax ,try_cast(TS.TAX as float) TAX ,try_cast(TS.CGST as float) CGST ,try_cast(TS.SGST as float) SGST ,try_cast(TS.IGST as float) IGST ,try_cast(TS.CESS as float) CESS ,try_cast(TS.TDS as float) TDS ,try_cast(TS.TCS as float) TCS ,try_cast(TS.UTGST as float) UTGST ,try_cast(TS.\"Order Invoice Amount\" as float) Order_Invoice_Amount ,try_cast(TS.\"Collectible Amount\" as float) Collectible_Amount ,try_cast(TS.\"Taxable Value\" as float) Taxable_Value from (select * from andamen_db.maplemonk.andamen_ee_tax_sales where not(lower(\"MP Name\") like \'%impulse%\')) TS left join (select * from (select upper(commonsku) skucode , upper(product_name) name , upper(category) category , upper(sub_category) sub_category , upper(collection) Collection , upper(season) season , try_to_date(launch_date, \'DD Mon YYYY\') LAUNCH_DATE , row_number() over (partition by upper(commonsku) order by 1) rw from andamen_db.MAPLEMONK.sku_master) where rw = 1) skumaster on lower(trim(SPLIT_PART(SPLIT_PART(SPLIT_PART(replace(TS.\"Component SKU\",\'`\',\'\'), \'-\', 1),\' -\',1),\'-\',1))) = lower(skumaster.skucode) left join (select * from (select upper(commonsku) skucode , upper(product_name) name , upper(category) category , upper(sub_category) sub_category , upper(collection) Collection , upper(season) season , try_to_date(launch_date, \'DD Mon YYYY\') LAUNCH_DATE , row_number() over (partition by upper(commonsku) order by 1) rw from andamen_db.MAPLEMONK.sku_master) where rw = 1) skumasterP on lower(trim(SPLIT_PART(SPLIT_PART(SPLIT_PART(replace(TS.\"Parent SKU\",\'`\',\'\'), \'-\', 1),\' -\',1),\'-\',1))) = lower(skumasterP.skucode) left join (select upper(MARKETPLACE) MARKETPLACE ,upper(SALES_CHANNEL) SALES_CHANNEL ,UPPER(mapped_marketplace) MAPPED_MARKETPLACE from andamen_db.maplemonk.marketplace_mapping qualify (row_number() over (partition by lower(marketplace) order by 1)) = 1 ) MM on lower(TS.\"MP Name\") = lower(MM.MARKETPLACE) qualify row_number() over (partition by TS.\"MP Ref No\",TS.\"Reference Code\", TS.\"Suborder No\",TS.\"EE Invoice No\", TS.\"AWB No\" order by _AIRBYTE_NORMALIZED_AT desc) = 1;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from andamen_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            