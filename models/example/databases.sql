{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table eggozdb.maplemonk.zero_billing_retailers as select rr.code as retailer_name, rr.area_classification, rr.beat_number, rrp.name as parent_name, cast(timestampadd(minute, 660, rr.last_order_date) as date) last_order_date, cast(timestampadd(minute, 660, rr.onboarding_date) as date) onboarding_date, datediff(day,cast(timestampadd(minute, 660, rr.onboarding_date) as date),current_date()) days_since_onboarded, sum(oo.order_price_amount) total_bill_amount, count(distinct(oo.id)) as frequency, sum(oo.order_price_amount)/count(distinct(oo.id)) as average_order_amount, datediff(day,cast(timestampadd(minute, 660, rr.last_order_date) as date),current_date()) as recency from eggozdb.maplemonk.my_sql_order_order oo right join eggozdb.maplemonk.my_sql_retailer_retailer rr on rr.id = oo.retailer_id left join eggozdb.maplemonk.my_sql_retailer_retailerparent rrp on rrp.id = rr.parent_id where lower(rr.onboarding_status) = \'active\' and lower(oo.status) in (\'delivered\') and rr.distributor_id is null group by rr.code , rr.area_classification , rr.beat_number , rrp.name , cast(timestampadd(minute, 660, rr.last_order_date) as date) , cast(timestampadd(minute, 660, rr.onboarding_date) as date) ; create or replace table eggozdb.maplemonk.secondary_zero_billing_retailers as select rr2.code as distributor, tt.* from (select rr.code as retailer_name, rr.distributor_id, rr.area_classification, rr.beat_number, rrp.name as parent_name, cast(timestampadd(minute, 660, rr.last_order_date) as date) last_order_date, cast(timestampadd(minute, 660, rr.onboarding_date) as date) onboarding_date, datediff(day,cast(timestampadd(minute, 660, rr.onboarding_date) as date),current_date()) days_since_onboarded, sum(oo.order_price_amount) total_bill_amount, count(distinct(oo.id)) as frequency, sum(oo.order_price_amount)/count(distinct(oo.id)) as average_order_amount, datediff(day,cast(timestampadd(minute, 660, rr.last_order_date) as date),current_date()) as recency from eggozdb.maplemonk.my_sql_distributor_sales_secondaryorder oo join eggozdb.maplemonk.my_sql_retailer_retailer rr on rr.id = oo.retailer_id left join eggozdb.maplemonk.my_sql_retailer_retailerparent rrp on rrp.id = rr.parent_id where lower(rr.onboarding_status) = \'active\' and lower(oo.status) in (\'created\') and rr.distributor_id is not null group by rr.code , rr.area_classification , rr.beat_number , rrp.name , cast(timestampadd(minute, 660, rr.last_order_date) as date) , cast(timestampadd(minute, 660, rr.onboarding_date) as date) , rr.distributor_id ) tt join eggozdb.maplemonk.my_sql_retailer_retailer rr2 on tt.distributor_id = rr2.id ; create or replace table eggozdb.maplemonk.untouched_retailers as select tt.*, bgt.so from (SELECT CAST(TIMESTAMPADD(MINUTE, 660, db.beat_date) AS DATE) beat_date, db.beat_number, db.beat_name, rc.retailer_count, rr.code AS retailer_name, rr.area_classification, CAST(TIMESTAMPADD(MINUTE, 660, rr.onboarding_date) AS DATE) onboarding_date, CAST(TIMESTAMPADD(MINUTE, 660, rr.last_order_date) AS DATE) last_order_date, oo.status status_bill, oor.line_type status_ret_rep, oor2.last_pickup_date FROM eggozdb.maplemonk.my_sql_distributionchain_beatassignment db RIGHT JOIN eggozdb.maplemonk.my_sql_retailer_retailer rr ON rr.beat_number = db.beat_number AND rr.area_classification = db.demand_classification LEFT JOIN (SELECT * FROM eggozdb.maplemonk.my_sql_order_order WHERE is_trial <> TRUE AND LOWER(status) = \'delivered\') oo ON oo.beat_assignment_id = db.id AND CAST(TIMESTAMPADD(MINUTE, 660, oo.delivery_date) AS DATE) = CAST(TIMESTAMPADD(MINUTE, 660, db.beat_date) AS DATE) AND oo.retailer_id = rr.id LEFT JOIN (SELECT * FROM eggozdb.maplemonk.my_sql_order_orderreturnline WHERE LOWER(line_type) IN (\'replacement\' , \'return\')) oor ON oor.beat_assignment_id = db.id AND CAST(TIMESTAMPADD(MINUTE, 660, oor.pickup_date) AS DATE) = CAST(TIMESTAMPADD(MINUTE, 660, db.beat_date) AS DATE) AND rr.id = oor.retailer_id LEFT JOIN (SELECT area_classification, beat_number, COUNT(code) retailer_count FROM eggozdb.maplemonk.my_sql_retailer_retailer WHERE LOWER(onboarding_status) = \'active\' GROUP BY beat_number , area_classification) rc ON rc.area_classification = db.demand_classification AND rc.beat_number = db.beat_number LEFT JOIN (SELECT retailer_id, MAX(CAST(TIMESTAMPADD(MINUTE, 660, pickup_date) AS DATE)) AS last_pickup_date FROM eggozdb.maplemonk.my_sql_order_orderreturnline WHERE LOWER(line_type) IN (\'replacement\' , \'return\') GROUP BY retailer_id) oor2 ON oor2.retailer_id = rr.id WHERE LOWER(db.beat_type) = \'regular\' AND LOWER(db.beat_status) = \'completed\' AND LOWER(rr.onboarding_status) = \'active\' and rr.distributor_id is null ) tt left join maplemonk.target_jse_gt bgt on bgt.beat_number_original = tt.beat_number and bgt.city = tt.area_classification ; create or replace table eggozdb.maplemonk.secondary_untouched_retailers as select rr2.code as distributor_name, tt.bill_name, tt.status, tt.delivery_date, sum(tt.gross_sale) sale, sum(tt.eggs_sold) eggs_sold, tt.retailer_id, tt.retailer_name, tt.area_classification, tt.beat_number_original, tt.onboarding_status, tt.city_id, tt.distributor_id from ( select oo.name bill_name, oo.status, cast(timestampadd(minute, 330, oo.delivery_date) as date) delivery_date, sum(oo.order_price_amount) order_price_amount, sum(ol.quantity) * (ol.single_sku_rate + sum(ol.single_sku_discount)) gross_sale, CASE WHEN pp.name LIKE \'%liquid%\' THEN sum(ol.quantity) * 1000 / 35 ELSE sum(ol.quantity) * CASE WHEN pp.SKU_Count = 1 THEN CASE WHEN rr.area_classification = \'UP-UB\' THEN 1 ELSE 30 END ELSE pp.SKU_Count END END AS eggs_sold, concat(pp.sku_count,left(pp.name,1)) sku, pp.slug, sum(ol.quantity) quantity, oo.retailer_id, rr.code as retailer_name, rr.area_classification, rr.beat_number beat_number_original, rr.onboarding_status, rr.city_id, rr.distributor_id from eggozdb.maplemonk.my_sql_distributor_sales_secondaryorder oo join eggozdb.maplemonk.my_sql_retailer_retailer rr on rr.id = oo.retailer_id join eggozdb.maplemonk.my_sql_distributor_sales_secondaryorderline ol on ol.order_id = oo.id join eggozdb.maplemonk.my_sql_product_product pp on pp.id = ol.product_id group by cast(timestampadd(minute, 330, oo.delivery_date) as date), oo.retailer_id, oo.name, pp.name, pp.slug, oo.status, ol.single_sku_rate, rr.code, rr.area_classification, rr.beat_number, rr.onboarding_status, rr.city_id, rr.distributor_id, pp.sku_count ) tt join eggozdb.maplemonk.my_sql_retailer_retailer rr2 on rr2.id = tt.distributor_id group by tt.bill_name, tt.status, tt.delivery_date, tt.retailer_id, tt.retailer_name, tt.area_classification, tt.beat_number_original, tt.onboarding_status, tt.city_id, tt.distributor_id, rr2.code;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from EGGOZDB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        