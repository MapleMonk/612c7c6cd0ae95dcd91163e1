{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table XYXX_DB.MAPLEMONK.XYXX_SHOPIFY_SALES_INVENTORY_DOH as WITH Inventory_Data AS ( select * from ( select SR ,EAN ,SKU ,SIZE ,RANGE ,try_cast(STOCK as float) AVAILABLEINVENTORY ,UPPER(STYLE) STYLE ,PARENT ,upper(\"Bin Number\") BIN_NUMBER ,upper(\"New Color Name\") NEW_COLOR_NAME ,upper(\"Old Color Name\") OLD_COLOR_NAME ,upper(\"Collection Name\") COLLECTION ,_AIRBYTE_EMITTED_AT DATA_FETCH_DATE , row_number() over (partition by _AIRBYTE_EMITTED_AT::date, EAN, SKU order by _AIRBYTE_EMITTED_AT desc) rw from xyxx_db.maplemonk.XYXX_SOH_ROW ) where rw = 1 ), Sales_Data_Daily as ( SELECT order_timestamp::date Order_date, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, SUM(IFNULL(quantity, 0)) AS QUANTITY, sum(case when lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) QUANTITY_BUILD_A_PACK, count(distinct case when lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then ORDER_NAME end) ORDERS_BUILD_A_PACK, sum(case when lower(order_status) like \'%cancel%\' then IFNULL(quantity, 0) else 0 end) CANCELLED_QUANTITY, sum(case when lower(order_status) like \'%cancel%\' and lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) CANCELLED_QUANTITY_BUILD_A_PACK, sum(case when IS_REFUND<>0 and not(lower(order_status) like \'%cancel%\') then IFNULL(quantity, 0) else 0 end) AS RETURNED_QUANTITY, sum(case when IS_REFUND<>0 and not(lower(order_status) like \'%cancel%\') and lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) AS RETURNED_QUANTITY_BUILD_A_PACK FROM xyxx_db.maplemonk.fact_items_shopify_xyxx GROUP BY 1, 2, 3, 4, 5, 6, 7, 8 ), Sales_Data_Max_Weekly as ( WITH WeeklySales AS ( SELECT date_trunc(\'week\',order_timestamp::date) As WEEK_START, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, SUM(IFNULL(quantity, 0)) AS QUANTITY, sum(case when lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) QUANTITY_BUILD_A_PACK, count(distinct case when lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then ORDER_NAME end) ORDERS_BUILD_A_PACK, sum(case when lower(order_status) like \'%cancel%\' then IFNULL(quantity, 0) else 0 end) CANCELLED_QUANTITY, sum(case when lower(order_status) like \'%cancel%\' and lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) CANCELLED_QUANTITY_BUILD_A_PACK, sum(case when IS_REFUND<>0 and not(lower(order_status) like \'%cancel%\') then IFNULL(quantity, 0) else 0 end) AS RETURNED_QUANTITY, sum(case when IS_REFUND<>0 and not(lower(order_status) like \'%cancel%\') and lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) AS RETURNED_QUANTITY_BUILD_A_PACK FROM xyxx_db.maplemonk.fact_items_shopify_xyxx where datediff(day,order_timestamp::date,current_date()) <=56 GROUP BY 1, 2, 3, 4, 5, 6, 7, 8 ) SELECT week_Start, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, QUANTITY, QUANTITY_BUILD_A_PACK, ORDERS_BUILD_A_PACK, CANCELLED_QUANTITY, CANCELLED_QUANTITY_BUILD_A_PACK, RETURNED_QUANTITY, RETURNED_QUANTITY_BUILD_A_PACK FROM ( SELECT week_Start, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, QUANTITY, QUANTITY_BUILD_A_PACK, ORDERS_BUILD_A_PACK, CANCELLED_QUANTITY, CANCELLED_QUANTITY_BUILD_A_PACK, RETURNED_QUANTITY, RETURNED_QUANTITY_BUILD_A_PACK, row_number() OVER (PARTITION BY SKU ORDER BY QUANTITY DESC) AS ranking FROM WeeklySales ) ranked_weekly_sales WHERE ranking = 1 ) , Sales_Data_Min_Weekly as ( WITH WeeklySales AS ( SELECT date_trunc(\'week\',order_timestamp::date) As WEEK_START, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, SUM(IFNULL(quantity, 0)) AS QUANTITY, sum(case when lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) QUANTITY_BUILD_A_PACK, count(distinct case when lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then ORDER_NAME end) ORDERS_BUILD_A_PACK, sum(case when lower(order_status) like \'%cancel%\' then IFNULL(quantity, 0) else 0 end) CANCELLED_QUANTITY, sum(case when lower(order_status) like \'%cancel%\' and lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) CANCELLED_QUANTITY_BUILD_A_PACK, sum(case when IS_REFUND<>0 and not(lower(order_status) like \'%cancel%\') then IFNULL(quantity, 0) else 0 end) AS RETURNED_QUANTITY, sum(case when IS_REFUND<>0 and not(lower(order_status) like \'%cancel%\') and lower(tags) like any (\'%3@%\', \'%5@%\',\'%2@%\') then IFNULL(quantity, 0) else 0 end) AS RETURNED_QUANTITY_BUILD_A_PACK FROM xyxx_db.maplemonk.fact_items_shopify_xyxx where datediff(day,order_timestamp::date,current_date()) <=56 GROUP BY 1, 2, 3, 4, 5, 6, 7, 8 ) SELECT week_Start, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, QUANTITY, QUANTITY_BUILD_A_PACK, ORDERS_BUILD_A_PACK, CANCELLED_QUANTITY, CANCELLED_QUANTITY_BUILD_A_PACK, RETURNED_QUANTITY, RETURNED_QUANTITY_BUILD_A_PACK FROM ( SELECT week_Start, SKU, PRODUCT_CATEGORY, PRODUCT_SUPER_CATEGORY, PRODUCT_SUB_CATEGORY, COLLECTION, PRODUCT_NAME, PRODUCT_NAME_FINAL, QUANTITY, QUANTITY_BUILD_A_PACK, ORDERS_BUILD_A_PACK, CANCELLED_QUANTITY, CANCELLED_QUANTITY_BUILD_A_PACK, RETURNED_QUANTITY, RETURNED_QUANTITY_BUILD_A_PACK, row_number() OVER (PARTITION BY SKU ORDER BY QUANTITY) AS ranking FROM WeeklySales ) ranked_weekly_sales WHERE ranking = 1 ), Sales_56avg_w_Inv as ( select ID.DATA_FETCH_DATE ,ID.SKU ,ID.SIZE ,ID.RANGE ,ID.STYLE ,ID.PARENT ,ID.NEW_COLOR_NAME ,ID.OLD_COLOR_NAME ,ID.COLLECTION ,coalesce(SD56.PRODUCT_NAME, SD56.PRODUCT_NAME_FINAL) Product_Final_Name ,max(ifnull(ID.availableinventory,0)) Available_Inventory ,sum(ifnull(SD56.Quantity,0)) Sold_Quantity_56_Days ,sum(ifnull(SD56.QUANTITY_BUILD_A_PACK,0)) Sold_QUANTITY_BUILD_A_PACK_56_Days ,sum(ifnull(SD56.CANCELLED_QUANTITY,0)) CANCELLED_QUANTITY_56_Days ,sum(ifnull(SD56.CANCELLED_QUANTITY_BUILD_A_PACK,0)) CANCELLED_QUANTITY_BUILD_A_PACK_56_Days ,sum(ifnull(SD56.RETURNED_QUANTITY,0)) RETURNED_QUANTITY_56_Days ,sum(ifnull(SD56.RETURNED_QUANTITY_BUILD_A_PACK,0)) RETURNED_QUANTITY_BUILD_A_PACK_56_Days ,max(ifnull(SWMax.Quantity,0)) Max_Weekly_Sales ,max(ifnull(SWMin.Quantity,0)) Min_Weekly_Sales from Inventory_Data ID left join Sales_Data_Daily SD56 on ID.SKU = SD56.SKU and (datediff(day,try_to_date(SD56.ORDER_DATE),ifnull(ID.DATA_FETCH_DATE,current_date())) BETWEEN 1 AND 56) left join Sales_Data_Max_Weekly SWMax on ID.SKU = SWMax.SKU left join SALES_DATA_MIN_WEEKLY SWMin on ID.SKU = SWMin.SKU group by 1,2,3,4,5,6,7,8,9,10 ) , Sales_56_14_Avg_w_Inv as ( select SD56.DATA_FETCH_DATE ,SD56.SKU ,SD56.SIZE ,SD56.RANGE ,SD56.STYLE ,SD56.PARENT ,SD56.NEW_COLOR_NAME ,SD56.OLD_COLOR_NAME ,SD56.COLLECTION ,SD56.Product_Final_Name ,Available_Inventory ,Max_Weekly_Sales ,Min_Weekly_Sales ,Sold_Quantity_56_Days ,Sold_QUANTITY_BUILD_A_PACK_56_Days ,CANCELLED_QUANTITY_56_Days ,CANCELLED_QUANTITY_BUILD_A_PACK_56_Days ,RETURNED_QUANTITY_56_Days ,RETURNED_QUANTITY_BUILD_A_PACK_56_Days ,sum(ifnull(SD14.Quantity,0)) Sold_Quantity_14_Days from Sales_56avg_w_Inv SD56 left join Sales_Data_Daily SD14 on SD56.SKU = SD14.SKU and (datediff(day,try_to_date(SD14.ORDER_DATE),ifnull(SD56.DATA_FETCH_DATE,current_date())) BETWEEN 1 AND 14) group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19 ) , Sales_56_14_mtd_Avg_w_Inv as ( select SD56.DATA_FETCH_DATE ,SD56.SKU ,SD56.SIZE ,SD56.RANGE ,SD56.STYLE ,SD56.PARENT ,SD56.NEW_COLOR_NAME ,SD56.OLD_COLOR_NAME ,SD56.COLLECTION ,SD56.Product_Final_Name ,SD56.Available_Inventory ,SD56.Max_Weekly_Sales ,SD56.Min_Weekly_Sales ,SD56.Sold_Quantity_56_Days ,SD56.Sold_QUANTITY_BUILD_A_PACK_56_Days ,SD56.CANCELLED_QUANTITY_56_Days ,SD56.CANCELLED_QUANTITY_BUILD_A_PACK_56_Days ,SD56.RETURNED_QUANTITY_56_Days ,SD56.RETURNED_QUANTITY_BUILD_A_PACK_56_Days ,SD56.Sold_Quantity_14_Days ,sum(ifnull(SDmtd.Quantity,0)) sold_quantity_mtd from Sales_56_14_Avg_w_Inv SD56 left join Sales_Data_Daily SDmtd on SD56.SKU = SDmtd.SKU and date_trunc(\'month\',try_to_date(SDmtd.ORDER_DATE)-1) = date_trunc(\'month\',ifnull(SD56.DATA_FETCH_DATE,current_date())) and try_to_date(SDmtd.ORDER_DATE) < ifnull(SD56.DATA_FETCH_DATE,current_date()) group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20 ) select DATA_FETCH_DATE ,right(DATA_FETCH_DATE::Date,2)-1 mtd_Days ,SD56_14.SKU ,SD56_14.SIZE ,SD56_14.RANGE ,SD56_14.STYLE ,SD56_14.PARENT ,SD56_14.NEW_COLOR_NAME ,SD56_14.OLD_COLOR_NAME ,SD56_14.COLLECTION ,SD56_14.Product_Final_Name ,SD56_14.Available_Inventory ,SD56_14.Max_Weekly_Sales ,SD56_14.Min_Weekly_Sales ,SD56_14.Sold_Quantity_56_Days ,SD56_14.Sold_QUANTITY_BUILD_A_PACK_56_Days ,SD56_14.CANCELLED_QUANTITY_56_Days ,SD56_14.CANCELLED_QUANTITY_BUILD_A_PACK_56_Days ,SD56_14.RETURNED_QUANTITY_56_Days ,SD56_14.RETURNED_QUANTITY_BUILD_A_PACK_56_Days ,SD56_14.Sold_Quantity_14_Days ,SD56_14.sold_quantity_mtd ,sum(ifnull(SD7.Quantity,0)) Sold_Quantity_7_Days from Sales_56_14_mtd_Avg_w_Inv SD56_14 left join Sales_Data_Daily SD7 on SD56_14.SKU = SD7.SKU and (datediff(day,try_to_date(SD7.ORDER_DATE),ifnull(SD56_14.DATA_FETCH_DATE,current_date())) BETWEEN 1 AND 7) group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22 order by 15 desc ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from XYXX_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        