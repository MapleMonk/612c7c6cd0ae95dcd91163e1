{{ config(
            materialized='table',
                post_hook={
                    "sql": "create or replace table snitch_db.maplemonk.ga_funnel_new as ( with sessions as ( select to_date(date,\'YYYYMMDD\') as date, \'Web\' as channel, sum(case when landingpage like \'%collection%\' then sessions else 0 end) as plp_sessions, sum(case when landingpage like \'%product%\' then sessions else 0 end) as pdp_sessions, sum(case when landingpage = \'/\' then sessions else 0 end) as home_sessions from snitch_db.maplemonk.web_landing_pages_sessions_source group by 1,2 union select to_date(date,\'YYYYMMDD\') as date, concat(\'App \',operatingsystem) as channel, sum(case when unifiedpagepathscreen = \'Product List\' then sessions else 0 end) as plp_sessions, sum(case when unifiedpagepathscreen = \'Products\' then sessions else 0 end) as pdp_sessions, sum(case when unifiedpagepathscreen = \'Home\' then sessions else 0 end) as home_sessions from snitch_db.maplemonk.app_landing_page_session_source group by 1,2 union select to_date(date,\'YYYYMMDD\') as date, \'App_2_0_IOS\' as channel, sum(case when unifiedpagepathscreen = \'Home\' then sessions else 0 end) as home_sessions, sum(case when unifiedpagepathscreen = \'PLP\' then sessions else 0 end) as plp_sessions, sum(case when unifiedpagepathscreen = \'products\' then sessions else 0 end) as pdp_sessions from snitch_db.maplemonk.APP2_0_LANDING_PAGE_SESSION_SOURCE group by 1,2 ), events as ( select to_date(date,\'YYYYMMDD\') as date, \'Web\' as channel, SUM(CASE WHEN eventname = \'session_start\' THEN eventcount ELSE 0 END) AS session, SUM(CASE WHEN eventname = \'view_item\' THEN eventcount ELSE 0 END) AS click, sum(case when eventname = \'add_to_cart\' then eventcount else 0 end) as add_to_cart, sum(case when eventname in (\'begin_checkout\',\'magic_checkout_requested\') then eventcount else 0 end) as checkout, sum(case when eventname = \'purchase\' then eventcount else 0 end) as purchase_ga from snitch_db.maplemonk.web_funnel group by 1,2 union select to_date(date,\'YYYYMMDD\') as date, concat(\'App \',operatingsystem) as channel, SUM(CASE WHEN eventname = \'session_start\' THEN eventcount ELSE 0 END) AS session, SUM(CASE WHEN eventname = \'view_item\' THEN eventcount ELSE 0 END) AS click, sum(case when eventname = \'add_to_cart\' then eventcount else 0 end) as add_to_cart, sum(case when eventname = \'begin_checkout\' then eventcount else 0 end) as checkout, sum(case when eventname = \'purchase\' then eventcount else 0 end) as purchase_ga from snitch_db.maplemonk.app_funnel_events_new group by 1,2 union SELECT TO_DATE(DATE, \'YYYYMMDD\') AS date, \'App_2_0_IOS\' as channel, SUM(CASE WHEN eventname = \'session_start\' THEN eventcount ELSE 0 END) AS session, SUM(CASE WHEN eventname = \'view_item\' THEN eventcount ELSE 0 END) AS click, SUM(CASE WHEN eventname = \'add_to_cart\' THEN eventcount ELSE 0 END) AS add_to_cart, SUM(CASE WHEN eventname = \'begin_checkout\' THEN eventcount ELSE 0 END) AS checkout, SUM(CASE WHEN eventname = \'purchase\' THEN eventcount ELSE 0 END) AS purchase_ga, FROM snitch_db.maplemonk.IOS_IOS_EVENTS_DATA GROUP BY 1,2 ), sales_data as ( select order_timestamp::date as Date, CASE WHEN lower(webshopney) = \'appbrew\' THEN \'App Android\' when lower(webshopney) = \'snitch_ios\' then \'App_2_0_IOS\' ELSE \'Web\' end as channel, count(distinct order_name) as purchase_db from snitch_db.maplemonk.fact_items_snitch where lower(ifnull(discount_code,\'n\')) not like \'%eco%\' and lower(ifnull(discount_code,\'n\')) not like \'%influ%\' and order_name not in (\'2431093\',\'2422140\',\'2425364\',\'2430652\',\'2422237\',\'2420623\',\'2429832\',\'2422378\',\'2428311\',\'2429064\',\'2428204\',\'2421343\',\'2431206\',\'2430491\',\'2426682\',\'2426487\',\'2426458\',\'2423575\',\'2422431\',\'2423612\',\'2426625\',\'2428117\',\'2426894\',\'2425461\',\'2426570\',\'2423455\',\'2430777\',\'2426009\',\'2428245\',\'2427269\',\'2430946\',\'2425821\',\'2429986\',\'2429085\',\'2422047\',\'2430789\',\'2420219\',\'2428341\',\'2430444\',\'2426866\',\'2431230\',\'2425839\',\'2430980\',\'2427048\',\'2430597\',\'2420499\',\'2431050\',\'2420271\',\'2426684\',\'2428747\',\'2423523\',\'2431171\',\'2430830\',\'2425325\',\'2428414\',\'2429054\',\'2423596\') and tags not in (\'FLITS_LOGICERP\') group by 1,2 ) select a.*,b.add_to_cart,b.checkout,b.purchase_ga,b.session,b.click,coalesce(c.purchase_db,0) as purchase_db from sessions a left join events b on a.date=b.date and a.channel=b.channel left join sales_data c on a.date=c.date and a.channel=c.channel ); create or replace table snitch_db.maplemonk.sessions_landingpage as ( select TO_DATE(DATE, \'YYYYMMDD\') AS date, \'Web\' as channel, case when lower(sessionsource) like \'%facebook%\' or lower(sessionsource) like \'%fb%\' then \'Facebook\' when lower(sessionsource) like \'%google%\' then \'Google\' when sessionsource in (\'(direct)\',\'(not set)\',\'(other)\') then \'Direct\' else \'Others\' end as Source, case when landingpage like \'%collection%\' then \'PDP\' when landingpage like \'%product%\' then \'PLP\' when landingpage = \'/\' then \'Home\' else \'Others\' end as landing_page, sum(sessions) as sessions from snitch_db.maplemonk.web_landing_pages_sessions_source group by 1,2,3,4 union select TO_DATE(DATE, \'YYYYMMDD\') AS date, \'App\' as channel, case when lower(sessionsource) like \'%facebook%\' or lower(sessionsource) like \'%fb%\' then \'Facebook\' when lower(sessionsource) like \'%google%\' then \'Google\' when sessionsource in (\'(direct)\',\'(not set)\',\'(other)\') then \'Direct\' else \'Others\' end as Source, case when unifiedpagepathscreen = \'Product List\' then \'PDP\' when unifiedpagepathscreen = \'Products\' then \'PLP\' when unifiedpagepathscreen = \'Home\' then \'Home\' else \'Others\' end as landing_page, sum(sessions) as sessions from snitch_db.maplemonk.app_landing_page_session_source group by 1,2,3,4 union select TO_DATE(DATE, \'YYYYMMDD\') AS date, \'App_2_0_IOS\' as channel, case when lower(sessionsource) like \'%facebook%\' or lower(sessionsource) like \'%fb%\' then \'Facebook\' when lower(sessionsource) like \'%google%\' then \'Google\' when sessionsource in (\'(direct)\',\'(not set)\') then \'Direct\' else \'Others\' end as Source, case when unifiedpagepathscreen = \'Product List\' then \'PDP\' when unifiedpagepathscreen = \'Products\' then \'PLP\' when unifiedpagepathscreen = \'Home\' then \'Home\' else \'Others\' end as landing_page, sum(sessions) as sessions select * from snitch_db.maplemonk.APP2_0_LANDING_PAGE_SESSION_SOURCE group by 1,2,3,4 );",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            