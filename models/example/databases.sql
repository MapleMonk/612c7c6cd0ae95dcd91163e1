{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table rpsg_db.maplemonk.custom_retention_summary_drv as with Till_date as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct s.customer_id_final) Customers_till_date ,count(distinct order_id) as Orders_TD ,sum(selling_price) - sum(cancel_sales) - sum(return_sales) as net_sales_td from dates d left join sales_consolidated_drv s on d.month > s.acquisition_date::date group by 1) ,L1M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L1M_Customers ,count(distinct order_id) as Orders_L1M from dates d left join sales_consolidated_drv x on d.month > x.acquisition_date::date and dateadd(month,-1,d.month) <= x.acquisition_date::date group by 1 ) ,L2M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L2M_Customers ,count(distinct order_id) as Orders_L2M from dates d left join sales_consolidated_drv x on dateadd(month,-1,d.month) > x.acquisition_date::date and dateadd(month,-2,d.month) <= x.acquisition_date::date group by 1 ) ,L3M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L3M_Customers ,count(distinct order_id) as Orders_L3M from dates d left join sales_consolidated_drv x on dateadd(month,-2,d.month) > x.acquisition_date::date and dateadd(month,-3,d.month) <= x.acquisition_date::date group by 1 ) ,L4M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L4M_Customers ,count(distinct order_id) as Orders_L4M from dates d left join sales_consolidated_drv x on dateadd(month,-3,d.month) > x.acquisition_date::date and dateadd(month,-4,d.month) <= x.acquisition_date::date group by 1 ) ,L5M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L5M_Customers ,count(distinct order_id) as Orders_L5M from dates d left join sales_consolidated_drv x on dateadd(month,-4,d.month) > x.acquisition_date::date and dateadd(month,-5,d.month) <= x.acquisition_date::date group by 1 ) ,L6M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L6M_Customers ,count(distinct order_id) as Orders_L6M from dates d left join sales_consolidated_drv x on dateadd(month,-5,d.month) > x.acquisition_date::date and dateadd(month,-6,d.month) <= x.acquisition_date::date group by 1) ,L7M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L7M_Customers ,count(distinct order_id) as Orders_L7M from dates d left join sales_consolidated_drv x on dateadd(month,-6,d.month) > x.acquisition_date::date and dateadd(month,-7,d.month) <= x.acquisition_date::date group by 1) ,L8M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct x.customer_id_final) as L8M_Customers ,count(distinct order_id) as Orders_L8M from dates d left join sales_consolidated_drv x on dateadd(month,-7,d.month) > x.acquisition_date::date and dateadd(month,-8,d.month) <= x.acquisition_date::date group by 1) ,L9M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct y.customer_id_final) as L9M_Customers ,count(distinct order_id) as Orders_L9M from dates d left join sales_consolidated_drv y on dateadd(month,-8,d.month) > y.acquisition_date::date and dateadd(month,-9,month) <= y.acquisition_date::date group by 1) ,L10M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct y.customer_id_final) as L10M_Customers ,count(distinct order_id) as Orders_L10M from dates d left join sales_consolidated_drv y on dateadd(month,-9,d.month) > y.acquisition_date::date and dateadd(month,-10,d.month) <= y.acquisition_date::date group by 1) ,L11M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct y.customer_id_final) as L11M_Customers ,count(distinct order_id) as Orders_L11M from dates d left join sales_consolidated_drv y on dateadd(month,-10,d.month) > y.acquisition_date::date and dateadd(month,-11,d.month) <= y.acquisition_date::date group by 1) ,L12M as ( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv )select d.* ,count(distinct y.customer_id_final) as L12M_Customers ,count(distinct order_id) as Orders_L12M from dates d left join sales_consolidated_drv y on dateadd(month,-11,d.month) > y.acquisition_date::date and dateadd(month,-12,d.month) <= y.acquisition_date::date group by 1) ,Ret_td as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then ORDER_ID end) Retained_TD_customer_ORDERS from dates d left join sales_consolidated_drv s on d.month <= s.order_date::date group by 1 ) ,Ret_L1 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L1 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-1,d.month) <= s.acquisition_date::date and d.month > s.acquisition_date::date group by 1 ) ,Ret_L2 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L2 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-2,d.month) <= date_trunc(month,s.acquisition_date::date) and dateadd(month,-1,d.month) > s.acquisition_date::date group by 1 ) ,Ret_L3 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L3 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-3,d.month) <= s.acquisition_date::date and dateadd(month,-2,d.month) > s.acquisition_date::date group by 1 ) ,Ret_L4 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L4 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-4,d.month) <= s.acquisition_date::date and dateadd(month,-3,d.month) > s.acquisition_date::date group by 1 ),Ret_L5 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L5 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-5,d.month) <= s.acquisition_date::date and dateadd(month,-4,d.month) > s.acquisition_date::date group by 1 ) ,Ret_L6 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customer_orders_L6 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-6,d.month) <= s.acquisition_date::date and dateadd(month,-5,d.month) > s.acquisition_date::date group by 1 ) ,Ret_L7 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L7 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-7,d.month) <= s.acquisition_date::date and dateadd(month,-6,d.month) > s.acquisition_date::date group by 1 ),Ret_L8 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L8 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-8,d.month) <= s.acquisition_date::date and dateadd(month,-7,d.month) > s.acquisition_date::date group by 1 ),Ret_L9 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L9 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-9,d.month) <= s.acquisition_date::date and dateadd(month,-8,d.month) > s.acquisition_date::date group by 1 ),Ret_L10 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L10 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-10,d.month) <= s.acquisition_date::date and dateadd(month,-9,d.month) > s.acquisition_date::date group by 1 ),Ret_L11 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L11 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-11,d.month) <= s.acquisition_date::date and dateadd(month,-10,d.month) > s.acquisition_date::date group by 1 ),Ret_L12 as( with dates as ( select distinct date_trunc(month, order_date::date ) as Month from sales_consolidated_drv ) select distinct month,count(distinct case when new_customer_flag = \'Repeat\' then customer_id_final end) Retained_customers ,count(distinct case when new_customer_flag = \'Repeat\' then order_id end) Retained_customers_orders_L12 from dates d left join sales_consolidated_drv s on d.month = date_trunc(month,s.order_date::date) and dateadd(month,-12,d.month) <= s.acquisition_date::date and dateadd(month,-11,d.month) > s.acquisition_date::date group by 1 ) select Till_date.* ,L1m.L1M_customers L1M_customers ,L2m.L2M_customers L2M_customers ,L3m.L3M_customers L3M_customers ,L4m.L4M_customers L4M_customers ,L5m.L5M_customers L5M_customers ,L6M.L6M_customers as L6M_customers ,L7m.L7M_customers L7M_customers ,L8m.L8M_customers L8M_customers ,L9m.L9M_customers L9M_customers ,L10m.L10M_customers L10M_customers ,L11m.L11M_customers L11M_customers ,L12m.L12M_customers L12M_customers ,Ret_td.Retained_customers as Retained_customers_till_date ,Ret_td.Retained_TD_customer_ORDERS as Retained_customer_orders_till_date ,Ret_L1.Retained_customers as L1_Retained_customers ,Ret_L2.Retained_customers as L2_Retained_customers ,Ret_L3.Retained_customers as L3_Retained_customers ,Ret_L4.Retained_customers as L4_Retained_customers ,Ret_L5.Retained_customers as L5_Retained_customers ,Ret_L6.Retained_customers as L6_Retained_customers ,Ret_L7.Retained_customers as L7_Retained_customers ,Ret_L8.Retained_customers as L8_Retained_customers ,Ret_L9.Retained_customers as L9_Retained_customers ,Ret_L10.Retained_customers as L10_Retained_customers ,Ret_L11.Retained_customers as L11_Retained_customers ,Ret_L12.Retained_customers as L12_Retained_customers from till_date left join L1M on till_date.month = L1m.month left join L2M on till_date.month = L2m.month left join L3M on till_date.month = L3m.month left join L4M on till_date.month = L4m.month left join L5M on till_date.month = L5m.month left join L6M on till_date.month = L6m.month left join L7M on till_date.month = L7m.month left join L8M on till_date.month = L8m.month left join L9M on till_date.month = L9m.month left join L10M on till_date.month = L10m.month left join L11M on till_date.month = L11m.month left join L12M on till_date.month = L12m.month left join Ret_td on till_date.month = Ret_td.month left join Ret_L1 on till_date.month = Ret_L1.month left join Ret_L2 on till_date.month = Ret_L2.month left join Ret_L3 on till_date.month = Ret_L3.month left join Ret_L4 on till_date.month = Ret_L4.month left join Ret_L5 on till_date.month = Ret_L5.month left join Ret_L6 on till_date.month = Ret_L6.month left join Ret_L7 on till_date.month = Ret_L7.month left join Ret_L8 on till_date.month = Ret_L8.month left join Ret_L9 on till_date.month = Ret_L9.month left join Ret_L10 on till_date.month = Ret_L10.month left join Ret_L11 on till_date.month = Ret_L11.month left join Ret_L12 on till_date.month = Ret_L12.month;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from RPSG_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        