{{ config(
            materialized='table',
                post_hook={
                    "sql": "create or replace table hox_db.maplemonk.hox_db_blanko_summary_stock_reorder as with sku_masters as ( select * from (select distinct replace(marketplace_sku,\'\`\',\'\') marketplace_sku ,replace(master_sku,\'\`\',\'\') master_sku ,row_number() over (partition by replace(marketplace_sku,\'\`\',\'\') order by 1) rw from HOX_DB.MAPLEMONK.sku_master ) where rw=1 ), cog_price as ( select distinct sku, (cost:: float) as cost, WEIGHT from hox_db.maplemonk.easyecom_easyecom_blanko_hox_product_master where lower(PRODUCT_TYPE) in (\'normal_product\', \'child_product\') and (cost:: float) > 10 union select distinct MODEL_NO, (cost:: float) as cost, WEIGHT from hox_db.maplemonk.easyecom_easyecom_blanko_hox_product_master where lower(PRODUCT_TYPE) in (\'normal_product\', \'child_product\') and (cost:: float) > 10 ), sales_quantity as ( select case when lower(source) = \'amazon\' then \'Amazon FBA\' else \'Easyecom\' end as source, reference_code, date(order_date) as order_date, coalesce(a.master_sku, o.sku_code)as sku_code, case when lower(source) = \'amazon\' then \'Amazon warehouse\' else WAREHOUSE end as WAREHOUSE, sum(quantity) as total_quantity from HOX_DB.MapleMonk.HOX_DB_SALES_CONSOLIDATED o left join sku_masters a on lower(o.sku_code) = lower(a.marketplace_sku) where lower(order_status) not like \'%cancel%\' and sku_code not in (\'\',\'BLKCAP_FR_02\', \'BLKFREECAP_01\', \'BL_FREE_TSHIRT_01\',\'BLKCAP_FR_01\', \'450\') group by 1,2,3,4,5 ), fba_stock as ( select coalesce(c.new_sku , a.sku) as component_sku_name, \'Amazon warehouse\' as Warehouse, Sum(ifnull(c.item_count,1) * a.fba_inventory) as QUANTITY from ( select coalesce(a.master_sku, o.SKU) as SKU, fba_inventory from ( select o.sku, (SUM(\"afn-reserved-quantity\") + sum(\"afn-fulfillable-quantity\")) AS fba_inventory from ( Select * , ROW_NUMBER() OVER(PARTITION BY SKU order by _AIRBYTE_EMITTED_AT desc) as rn from HOX_DB.MapleMonk.GET_FBA_MYI_ALL_INVENTORY_DATA where lower(\"afn-listing-exists\") = \'yes\' )as o where rn = 1 group by 1 )o left join ( select distinct marketplace_sku,master_sku from sku_masters )a on lower(o.SKU) = lower(a.marketplace_sku) )as a left join hox_db.maplemonk.hox_db_Sku_child_mapping c on lower(a.SKU) = lower(c.sku_code) group by 1, 2 order by 3 ), base_final as ( select new_sku, case when new_sku in (\'BLKBE100\',\'BLKEE100\',\'BLKINOD100\',\'BLKLD100\',\'BLKODMY100\',\'BLKSS100\',\'DAWN\', \'DUSK\') then \'100 ml\' when new_sku in (\'BLKBE20\',\'BLKEE20\',\'BLKINOD20\',\'BLKLD20\',\'BLKODMY20\',\'BLKSS20\',\'BLKDN20\', \'BLKDK20\') then \'20 ml\' when new_sku in (\'BLKBE8\',\'BLKEE8\',\'BLKINOD8\',\'BLKLD8\',\'BLKODMY8\',\'BLKSS8\',\'BLKDN8\', \'BLKDK8\') then \'8 ml\' when new_sku in (\'BLKPRMNCN-P4_20\', \'BLKRLCN-P4_20\') then \'Pack of 4 - 20 ml\' when new_sku in (\'BLKCN-8_8\') then \'Pack of 8 - 8 ml\' when new_sku in (\'BLKCAP_FR_01\', \'BLKFREECAP_01\') then \'CAP\' when new_sku in (\'BL_FREE_TSHIRT_01\') then \'Tshirt\' end as sku_type, round(Sum(case when source = \'Easyecom\' and (order_date between (current_date - 7) and (current_date - 1)) then final_quantity end)/7, 2) as EE_DRR_7day, round(Sum(case when source = \'Easyecom\' and (order_date between (current_date - 30) and (current_date - 1)) then final_quantity end)/30, 2) as EE_DRR_30day, round(Sum(case when source = \'Easyecom\' and (order_date between (current_date - 60) and (current_date - 1)) then final_quantity end)/60, 2) as EE_DRR_60day, round(Sum(case when source =\'Easyecom\' and warehouse =\'BLANKO BLR\' and (order_date between (current_date - 7) and (current_date - 1)) then final_quantity end)/7, 2) as EE_DRR_7day_BLR, round(Sum(case when source =\'Easyecom\' and warehouse =\'BLANKO BLR\' and (order_date between (current_date - 30) and (current_date - 1)) then final_quantity end)/30, 2) as EE_DRR_30day_BLR, round(Sum(case when source =\'Easyecom\' and warehouse =\'BLANKO BLR\' and (order_date between (current_date - 60) and (current_date - 1)) then final_quantity end)/60, 2) as EE_DRR_60day_BLR, round(Sum(case when source =\'Easyecom\' and warehouse =\'BLANKO GGN\' and (order_date between (current_date - 7) and (current_date - 1)) then final_quantity end)/7, 2) as EE_DRR_7day_GGN, round(Sum(case when source =\'Easyecom\' and warehouse =\'BLANKO GGN\' and (order_date between (current_date - 30) and (current_date - 1)) then final_quantity end)/30, 2) as EE_DRR_30day_GGN, round(Sum(case when source =\'Easyecom\' and warehouse =\'BLANKO GGN\' and (order_date between (current_date - 60) and (current_date - 1)) then final_quantity end)/60, 2) as EE_DRR_60day_GGN, round(Sum(case when source = \'Amazon FBA\' and (order_date between (current_date - 7) and (current_date - 1)) then final_quantity end)/7,2) as FBA_DRR_7day, round(Sum(case when source = \'Amazon FBA\' and (order_date between (current_date - 30) and (current_date - 1)) then final_quantity end)/30,2) as FBA_DRR_30day, round(Sum(case when source = \'Amazon FBA\' and (order_date between (current_date - 60) and (current_date - 1)) then final_quantity end)/60,2) as FBA_DRR_60day from ( select distinct a.* , b.new_sku, round(b.item_count:: int,0) as item_count, (total_quantity * round(b.item_count:: int,0))as final_quantity from sales_quantity a left join hox_db.maplemonk.hox_db_Sku_child_mapping b on lower(a.sku_code) = lower(b.sku_code) )as o Group by 1,2 ), base_aggregate as ( select distinct o.* , a.QUANTITY as total_quantity_FBA from ( select sku, sum(case when new_location = \'BLANKO BLR\' then AVAILABLE_INVENTORY end)as total_quantity_Emiza_BLR, sum(case when new_location = \'BLANKO GGN\' then AVAILABLE_INVENTORY end)as total_quantity_Emiza_GGN, ( sum(case when new_location = \'BLANKO BLR\' then AVAILABLE_INVENTORY end) + sum(case when new_location = \'BLANKO GGN\' then AVAILABLE_INVENTORY end) ) as total_quantity_Emiza from ( select ROW_NUMBER() over (partition by sku, new_location order by data_fetch_date:: timestamp desc) rw, * from ( select case when trim(UPPER(location)) in (\'BLANKO GGN\', \'MOJOJOJO CREATORS PVT LTD GGN\') then \'BLANKO GGN\' when trim(upper(location)) in (\'BLANKO BLR\', \'MOJOJOJO CREATORS PVT LTD BLR\') then \'BLANKO BLR\' else location end as new_location, * from hox_db.maplemonk.hox_db_blanko_summary_inventory_sku_sales )o )as o where o.rw = 1 group by 1 order by 4 desc )o left join fba_stock a on lower(o.sku) = lower(a.component_sku_name) ) select o.*, a.cost as COGS, a.cost * TOTAL_QUANTITY_EMIZA as Emiza_cogs, a.cost * TOTAL_QUANTITY_FBA as FBA_cogs, case when \"Days of Inventory Emiza 30day\" <= 60 then \'YES\' else \'NO\' end as \"Re-order required Emiza\", case when \"Days of Inventory Emiza 30day\" <= 60 then round(EE_DRR_30day * 75,0) else null end as \"Re-order units\", case when \"Days of Inventory FBA 30day\" <= 60 then \'YES\' else \'NO\' end as \"Re-order required FBA\", case when \"Days of Inventory FBA 30day\" <= 60 then round(FBA_DRR_30day * 75,0) else null end as \"Re-order units FBA\", case when \"Days of Inventory BLR Emiza 30day\" <= 60 then \'YES\' else \'NO\' end as \"Re-order required Emiza BLR\", case when \"Days of Inventory BLR Emiza 30day\" <= 60 then round(EE_DRR_30day_BLR * 75,0) else null end as \"Re-order units Emiza BLR\", case when \"Days of Inventory GGN Emiza 30day\" <= 60 then \'YES\' else \'NO\' end as \"Re-order required Emiza GGN\", case when \"Days of Inventory GGN Emiza 30day\" <= 60 then round(EE_DRR_30day_GGN * 75,0) else null end as \"Re-order units Emiza GGN\" from ( Select o.*, round(coalesce((total_quantity_Emiza *1.00 / nullif(EE_DRR_30day,0)),0),2) as \"Days of Inventory Emiza 30day\", round(coalesce((total_quantity_Emiza *1.00 / nullif(EE_DRR_60day,0)),0),2) as \"Days of Inventory Emiza 60day\", round(coalesce((total_quantity_FBA *1.00 / nullif(FBA_DRR_30day,0)),0),2) as \"Days of Inventory FBA 30day\", round(coalesce((total_quantity_FBA *1.00 / nullif(FBA_DRR_60day,0)),0),2) as \"Days of Inventory FBA 60day\", round(coalesce((total_quantity_Emiza_BLR *1.00 / nullif(EE_DRR_30day_BLR,0)),0),2) as \"Days of Inventory BLR Emiza 30day\", round(coalesce((total_quantity_Emiza_BLR *1.00 / nullif(EE_DRR_60day_BLR,0)),0),2) as \"Days of Inventory BLR Emiza 60day\", round(coalesce((total_quantity_Emiza_GGN *1.00 / nullif(EE_DRR_30day_GGN,0)),0),2) as \"Days of Inventory GGN Emiza 30day\", round(coalesce((total_quantity_Emiza_GGN *1.00 / nullif(EE_DRR_60day_GGN,0)),0),2) as \"Days of Inventory GGN Emiza 60day\" from ( select a.* , b.total_quantity_Emiza, b.total_quantity_FBA, b.total_quantity_Emiza_BLR, b.total_quantity_Emiza_GGN from base_final a LEFT JOIN base_aggregate b ON lower(a.new_sku) = lower(b.sku) )as o )as o left join cog_price a on o.new_sku = a.sku where new_sku <> \'BLKCAP_FR_01\' order by 1",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from HOX_DB.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            