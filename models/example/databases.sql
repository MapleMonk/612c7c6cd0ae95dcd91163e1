{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE snitch_db.maplemonk.Product_info as ( WITH master AS ( select *, case when category in (\'Shirt\', \'Shirts\') then \'Shirts\' when category = \'Denim\' then \'Jeans\' else category end as new_category from snitch_db.maplemonk.availability_master_v2 ), product_type as ( SELECT id, producttype FROM ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, producttype, ROW_NUMBER() OVER ( PARTITION BY SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) ORDER BY REPLACE(A.value:updated_at, \'\"\', \'\') DESC ) AS rw FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A ) WHERE rw = 1 ), occassion AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS occassion FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'occassion_new\' ), print_design AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS print_design FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'print_design\' ), collar AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS collar FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'collar\' ), material AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS material FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'material\' ), sleeves_type AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS sleeves_type FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'sleeves_type\' ), fit AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS fit FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'fit\' ), color AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(REPLACE(REPLACE(A.value:values, \'[\', \'\'), \']\', \'\'), \'\"\', \'\') AS color FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => options) A WHERE REPLACE(A.value:position, \'\"\', \'\') = 1 ), style AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS style FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'style\' ), closure AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS closure FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'closure\' ), length AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS length FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'length\' ), sales as ( SELECT DATE as date_wise, new_category, sku_group, total_sales, total_quant FROM snitch_db.maplemonk.category_visibility ), productid as (select sku_group,id,price,status from (select distinct a.id, REVERSE(SUBSTRING(REVERSE(b.sku),CHARINDEX(\'-\', REVERSE(b.sku)) + 1)) AS SKU_GROUP ,to_timestamp(replace(b.updated_at,\'\"\',\'\')) as UPDATED_AT , row_number ()over (partition by SKU_group order by b.updated_at desc) as rw , b.price as price,status from snitch_db.MAPLEMONK.SHOPIFY_ALL_PRODUCTS a left join snitch_db.maplemonk.shopifyindia_product_variants b on a.id = b.product_id ) where rw=1) SELECT master.*, date_wise, total_sales, total_quant, product_type.producttype as product_type, occassion.occassion AS occassion, print_design.print_design AS print_design, collar.collar AS collar, material.material AS material, sleeves_type.sleeves_type AS sleeve_type, fit.fit AS fit, style.style as style, color.color AS color, closure.closure as closure, length.length as length, productid.id as product_id, case when lower(print_design) like \'%checks%\' then \'Checks\' when lower(print_design) like \'%animal%\' then \'Animal Print\' when lower(print_design) like \'%embroid%\' then \'Embroided\' when lower(print_design) like \'%floral%\' then \'Floral\' when lower(print_design) like \'%graphic%\' then \'Graphic Print\' when lower(print_design) like \'%embellished%\' then \'Embellished\' when lower(print_design) like \'%plain%\' then \'Solid\' when lower(print_design) like \'%solid%\' then \'Solid\' when lower(print_design) like \'%printed%\' then \'Printed\' when lower(print_design) like \'%self%\' then \'Self Design\' when lower(print_design) like \'%stripe%\' then \'Stripes\' when lower(print_design) like \'%crochet%\' then \'Crochet\' when lower(print_design) like \'%polka%\' then \'Polka Dots\' when lower(print_design) like \'%geometric%\' then \'Geometric\' when lower(print_design) like \'%stripe%\' then \'Stripes\' when lower(print_design) like \'%tie &%\' then \'Tie & Dye\' when lower(print_design) like \'%textured%\' then \'Textured\' when lower(print_design) IS NULL then \'Null\' Else \'Others\' END as Designs, case when lower(collar) like \'%cuban%\' then \'Cuban\' when lower(collar) like \'%crew%\' then \'Round\' when lower(collar) like \'%round%\' then \'Round\' when lower(collar) like \'%polo%\' then \'Polo\' when lower(collar) like \'%high neck%\' then \'High Neck\' when lower(collar) like \'%spread%\' then \'Spread\' when lower(collar) like \'%button down%\' then \'Button Down\' when lower(collar) like \'%mandarin%\' then \'Mandarin\' when lower(collar) like \'%baseball%\' then \'Baseball\' when lower(collar) like \'%classic%\' then \'Classic\' when lower(collar) like \'%shawl%\' then \'Shawl\' when lower(collar) like \'%hooded%\' then \'Hooded\' when lower(collar) like \'%mock%\' then \'Round\' when lower(collar) like \'%turtleneck%\' then \'Turtle Neck\' when lower(collar) like \'%camp%\' then \'Cuban\' when lower(collar) IS NULL then \'Null\' Else \'Others\' END as Collar_New, case when lower(material) like \'%cotton%\' then \'Cotton\' when lower(material) like \'%poly%\' then \'Polyester\' when lower(material) like \'%rayon%\' then \'Rayon\' when lower(material) like \'%linen%\' then \'Linen\' when lower(material) like \'%terry%\' then \'Terry\' when lower(material) like \'%Cotton Poly%\' then \'Cotton\' when lower(material) like \'%modal%\' then \'Modal\' when lower(material) like \'%tencel%\' then \'Tencel\' when lower(material) like \'%nylon%\' then \'Nylon\' when lower(material) like \'%tencil%\' then \'Tencil\' when lower(material) like \'%steel%\' then \'Stainless Steel\' when lower(material) IS NULL then \'Null\' Else \'Others\' END as Material_New, case when lower(occassion) like \'%casual%\' then \'Casual Wear\' when lower(occassion) like \'%formal%\' then \'Formal Wear\' when lower(occassion) like \'%club%\' then \'Club Wear\' when lower(occassion) like \'%festive%\' then \'Festive Wear\' when lower(occassion) like \'%elevated%\' then \'Elevated\' when lower(occassion) like \'%intimate%\' then \'Intimate\' when lower(occassion) like \'%sleep%\' then \'Sleep and Lounge Wear\' when lower(occassion) like \'%athletic%\' then \'Athletic\' when lower(occassion) like \'%college%\' then \'College Wear\' when lower(occassion) like \'%street%\' then \'Street Wear\' when lower(occassion) IS NULL then \'Null\' Else \'Others\' END as occassion_New, CASE WHEN occassion ILIKE \'%Casual Wear%\' THEN 1 ELSE 0 END AS \"Casual_Wear_Count\", CASE WHEN occassion ILIKE \'%Formal Wear%\' THEN 1 ELSE 0 END AS \"Formal_Wear_Count\", CASE WHEN occassion ILIKE \'%Club Wear%\' THEN 1 ELSE 0 END AS \"Club_Wear_Count\", CASE WHEN occassion ILIKE \'%Festive Wear%\' THEN 1 ELSE 0 END AS \"Festive_Wear_Count\", CASE WHEN occassion ILIKE \'%Elevated%\' THEN 1 ELSE 0 END AS \"Elevated_Count\", CASE WHEN occassion ILIKE \'%Intimate%\' THEN 1 ELSE 0 END AS \"Intimate_Count\", CASE WHEN occassion ILIKE \'%Sleep and Lounge wear%\' THEN 1 ELSE 0 END AS \"Sleep_and_Lounge_wear_Count\", CASE WHEN occassion ILIKE \'%Swim and Beach Wear%\' THEN 1 ELSE 0 END AS \"Swim_and_Beach_Wear_Count\", CASE WHEN occassion ILIKE \'%Athletic%\' THEN 1 ELSE 0 END AS \"Athletic_Count\", CASE WHEN occassion ILIKE \'%College Wear%\' THEN 1 ELSE 0 END AS \"College_Wear_Count\", CASE WHEN occassion ILIKE \'%Street Wear%\' THEN 1 ELSE 0 END AS \"Street_Wear_Count\", CASE WHEN occassion ILIKE \'%Casual Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Casual_Wear_Inventory\", CASE WHEN occassion ILIKE \'%Formal Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Formal_Wear_Inventory\", CASE WHEN occassion ILIKE \'%Club Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Club_Wear_Inventory\", CASE WHEN occassion ILIKE \'%Festive Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Festive_Wear_Inventory\", CASE WHEN occassion ILIKE \'%Elevated%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Elevated_Inventory\", CASE WHEN occassion ILIKE \'%Intimate%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Intimate_Inventory\", CASE WHEN occassion ILIKE \'%Sleep and Lounge wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Sleep_and_Lounge_wear_Inventory\", CASE WHEN occassion ILIKE \'%Swim and Beach Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Swim_and_Beach_Wear_Inventory\", CASE WHEN occassion ILIKE \'%Athletic%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Athletic_Inventory\", CASE WHEN occassion ILIKE \'%College Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"College_Wear_Inventory\", CASE WHEN occassion ILIKE \'%Street Wear%\' THEN AVAILABLE_UNITS ELSE 0 END AS \"Street_Wear_Inventory\", case when lower(category) = \'Joggers & Trackpants\' then \'Bottomwear\' when lower(category) = \'Shirts\' then \'Topwear\' when lower(category) = \'Accessories\' then \'Accessories\' when lower(category) = \'Denim\' then \'Bottomwear\' when lower(category) = \'Sunglasses\' then \'Accessories\' when lower(category) = \'Shirt\' then \'Topwear\' when lower(category) = \'Kurta\' then \'Topwear\' when lower(category) = \'Overshirt\' then \'Topwear\' when lower(category) = \'Hoodies\' then \'Topwear\' when lower(category) = \'Cargo Pants\' then \'Bottomwear\' when lower(category) = \'Boxers\' then \'Bottomwear\' when lower(category) = \'Sweaters\' then \'Topwear\' when lower(category) = \'T-Shirts\' then \'Topwear\' when lower(category) = \'Co-ords\' then \'Topwear\' when lower(category) = \'Sweatshirts\' then \'Topwear\' when lower(category) = \'Shoes\' then \'Accessories\' when lower(category) = \'Night Suit & Pyjamas\' then \'Bottomwear\' when lower(category) = \'Trousers\' then \'Bottomwear\' when lower(category) = \'Jackets\' then \'Topwear\' when lower(category) = \'Blazers\' then \'Topwear\' when lower(category) = \'Chinos\' then \'Bottomwear\' when lower(category) = \'Shorts\' then \'Bottomwear\' when lower(category) = \'Perfumes\' then \'Accessories\' when lower(category) = \'Inner Wear\' then \'Bottomwear\' when lower(category) IS NULL then \'Null\' ELSE \'OTHERS\' END as top_bottom_acc, case when product_type is not null then 1 when product_type is null then 0 end as product_type_score, case when lower(top_bottom_acc) = \'topwear\' and sleeves_type is not null then 1 when lower(top_bottom_acc) = \'topwear\' and sleeves_type is null then 0 end as sleeves_type_score, case when lower(top_bottom_acc) in (\'topwear\',\'bottomwear\') and style is not null then 1 when lower(top_bottom_acc) in (\'topwear\',\'bottomwear\') and style is null then 0 end as style_score, case when print_design is not null then 1 when print_design is null then 0 end as design_score, case when occassion is not null then 1 when occassion is null then 0 end as occassion_score, case when lower(top_bottom_acc) in (\'topwear\',\'bottomwear\') and fit is not null then 1 when lower(top_bottom_acc) in (\'topwear\',\'bottomwear\') and fit is null then 0 end as fit_score, case when lower(top_bottom_acc) = \'topwear\' and collar is not null then 1 when lower(top_bottom_acc) = \'topwear\' and collar is null then 0 end as collar_score, case when material is not null then 1 when material is null then 0 end as material_score, case when color is not null then 1 when color is null then 0 end as color_score, case when lower(top_bottom_acc) = \'Bottomwear\' and closure is not null then 1 when lower(top_bottom_acc) = \'Bottomwear\' and closure is null then 0 end as closure_score, case when lower(top_bottom_acc) = \'Bottomwear\' and length is not null then 1 when lower(top_bottom_acc) = \'Bottomwear\' and length is null then 0 end as length_score FROM master LEFT JOIN product_type ON master.id = product_type.id LEFT JOIN occassion ON master.id = occassion.id LEFT JOIN print_design ON master.id = print_design.id LEFT JOIN collar ON master.id = collar.id LEFT JOIN material ON master.id = material.id LEFT JOIN sleeves_type ON master.id = sleeves_type.id LEFT JOIN fit ON master.id = fit.id LEFT JOIN style on master.id = style.id LEFT JOIN color ON master.id = color.id LEFT JOIN closure ON master.id = closure.id LEFT JOIN length ON master.id = length.id LEFT JOIN sales on master.sku_group = sales.sku_group LEFT JOIN productid on master.sku_group = productid.sku_group ); create or replace table snitch_db.maplemonk.metafields_fill_rate_visiblity as ( WITH master AS ( select sku_group,id,price,product_name,sellable_inventory, case when category in (\'Shirt\', \'Shirts\') then \'Shirts\' when category = \'Denim\' then \'Jeans\' else category end as category from snitch_db.maplemonk.availability_master_v2 ), live_date as ( select a.id, a.status, a.published_at as live_date, b.price, b.sku_group, from snitch_db.maplemonk.shopifyindia_new_products a left join snitch_db.maplemonk.availability_master_v2 b on a.id = b.id ), product_type as ( SELECT id, producttype FROM ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, producttype, ROW_NUMBER() OVER ( PARTITION BY SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) ORDER BY REPLACE(A.value:updated_at, \'\"\', \'\') DESC ) AS rw FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A ) WHERE rw = 1 ), occassion AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS occassion FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'occassion_new\' ), print_design AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS print_design FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'print_design\' ), collar AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS collar FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'collar\' ), material AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS material FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'material\' ), sleeves_type AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS sleeves_type FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'sleeves_type\' ), fit AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS fit FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'fit\' ), color AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(REPLACE(REPLACE(A.value:values, \'[\', \'\'), \']\', \'\'), \'\"\', \'\') AS color FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => options) A WHERE REPLACE(A.value:position, \'\"\', \'\') = 1 ), style AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS style FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'style\' ), closure AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS closure FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'closure\' ), length AS ( SELECT SUBSTRING(id, POSITION(\'Product/\' IN id) + LENGTH(\'Product/\')) AS id, REPLACE(A.value:key, \'\"\', \'\') AS key_type, REPLACE(A.value:value, \'\"\', \'\') AS length FROM snitch_db.maplemonk.metafields_products_graph_ql, LATERAL FLATTEN (input => metafields) A WHERE key_type = \'length\' ), productid as ( select sku_group,id,price,status from (select distinct a.id, REVERSE(SUBSTRING(REVERSE(b.sku),CHARINDEX(\'-\', REVERSE(b.sku)) + 1)) AS SKU_GROUP ,to_timestamp(replace(b.updated_at,\'\"\',\'\')) as UPDATED_AT , row_number ()over (partition by SKU_group order by b.updated_at desc) as rw , b.price as price,status from snitch_db.MAPLEMONK.SHOPIFY_ALL_PRODUCTS a left join snitch_db.maplemonk.shopifyindia_product_variants b on a.id = b.product_id ) where rw=1 ), maindata as ( SELECT master.*, product_type.producttype as product_type, occassion.occassion AS occassion, print_design.print_design AS print_design, collar.collar AS collar, material.material AS material, sleeves_type.sleeves_type AS sleeve_type, fit.fit AS fit, style.style as style, color.color AS color, closure.closure as closure, length.length as length, productid.id as product_id, case when lower(print_design) like \'%checks%\' then \'Checks\' when lower(print_design) like \'%animal%\' then \'Animal Print\' when lower(print_design) like \'%embroid%\' then \'Embroided\' when lower(print_design) like \'%floral%\' then \'Floral\' when lower(print_design) like \'%graphic%\' then \'Graphic Print\' when lower(print_design) like \'%embellished%\' then \'Embellished\' when lower(print_design) like \'%plain%\' then \'Solid\' when lower(print_design) like \'%solid%\' then \'Solid\' when lower(print_design) like \'%printed%\' then \'Printed\' when lower(print_design) like \'%self%\' then \'Self Design\' when lower(print_design) like \'%stripe%\' then \'Stripes\' when lower(print_design) like \'%crochet%\' then \'Crochet\' when lower(print_design) like \'%polka%\' then \'Polka Dots\' when lower(print_design) like \'%geometric%\' then \'Geometric\' when lower(print_design) like \'%stripe%\' then \'Stripes\' when lower(print_design) like \'%tie &%\' then \'Tie & Dye\' when lower(print_design) like \'%textured%\' then \'Textured\' Else \'Others\' END as Designs, case when lower(collar) like \'%cuban%\' then \'Cuban\' when lower(collar) like \'%crew%\' then \'Round\' when lower(collar) like \'%round%\' then \'Round\' when lower(collar) like \'%polo%\' then \'Polo\' when lower(collar) like \'%high neck%\' then \'High Neck\' when lower(collar) like \'%spread%\' then \'Spread\' when lower(collar) like \'%button down%\' then \'Button Down\' when lower(collar) like \'%mandarin%\' then \'Mandarin\' when lower(collar) like \'%baseball%\' then \'Baseball\' when lower(collar) like \'%classic%\' then \'Classic\' when lower(collar) like \'%shawl%\' then \'Shawl\' when lower(collar) like \'%hooded%\' then \'Hooded\' when lower(collar) like \'%mock%\' then \'Round\' when lower(collar) like \'%turtleneck%\' then \'Turtle Neck\' when lower(collar) like \'%camp%\' then \'Cuban\' Else \'Others\' END as Collar_New, case when lower(material) like \'%cotton%\' then \'Cotton\' when lower(material) like \'%poly%\' then \'Polyester\' when lower(material) like \'%rayon%\' then \'Rayon\' when lower(material) like \'%linen%\' then \'Linen\' when lower(material) like \'%terry%\' then \'Terry\' when lower(material) like \'%Cotton Poly%\' then \'Cotton\' when lower(material) like \'%modal%\' then \'Modal\' when lower(material) like \'%tencel%\' then \'Tencel\' when lower(material) like \'%nylon%\' then \'Nylon\' when lower(material) like \'%tencil%\' then \'Tencil\' when lower(material) like \'%steel%\' then \'Stainless Steel\' Else \'Others\' END as Material_New, case when lower(occassion) like \'%casual%\' then \'Casual Wear\' when lower(occassion) like \'%formal%\' then \'Formal Wear\' when lower(occassion) like \'%club%\' then \'Club Wear\' when lower(occassion) like \'%festive%\' then \'Festive Wear\' when lower(occassion) like \'%elevated%\' then \'Elevated\' when lower(occassion) like \'%intimate%\' then \'Intimate\' when lower(occassion) like \'%sleep%\' then \'Sleep and Lounge Wear\' when lower(occassion) like \'%athletic%\' then \'Athletic\' when lower(occassion) like \'%college%\' then \'College Wear\' when lower(occassion) like \'%street%\' then \'Street Wear\' Else \'Others\' END as occassion_New, case when product_type is null then 0 else 1 end as product_type_fill_rate, case when occassion is null then 0 else 1 end as occassion_fill_rate, case when PRINT_DESIGN is null then 0 else 1 end as PRINT_DESIGN_fill_rate, case when COLLAR is null then 0 else 1 end as COLLAR_fill_rate, case when MATERIAL is null then 0 else 1 end as MATERIAL_fill_rate, case when SLEEVE_TYPE is null then 0 else 1 end as SLEEVE_TYPE_fill_rate, case when FIT is null then 0 else 1 end as FIT_fill_rate, case when style is null then 0 else 1 end as style_fill_rate, case when color is null then 0 else 1 end as color_fill_rate, case when closure is null then 0 else 1 end as closure_fill_rate, case when length is null then 0 else 1 end as length_fill_rate, case when designs is null then 0 else 1 end as designs_fill_rate, case when collar_new is null then 0 else 1 end as collar_new_fill_rate, case when material_new is null then 0 else 1 end as material_new_fill_rate, case when occassion_new is null then 0 else 1 end as occassion_new_fill_rate, FROM master LEFT JOIN product_type ON master.id = product_type.id LEFT JOIN occassion ON master.id = occassion.id LEFT JOIN print_design ON master.id = print_design.id LEFT JOIN collar ON master.id = collar.id LEFT JOIN material ON master.id = material.id LEFT JOIN sleeves_type ON master.id = sleeves_type.id LEFT JOIN fit ON master.id = fit.id LEFT JOIN style on master.id = style.id LEFT JOIN color ON master.id = color.id LEFT JOIN closure ON master.id = closure.id LEFT JOIN length ON master.id = length.id LEFT JOIN productid on master.sku_group = productid.sku_group left join live_date on master.sku_group = live_date.sku_group ), main_data2 as ( select sku_group, product_type, sum(sellable_inventory) as inventory, case when product_type in (\'Joggers & Trackpants\',\'Denim\',\'Cargo Pants\',\'Boxers\',\'Night Suit & Pyjamas\',\'Trousers\',\'Chinos\',\'Shorts\',\'Inner Wear\',\'Jeans\') then sum(color_fill_rate+MATERIAL_fill_rate+color_fill_rate+FIT_fill_rate+occassion_fill_rate+style_fill_rate+SLEEVE_TYPE_fill_rate+product_type_fill_rate+PRINT_DESIGN_fill_rate)/9 when product_type in (\'Shirts\',\'Shirt\',\'Kurta\',\'Overshirt\',\'Hoodies\',\'Sweaters\',\'T-Shirts\',\'Co-ords\',\'Sweatshirts\',\'Jackets\',\'Blazers\') then sum(color_fill_rate+MATERIAL_fill_rate+FIT_fill_rate+occassion_fill_rate+style_fill_rate+product_type_fill_rate+closure_fill_rate+length_fill_rate+PRINT_DESIGN_fill_rate)/9 when product_type in (\'Accessories\',\'Sunglasses\',\'Shoes\',\'Perfumes\') then sum(color_fill_rate+MATERIAL_fill_rate+occassion_fill_rate+style_fill_rate+occassion_fill_rate+product_type_fill_rate)/6 end as fill_rate, case when product_type in (\'Joggers & Trackpants\',\'Denim\',\'Cargo Pants\',\'Boxers\',\'Night Suit & Pyjamas\',\'Trousers\',\'Chinos\',\'Shorts\',\'Inner Wear\',\'Jeans\') then sum(color_fill_rate+MATERIAL_fill_rate+color_fill_rate+FIT_fill_rate+occassion_fill_rate+style_fill_rate+SLEEVE_TYPE_fill_rate+product_type_fill_rate+PRINT_DESIGN_fill_rate) when product_type in (\'Shirts\',\'Shirt\',\'Kurta\',\'Overshirt\',\'Hoodies\',\'Sweaters\',\'T-Shirts\',\'Co-ords\',\'Sweatshirts\',\'Jackets\',\'Blazers\') then sum(color_fill_rate+MATERIAL_fill_rate+FIT_fill_rate+occassion_fill_rate+style_fill_rate+product_type_fill_rate+closure_fill_rate+length_fill_rate+PRINT_DESIGN_fill_rate) when product_type in (\'Accessories\',\'Sunglasses\',\'Shoes\',\'Perfumes\') then sum(color_fill_rate+MATERIAL_fill_rate+occassion_fill_rate+style_fill_rate+occassion_fill_rate+product_type_fill_rate) end as filled_metafields, from maindata group by 1,2 ) select a.* from main_data2 a left join live_date b on a.sku_group = b.sku_group where lower(b.status) = \'active\' )",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            