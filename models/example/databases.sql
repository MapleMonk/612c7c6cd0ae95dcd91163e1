{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table snitch_db.maplemonk.inward_lead_time as ( SELECT CASE WHEN STARTSWITH(SKU_NUMBER, \'R\') THEN \'New\' ELSE \'Repeat\' END AS type, CASE WHEN STARTSWITH(SKU_NUMBER, \'R\') THEN upper(RIGHT(SKU_NUMBER, LENGTH(SKU_NUMBER) - 1)) ELSE upper(SKU_NUMBER) END AS sku_group, TO_DATE(date_issued, \'DD-MM-YYYY\') AS date_issued, cut_qty as qty, case when factory_ in (\'MQ - M Square\',\'FOB - MSQUARE\') then \'MSquare\' when factory_ = \'05 - Sai Textiles\' then \'Sai_Textiles\' when factory_ = \'08 - Vignesh\' then \'Vignesh\' when factory_ = \'KU - Kunal\' then \'Kunal\' when factory_ = \'01 - SSTC\' then \'SSTC\' when factory_ = \'IN - Mohit\' then \'Mohit\' when factory_ = \'14 - Lohith Creations\' then \'Lohith_Creations\' when factory_ = \'07 - K P\' then \'K_P\' when factory_ = \'15 - Prestige\' then \'Prestige\' when factory_ = \'Navkar\' then \'Navkar\' when factory_ = \'21-BLUE MONKEY\' then \'Blue_Money\' when factory_ = \'03 - Leandro\' then \'Leandro\' when factory_ = \'G.G GARMENT\' then \'G.G_Garment\' when factory_ = \'16 - Thandeshwara\' then \'Thandeshwara\' when factory_ IN (\'Wearever\',\'Wearever-WE\') then \'Wearever\' when factory_ = \'VN - Vanitha Garments\'then \'Vanitha_Garments\' when factory_ = \'06 - Alagesh\' then \'Alagesh\' when factory_ = \'VK - Vista Global\' then \'Vista_Global\' when factory_ = \'AC - Asian Clothing\' then \'Asian_Clothing\' when factory_ = \'27-ANUVARTHH\' then \'Anuvarthh\' when factory_ = \'LS - Lamsolee Clothing\' then \'Lamsolee_Clothing\' when factory_ = \'19 - S R Apparels\' then \'SR_Apparels\' when factory_ = \'09 - Nalanda\' then \'Nalanda\' when factory_ = \'Groovy Fashion\' then \'Groovy_Fashion\' when factory_ IN (\'BBI\',\'25-BBI\') then \'BBI\' when factory_ = \'17 - Vijay Ram\' then \'Vijay_Ram\' when factory_ = \'Kharva\' then \'Kharva\' when factory_ = \'POOJA Fashion\' then \'Pooja_Fashion\' when factory_ = \'ASM\' then \'ASM\' when factory_ = \'18 - Expert\' then \'Expert\' when factory_ = \'17 - VR CREATION\' then \'VR_Creation\' when factory_ = \'Ettro\' then \'Ettro\' else \'Others\' end as factory, (current_date - TO_DATE(date_issued, \'DD-MM-YYYY\')) as current_lead_time FROM snitch_db.maplemonk.gs_pt_main ); create or replace table snitch_db.maplemonk.lead_time_factory as ( SELECT CASE WHEN STARTSWITH(SKU_NUMBER, \'R\') THEN \'New\' ELSE \'Repeat\' END AS type, CASE WHEN STARTSWITH(SKU_NUMBER, \'R\') THEN UPPER(RIGHT(SKU_NUMBER, LENGTH(SKU_NUMBER) - 1)) ELSE UPPER(SKU_NUMBER) END AS sku_group, TRY_TO_DATE(date_issued, \'DD-MM-YYYY\') AS date_issued, TRY_TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\') AS Expected_Delivery_Date, round(TRY_TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\')-TRY_TO_DATE(date_issued, \'DD-MM-YYYY\'),0) as lead_time, case when p_factory_ in (\'MQ - M Square\',\'FOB - MSQUARE\') then \'MSquare\' when p_factory_ = \'05 - Sai Textiles\' then \'Sai_Textiles\' when p_factory_ = \'08 - Vignesh\' then \'Vignesh\' when p_factory_ = \'KU - Kunal\' then \'Kunal\' when p_factory_ = \'01 - SSTC\' then \'SSTC\' when p_factory_ = \'IN - Mohit\' then \'Mohit\' when p_factory_ = \'14 - Lohith Creations\' then \'Lohith_Creations\' when p_factory_ = \'07 - K P\' then \'K_P\' when p_factory_ = \'15 - Prestige\' then \'Prestige\' when p_factory_ = \'Navkar\' then \'Navkar\' when p_factory_ = \'21-BLUE MONKEY\' then \'Blue_Money\' when p_factory_ = \'03 - Leandro\' then \'Leandro\' when p_factory_ = \'G.G GARMENT\' then \'G.G_Garment\' when p_factory_ = \'16 - Thandeshwara\' then \'Thandeshwara\' when p_factory_ IN (\'Wearever\',\'Wearever-WE\') then \'Wearever\' when p_factory_ = \'VN - Vanitha Garments\'then \'Vanitha_Garments\' when p_factory_ = \'06 - Alagesh\' then \'Alagesh\' when p_factory_ = \'VK - Vista Global\' then \'Vista_Global\' when p_factory_ = \'AC - Asian Clothing\' then \'Asian_Clothing\' when p_factory_ = \'27-ANUVARTHH\' then \'Anuvarthh\' when p_factory_ = \'LS - Lamsolee Clothing\' then \'Lamsolee_Clothing\' when p_factory_ = \'19 - S R Apparels\' then \'SR_Apparels\' when p_factory_ = \'09 - Nalanda\' then \'Nalanda\' when p_factory_ = \'Groovy Fashion\' then \'Groovy_Fashion\' when p_factory_ IN (\'BBI\',\'25-BBI\') then \'BBI\' when p_factory_ = \'17 - Vijay Ram\' then \'Vijay_Ram\' when p_factory_ = \'Kharva\' then \'Kharva\' when p_factory_ = \'POOJA Fashion\' then \'Pooja_Fashion\' when p_factory_ = \'ASM\' then \'ASM\' when p_factory_ = \'18 - Expert\' then \'Expert\' when p_factory_ = \'17 - VR CREATION\' then \'VR_Creation\' when p_factory_ = \'Ettro\' then \'Ettro\' else \'Others\' end as factory, ps_cut_qty as qty FROM snitch_db.maplemonk.snitch_prodcut_tracking_shipped WHERE date_issued IS NOT NULL AND date_issued != \'NOT MENTIONED\' AND Expected_Delivery_Date IS NOT NULL AND Expected_Delivery_Date != \'NOT MENTIONED\' AND TRY_TO_DATE(date_issued, \'DD-MM-YYYY\') IS NOT NULL AND TRY_TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\') IS NOT NULL ); create or replace table snitch_db.maplemonk.sku_order_check as ( WITH eoq AS ( SELECT sku_group, ROUND(avg(op), 0) AS order_point, ROUND(avg(eoq), 0) AS eoq, round(avg(total_units_on_hand),0) as inventory, round(avg(sales_first_30_days/30),0) as ros_30_days FROM snitch_db.maplemonk.eoq_table_v3 WHERE op-total_units_on_hand > 0 group by 1 ), in_production AS ( SELECT sku_group, MAX(date_issued) AS last_ordered FROM snitch_db.maplemonk.inward_lead_time GROUP BY sku_group ), shipped AS ( SELECT sku_group, MAX(date_issued) AS last_ordered, MAX(Expected_Delivery_Date) AS last_delivered_date FROM snitch_db.maplemonk.lead_time_factory GROUP BY sku_group ), active as ( select a.ID, b.sku_group from snitch_db.maplemonk.SHOPIFYINDIA_PRODUCTS a left join snitch_db.maplemonk.availability_master_v2 b on a.ID = b.product_id where a.status = \'active\' ) SELECT a.*, COALESCE(GREATEST(b.last_ordered, c.last_ordered), NULL) AS LAST_ORDER_DATE, current_date - COALESCE(GREATEST(b.last_ordered, c.last_ordered), NULL) as days_since_last_purchased FROM eoq a LEFT JOIN in_production b ON a.sku_group = b.sku_group LEFT JOIN shipped c ON a.sku_group = c.sku_group inner join active d on a.sku_group = d.sku_group );",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        