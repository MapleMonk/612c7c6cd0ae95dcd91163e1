{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_fact_items AS with Amazon_Order_Items as ( select AMAZONORDERID::varchar AMAZONORDERID ,ORDERITEMID::varchar ORDERITEMID ,ASIN ,SELLERSKU ,TITLE ,sum(ifnull(ITEMPRICE:\"Amount\"::float,0)) SELLING_PRICE ,sum(ifnull(ITEMTAX:\"Amount\"::float,0)) ITEM_TAX ,sum(ifnull(PROMOTIONDISCOUNT:\"Amount\"::float,0)) PROMOTION_DISCOUNT ,sum(ifnull(PROMOTIONDISCOUNTTAX:\"Amount\"::float,0)) PROMOTION_DISCOUNT_TAX ,sum(ifnull(SHIPPINGPRICE:\"Amount\"::float,0)) SHIPPING_PRICE ,sum(ifnull(SHIPPINGTAX:\"Amount\"::float,0)) SHIPPING_TAX ,sum(ifnull(SHIPPINGDISCOUNT:\"Amount\"::float,0)) SHIPPING_DISCOUNT ,sum(ifnull(SHIPPINGDISCOUNTTAX:\"Amount\"::float,0)) SHIPPING_DISCOUNT_TAX ,sum(ifnull(QUANTITYORDERED,0)) QUANTITYORDERED ,sum(ifnull(QUANTITYSHIPPED,0)) QUANTITYSHIPPED from sleepycat_db.maplemonk.ASP_SLEEPYCAT_ORDERITEMS group by 1,2,3,4,5 ) SELECT \'AMAZON_SLP\' AS shop_name, coalesce(X.\"amazon-order-id\"::varchar,B.AMAZONORDERID) AS order_id, NULL AS order_name, NULL AS customer_id, NULL AS phone, NULL AS tags, B.ORDERITEMID AS line_item_id, coalesce(X.sku, B.SELLERSKU) SKU, coalesce(X.ASIN, B.ASIN) AS product_id, currency, case when \"order-status\" in (\'Shipped - Returned to Seller\', \'Shipped - Returning to Seller\',\'Shipped - Rejected by Buyer\',\'Shipped - Damaged\') then 1 else 0 end AS is_refund, upper(\"ship-city\") AS city, upper(\"ship-state\") AS state, coalesce(B.TITLE, X.\"product-name\") AS product_name, NULL AS category, \"order-status\" AS order_status, \"Purchase-datetime-PDT\" AS order_timestamp, coalesce(B.SELLING_PRICE,div0(ifnull(TRY_CAST(X.\"item-price\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS line_item_sales, coalesce(B.SHIPPING_PRICE,div0(ifnull(TRY_CAST(X.\"shipping-price\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS shipping_price, coalesce(B.QUANTITYORDERED,div0(ifnull(TRY_CAST(X.QUANTITY AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS quantity, coalesce(B.ITEM_TAX,div0(ifnull(TRY_CAST(X.\"item-tax\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS tax, div0(tax,line_item_sales+tax) as tax_rate, coalesce(B.PROMOTION_DISCOUNT,div0(ifnull(TRY_CAST(X.\"item-promotion-discount\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS discount, div0(discount,(1-tax_rate)) AS discount_before_tax, NULL AS gross_sales_after_tax, line_item_sales - discount_before_tax AS gross_sales_before_tax, NULL AS net_sales_before_tax, line_item_sales - discount AS total_sales, \"fulfillment-channel\" fulfillment_channel, \'Amazon\' AS source, NULL AS landing_utm_medium, NULL AS landing_utm_source, NULL AS landing_utm_campaign, NULL AS referring_utm_medium, NULL AS referring_utm_source, NULL AS landing_utm_channel, NULL AS referring_utm_channel, NULL AS final_utm_channel, NULL AS new_customer_flag, NULL AS acquisition_channel, NULL AS acquisition_product, coalesce(B.SHIPPING_TAX,div0(ifnull(TRY_CAST(X.\"shipping-tax\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS shipping_tax, coalesce(B.SHIPPING_DISCOUNT,div0(ifnull(TRY_CAST(X.\"ship-promotion-discount\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1))) AS ship_promotion_discount, div0(ifnull(TRY_CAST(X.\"gift-wrap-price\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1)) AS gift_wrap_price, div0(ifnull(TRY_CAST(X.\"gift-wrap-tax\" AS FLOAT),0),count(1) over (partition by X.\"amazon-order-id\" order by 1)) AS gift_wrap_tax FROM (SELECT *, CONVERT_TIMEZONE(\'UTC\',\'Asia/Kolkata\', \"purchase-date\":: DATETIME) as \"Purchase-datetime-PDT\" FROM SLEEPYCAT_DB.MAPLEMONK.Custom_Amazon_Seller_Partner_SC_AMAZON_SLP_GET_FLAT_FILE_ALL_ORDERS_DATA_BY_LAST_UPDATE_GENERAL) X LEFT JOIN Amazon_Order_Items B ON X.\"amazon-order-id\"::varchar = B.AMAZONORDERID::varchar ; create or replace table SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_orders_fact_items AS select * FROM SLEEPYCAT_DB.MAPLEMONK.Custom_Amazon_Seller_Partner_SC_AMAZON_SLP_GET_FLAT_FILE_ALL_ORDERS_DATA_BY_ORDER_DATE_GENERAL ; CREATE OR REPLACE TABLE SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_fact_items_TEMP_Category as select fi.* ,upper(coalesce(p.name,fi.product_name)) as product_name_final ,coalesce(Upper(p.CATEGORY),upper(fi.category)) AS product_category ,Upper(p.sub_category) as product_sub_category ,AmazonOrdersBuyer.Buyer_email ,AmazonOrdersBuyer.Buyer_name ,AmazonOrdersBuyer.Recipient_Name ,p.skucode common_sku_code from SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_fact_items fi left join (select * from (select MARKETPLACE_SKU ,NAME ,CATEGORY ,SUB_CATEGORY ,SKUCODE ,row_number() over (partition by lower(marketplace_sku) order by 1) rw from sleepycat_db.maplemonk.final_sku_master ) where rw = 1 ) p on lower(fi.sku) = lower(p.marketplace_sku) left join (select \"order-id\" order_id ,CONVERT_TIMEZONE(\'UTC\',\'Asia/Kolkata\', \"purchase-date\":: DATETIME) as Purchase_date ,CONVERT_TIMEZONE(\'UTC\',\'Asia/Kolkata\', \"payments-date\":: DATETIME) as Payments_date ,\"buyer-email\" Buyer_email ,\"buyer-name\" Buyer_name ,\"recipient-name\" Recipient_Name from SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_orders_fact_items) AmazonOrdersBuyer on fi.order_id=AmazonOrdersBuyer.order_id ; CREATE OR REPLACE TABLE SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_fact_items AS SELECT * FROM SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_amazon_fact_items_TEMP_Category;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from SLEEPYCAT_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        