{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE maplemonk.zouk_CUSTOMER_RETENTION AS SELECT EXTRACT(YEAR FROM Acquisition_Date) AS Acquisition_Year, FORMAT_TIMESTAMP(\'%B\', Acquisition_Date) AS Acquisition_Month, LAST_DAY(Acquisition_Date) AS Acquisition_Month_LastDate, Acquisition_Channel, Acquisition_Marketplace, Acquisition_Product, Shop_Name AS Purchase_Marketplace, COUNT(DISTINCT customer_id_final) AS total_customers, COUNT(DISTINCT CASE WHEN LOWER(Acquisition_Marketplace) LIKE \'%shopify%\' THEN customer_id_final END) AS Shopify_Acquired_Customers, COUNT(DISTINCT CASE WHEN LOWER(Acquisition_Marketplace) LIKE \'%cred%\' THEN customer_id_final END) AS CRED_Acquired_Customers, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) = LAST_DAY(order_date) THEN order_id END) AS total_orders, SUM(CASE WHEN LAST_DAY(Acquisition_Date) = LAST_DAY(order_date) THEN selling_price END) AS total_sales, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN customer_id_final END) AS mn_c, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS mn_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN order_id END) AS mn_o, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS mn_o_Shopify, SUM(CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN selling_price END) AS mn_s, SUM(CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS mn_s_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN customer_id_final END) AS product_mn_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_mn_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN order_id END) AS product_mn_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_mn_o_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN selling_price END) AS product_mn_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_mn_s_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m2_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m3_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m4_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m5_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m6_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m7_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m8_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m9_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m10_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m11_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m12_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m2_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m3_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m4_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m5_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m6_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m7_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m8_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m9_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m10_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m11_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m12_o, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m2_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m3_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m4_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m5_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m6_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m7_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m8_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m9_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m10_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m11_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m12_s, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m2_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m3_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m4_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m5_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m6_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m7_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m8_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m9_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m10_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m11_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m12_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m2_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m3_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m4_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m5_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m6_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m7_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m8_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m9_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m10_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m11_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m12_o, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m2_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m3_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m4_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m5_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m6_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m7_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m8_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m9_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m10_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m11_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m12_s, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m2_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m3_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m4_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m5_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m6_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m7_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m8_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m9_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m10_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m11_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m12_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m2_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m3_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m4_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m5_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m6_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m7_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m8_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m9_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m10_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m11_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m12_o_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m2_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m3_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m4_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m5_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m6_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m7_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m8_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m9_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m10_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m11_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m12_s_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m2_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m3_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m4_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m5_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m6_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m7_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m8_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m9_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m10_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m11_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m12_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m2_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m3_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m4_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m5_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m6_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m7_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m8_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m9_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m10_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m11_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m12_o_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m2_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m3_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m4_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m5_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m6_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m7_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m8_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m9_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m10_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m11_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m12_s_Shopify FROM ( SELECT customer_id_final, order_id, acquisition_product, acquisition_channel, acquisition_marketplace, shop_name, product_name, order_date, selling_price, CAST(first_complete_order_date AS DATE) AS Acquisition_Date FROM maplemonk.zouk_SALES_CONSOLIDATED WHERE customer_id_final IS NOT NULL AND LOWER(order_status) <> \'cancelled\' ) res GROUP BY EXTRACT(YEAR FROM Acquisition_Date), FORMAT_TIMESTAMP(\'%B\', Acquisition_Date), LAST_DAY(Acquisition_Date), Acquisition_Channel, Acquisition_Marketplace, Acquisition_Product, Shop_Name union all SELECT EXTRACT(YEAR FROM Acquisition_Date) AS Acquisition_Year, FORMAT_TIMESTAMP(\'%B\', Acquisition_Date) AS Acquisition_Month, LAST_DAY(Acquisition_Date) AS Acquisition_Month_LastDate, Acquisition_Channel, Acquisition_Marketplace, Acquisition_Product, \'All\' AS Purchase_Marketplace, COUNT(DISTINCT customer_id_final) AS total_customers, COUNT(DISTINCT CASE WHEN LOWER(Acquisition_Marketplace) LIKE \'%shopify%\' THEN customer_id_final END) AS Shopify_Acquired_Customers, COUNT(DISTINCT CASE WHEN LOWER(Acquisition_Marketplace) LIKE \'%cred%\' THEN customer_id_final END) AS CRED_Acquired_Customers, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) = LAST_DAY(order_date) THEN order_id END) AS total_orders, SUM(CASE WHEN LAST_DAY(Acquisition_Date) = LAST_DAY(order_date) THEN selling_price END) AS total_sales, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN customer_id_final END) AS mn_c, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS mn_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN order_id END) AS mn_o, COUNT(DISTINCT CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS mn_o_Shopify, SUM(CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN selling_price END) AS mn_s, SUM(CASE WHEN LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS mn_s_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN customer_id_final END) AS product_mn_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_mn_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN order_id END) AS product_mn_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_mn_o_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) THEN selling_price END) AS product_mn_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(Acquisition_Date) <> LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_mn_s_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m2_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m3_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m4_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m5_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m6_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m7_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m8_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m9_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m10_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m11_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS m12_c, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m2_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m3_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m4_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m5_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m6_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m7_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m8_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m9_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m10_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m11_o, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS m12_o, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m2_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m3_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m4_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m5_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m6_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m7_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m8_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m9_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m10_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m11_s, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS m12_s, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m2_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m3_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m4_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m5_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m6_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m7_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m8_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m9_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m10_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m11_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN customer_id_final END) AS product_m12_c, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m2_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m3_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m4_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m5_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m6_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m7_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m8_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m9_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m10_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m11_o, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN order_id END) AS product_m12_o, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m2_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m3_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m4_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m5_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m6_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m7_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m8_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m9_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m10_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m11_s, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) THEN selling_price END) AS product_m12_s, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m2_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m3_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m4_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m5_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m6_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m7_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m8_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m9_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m10_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m11_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS m12_c_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m2_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m3_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m4_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m5_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m6_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m7_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m8_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m9_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m10_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m11_o_Shopify, COUNT(DISTINCT CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS m12_o_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m2_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m3_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m4_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m5_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m6_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m7_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m8_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m9_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m10_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m11_s_Shopify, SUM(CASE WHEN LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS m12_s_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m2_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m3_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m4_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m5_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m6_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m7_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m8_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m9_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m10_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m11_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN customer_id_final END) AS product_m12_c_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m2_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m3_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m4_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m5_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m6_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m7_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m8_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m9_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m10_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m11_o_Shopify, COUNT(DISTINCT CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN order_id END) AS product_m12_o_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 1 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m2_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 2 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m3_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 3 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m4_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 4 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m5_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 5 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m6_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 6 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m7_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 7 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m8_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 8 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m9_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 9 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m10_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 10 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m11_s_Shopify, SUM(CASE WHEN acquisition_product = product_name AND LAST_DAY(DATE_ADD(Acquisition_Date, INTERVAL 11 MONTH)) = LAST_DAY(order_date) AND LOWER(shop_name) LIKE \'%shopify%\' THEN selling_price END) AS product_m12_s_Shopify FROM ( SELECT customer_id_final, order_id, acquisition_product, acquisition_channel, acquisition_marketplace, shop_name, product_name, order_date, selling_price, CAST(first_complete_order_date AS DATE) AS Acquisition_Date FROM maplemonk.zouk_SALES_CONSOLIDATED WHERE customer_id_final IS NOT NULL AND LOWER(order_status) <> \'cancelled\' ) res GROUP BY EXTRACT(YEAR FROM Acquisition_Date), FORMAT_TIMESTAMP(\'%B\', Acquisition_Date), LAST_DAY(Acquisition_Date), Acquisition_Channel, Acquisition_Marketplace, Acquisition_Product ; CREATE OR REPLACE TABLE maplemonk.zouk_monthly_retention AS WITH CUST AS ( SELECT DATE_TRUNC(DATE(order_date), MONTH) AS DATE_START ,EXTRACT(MONTH FROM (DATE_TRUNC(DATE(order_date), MONTH))) AS MONTH ,EXTRACT(YEAR FROM (DATE_TRUNC(DATE(order_date), MONTH))) AS YEAR ,customer_id_final ,MAX(CASE WHEN LOWER(new_customer_flag_month) = \'new\' THEN 1 ELSE 0 END) AS NEW_FLAG ,MAX(CASE WHEN LOWER(new_customer_flag_month) = \'repeat\' THEN 1 ELSE 0 END) AS REPEAT_FLAG FROM maplemonk.zouk_sales_consolidated WHERE (LOWER(shop_name) LIKE \'%shopify%\' OR LOWER(shop_name) LIKE \'%cred%\') AND LOWER(order_status) <> \'cancelled\' GROUP BY DATE_START, MONTH, YEAR, customer_id_final ), MONTHS AS ( SELECT DISTINCT DATE_TRUNC(DATE(order_date), MONTH) AS DATE_START FROM maplemonk.zouk_sales_consolidated WHERE LOWER(shop_name) LIKE \'%shopify%\' OR LOWER(shop_name) LIKE \'%cred%\' ), ALL_CUSTOMERS AS ( SELECT DATE_TRUNC(DATE(Date_Start), MONTH) AS DATE_START ,EXTRACT(MONTH FROM DATE_START) AS MONTH ,EXTRACT(YEAR FROM DATE_START) AS YEAR ,COUNT(DISTINCT customer_id_final) AS ALL_CUSTOMERS ,SUM(NEW_FLAG) AS TM_NEW_CUSTOMERS ,SUM(REPEAT_FLAG) AS TM_REPEAT_CUSTOMERS FROM CUST GROUP BY DATE_START, MONTH, YEAR ), ALL_CUSTOMERS_TILL_LM AS ( SELECT a.MONTH ,a.YEAR ,a.DATE_START ,a.ALL_CUSTOMERS_TILL_LM ,COUNT(DISTINCT c.customer_id_final) AS ALL_CUSTOMERS_LTM ,COUNT(DISTINCT CASE WHEN c.NEW_FLAG = 1 THEN c.customer_id_final END) AS NEW_CUSTOMERS_LTM FROM ( SELECT EXTRACT(MONTH FROM a.DATE_START) AS MONTH ,EXTRACT(YEAR FROM a.DATE_START) AS YEAR ,a.DATE_START ,COUNT(DISTINCT b.customer_id_final) AS ALL_CUSTOMERS_TILL_LM FROM MONTHS a LEFT JOIN CUST b ON b.DATE_START < a.DATE_START GROUP BY MONTH, YEAR, DATE_START ) a LEFT JOIN CUST c ON c.DATE_START < a.DATE_START AND c.DATE_START >= DATE_TRUNC(DATE_SUB(a.DATE_START, INTERVAL 365 DAY), MONTH) GROUP BY a.MONTH, a.YEAR, a.DATE_START, a.ALL_CUSTOMERS_TILL_LM ) SELECT TM.DATE_START ,TM.MONTH ,TM.YEAR ,TM.ALL_CUSTOMERS AS TM_ALL_CUSTOMERS ,(SUM(TM.ALL_CUSTOMERS) OVER (PARTITION BY 1 ORDER BY TM.DATE_START ASC ROWS BETWEEN 1 PRECEDING AND CURRENT ROW) - TM.ALL_CUSTOMERS) AS ALL_CUSTOMERS_LM ,TM.TM_NEW_CUSTOMERS ,(SUM(TM.TM_NEW_CUSTOMERS) OVER (PARTITION BY 1 ORDER BY TM.DATE_START ASC ROWS BETWEEN 1 PRECEDING AND CURRENT ROW) - TM.TM_NEW_CUSTOMERS) AS LM_NEW_CUSTOMERS ,TM.TM_REPEAT_CUSTOMERS ,TLM.ALL_CUSTOMERS_TILL_LM ,TLM.ALL_CUSTOMERS_LTM ,TLM.NEW_CUSTOMERS_LTM FROM ALL_CUSTOMERS TM LEFT JOIN ALL_CUSTOMERS_TILL_LM TLM ON TM.DATE_START = TLM.DATE_START;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from maplemonk.INFORMATION_SCHEMA.TABLES
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            