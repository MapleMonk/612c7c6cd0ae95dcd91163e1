{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table mymuse_db.maplemonk.mymuse_db_GA_produt_funnel_shopify as select a.* ,upper(case when GCM.final_channel is null then case when lower(a.SESSIONSOURCEMEDIUM) like \'%google%\' then \'Google\' when lower(a.SESSIONSOURCEMEDIUM) like \'%facebook%\' then \'Facebook\' when lower(a.SESSIONSOURCEMEDIUM) like \'%instagram%\' then \'Instagram\' when lower(a.SESSIONSOURCEMEDIUM) like \'%direct%\' then \'Direct\' when lower(a.SESSIONSOURCEMEDIUM) like \'%webengage%\' then \'Push Notification\' when lower(a.SESSIONSOURCEMEDIUM) like \'%chatbot%\' then \'Whatsapp\' when lower(a.SESSIONSOURCEMEDIUM) like \'%email%\' then \'Email\' when lower(a.SESSIONSOURCEMEDIUM) like \'%cashfree%\' then \'Payment Providers\' when lower(a.SESSIONSOURCEMEDIUM) like \'%affiliate%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%youtube%\' then \'Google\' when lower(a.SESSIONSOURCEMEDIUM) like \'%duckduckgo%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%linkedin%\' then \'LinkedIn\' when lower(a.SESSIONSOURCEMEDIUM) like \'%bing%\' then \'Organic\' when lower(a.SESSIONSOURCEMEDIUM) like \'%whatsapp%\' then \'Whatsapp\' when lower(a.SESSIONSOURCEMEDIUM) like \'%paytm%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%grabon%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%sms%\' then \'SMS\' when lower(a.SESSIONSOURCEMEDIUM) like \'%yahoo%\' then \'Organic\' when lower(a.SESSIONSOURCEMEDIUM) like \'%referral%\' then \'Referral\' else a.SESSIONSOURCEMEDIUM end else GCM.final_channel end) Channel ,upper(case when GCM.final_source is null then case when lower(a.SESSIONSOURCEMEDIUM) like \'%google%\' then \'Google\' when lower(a.SESSIONSOURCEMEDIUM) like \'%facebook%\' then \'Facebook\' when lower(a.SESSIONSOURCEMEDIUM) like \'%instagram%\' then \'Instagram\' when lower(a.SESSIONSOURCEMEDIUM) like \'%direct%\' then \'Direct\' when lower(a.SESSIONSOURCEMEDIUM) like \'%webengage%\' then \'Push Notification\' when lower(a.SESSIONSOURCEMEDIUM) like \'%chatbot%\' then \'Whatsapp\' when lower(a.SESSIONSOURCEMEDIUM) like \'%email%\' then \'Email\' when lower(a.SESSIONSOURCEMEDIUM) like \'%cashfree%\' then \'Payment Providers\' when lower(a.SESSIONSOURCEMEDIUM) like \'%affiliate%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%youtube%\' then \'Google\' when lower(a.SESSIONSOURCEMEDIUM) like \'%duckduckgo%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%linkedin%\' then \'LinkedIn\' when lower(a.SESSIONSOURCEMEDIUM) like \'%bing%\' then \'Organic\' when lower(a.SESSIONSOURCEMEDIUM) like \'%whatsapp%\' then \'Whatsapp\' when lower(a.SESSIONSOURCEMEDIUM) like \'%paytm%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%grabon%\' then \'Affiliate\' when lower(a.SESSIONSOURCEMEDIUM) like \'%sms%\' then \'SMS\' when lower(a.SESSIONSOURCEMEDIUM) like \'%yahoo%\' then \'Organic\' when lower(a.SESSIONSOURCEMEDIUM) like \'%referral%\' then \'Referral\' else a.SESSIONSOURCEMEDIUM end else GCM.final_source end) Final_Source ,coalesce(g.product_name_final,f.product_name_final, h.product_name_final,i.product_name_final) Product_name_final ,coalesce(g.product_Category, f.product_Category,g.product_Category, h.product_Category,i.product_Category) Product_Category ,coalesce(g.product_sub_Category, f.product_sub_Category, h.product_sub_Category,i.product_sub_Category) Product_Sub_Category ,ifnull(b.orders,0) + ifnull(c.orders,0) + ifnull(d.orders,0) + ifnull(e.orders,0) orders ,ifnull(b.items_purchased,0) + ifnull(c.items_purchased,0) + ifnull(d.items_purchased,0) + ifnull(e.items_purchased,0) items_purchased from (select to_date(date, \'yyyymmdd\') Date ,PROPERTY_ID ,ITEMID ,ITEMNAME ,sessionsourcemedium ,sum(ifnull(ITEMSVIEWED,0)) ITEMS_VIEWED ,sum(ifnull(TOTALUSERS,0)) TOTAL_USERS ,sum(ifnull(SESSIONS,0)) SESSIONS ,sum(ifnull(ENGAGEDSESSIONS,0)) ENGAGEDSESSIONS ,sum(ifnull(ITEMSCHECKEDOUT,0)) ITEMSCHECKEDOUT ,sum(ifnull(ITEMSADDEDTOCART,0)) ITEMSADDEDTOCART from mymuse_db.maplemonk.GA4_MYMUSE_PRODUCTS_FUNNEL_METRICS group by 1,2,3,4,5 ) a left join ( select sku , order_timestamp::Date order_Date , count(distinct ordeR_id) orders , sum(quantity) items_purchased from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS group by 1,2 ) b on a.date = b.order_Date and lower(replace(a.itemid,\' \',\'\')) = lower(replace(b.sku,\' \',\'\')) left join ( select product_id GA_product_id ,order_timestamp::Date order_Date ,count(distinct order_id) orders , sum(quantity) items_purchased from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1,2 ) c on a.date = c.order_Date and lower(replace(substr(a.itemid,position(\'shopify_IN_\',a.itemid)+11,13),\' \',\'\')) = lower(replace(c.GA_product_id,\' \',\'\')) left join ( select product_id GA_product_id ,order_timestamp::Date order_Date ,count(distinct order_id) orders , sum(quantity) items_purchased from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1,2 ) d on a.date = d.order_Date and lower(replace(a.itemid,\' \',\'\')) = lower(replace(d.GA_product_id,\' \',\'\')) left join ( select variant_id GA_product_id ,order_timestamp::Date order_Date ,count(distinct order_id) orders , sum(quantity) items_purchased from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1,2 ) e on a.date = e.order_Date and lower(replace(a.itemid,\' \',\'\')) = lower(replace(e.GA_product_id,\' \',\'\')) left join ( select sku GA_product_id ,max(product_category) product_category ,max(product_sub_category) product_sub_category ,max(product_name_final) product_name_final from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1 ) f on lower(replace(a.itemid,\' \',\'\')) = lower(replace(f.GA_product_id,\' \',\'\')) left join ( select product_id GA_product_id ,max(product_category) product_category ,max(product_sub_category) product_sub_category ,max(product_name_final) product_name_final from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1 ) g on replace(substr(a.itemid,position(\'shopify_IN_\',a.itemid)+11,13),\' \',\'\') = lower(replace(g.GA_product_id,\' \',\'\')) left join ( select product_id GA_product_id ,max(product_category) product_category ,max(product_sub_category) product_sub_category ,max(product_name_final) product_name_final from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1 ) h on lower(replace(a.itemid,\' \',\'\')) = lower(replace(h.GA_product_id,\' \',\'\')) left join ( select variant_id GA_product_id ,max(product_category) product_category ,max(product_sub_category) product_sub_category ,max(product_name_final) product_name_final from MYMUSE_DB.MAPLEMONK.MYMUSE_DB_SHOPIFY_FACT_ITEMS FI group by 1 ) i on lower(replace(a.itemid,\' \',\'\')) = lower(replace(i.GA_product_id,\' \',\'\')) left join (select * from (select GA_SOURCEMEDIUM, final_channel, final_source, row_number() over (partition by lower(GA_SOURCEMEDIUM) order by lower(GA_SOURCEMEDIUM)) rw from MYMUSE_DB.MAPLEMONK.GA_CHANNEL_MAPPING) where rw=1) GCM on lower(a.SESSIONSOURCEMEDIUM) = lower(GCM.GA_SOURCEMEDIUM) ; create or replace table mymuse_db.maplemonk.mymuse_db_GA_landing_page_funnel_shopify as select to_date(date, \'yyyymmdd\') Date ,UUID ,SESSIONS ,CHECKOUTS ,ADDTOCARTS ,LANDINGPAGE ,PROPERTY_ID ,TRANSACTIONS ,SESSIONMEDIUM ,SESSIONSOURCE ,ENGAGEDSESSIONS ,SCREENPAGEVIEWS ,SESSIONSOURCEMEDIUM ,upper(case when GCM.final_channel is null then case when lower(GASC.SESSIONSOURCEMEDIUM) like \'%google%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%facebook%\' then \'Facebook\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%instagram%\' then \'Instagram\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%direct%\' then \'Direct\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%webengage%\' then \'Push Notification\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%chatbot%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%email%\' then \'Email\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%cashfree%\' then \'Payment Providers\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%affiliate%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%youtube%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%duckduckgo%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%linkedin%\' then \'LinkedIn\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%bing%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%whatsapp%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%paytm%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%grabon%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%sms%\' then \'SMS\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%yahoo%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%referral%\' then \'Referral\' else GASC.SESSIONSOURCEMEDIUM end else GCM.final_channel end) Channel ,upper(case when GCM.final_source is null then case when lower(GASC.SESSIONSOURCEMEDIUM) like \'%google%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%facebook%\' then \'Facebook\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%instagram%\' then \'Instagram\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%direct%\' then \'Direct\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%webengage%\' then \'Push Notification\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%chatbot%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%email%\' then \'Email\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%cashfree%\' then \'Payment Providers\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%affiliate%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%youtube%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%duckduckgo%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%linkedin%\' then \'LinkedIn\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%bing%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%whatsapp%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%paytm%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%grabon%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%sms%\' then \'SMS\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%yahoo%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%referral%\' then \'Referral\' else GASC.SESSIONSOURCEMEDIUM end else GCM.final_source end) Final_Source from MYMUSE_DB.MAPLEMONK.ga4_mymuse_landing_page_funnel_metrics GASC left join (select * from (select GA_SOURCEMEDIUM, final_channel, final_source, row_number() over (partition by lower(GA_SOURCEMEDIUM) order by lower(GA_SOURCEMEDIUM)) rw from MYMUSE_DB.MAPLEMONK.GA_CHANNEL_MAPPING) where rw=1) GCM on lower(GASC.SESSIONSOURCEMEDIUM) = lower(GCM.GA_SOURCEMEDIUM) ; create or replace table mymuse_db.maplemonk.mymuse_db_GA_marketing_channel_funnel_shopify as select to_date(date, \'yyyymmdd\') Date ,UUID ,SESSIONS ,CHECKOUTS ,ADDTOCARTS ,PROPERTY_ID ,TRANSACTIONS ,SESSIONMEDIUM ,SESSIONSOURCE ,ENGAGEDSESSIONS ,SCREENPAGEVIEWS ,SESSIONSOURCEMEDIUM ,upper(case when GCM.final_channel is null then case when lower(GASC.SESSIONSOURCEMEDIUM) like \'%google%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%facebook%\' then \'Facebook\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%instagram%\' then \'Instagram\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%direct%\' then \'Direct\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%webengage%\' then \'Push Notification\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%chatbot%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%email%\' then \'Email\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%cashfree%\' then \'Payment Providers\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%affiliate%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%youtube%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%duckduckgo%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%linkedin%\' then \'LinkedIn\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%bing%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%whatsapp%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%paytm%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%grabon%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%sms%\' then \'SMS\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%yahoo%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%referral%\' then \'Referral\' else GASC.SESSIONSOURCEMEDIUM end else GCM.final_channel end) Channel ,upper(case when GCM.final_source is null then case when lower(GASC.SESSIONSOURCEMEDIUM) like \'%google%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%facebook%\' then \'Facebook\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%instagram%\' then \'Instagram\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%direct%\' then \'Direct\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%webengage%\' then \'Push Notification\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%chatbot%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%email%\' then \'Email\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%cashfree%\' then \'Payment Providers\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%affiliate%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%youtube%\' then \'Google\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%duckduckgo%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%linkedin%\' then \'LinkedIn\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%bing%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%whatsapp%\' then \'Whatsapp\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%paytm%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%grabon%\' then \'Affiliate\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%sms%\' then \'SMS\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%yahoo%\' then \'Organic\' when lower(GASC.SESSIONSOURCEMEDIUM) like \'%referral%\' then \'Referral\' else GASC.SESSIONSOURCEMEDIUM end else GCM.final_source end) Final_Source from MYMUSE_DB.MAPLEMONK.ga4_mymuse_marketing_channel_funnel_metrics GASC left join (select * from (select GA_SOURCEMEDIUM, final_channel, final_source, row_number() over (partition by lower(GA_SOURCEMEDIUM) order by lower(GA_SOURCEMEDIUM)) rw from MYMUSE_DB.MAPLEMONK.GA_CHANNEL_MAPPING) where rw=1) GCM on lower(GASC.SESSIONSOURCEMEDIUM) = lower(GCM.GA_SOURCEMEDIUM) ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from MYMUSE_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        