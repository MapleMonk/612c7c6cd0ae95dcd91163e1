{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE anveshan_db.public.FACT_ITEMS AS SELECT Cast(O.id AS VARCHAR(16777216)) AS Order_ID, o.customer:id::int Customer_ID, Ol1.id AS Item_ID, Cast(Ol1.product_id AS VARCHAR(16777216)) Product_ID, CASE WHEN P.title IS NULL THEN 'NA' ELSE P.title END AS Product_Name, CASE WHEN Cd.city IS NULL OR Cd.city = '' THEN 'NA' ELSE Cd.city END AS City, CASE WHEN Cd.province IS NULL OR Cd.province = '' THEN 'NA' ELSE Cd.province END AS State, CASE WHEN P.product_type = '' THEN 'NA' ELSE P.product_type END AS Category, CASE WHEN O.cancelled_at IS NULL THEN 0 ELSE 1 END AS Cancelled_Flag, Cast(O.created_at AS DATETIME) Order_Timestamp, Sum(Ol1.price * Ol1.quantity) AS Sales, Sum(O.total_tax) / Sum(Ol2.items) AS Tax, Sum(O.total_discounts) / Sum(Ol2.items) AS Discount, Sum(Ol1.quantity) Quantity, 'Shopify' AS Source FROM anveshan_db.PUBLIC.orders O LEFT JOIN anveshan_db.PUBLIC.orders_line_items Ol1 ON O._airbyte_orders_hashid = Ol1._airbyte_orders_hashid LEFT JOIN (SELECT _airbyte_orders_hashid, Count(1) AS Items FROM anveshan_db.PUBLIC.orders_line_items GROUP BY _airbyte_orders_hashid) Ol2 ON O._airbyte_orders_hashid = Ol2._airbyte_orders_hashid LEFT JOIN anveshan_db.PUBLIC.products P ON Ol1.product_id = P.id LEFT JOIN anveshan_db.PUBLIC.customers C ON O.customer:id::int = C.id LEFT JOIN (SELECT customer_id, city, province, Row_number() OVER ( partition BY customer_id ORDER BY id DESC) rowid FROM anveshan_db.PUBLIC.customers_addresses) AS Cd ON o.customer:id::int = Cd.customer_id AND Cd.rowid = 1 GROUP BY Cast(O.id AS VARCHAR(16777216)), o.customer:id::int, Ol1.id, Cast(Ol1.product_id AS VARCHAR(16777216)), CASE WHEN P.title IS NULL THEN 'NA' ELSE P.title END, CASE WHEN Cd.city IS NULL OR Cd.city = '' THEN 'NA' ELSE Cd.city END, CASE WHEN Cd.province IS NULL OR Cd.province = '' THEN 'NA' ELSE Cd.province END, CASE WHEN P.product_type = '' THEN 'NA' ELSE P.product_type END, CASE WHEN O.cancelled_at IS NULL THEN 0 ELSE 1 END, Cast(O.created_at AS DATETIME) UNION SELECT Co.id Order_ID, Co.customer_id, Coi.id Item_ID, Coi.product_sku_id AS Product_ID, CASE WHEN Ca.NAME IS NULL THEN 'NA' ELSE Ca.NAME END AS Product_Name, Cc.city, Cc.address_state AS State, 'NA' AS Category, CASE WHEN Co.order_status = 'CANCELLED' THEN 1 ELSE 0 END AS Cancelled_Flag, Cast(Co.order_date_time AS DATETIME) AS Order_Timestamp, Sum(Coi.price_without_tax * Coi.quantity) Sales, NULL AS Tax, Sum(Coi.discount) Discount, Sum(Coi.quantity) Quantity, Co.channel AS Source FROM anveshan_db.PUBLIC.core_order Co INNER JOIN anveshan_db.PUBLIC.core_orderitems Coi ON Co.id = Coi.order_id LEFT JOIN anveshan_db.PUBLIC.core_customer Cc ON Co.customer_id = Cc.id LEFT JOIN anveshan_db.PUBLIC.core_anveshanproductsku Ca ON Coi.product_sku_id = Ca.sku_code WHERE Co.channel <> 'SHOPIFY' GROUP BY Co.id, Co.customer_id, Coi.id, Coi.product_sku_id, CASE WHEN Ca.NAME IS NULL THEN 'NA' ELSE Ca.NAME END, Cc.city, Cc.address_state, CASE WHEN Co.order_status = 'CANCELLED' THEN 1 ELSE 0 END, Cast(Co.order_date_time AS DATETIME), Co.channel ; alter table anveshan_db.public.fact_items add column Customer_Flag varchar(50); alter table anveshan_db.public.fact_items add column New_Customer_Flag varchar(50); alter table anveshan_db.public.fact_items add column Acquisition_Channel varchar(16777216); alter table anveshan_db.public.fact_items add column Acquisition_Product varchar(16777216); UPDATE anveshan_db.PUBLIC.fact_items AS A SET A.customer_flag = B.flag FROM (SELECT DISTINCT order_id, customer_id, order_timestamp, CASE WHEN order_timestamp <> Min(order_timestamp) OVER ( partition BY customer_id) THEN 'Repeated' ELSE 'New' END AS Flag FROM anveshan_db.PUBLIC.fact_items)AS B WHERE A.order_id = B.order_id AND A.customer_id = B.customer_id; UPDATE anveshan_db.PUBLIC.fact_items SET customer_flag = CASE WHEN customer_flag IS NULL THEN 'New' ELSE customer_flag END; UPDATE anveshan_db.PUBLIC.fact_items AS A SET A.new_customer_flag = B.flag FROM (SELECT DISTINCT order_id, customer_id, order_timestamp, CASE WHEN Last_day(order_timestamp, 'month') <> Last_day(Min(order_timestamp) OVER ( partition BY customer_id)) THEN 'Repeated' ELSE 'New' END AS Flag FROM anveshan_db.PUBLIC.fact_items)AS B WHERE A.order_id = B.order_id AND A.customer_id = B.customer_id; UPDATE anveshan_db.PUBLIC.fact_items SET new_customer_flag = CASE WHEN new_customer_flag IS NULL THEN 'New' ELSE new_customer_flag END; CREATE OR REPLACE TEMPORARY TABLE anveshan_db.public.temp_source AS SELECT DISTINCT customer_id, source FROM (SELECT DISTINCT customer_id, order_timestamp, source, Min(order_timestamp) over ( PARTITION BY customer_id) firstOrderdate FROM anveshan_db.public.fact_items)res WHERE order_timestamp=firstorderdate; update anveshan_db.PUBLIC.fact_items AS a SET a.acquisition_channel=b.source FROM anveshan_db.PUBLIC.temp_source b WHERE a.customer_id = b.customer_id; CREATE OR REPLACE TEMPORARY TABLE anveshan_db.PUBLIC.temp_product AS SELECT DISTINCT customer_id, product_name, Row_number() OVER (partition BY customer_id ORDER BY sales DESC) rowid FROM ( SELECT DISTINCT customer_id, order_timestamp, product_name, sales , Min(order_timestamp) OVER (partition BY customer_id) firstOrderdate FROM anveshan_db.PUBLIC.fact_items )res WHERE order_timestamp=firstorderdate; UPDATE anveshan_db.PUBLIC.fact_items AS A SET A.acquisition_product=B.product_name FROM ( SELECT * FROM anveshan_db.PUBLIC.temp_product WHERE rowid=1)B WHERE A.customer_id = B.customer_id;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from Anveshan_DB.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            