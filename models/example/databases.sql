{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE RPSG_DB.MAPLEMONK.drv_asp_fba_daily_inventory_fact_items AS WITH inventory AS ( SELECT svd.*, map.sku, map.PRODUCTNAME FROM rpsg_db.maplemonk.asp_drv_fc_get_ledger_summary_view_data svd left join ( SELECT * FROM rpsg_db.maplemonk.amazon_asin_amazon_asin qualify row_number() over(partition by lower(\"Marketplace _SKU\") order by 1) = 1 )map on svd.ASIN = map.\"Marketplace _SKU\" ), sales_consolidated AS ( SELECT DATE(ORDER_DATE) as Order_Date, SKU, SUM(SUBORDER_QUANTITY) AS QUANTITY_SOLD FROM RPSG_DB.MAPLEMONK.SALES_CONSOLIDATED_DRV WHERE LOWER(MARKETPLACE) = \'amazon\' GROUP BY 1,2 ), location_mapping AS ( SELECT * FROM RPSG_DB.MAPLEMONK.AMAZON_MAPPING_LOCATION_TO_REGION qualify row_number() over(partition by lower(LOCATION_ID) order by 1) = 1 ), sales_l14 AS ( SELECT p1.SKU, p1.ORDER_DATE, SUM(p2.QUANTITY_SOLD) AS quantity_last_14_days from sales_consolidated p1 left join sales_consolidated p2 ON p1.SKU = p2.SKU AND p2.ORDER_DATE BETWEEN DATEADD(day, -14, p1.ORDER_DATE) AND p1.ORDER_DATE where p1.sku is not null GROUP BY 1,2 ), inventory_consolidated AS (SELECT T1.*, T4.LOCATION_ID, T4.REGION, T4.FC_TYPE, T3.QUANTITY_SOLD, quantity_last_14_days AS total_quantity_last_14_days, FROM inventory T1 LEFT JOIN sales_consolidated T3 ON T1.SKU = T3.SKU AND T1.DATE = T3.ORDER_DATE LEFT JOIN location_mapping T4 ON T1.LOCATION = T4.LOCATION_ID LEFT JOIN sales_l14 T5 ON T1.SKU = T5.SKU AND T1.DATE = T5.ORDER_DATE ) SELECT A.*,TITLE , DISPOSITION, \"Ending Warehouse Balance\", \"Starting Warehouse Balance\", total_quantity_last_14_days, QUANTITY_SOLD FROM ( SELECT ASIN,DATE, SKU, FC_TYPE, ifnull(SUM(\"\'BLR5\'\"),0) AS BLR5, ifnull(SUM(\"\'BLR7\'\"),0) AS BLR7, ifnull(SUM(\"\'BLR8\'\"),0) AS BLR8, ifnull(SUM(\"\'HYD3\'\"),0) AS HYD3, ifnull(SUM(\"\'HYD8\'\"),0) AS HYD8, ifnull(ifnull(SUM(\"\'BLR5\'\"),0) + ifnull(SUM(\"\'BLR7\'\"),0) + ifnull(SUM(\"\'BLR8\'\"),0) + ifnull(SUM(\"\'HYD3\'\"),0) + ifnull(SUM(\"\'HYD8\'\"),0),0) AS SOUTH, ifnull(SUM(\"\'BOM4\'\"),0) AS BOM4, ifnull(SUM(\"\'BOM5\'\"),0) AS BOM5, ifnull(SUM(\"\'BOM7\'\"),0) AS BOM7, ifnull(SUM(\"\'YWJJ\'\"),0) AS YWJJ, ifnull(ifnull(SUM(\"\'BOM4\'\"),0) + ifnull(SUM(\"\'BOM5\'\"),0) + ifnull(SUM(\"\'BOM7\'\"),0) + ifnull(SUM(\"\'YWJJ\'\"),0),0) AS WEST, ifnull(SUM(\"\'CCX1\'\"),0) AS CCX1, ifnull(ifnull(SUM(\"\'CCX1\'\"),0),0) AS EAST, ifnull(SUM(\"\'DED4\'\"),0) AS DED4, ifnull(SUM(\"\'DEL2\'\"),0) AS DEL2, ifnull(SUM(\"\'DEL4\'\"),0) AS DEL4, ifnull(SUM(\"\'DEL5\'\"),0) AS DEL5, ifnull(SUM(\"\'LKO1\'\"),0) AS LKO1, ifnull(ifnull(SUM(\"\'DED4\'\"),0) + ifnull(SUM(\"\'DEL2\'\"),0) + ifnull(SUM(\"\'DEL4\'\"),0) + ifnull(SUM(\"\'DEL5\'\"),0)+ifnull(SUM(\"\'LKO1\'\"),0),0) AS NORTH, ifnull(SUM(\"\'XHFZ\'\"),0) AS XHFZ, ifnull(SUM(\"\'XHG0\'\"),0) AS XHG0, ifnull(SUM(\"\'XHG1\'\"),0) AS XHG1, ifnull(ifnull(SUM(\"\'XHFZ\'\"),0) + ifnull(SUM(\"\'XHG0\'\"),0) + ifnull(SUM(\"\'XHG1\'\"),0) ,0) AS SELLER_FLEX FROM( SELECT * FROM (SELECT ASIN, DATE,SKU, LOCATION, REGION, FC_TYPE, SUM(\"Ending Warehouse Balance\") AS S1 FROM inventory_consolidated GROUP BY 1,2,3,4,5,6) PIVOT ( SUM(S1) FOR LOCATION IN (\'BLR5\', \'BLR7\', \'BLR8\', \'HYD3\', \'HYD8\' ,\'BOM4\', \'BOM5\', \'BOM7\', \'YWJJ\', \'CCX1\', \'DED4\' , \'DEL2\', \'DEL4\', \'DEL5\', \'LKO1\', \'XHFZ\', \'XHG0\',\'XHG1\') ) AS pvt) GROUP BY 1,2,3,4 )A LEFT JOIN (select ASIN, DATE, SKU, TITLE , DISPOSITION, SUM(\"Ending Warehouse Balance\") AS \"Ending Warehouse Balance\", SUM(\"Starting Warehouse Balance\") AS \"Starting Warehouse Balance\" , FC_TYPE, TOTAL_QUANTITY_LAST_14_DAYS, QUANTITY_SOLD FROM inventory_consolidated GROUP BY 1,2,3,4,5,8,9,10) B ON A.ASIN = B.ASIN AND A.DATE = B.DATE AND A.FC_TYPE = B.FC_TYPE",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from RPSG_DB.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            