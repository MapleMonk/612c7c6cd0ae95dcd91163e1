{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_clicks_impressions_by_itemid AS WITH GA_DATA AS ( SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'WEB\' AS TYPE, sum(itemsViewedInList) AS IMPRESSIONS, sum(itemsViewed) AS CLICKS, sum(itemsAddedToCart) as itemsAddedToCart FROM snitch_db.maplemonk.ga4_web_jan24_clicks_impressions_by_itemid WHERE GA_DATE > \'2024-02-27\' group by 1,2 UNION SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'WEB\' AS TYPE, sum(itemsViewedInList) AS IMPRESSIONS, sum(itemsViewed) AS CLICKS, sum(itemsAddedToCart) as itemsAddedToCart FROM snitch_db.maplemonk.ga4_web_clicks_impressions_by_itemid WHERE GA_DATE <= \'2024-02-27\' group by 1,2 UNION SELECT TO_DATE(DATE,\'YYYYMMDD\') AS GA_DATE, CASE WHEN LENGTH(ITEMID) > 14 THEN REPLACE(SPLIT(itemid, \'_\')[2],\'\"\',\'\') ELSE itemid END AS itemid, \'APP\' AS TYPE, sum(itemsViewedInList) AS IMPRESSIONS, sum(itemsViewed) AS CLICKS, sum(itemsAddedToCart) as itemsAddedToCart FROM snitch_db.maplemonk.ga4_APP_clicks_impressions_by_itemid group by 1,2 ), sales_data AS ( SELECT order_timestamp::date AS order_Date, case when lower(webshopney) = \'appbrew\' then \'app\' when lower(webshopney) = \'web\' then \'web\' end as type, product_id, sku_group, SUM(quantity) AS quantity, SUM(gross_sales) AS gross_sales FROM snitch_db.maplemonk.fact_items_snitch GROUP BY 1,2,3,4 ), main_data AS ( SELECT sd.order_date, sd.type, sd.product_id AS product_id, sd.sku_group, gd.IMPRESSIONS, gd.CLICKS, gd.itemsAddedToCart, sd.quantity, sd.gross_sales, gd.IMPRESSIONS / NULLIF(SUM(gd.IMPRESSIONS) OVER (PARTITION BY sd.order_date, sd.type), 0) AS impression_share, gd.CLICKS / NULLIF(SUM(gd.CLICKS) OVER (PARTITION BY sd.order_date, sd.type), 0) AS clicks_share, SUM(gd.IMPRESSIONS) OVER (PARTITION BY sd.order_date, sd.type ORDER BY gd.IMPRESSIONS DESC) / NULLIF(SUM(gd.IMPRESSIONS) OVER (PARTITION BY sd.order_date, sd.type), 0) AS cumulative_impression_share, SUM(gd.CLICKS) OVER (PARTITION BY sd.order_date, sd.type ORDER BY gd.CLICKS DESC) / NULLIF(SUM(gd.CLICKS) OVER (PARTITION BY sd.order_date, sd.type), 0) AS cumulative_clicks_share FROM sales_data sd LEFT JOIN GA_DATA gd ON sd.order_Date = gd.GA_DATE AND sd.product_id = gd.itemid and lower(sd.type) = lower(gd.TYPE) WHERE sd.order_date IS NOT NULL AND sd.type IS NOT NULL AND sd.product_id IS NOT NULL AND gd.IMPRESSIONS IS NOT NULL AND gd.CLICKS IS NOT NULL AND gd.itemsAddedToCart IS NOT NULL ) SELECT order_date, type, product_id, sku_group, IMPRESSIONS, CLICKS, itemsAddedToCart, quantity, gross_sales, impression_share, cumulative_impression_share, clicks_share, cumulative_clicks_share, CASE WHEN cumulative_impression_share <= 0.1 THEN \'0% - 10%\' WHEN cumulative_impression_share > 0.1 and cumulative_impression_share <= 0.2 THEN \'10% - 20%\' WHEN cumulative_impression_share > 0.2 and cumulative_impression_share <= 0.3 THEN \'20% - 30%\' WHEN cumulative_impression_share > 0.3 and cumulative_impression_share <= 0.4 THEN \'30% - 40%\' WHEN cumulative_impression_share > 0.4 and cumulative_impression_share <= 0.5 THEN \'40% - 50%\' WHEN cumulative_impression_share > 0.5 and cumulative_impression_share <= 0.6 THEN \'50% - 60%\' WHEN cumulative_impression_share > 0.6 and cumulative_impression_share <= 0.7 THEN \'60% - 70%\' WHEN cumulative_impression_share > 0.7 and cumulative_impression_share <= 0.8 THEN \'70% - 80%\' WHEN cumulative_impression_share > 0.8 and cumulative_impression_share <= 0.9 THEN \'80% - 90%\' WHEN cumulative_impression_share > 0.9 and cumulative_impression_share <= 1.0 THEN \'90% - 100%\' ELSE \'null\' END AS impression_share_bucket, CASE WHEN cumulative_clicks_share <= 0.1 THEN \'0% - 10%\' WHEN cumulative_clicks_share > 0.1 and cumulative_clicks_share <= 0.2 THEN \'10% - 20%\' WHEN cumulative_clicks_share > 0.2 and cumulative_clicks_share <= 0.3 THEN \'20% - 30%\' WHEN cumulative_clicks_share > 0.3 and cumulative_clicks_share <= 0.4 THEN \'30% - 40%\' WHEN cumulative_clicks_share > 0.4 and cumulative_clicks_share <= 0.5 THEN \'40% - 50%\' WHEN cumulative_clicks_share > 0.5 and cumulative_clicks_share <= 0.6 THEN \'50% - 60%\' WHEN cumulative_clicks_share > 0.6 and cumulative_clicks_share <= 0.7 THEN \'60% - 70%\' WHEN cumulative_clicks_share > 0.7 and cumulative_clicks_share <= 0.8 THEN \'70% - 80%\' WHEN cumulative_clicks_share > 0.8 and cumulative_clicks_share <= 0.9 THEN \'80% - 90%\' WHEN cumulative_clicks_share > 0.9 and cumulative_clicks_share <= 1.0 THEN \'90% - 100%\' ELSE \'null\' END AS clicks_share_bucket FROM main_data ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.sessions_impressions_by_date_source AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'WEB\' AS TYPE, SESSIONSOURCEMEDIUM, itemsViewedInList AS IMPRESSIONS, SESSIONS FROM snitch_db.maplemonk.ga4_web_jan24_sessions_impressions_by_date_source WHERE GA_DATE>\'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'WEB\' AS TYPE, SESSIONSOURCEMEDIUM, itemsViewedInList AS IMPRESSIONS, SESSIONS FROM snitch_db.maplemonk.ga4_web_sessions_impressions_by_date_source WHERE GA_DATE<=\'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, SESSIONSOURCEMEDIUM, itemsViewedInList AS IMPRESSIONS, SESSIONS FROM snitch_db.maplemonk.ga4_APP_sessions_impressions_by_date_source ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_sessions_conversions_by_landingpage AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, landingPage, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_JAN24_sessions_conversions_by_landingpage WHERE GA_DATE > \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, landingPage, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_sessions_conversions_by_landingpage WHERE GA_DATE <= \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, landingPage, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_APP_sessions_conversions_by_landingpage ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_sessions_conversions_by_CAMPAIGN AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_JAN24_session_conversions_by_CAMPAIGN WHERE GA_DATE > \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_session_conversions_by_CAMPAIGN WHERE GA_DATE <= \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, SESSIONCAMPAIGNNAME, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_APP_session_conversions_by_CAMPAIGN ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_session_conversions_by_landingpage_campaign AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, LANDINGPAGE, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_JAN24_sessionS_conversions_by_landingpage_campaign WHERE GA_DATE > \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, LANDINGPAGE, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_session_conversions_by_landingpage_campaign WHERE GA_DATE <= \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, SESSIONCAMPAIGNNAME, LANDINGPAGE, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_APP_session_conversions_by_landingpage_campaign",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        