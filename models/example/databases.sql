{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table hilodesign_db.MAPLEMONK.Sales_Cost_Source_hilo_web as with orders as ( select date(FI.order_date) Date ,FI.SOURCE Channel ,ifnull(sum(case when lower(order_status) not in (\'cancelled\') then FI.selling_price end),0) Gross_Sales ,ifnull(sum(case when lower(order_status) not in (\'cancelled\') and payment_gateway = \'COD\' then FI.selling_price end),0) COD_Gross_Sales ,ifnull(sum(case when lower(order_status) not in (\'cancelled\') and payment_gateway = \'Prepaid\' then FI.selling_price end),0) Prepaid_Gross_Sales ,count(distinct case when lower(order_status) not in (\'cancelled\') then FI.order_id end) Orders ,count(distinct case when lower(order_status) not in (\'cancelled\') and payment_gateway = \'COD\' then FI.order_id end) COD_Orders ,count(distinct case when lower(order_status) not in (\'cancelled\') and payment_gateway = \'Prepaid\' then FI.order_id end) Prepaid_Orders ,count(distinct case when lower(order_status) not in (\'cancelled\') and payment_gateway = \'Exchange\' then FI.order_id end) Exchange_Orders ,count(distinct case when lower(order_status) not in (\'cancelled\') and payment_gateway = \'Test\' then FI.order_id end) Test_Orders ,count(distinct(case when lower(order_status) not in (\'cancelled\') and lower(FI.new_customer_flag) = 1 then FI.order_id end)) as New_Customer_Orders ,count(distinct(case when lower(order_status) not in (\'cancelled\') and lower(FI.new_customer_flag) = 1 then FI.customer_id end)) as New_Customers ,count(distinct case when lower(order_status) not in (\'cancelled\') then FI.customer_id_final end) as Unique_Customers ,count(distinct(case when lower(FI.new_customer_flag) = 0 and lower(order_status) not in (\'cancelled\') then FI.customer_id_final end)) as Repeat_Customers ,ifnull(sum(case when lower(order_status) not in (\'cancelled\') then FI.suborder_quantity end),0) Gross_QUANTITY ,ifnull(sum(case when is_refund=1 and lower(order_status) not in (\'cancelled\') then FI.suborder_quantity end),0) as Return_Quantity ,ifnull(sum(case when is_refund=1 and lower(order_status) not in (\'cancelled\') then ifnull(FI.selling_price,0) end),0) as Return_Value ,ifnull(sum(case when lower(order_status) not in (\'cancelled\') then FI.cogs::float end),0) as COGS ,Gross_Sales - Return_Value as Net_Sales from hilodesign_db.maplemonk.SALES_CONSOLIDATED_HILO FI where lower(FI.marketplace) in (\'shopify_india\') group by 1,2 order by date desc ) , spend as (select date,channel, sum(spend) as spend from hilodesign_db.MAPLEMONK.MARKETING_CONSOLIDATED_HILO group by 1,2 ) select coalesce(fi.Date,MC.date) as date, coalesce(FI.Channel, MC.channel) as channel, Gross_Sales, COD_Gross_sales, Prepaid_Gross_sales, Orders, COD_orders, Prepaid_orders, Exchange_orders, Test_Orders, New_Customer_Orders, New_Customers, Unique_Customers, Repeat_Customers, Gross_QUANTITY, Return_Quantity, Return_Value, COGS, spend as marketing_spend, Net_Sales from orders FI full outer join spend MC on FI.Date = MC.date and FI.Channel = MC.channel ; Create or replace table hilodesign_db.MAPLEMONK.Sales_Cost_Source_hilo as with sales as ( select marketplace,sales_channel ,order_date::date as ORDER_DATE ,count(distinct case when new_customer_flag = 1 and lower(order_status) <> \'cancelled\' then order_id end) as orders_new ,coalesce(sum(case when new_customer_flag = 1 and lower(order_status) <> \'cancelled\' then selling_price end),0) as gross_sales_new ,sum(case when new_customer_flag = 1 then suborder_quantity end ) as total_quantity_new ,sum(case when new_customer_flag = 1 then returned_quantity end ) as returned_quantity_new ,sum(case when new_customer_flag = 1 then cancelled_quantity end ) as cancelled_quantity_new ,sum(case when new_customer_flag = 1 then return_sales end ) as return_sales_new ,sum(case when new_customer_flag = 1 then cancel_sales end ) as cancel_sales_new ,ifnull(gross_sales_new,0) - ifnull(return_sales_new,0) as net_sales_new ,count(distinct case when new_customer_flag = 0 and lower(order_status) <> \'cancelled\' then order_id end) as orders_repeat ,coalesce(sum(case when new_customer_flag = 0 and lower(order_status) <> \'cancelled\' then selling_price end),0) as gross_sales_repeat ,sum(case when new_customer_flag = 0 then suborder_quantity end ) as total_quantity_repeat ,sum(case when new_customer_flag = 0 then returned_quantity end ) as returned_quantity_repeat ,sum(case when new_customer_flag = 0 then cancelled_quantity end ) as cancelled_quantity_repeat ,sum(case when new_customer_flag = 0 then return_sales end ) as return_sales_repeat ,sum(case when new_customer_flag = 0 then cancel_sales end ) as cancel_sales_repeat ,ifnull(gross_sales_repeat,0) - ifnull(return_sales_repeat,0) as net_sales_repeat ,count(distinct case when lower(order_status) in (\'cancelled\') then order_id end) as orders_cancelled ,count(distinct case when lower(order_status) not in (\'cancelled\') then customer_id_final end) as Unique_Customers ,count(distinct case when new_customer_flag = 1 and lower(order_status) not in (\'cancelled\') then customer_id_final end) as New_Customers ,ifnull(sum(case when lower(order_status) <> \'cancelled\' then cogs::float end),0) as COGS from hilodesign_db.maplemonk.sales_consolidated_hilo group by 1,2,3 ), marketing as ( select date,\'Shopify_India\' as marketplace ,sum(spend) as spend, avg(orders) orders,avg(Sales) Sales from hilodesign_db.MAPLEMONK.MARKETING_CONSOLIDATED_HILO a left join (select order_timestamp::date as order_date, count(distinct order_id) as orders, sum(total_sales) as Sales from hilodesign_db.maplemonk.FACT_ITEMS where shop_name like \'%hop%\' and final_utm_channel not in (\'Others\',\'Direct\') and lower(order_status) not in (\'cancelled\') group by 1 ) b on a.date::date = b.order_date::date group by 1,2 ) select coalesce(s.marketplace,m.marketplace) as marketplace ,sales_channel ,coalesce(s.order_date,m.date) as order_date ,orders_new ,gross_sales_new ,total_quantity_new ,returned_quantity_new ,cancelled_quantity_new ,return_sales_new ,cancel_sales_new ,net_sales_new ,orders_repeat ,gross_sales_repeat ,total_quantity_repeat ,returned_quantity_repeat ,cancelled_quantity_repeat ,return_sales_repeat ,cancel_sales_repeat ,net_sales_repeat ,orders_cancelled ,Unique_Customers ,New_Customers ,cogs ,m.spend as spend ,m.sales as ads_sales ,m.orders as ads_orders from sales s full join marketing m on s.order_date::date = m.date::date and s.marketplace in (\'Shopify\',\'Shopify_India\') order by s.order_date::date desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from HILODESIGN_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        