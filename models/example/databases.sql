{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.INVENTORY_PALN_V1 AS WITH MASTER AS ( SELECT *, CASE WHEN NEWWW_CATEGORY IN (\'Cargo\',\'Cargo Pants\') then \'Cargo\' when NEWWW_CATEGORY in (\'Co-ords\',\'Co-Ords\') then \'Co-ords\' when NEWWW_CATEGORY in (\'T-Shirts\',\'T-Shirt\') then \'T-Shirts\' when NEWWW_CATEGORY in (\'Shirts\',\'Shirt\') then \'Shirts\' when NEWWW_CATEGORY in (\'Jogger\',\'Joggers & Trackpants\') then \'Joggers & Trackpants\' when NEWWW_CATEGORY in (\'Trouser\',\'Trousers\') then \'Trousers\' when NEWWW_CATEGORY in (\'Chinos\',\'Chino\') then \'Chinos\' when NEWWW_CATEGORY in (\'Jackets\',\'Jacket\') then \'Jackets\' when NEWWW_CATEGORY in (\'Boxers\',\'Boxer\') then \'Boxers\' when NEWWW_CATEGORY in (\'Blazers\',\'Blazer\') then \'Blazers\' else NEWWW_CATEGORY end Final_Category FROM ( WITH SALES_2 AS ( WITH SALES AS ( SELECT SKU_GROUP, SUM(SELLING_PRICE) AS Sales, SUM(COALESCE(SUBORDER_QUANTITY, SHIPPING_QUANTITY)) AS Qty FROM SNITCH_DB.MAPLEMONK.UNICOMMERCE_FACT_ITEMS_SNITCH WHERE ORDER_DATE >= DATEADD(DAY, -30, CURRENT_DATE()) AND ORDER_STATUS NOT IN (\'Cancelled\', \'CANCELLED\') AND SKU_GROUP NOT LIKE \'CB%\' AND SELLING_PRICE !=0 GROUP BY SKU_GROUP ), COGS AS ( SELECT DISTINCT SKU_GROUP, MAX(cogs_unit) AS cogs_unit FROM ( SELECT DISTINCT REVERSE(SUBSTRING(REVERSE(\"Item Type skuCode\"), CHARINDEX(\'-\', REVERSE(\"Item Type skuCode\")) + 1)) AS sku_group, COUNT(DISTINCT \"Item Code\") AS inventory, Facility AS branch, SUM(\"Unit price without tax\") AS COGS, \"Unit price without tax\" AS cogs_unit FROM snitch_db.maplemonk.UNICOMMERCE_INVENTORY_AGING GROUP BY sku_group, branch, \"Unit price without tax\" UNION ALL SELECT DISTINCT REVERSE(SUBSTRING(REVERSE(\"Item SkuCode\"), CHARINDEX(\'-\', REVERSE(\"Item SkuCode\")) + 1)) AS sku_group, SUM(inventory) AS inventory, \'WH2\' AS branch, SUM(\"Cost Price\" * inventory) AS COGS, \"Cost Price\" AS cogs_unit FROM snitch_db.maplemonk.snitch_final_inventory_wh2 GROUP BY sku_group, \"Cost Price\" UNION ALL SELECT DISTINCT REVERSE(SUBSTRING(REVERSE(LOGICUSERCODE), CHARINDEX(\'-\', REVERSE(LOGICUSERCODE)) + 1)) AS sku_group, SUM(TOTAL_QTY) AS inventory, \'Offline\' AS branch, SUM(COGS) AS COGS, SUM(COGS) / SUM(TOTAL_QTY) AS PER_UNIT_COGS FROM snitch_db.maplemonk.store_stock_aging WHERE sku_group NOT LIKE \'CB%\' GROUP BY sku_group ) GROUP BY SKU_GROUP ) SELECT A.*, B.cogs_unit, A.QTY * B.cogs_unit AS TOTAL_COGS FROM SALES A LEFT JOIN COGS B ON A.SKU_GROUP = B.SKU_GROUP ), latest_orders AS ( SELECT * FROM ( SELECT sku_group as SKu_Group1, product_name, category, sku_class, ROW_NUMBER() OVER (PARTITION BY sku_group ORDER BY order_timestamp DESC) AS rn FROM snitch_db.maplemonk.fact_items_snitch ) WHERE RN = 1 ) SELECT D.*, F.*, CASE WHEN F.category = \'NA\' THEN \'Shirts\' WHEN F.category IS NULL THEN CASE WHEN D.sku_group LIKE \'4MSN%\' THEN \'Shirt\' WHEN D.sku_group LIKE \'4MST%\' THEN \'T-Shirt\' WHEN D.sku_group LIKE \'4MBX%\' THEN \'Boxer\' WHEN D.sku_group LIKE \'4MSJ%\' THEN \'Jacket\' WHEN D.sku_group LIKE \'4MSNJ%\' THEN \'Jacket\' WHEN D.sku_group LIKE \'4MSW%\' THEN \'Co-Ords\' WHEN D.sku_group LIKE \'4MPJP%\' THEN \'Night Suit & Pyjamas\' WHEN D.sku_group LIKE \'4MTP%\' THEN \'Jogger\' WHEN D.sku_group LIKE \'4MPJ%\' THEN \'Night Suit & Pyjamas\' WHEN D.sku_group LIKE \'4MTR%\' THEN \'Chino\' WHEN D.sku_group LIKE \'4MSH%\' THEN \'Shorts\' WHEN D.sku_group LIKE \'4MSZ%\' THEN \'T-Shirt\' WHEN D.sku_group LIKE \'4MSNBC%\' THEN \'T-Shirt\' WHEN D.sku_group LIKE \'4MSNH%\' THEN \'Shorts\' WHEN D.sku_group LIKE \'4MSQ%\' THEN \'Shirt\' WHEN D.sku_group LIKE \'4MKJ%\' THEN \'Jogger\' WHEN D.sku_group LIKE \'4MSF%\' THEN \'Chino\' WHEN D.sku_group LIKE \'4MJK%\' THEN \'Jacket\' WHEN D.sku_group LIKE \'4MSS%\' THEN \'Shirt\' WHEN D.sku_group LIKE \'4MSWH%\' THEN \'Sweatshirt\' WHEN D.sku_group LIKE \'4MSCR%\' THEN \'Co-Ords\' WHEN D.sku_group LIKE \'4MSK%\' THEN \'Jacket\' WHEN D.sku_group LIKE \'4MSIWB%\' THEN \'Underpants\' WHEN D.sku_group LIKE \'4MSIWT%\' THEN \'Underpants\' WHEN D.sku_group LIKE \'4MSP%\' THEN \'Night Suit & Pyjamas\' WHEN D.sku_group LIKE \'4MSO%\' THEN \'Cargo\' WHEN D.sku_group LIKE \'4MCR%\' THEN \'Co-Ords\' WHEN D.sku_group LIKE \'4MSD%\' THEN \'Denim\' WHEN D.sku_group LIKE \'4MSC%\' THEN \'Chino\' WHEN D.sku_group LIKE \'4MSBX%\' THEN \'Boxer\' WHEN D.sku_group LIKE \'4MSR%\' THEN \'Trouser\' WHEN D.sku_group LIKE \'4MAMST%\' THEN \'T-Shirt\' WHEN D.sku_group LIKE \'4MAC%\' THEN \'Accessories\' WHEN D.sku_group LIKE \'SH%\' THEN \'Shoes\' WHEN D.sku_group LIKE \'SN%\' THEN \'Sunglass\' WHEN D.sku_group LIKE \'4MVK%\' THEN \'Denim\' WHEN D.sku_group LIKE \'4MBZ%\' THEN \'Blazer\' WHEN D.sku_group LIKE \'4MBGSS%\' THEN \'PLUS SIZE SHIRTS\' ELSE F.category END ELSE F.category END AS newww_category FROM SALES_2 D LEFT JOIN latest_orders F ON D.SKU_GROUP = F.SKu_Group1 ) ), consol_Inventory AS ( SELECT sku_group, case when newww in (\'Cargo\',\'Cargo Pants\') then \'Cargo\' when newww in (\'Co-ords\',\'Co-Ords\') then \'Co-ords\' when newww in (\'T-Shirts\',\'T-Shirt\') then \'T-Shirts\' when newww in (\'Shirts\',\'Shirt\') then \'Shirts\' when newww in (\'Jogger\',\'Joggers & Trackpants\') then \'Joggers & Trackpants\' when newww in (\'Trouser\',\'Trousers\') then \'Trousers\' when newww in (\'Chinos\',\'Chino\') then \'Chinos\' when newww in (\'Jackets\',\'Jacket\') then \'Jackets\' when newww in (\'Boxers\',\'Boxer\') then \'Boxers\' when newww in (\'Blazers\',\'Blazer\') then \'Blazers\' else newww end AS Category, product_name,sku_class, SUM(Inventory) AS Inventory, SUM(COGS) AS COGS_IN_HAND FROM ( WITH complete AS ( SELECT REVERSE(SUBSTRING(REVERSE(LOGICUSERCODE), CHARINDEX(\'-\', REVERSE(LOGICUSERCODE)) + 1)) AS sku_group, SUM(TOTAL_QTY) AS inventory, \'Offline\' AS branch, SUM(COGS) AS COGS FROM snitch_db.maplemonk.store_stock_aging WHERE sku_group NOT LIKE \'CB%\' GROUP BY sku_group UNION ALL SELECT REVERSE(SUBSTRING(REVERSE(\"Item Type skuCode\"), CHARINDEX(\'-\', REVERSE(\"Item Type skuCode\")) + 1)) AS sku_group, COUNT(DISTINCT \"Item Code\") AS inventory, Facility AS branch, SUM(\"Unit price without tax\") AS COGS FROM snitch_db.maplemonk.UNICOMMERCE_INVENTORY_AGING WHERE CONVERT_TIMEZONE(\'UTC\', \'Asia/Kolkata\', _airbyte_emitted_at::TIMESTAMP)::DATE = CURRENT_DATE GROUP BY sku_group, branch UNION ALL SELECT REVERSE(SUBSTRING(REVERSE(\"Item SkuCode\"), CHARINDEX(\'-\', REVERSE(\"Item SkuCode\")) + 1)) AS sku_group, SUM(inventory) AS inventory, \'WH2\' AS branch, SUM(\"Cost Price\" * inventory) AS COGS FROM snitch_db.maplemonk.snitch_final_inventory_wh2 WHERE DATE = CURRENT_DATE GROUP BY sku_group ), latest_orders AS ( SELECT sku_group, product_name, category, sku_class, ROW_NUMBER() OVER (PARTITION BY sku_group ORDER BY order_timestamp DESC) AS rn FROM snitch_db.maplemonk.fact_items_snitch ) SELECT a.*, b.product_name, b.category, b.sku_class, CASE WHEN b.category = \'NA\' THEN \'Shirts\' WHEN b.category IS NULL THEN CASE WHEN a.sku_group LIKE \'4MSN%\' THEN \'Shirt\' WHEN a.sku_group LIKE \'4MST%\' THEN \'T-Shirt\' WHEN a.sku_group LIKE \'4MBX%\' THEN \'Boxer\' WHEN a.sku_group LIKE \'4MSJ%\' THEN \'Jacket\' WHEN a.sku_group LIKE \'4MSNJ%\' THEN \'Jacket\' WHEN a.sku_group LIKE \'4MSW%\' THEN \'Co-Ords\' WHEN a.sku_group LIKE \'4MPJP%\' THEN \'Night Suit & Pyjamas\' WHEN a.sku_group LIKE \'4MTP%\' THEN \'Jogger\' WHEN a.sku_group LIKE \'4MPJ%\' THEN \'Night Suit & Pyjamas\' WHEN a.sku_group LIKE \'4MTR%\' THEN \'Chino\' WHEN a.sku_group LIKE \'4MSH%\' THEN \'Shorts\' WHEN a.sku_group LIKE \'4MSZ%\' THEN \'T-Shirt\' WHEN a.sku_group LIKE \'4MSNBC%\' THEN \'T-Shirt\' WHEN a.sku_group LIKE \'4MSNH%\' THEN \'Shorts\' WHEN a.sku_group LIKE \'4MSQ%\' THEN \'Shirt\' WHEN a.sku_group LIKE \'4MKJ%\' THEN \'Jogger\' WHEN a.sku_group LIKE \'4MSF%\' THEN \'Chino\' WHEN a.sku_group LIKE \'4MJK%\' THEN \'Jacket\' WHEN a.sku_group LIKE \'4MSS%\' THEN \'Shirt\' WHEN a.sku_group LIKE \'4MSWH%\' THEN \'Sweatshirt\' WHEN a.sku_group LIKE \'4MSCR%\' THEN \'Co-Ords\' WHEN a.sku_group LIKE \'4MSK%\' THEN \'Jacket\' WHEN a.sku_group LIKE \'4MSIWB%\' THEN \'Underpants\' WHEN a.sku_group LIKE \'4MSIWT%\' THEN \'Underpants\' WHEN a.sku_group LIKE \'4MSP%\' THEN \'Night Suit & Pyjamas\' WHEN a.sku_group LIKE \'4MSO%\' THEN \'Cargo\' WHEN a.sku_group LIKE \'4MCR%\' THEN \'Co-Ords\' WHEN a.sku_group LIKE \'4MSD%\' THEN \'Denim\' WHEN a.sku_group LIKE \'4MSC%\' THEN \'Chino\' WHEN a.sku_group LIKE \'4MSBX%\' THEN \'Boxer\' WHEN a.sku_group LIKE \'4MSR%\' THEN \'Trouser\' WHEN a.sku_group LIKE \'4MAMST%\' THEN \'T-Shirt\' WHEN a.sku_group LIKE \'4MAC%\' THEN \'Accessories\' WHEN a.sku_group LIKE \'SH%\' THEN \'Shoes\' WHEN a.sku_group LIKE \'SN%\' THEN \'Sunglass\' WHEN a.sku_group LIKE \'4MVK%\' THEN \'Denim\' WHEN a.sku_group LIKE \'4MBZ%\' THEN \'Blazer\' WHEN a.sku_group LIKE \'4MBGSS%\' THEN \'PLUS SIZE SHIRTS\' ELSE b.category END ELSE b.category END AS newww FROM complete a LEFT JOIN (SELECT * FROM latest_orders WHERE rn = 1) b ON a.sku_group = b.sku_group ) GROUP BY 1, 2 ,3,4 ) SELECT COALESCE(x.sku_group, y.sku_group) AS sku_group, COALESCE(x.product_name, y.product_name) AS product_name, COALESCE(x.Final_Category, y.category) AS category, COALESCE(y.sku_class, x.sku_class) AS sku_class, y.inventory, y.COGS_IN_HAND, x.sales, x.qty, x.total_cogs FROM MASTER x FULL JOIN consol_Inventory y ON x.sku_group = y.sku_group;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        