{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Products_Intermediate_PV3 as select primary_key ,try_to_date(REPORTDATE,\'yyyy-mm-dd\') REPORTDATE ,RECORDTYPE ,PROFILEID ,campaignId ,campaignName ,adGroupId ,adGroupName ,campaignStatus ,keywordId ,keywordText ,adId ,matchType ,targetId ,targetingType ,targetingExpression ,targetingText ,currency ,asin ,otherAsin ,sku ,impressions ,clicks ,cost ,attributedSales14d ,attributedConversions14d ,attributedSales7d ,attributedConversions7d ,attributedConversions14dSameSKU ,attributedSales14dSameSKU ,attributedSales14dOtherSKU from ( select *,row_number()over(partition by primary_key order by _AIRBYTE_EMITTED_AT desc) as rw2 from (select array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int ,metric:campaignStatus::varchar,metric:keywordId::int,metric:matchType::varchar ,metric:targetId::int,metric:targetingType::varchar,metric:advertisedAsin::varchar,metric:purchasedAsin::varchar,metric:advertisedSku::varchar)),\'\') primary_key ,REPORTDATE ,RECORDTYPE ,PROFILEID ,metric:campaignId::int as campaignId ,metric:campaignName::varchar as campaignName ,metric:adGroupId::int adGroupId ,metric:adGroupName::varchar as adGroupName ,metric:campaignStatus::varchar campaignStatus ,metric:keywordId::int keywordId ,metric:keyword::varchar keywordText ,metric:adId::int adId ,metric:matchType::varchar matchType ,NULL targetId ,NULL targetingType ,NULL targetingExpression ,NULL targetingText ,\'JPY\' currency ,metric:advertisedAsin::varchar asin ,metric:purchasedAsin::varchar otherAsin ,metric:advertisedSku::varchar sku ,metric:impressions::float impressions ,metric:clicks::float clicks ,metric:cost::float cost ,metric:sales14d::float attributedSales14d ,metric:purchases14d::float attributedConversions14d ,metric:sales7d::float attributedSales7d ,metric:purchases7d::float attributedConversions7d ,metric:purchasesSameSku14d::float attributedConversions14dSameSKU ,metric:attributedSalesSameSku14d::float attributedSales14dSameSKU ,metric:salesOtherSku14d::float attributedSales14dOtherSKU ,metric:impressions::float +metric:clicks::float +metric:cost::float +metric:sales14d::float +metric:purchases14d::float+metric:sales7d::float +metric:purchases7d::float as tt ,_AIRBYTE_EMITTED_AT ,row_number()over(partition by array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int ,metric:campaignStatus::varchar,metric:keywordId::int,metric:matchType::varchar,metric:advertisedAsin,metric:purchasedAsin::varchar,metric:advertisedSku::varchar)),\'\') order by metric:impressions::float +metric:clicks::float +metric:cost::float +metric:sales14d::float +metric:purchases14d::float+metric:sales7d::float +metric:purchases7d::float desc) as rw from VAHDAM_DB.MAPLEMONK.AA_DE_PV3_SPONSORED_PRODUCTS_REPORT_STREAM where RECORDTYPE = \'productAds\' ) a where rw =1 or tt>0 ) b where rw2 =1; create or replace table vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Brands_Intermediate_PV3 as select primary_key ,try_to_date(REPORTDATE,\'yyyymmdd\') REPORTDATE ,RECORDTYPE ,PROFILEID ,campaignId ,campaignName ,adGroupId ,adGroupName ,campaignStatus ,campaignBudgetType ,adId ,keywordId ,keywordText ,keywordStatus ,matchType ,targetId ,targetingType ,targetingExpression ,targetingText ,currency ,asin ,otherAsin ,sku ,impressions ,clicks ,cost ,attributedSales14d ,attributedConversions14d ,attributedSales7d ,attributedConversions7d ,attributedOrdersNewToBrand14d ,attributedSalesNewToBrand14d ,attributedUnitsOrderedNewToBrand14d ,attributedConversions14dSameSKU ,attributedSales14dSameSKU ,attributedSales14dOtherSKU from ( select *,row_number()over(partition by primary_key order by _AIRBYTE_EMITTED_AT desc) as rw2 from (select array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int, metric:campaignBudgetType::varchar ,metric:keywordText::varchar, metric:matchType::varchar)),\'\') primary_key ,REPORTDATE ,RECORDTYPE ,PROFILEID ,metric:campaignId::int as campaignId ,metric:campaignName::varchar as campaignName ,metric:adGroupId::int adGroupId ,metric:adGroupName::varchar as adGroupName ,metric:campaignStatus::varchar campaignStatus ,metric:campaignBudgetType::varchar campaignBudgetType ,NULL adId ,metric:keywordText::varchar keywordText ,metric:keywordStatus::varchar keywordStatus ,metric:keywordId::int keywordId ,metric:matchType::varchar matchType ,NULL targetId ,NULL targetingType ,NULL targetingExpression ,NULL targetingText ,\'JPY\' currency ,NULL asin ,NULL otherAsin ,NULL sku ,metric:impressions::float impressions ,metric:clicks::float clicks ,metric:cost::float cost ,metric:attributedSales14d::float attributedSales14d ,metric:attributedConversions14d::float attributedConversions14d ,NULL attributedSales7d ,NULL attributedConversions7d ,metric:attributedOrdersNewToBrand14d::float attributedOrdersNewToBrand14d ,metric:attributedSalesNewToBrand14d::float attributedSalesNewToBrand14d ,metric:attributedUnitsOrderedNewToBrand14d::float attributedUnitsOrderedNewToBrand14d ,metric:attributedConversions14dSameSKU::float attributedConversions14dSameSKU ,metric:attributedSales14dSameSKU::float attributedSales14dSameSKU ,IFNULL(metric:attributedSales14d::float,0)- IFNULL(metric:attributedSales14dSameSKU::float,0) attributedSales14dOtherSKU ,IFNULL(metric:impressions::float,0) +IFNULL(metric:clicks::float,0) +IFNULL(metric:cost::float,0) +IFNULL(metric:attributedSales14d::float,0) +IFNULL(metric:attributedConversions14d::float,0) as tt ,_AIRBYTE_EMITTED_AT ,row_number() over (partition by array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int, metric:campaignBudgetType::varchar ,metric:keywordText::varchar, metric:matchType::varchar)),\'\') order by IFNULL(metric:impressions::float,0) +IFNULL(metric:clicks::float,0) +IFNULL(metric:cost::float,0) +IFNULL(metric:attributedSales14d::float,0) +IFNULL(metric:attributedConversions14d::float,0) desc) as rw from VAHDAM_DB.MAPLEMONK.AA_DE_PV3_SPONSORED_BRANDS_REPORT_STREAM where RECORDTYPE = \'keywords\' ) a where rw =1 or tt>0 ) b where rw2 =1; create or replace table vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Brands_Video_Intermediate_PV3 as select primary_key ,try_to_date(REPORTDATE,\'yyyymmdd\') REPORTDATE ,RECORDTYPE ,PROFILEID ,campaignId ,campaignName ,adGroupId ,adGroupName ,campaignStatus ,campaignBudgetType ,adId ,keywordId ,keywordText ,keywordStatus ,matchType ,targetId ,targetingType ,targetingExpression ,targetingText ,currency ,asin ,otherAsin ,sku ,impressions ,clicks ,cost ,attributedSales14d ,attributedConversions14d ,attributedSales7d ,attributedConversions7d ,attributedConversions14dSameSKU ,attributedSales14dSameSKU ,attributedSales14dOtherSKU from ( select *,row_number()over(partition by primary_key order by _AIRBYTE_EMITTED_AT desc) as rw2 from (select array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int, metric:campaignBudgetType::varchar ,metric:keywordText::varchar, metric:matchType::varchar)),\'\') primary_key ,REPORTDATE ,RECORDTYPE ,PROFILEID ,metric:campaignId::int as campaignId ,metric:campaignName::varchar as campaignName ,metric:adGroupId::int adGroupId ,metric:adGroupName::varchar as adGroupName ,metric:campaignStatus::varchar campaignStatus ,metric:campaignBudgetType::varchar campaignBudgetType ,NULL adId ,metric:keywordText::varchar keywordText ,metric:keywordStatus::varchar keywordStatus ,metric:keywordId::int keywordId ,metric:matchType::varchar matchType ,NULL targetId ,NULL targetingType ,NULL targetingExpression ,NULL targetingText ,\'JPY\' currency ,NULL asin ,NULL otherAsin ,NULL sku ,metric:impressions::float impressions ,metric:clicks::float clicks ,metric:cost::float cost ,metric:attributedSales14d::float attributedSales14d ,metric:attributedConversions14d::float attributedConversions14d ,NULL attributedSales7d ,NULL attributedConversions7d ,metric:attributedConversions14dSameSKU::float attributedConversions14dSameSKU ,metric:attributedSales14dSameSKU::float attributedSales14dSameSKU ,IFNULL(metric:attributedSales14d::float,0)- IFNULL(metric:attributedSales14dSameSKU::float,0) attributedSales14dOtherSKU ,IFNULL(metric:impressions::float,0) +IFNULL(metric:clicks::float,0) +IFNULL(metric:cost::float,0) +IFNULL(metric:attributedSales14d::float,0) +IFNULL(metric:attributedConversions14d::float,0) as tt ,_AIRBYTE_EMITTED_AT ,row_number()over(partition by array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int, metric:campaignBudgetType::varchar ,metric:keywordText::varchar, metric:matchType::varchar)),\'\') order by IFNULL(metric:impressions::float,0) +IFNULL(metric:clicks::float,0) +IFNULL(metric:cost::float,0) +IFNULL(metric:attributedSales14d::float,0) +IFNULL(metric:attributedConversions14d::float,0) DESC) as rw from VAHDAM_DB.MAPLEMONK.AA_DE_PV3_SPONSORED_BRANDS_VIDEO_REPORT_STREAM where RECORDTYPE = \'keywords\' ) a where rw =1 or tt>0 ) b where rw2 =1; create or replace table vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Display_Intermediate_PV3 as select primary_key ,try_to_date(REPORTDATE,\'yyyymmdd\') REPORTDATE ,RECORDTYPE ,PROFILEID ,campaignId ,campaignName ,adGroupId ,adGroupName ,campaignStatus ,campaignBudgetType ,adId ,keywordId ,keywordText ,keywordStatus ,matchType ,targetId ,targetingType ,targetingExpression ,targetingText ,currency ,asin ,otherAsin ,sku ,impressions ,clicks ,cost ,attributedSales14d ,attributedConversions14d ,attributedSales7d ,attributedConversions7d ,attributedOrdersNewToBrand14d ,attributedSalesNewToBrand14d ,attributedUnitsOrderedNewToBrand14d ,attributedConversions14dSameSKU ,attributedSales14dSameSKU ,attributedSales14dOtherSKU from ( select *,row_number()over(partition by primary_key order by _AIRBYTE_EMITTED_AT desc) as rw2 from (select array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int, metric:adId::int, metric:targetId::int, metric:targetingType::varchar, metric:asin::varchar, metric:otherAsin::varchar, metric:sku::varchar)),\'\') primary_key ,REPORTDATE ,RECORDTYPE ,PROFILEID ,metric:campaignId::int as campaignId ,metric:campaignName::varchar as campaignName ,metric:adGroupId::int adGroupId ,metric:adGroupName::varchar as adGroupName ,metric:campaignStatus::varchar campaignStatus ,NULL campaignBudgetType ,NULL keywordText ,NULL keywordStatus ,NULL keywordId ,NULL matchType ,metric:adId::int adId ,metric:targetId::int targetId ,metric:targetingType::varchar targetingType ,metric:targetingExpression::varchar targetingExpression ,metric:targetingText::varchar targetingText ,\'JPY\' currency ,metric:asin::varchar asin ,metric:otherAsin::varchar otherAsin ,metric:sku::varchar sku ,metric:impressions::float impressions ,metric:clicks::float clicks ,metric:cost::float cost ,metric:attributedSales14d::float attributedSales14d ,metric:attributedConversions14d::float attributedConversions14d ,metric:attributedSales7d::float attributedSales7d ,metric:attributedConversions7d::float attributedConversions7d ,metric:attributedOrdersNewToBrand14d::float attributedOrdersNewToBrand14d ,metric:attributedSalesNewToBrand14d::float attributedSalesNewToBrand14d ,metric:attributedUnitsOrderedNewToBrand14d::float attributedUnitsOrderedNewToBrand14d ,metric:attributedConversions14dSameSKU::float attributedConversions14dSameSKU ,metric:attributedSales14dSameSKU::float attributedSales14dSameSKU ,metric:attributedSales14dOtherSKU::float attributedSales14dOtherSKU ,IFNULL(metric:impressions::float,0) +IFNULL(metric:clicks::float,0) +IFNULL(metric:cost::float,0) +IFNULL(metric:attributedSales14d::float,0) +IFNULL(metric:attributedConversions14d::float,0)+IFNULL(metric:attributedSales7d::float,0) +IFNULL(metric:attributedConversions7d::float,0) as tt ,_AIRBYTE_EMITTED_AT ,row_number()over(partition by array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int, metric:adId::int, metric:targetId::int, metric:targetingType::varchar, metric:asin::varchar, metric:otherAsin::varchar, metric:sku::varchar)),\'\') order by IFNULL(metric:impressions::float,0) +IFNULL(metric:clicks::float,0) +IFNULL(metric:cost::float,0) +IFNULL(metric:attributedSales14d::float,0) +IFNULL(metric:attributedConversions14d::float,0)+IFNULL(metric:attributedSales7d::float,0) +IFNULL(metric:attributedConversions7d::float,0) desc) as rw from VAHDAM_DB.MAPLEMONK.AA_DE_PV3_SPONSORED_DISPLAY_REPORT_STREAM where RECORDTYPE = \'productAds\' ) a where rw =1 or tt>0 ) b where rw2 =1; CREATE OR REPLACE TABLE VAHDAM_DB.MAPLEMONK.AMAZONADS_DE_MARKETING_PV3 AS with orders as ( select \"purchase-date\"::date as order_date, asin, sum(ifnull(try_cast(\"item-price\" as float),0) - ifnull(try_cast(\"item-promotion-discount\" as float),0)) as sales, count(distinct \"amazon-order-id\") as orders, sum(Quantity) as quantity from (SELECT *, CONVERT_TIMEZONE(\'UTC\',\'Europe/Berlin\', \"purchase-date\":: DATETIME) as \"Purchase-datetime-PDT\" FROM Vahdam_db.maplemonk.ASP_UK_GET_FLAT_FILE_ALL_ORDERS_DATA_BY_LAST_UPDATE_GENERAL)X where \"sales-channel\" = \'Amazon.de\' group by 1,2 ), sessions as (select datastarttime, childasin, sum(trafficbyasin:sessions::float) as sessions, sum(trafficbyasin:pageViews::float) as pageviews from vahdam_db.maplemonk.asp_de_get_sales_and_traffic_report_asin group by 1,2), amazon as ( SELECT \'Sponsored Products\' CAMPAIGN_TYPE, sp.PROFILEID ,sp.REPORTDATE AS Date ,sp.CampaignId ,sp.campaignName ,sp.adGroupId ,sp.adGroupName ,sp.keywordText ,sp.campaignStatus ,sp.ASIN as Asin ,sp.adId ,sp.targetingExpression ,sp.targetingText ,sp.currency ,Null as NewToBrandOrders ,Null as NewToBrandSales ,Null as NewToBrandUnits ,sum(sp.impressions) as Impressions ,sum(sp.clicks) as Clicks ,sum(sp.cost) as Spend ,sum(sp.attributedSales7d) as Sales ,sum(sp.attributedConversions7d) as Conversions ,sum(sp.attributedConversions14dSameSKU) as ConversionsSameSKU ,sum(sp.attributedSales14dSameSKU) as SalesSameSKU ,sum(sp.attributedSales14dOtherSKU) as OtherSKUSales ,(sum(sp.attributedConversions14d) - sum(sp.attributedConversions14dSameSKU)) as ConversionsOtherSKU FROM vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Products_Intermediate_PV3 sp WHERE sp.RECORDTYPE = \'productAds\' GROUP BY sp.REPORTDATE, sp.PROFILEID, sp.campaignId, sp.campaignName, sp.adGroupId, sp.adGroupName, sp.keywordText ,sp.campaignStatus, sp.ASIN, sp.adId, sp.targetingExpression, sp.targetingText, sp.targetingType, sp.currency UNION SELECT \'Sponsored Display\' CAMPAIGN_TYPE, sd.PROFILEID ,sd.REPORTDATE AS Date ,sd.campaignId as CampaignID ,sd.campaignName as CampaignName ,sd.adGroupId as AdGroupId ,sd.adGroupName as AdGroupName ,sd.keywordText as Keywordtext ,sd.campaignStatus as CampaignStatus ,sd.asin as Asin ,sd.adId as AdId ,sd.targetingExpression as TargetingExpression ,sd.targetingText as TargetingText ,sd.currency as Currency ,sum(sd.attributedOrdersNewToBrand14d) as NewToBrandOrders ,sum(sd.attributedSalesNewToBrand14d) as NewToBrandSales ,sum(sd.attributedUnitsOrderedNewToBrand14d) as NewToBrandUnits ,sum(sd.impressions) as Impressions ,sum(sd.clicks) as Clicks ,sum(sd.cost) as Spend ,sum(sd.attributedSales7d) as Sales ,sum(sd.attributedConversions7d) as Conversions ,sum(sd.attributedConversions14dSameSKU) as ConversionsSameSKU ,sum(sd.attributedSales14dSameSKU) as SalesSameSKU ,sum(sd.attributedSales14dOtherSKU) as OtherSKUSales ,(sum(sd.attributedConversions14d) - sum(sd.attributedConversions14dSameSKU)) as ConversionsOtherSKU FROM vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Display_Intermediate_PV3 sd WHERE sd.RECORDTYPE = \'productAds\' GROUP BY sd.REPORTDATE, sd.PROFILEID, sd.campaignId, sd.campaignName, sd.adGroupId, sd.adGroupName, sd.keywordText, sd.campaignStatus ,sd.ASIN, sd.adId ,sd.targetingExpression, sd.targetingText, sd.targetingType, sd.currency UNION SELECT \'Sponsored Brands\' CAMPAIGN_TYPE, sb.PROFILEID ,sb.REPORTDATE AS Date ,sb.campaignId as CampaignID ,sb.campaignName as CampaignName ,sb.adGroupId as AdGroupId ,sb.adGroupName as AdGroupName ,sb.keywordText as Keywordtext ,sb.campaignStatus as CampaignStatus ,sb.asin as Asin ,sb.adId as AdId ,sb.targetingExpression as TargetingExpression ,sb.targetingText as TargetingText ,sb.currency as Currency ,sum(sb.attributedOrdersNewToBrand14d) as NewToBrandOrders ,sum(sb.attributedSalesNewToBrand14d) as NewToBrandSales ,sum(sb.attributedUnitsOrderedNewToBrand14d) as NewToBrandUnits ,sum(sb.impressions) as Impressions ,sum(sb.clicks) as Clicks ,sum(sb.cost) as Spend ,sum(sb.attributedSales14d) as Sales ,sum(sb.attributedConversions14d) as Conversions ,sum(sb.attributedConversions14dSameSKU) as ConversionsSameSKU ,sum(sb.attributedSales14dSameSKU) as SalesSameSKU ,sum(sb.attributedSales14dOtherSKU) as SalesOtherSKU ,(sum(sb.attributedConversions14d) - sum(sb.attributedConversions14dSameSKU)) as ConversionsOtherSKU FROM vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Brands_Intermediate_PV3 sb WHERE sb.RECORDTYPE = \'keywords\' GROUP BY sb.REPORTDATE, sb.PROFILEID, sb.campaignId, sb.campaignName, sb.adGroupId, sb.adGroupName, sb.keywordText ,sb.campaignStatus, sb.ASIN, sb.adId, sb.targetingExpression, sb.targetingText, sb.targetingType, sb.currency UNION SELECT \'Sponsored Brands Video\' CAMPAIGN_TYPE, sbv.PROFILEID ,sbv.REPORTDATE AS Date ,sbv.campaignId as CampaignID ,sbv.campaignName as CampaignName ,sbv.adGroupId as AdGroupId ,sbv.adGroupName as AdGroupName ,sbv.keywordText as Keywordtext ,sbv.campaignStatus as CampaignStatus ,sbv.asin as Asin ,sbv.adId as AdId ,sbv.targetingExpression as TargetingExpression ,sbv.targetingText as TargetingText ,sbv.currency as Currency ,Null as NewToBrandOrders ,Null as NewToBrandSales ,Null as NewToBrandUnits ,sum(sbv.impressions) as Impressions ,sum(sbv.clicks) as Clicks ,sum(sbv.cost) as Spend ,sum(sbv.attributedSales14d) as Sales ,sum(sbv.attributedConversions14d) as Conversions ,sum(sbv.attributedConversions14dSameSKU) as ConversionsSameSKU ,sum(sbv.attributedSales14dSameSKU) as SalesSameSKU ,sum(sbv.attributedSales14dOtherSKU) as SalesOtherSKU ,(sum(sbv.attributedConversions14d) - sum(sbv.attributedConversions14dSameSKU)) as ConversionsOtherSKU FROM vahdam_db.maplemonk.AA_DE_NEW_Sponsored_Brands_Video_Intermediate_PV3 sbv WHERE sbv.RECORDTYPE = \'keywords\' GROUP BY sbv.REPORTDATE, sbv.PROFILEID, sbv.campaignId, sbv.campaignName, sbv.adGroupId, sbv.adGroupName , sbv.keywordText, sbv.campaignStatus, sbv.asin, sbv.adId, sbv.targetingExpression, sbv.targetingText , sbv.targetingType, sbv.currency ) select coalesce(c.date, s.datastarttime) as date, coalesce(c.asin, s.childasin) as asin, c.CAMPAIGN_TYPE, c.PROFILEID ,c.CampaignID, c.CampaignName, c.AdGroupId, c.AdGroupName, c.KeywordText ,c.CampaignStatus, c.AdId, c.TargetingExpression, c.TargetingText, c.Currency, c.NewToBrandOrders, c.NewToBrandSales ,c.NewToBrandUnits, c.Impressions, c.Clicks, c.spend, c.Sales, c.Conversions, c.ConversionsSameSKU, c.SalesSameSKU ,c.OtherSKUSales, c.ConversionsOtherSKU, c.sales_usd, c.orders, c.quantity ,s.sessions/count(1)over(partition by coalesce(c.date, s.datastarttime), coalesce(c.asin, s.childasin)) as sessions ,s.pageviews/count(1)over(partition by coalesce(c.date, s.datastarttime), coalesce(c.asin, s.childasin)) as pageviews from (select coalesce(a.date, o.order_date::date) as date, coalesce(a.asin, o.asin) as asin ,a.CAMPAIGN_TYPE, a.PROFILEID, a.CampaignID, a.CampaignName, a.AdGroupId, a.AdGroupName, a.KeywordText ,a.CampaignStatus, a.AdId, a.TargetingExpression, a.TargetingText, a.Currency, a.NewToBrandOrders, a.NewToBrandSales ,a.NewToBrandUnits, a.Impressions, a.Clicks, a.spend, a.Sales, a.Conversions, a.ConversionsSameSKU, a.SalesSameSKU ,a.OtherSKUSales, a.ConversionsOtherSKU ,o.Sales/count(1)over(partition by coalesce(a.date, o.order_date::date),coalesce(a.asin, o.asin)) as Sales_usd ,o.orders/count(1)over(partition by coalesce(a.date, o.order_date::date),coalesce(a.asin, o.asin)) as orders ,o.quantity/count(1)over(partition by coalesce(a.date, o.order_date::date),coalesce(a.asin, o.asin)) as quantity from amazon a full outer join orders o on a.asin = o.asin and order_date::date = a.Date::date) c full outer join sessions s on c.asin = s.childasin and c.date = s.datastarttime where coalesce(c.date, s.datastarttime) > \'2022-05-26\'; create or replace table vahdam_db.maplemonk.amazonads_de_marketing_mapping_intermediate_PV3 as select a.*, coalesce(b.\"Amazon DE\", a.asin) as ASIN_Mapping from vahdam_db.maplemonk.AMAZONADS_DE_MARKETING_PV3 a left join (select \"Amazon DE\" ,weight ,brand ,\"Mother SKU\" ,\"Common Name\" ,category ,\"SUB CATEGORY\" ,\"LOOSE/TEA BAG/ POWDER\" ,\"Common SKU Description\" ,\"COMMON SKU ID\" ,row_number() over (partition by \"Amazon DE\" order by \"Amazon DE\") as rw from vahdam_db.maplemonk.sku_mapping_raw_data) b on a.asin = b.\"Amazon DE\" where (rw = 1 or rw is null) and (a.campaign_type in (\'Sponsored Products\', \'Sponsored Display\') and date>\'2022-03-23\' or a.campaign_type is null) union select a.*, coalesce (b.\"Amazon DE\", c.ASIN, case when contains(campaignname,\'B0\') then left(right(campaignname, length(campaignname)-position(\'B0\',campaignname)+1),10) end) as ASIN_Mapping from vahdam_db.maplemonk.AMAZONADS_DE_MARKETING_PV3 a left join (select \"Amazon DE\" ,weight ,brand ,\"Mother SKU\" ,\"Common Name\" ,category ,\"SUB CATEGORY\" ,\"LOOSE/TEA BAG/ POWDER\" ,\"Common SKU Description\" ,\"COMMON SKU ID\" ,row_number() over (partition by \"Amazon DE\" order by \"Amazon DE\") as rw from vahdam_db.maplemonk.sku_mapping_raw_data) b on case when contains(campaignname,\'B0\') then left(right(campaignname, length(campaignname)-position(\'B0\',campaignname)+1),10) end = b.\"Amazon DE\" left join (select distinct \"Campaign Name\", ASIN from \"VAHDAM_DB\".\"MAPLEMONK\".\"AA_SBV_MANUAL_MAPPING_DE_VA_MAP\") c on a.campaignname = c.\"Campaign Name\" where (b.rw = 1 or b.rw is null) and a.campaign_type in (\'Sponsored Brands\', \'Sponsored Brands Video\') and date>\'2022-03-23\'; create or replace table vahdam_db.maplemonk.AMAZONADS_DE_MARKETING_PV3 as select a.* ,coalesce(b.\"Amazon DE\", a.asin, a.asin_mapping) as ASIN_New ,b.weight ,b.brand ,b.\"Mother SKU\" ,b.category ,b.\"SUB CATEGORY\" ,b.\"LOOSE/TEA BAG/ POWDER\" ,b.\"Common SKU Description\" ,b.\"COMMON SKU ID\" ,null as Typeofpack from vahdam_db.maplemonk.amazonads_de_marketing_mapping_intermediate_PV3 a left join (select \"Amazon DE\" ,weight ,brand ,\"Mother SKU\" ,\"Common Name\" ,category ,\"SUB CATEGORY\" ,\"LOOSE/TEA BAG/ POWDER\" ,\"Common SKU Description\" ,\"COMMON SKU ID\" ,row_number() over (partition by \"Amazon DE\" order by \"Amazon DE\") as rw from vahdam_db.maplemonk.sku_mapping_raw_data) b on a.ASIN_Mapping = b.\"Amazon DE\" where (b.rw = 1 or b.rw is null); create or replace table VAHDAM_DB.MAPLEMONK.AMAZONADS_DE_MARKETING as select DATE ,ASIN ,CAMPAIGN_TYPE ,PROFILEID ,CAMPAIGNID ,CAMPAIGNNAME ,ADGROUPID ,ADGROUPNAME ,KEYWORDTEXT ,CAMPAIGNSTATUS ,ADID ,TARGETINGEXPRESSION ,TARGETINGTEXT ,CURRENCY ,NEWTOBRANDORDERS ,NEWTOBRANDSALES ,NEWTOBRANDUNITS ,IMPRESSIONS ,CLICKS ,SPEND ,SALES ,CONVERSIONS ,CONVERSIONSSAMESKU ,SALESSAMESKU ,OTHERSKUSALES ,CONVERSIONSOTHERSKU ,SALES_USD ,ORDERS ,QUANTITY ,SESSIONS ,PAGEVIEWS ,ASIN_MAPPING ,ASIN_NEW ,WEIGHT ,BRAND BRAND ,MOTHER_SKU \"Mother SKU\" ,PRODUCTCATEGORY CATEGORY ,TYPEOFTEA \"SUB CATEGORY\" ,TYPEOFPRODUCT \"LOOSE/TEA BAG/ POWDER\" ,PRODUCTNAME \"Common SKU Description\" ,COMMONSKU_ID \"COMMON SKU ID\" ,TYPEOFPACK from VAHDAM_DB.MAPLEMONK.AMAZONADS_DE_MARKETING_PV2_Consol where PROFILEID Not in (\'4162256033897995\') or PROFILEID is null and date < \'2023-10-01\' union all select DATE ,ASIN ,CAMPAIGN_TYPE ,PROFILEID ,CAMPAIGNID ,CAMPAIGNNAME ,ADGROUPID ,ADGROUPNAME ,KEYWORDTEXT ,CAMPAIGNSTATUS ,ADID ,TARGETINGEXPRESSION ,TARGETINGTEXT ,CURRENCY ,NEWTOBRANDORDERS ,NEWTOBRANDSALES ,NEWTOBRANDUNITS ,IMPRESSIONS ,CLICKS ,SPEND ,SALES ,CONVERSIONS ,CONVERSIONSSAMESKU ,SALESSAMESKU ,OTHERSKUSALES ,CONVERSIONSOTHERSKU ,SALES_USD ,ORDERS ,QUANTITY ,SESSIONS ,PAGEVIEWS ,ASIN_MAPPING ,ASIN_NEW ,WEIGHT ,BRAND ,\"Mother SKU\" ,CATEGORY ,\"SUB CATEGORY\" ,\"LOOSE/TEA BAG/ POWDER\" ,\"Common SKU Description\" ,\"COMMON SKU ID\" ,TYPEOFPACK from VAHDAM_DB.MAPLEMONK.AMAZONADS_DE_MARKETING_PV3 where PROFILEID Not in (\'4162256033897995\') or PROFILEID is null and date >= \'2023-10-01\';",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from VAHDAM_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        