{{ config(
            materialized='table',
                post_hook={
                    "sql": "create or replace table snitch_db.maplemonk.customer_segments_rfm as ( WITH base AS ( SELECT \"Email\" as \"id_email\",\"Phone\" as \"id_phone\", \"First_name\" as \"id_name\", DATEDIFF(\'day\', \"Last_order_date\", CURRENT_DATE) AS recency_score, \"Net_orders\" AS frequency_score, \"Total_revenue\" AS monetary_score, \"Pincode\", \"District\", \"State_name\", \"Last_name\", \"First_order_date\", \"Last_order_date\", last1_months_orders, last3_months_orders, last6_months_orders, last12_months_orders, average_time_duration_between_purchase, time_between_1_2_order, time_between_2_3_order, \"Net_units\", \"Total_revenue\", div0(\"Total_revenue\",\"Net_units\") as aov, \"Return_percentage\", \"Discount%\", \"Cancel_percentage\", \"Total_discount\", recommended_size, cod_percentage, prepaid_percentage, frequently_purchased_productcategory, frequently_purchased_sku_group, average_selling_price FROM snitch_db.snitch.customer_master_view_shopify_extension ), quartiles AS ( SELECT PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY frequency_score) AS Q1f, PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY frequency_score) AS Q2f, PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY frequency_score) AS Q3f, PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY monetary_score) AS Q1m, PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY monetary_score) AS Q2m, PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY monetary_score) AS Q3m, PERCENTILE_CONT(0.25) WITHIN GROUP (ORDER BY recency_score) AS Q1r, PERCENTILE_CONT(0.50) WITHIN GROUP (ORDER BY recency_score) AS Q2r, PERCENTILE_CONT(0.75) WITHIN GROUP (ORDER BY recency_score) AS Q3r FROM base ), main_data AS ( SELECT b.*, q.Q1m, q.Q2m, q.Q3m, CASE WHEN b.recency_score <= q.Q1r THEN \'High\' WHEN b.recency_score <= q.Q2r AND b.recency_score > q.Q1r THEN \'Medium\' ELSE \'Low\' END AS recency_category, CASE WHEN b.frequency_score > 2 THEN \'High\' WHEN b.frequency_score = 2 THEN \'Medium\' WHEN b.frequency_score = 1 THEN \'Low\' ELSE \'Very_Low\' END AS frequency_category, CASE WHEN b.monetary_score >= q.Q3m THEN \'High\' WHEN b.monetary_score >= q.Q2m AND b.monetary_score < q.Q3m THEN \'Medium\' ELSE \'Low\' END AS monetary_category FROM base b, quartiles q ), categorized_data AS ( SELECT \"id_email\",\"id_phone\",\"id_name\",recency_score,frequency_score,monetary_score, \"Pincode\", \"District\", \"State_name\", \"Last_name\", \"First_order_date\", \"Last_order_date\", last1_months_orders, last3_months_orders, last6_months_orders, last12_months_orders, average_time_duration_between_purchase, time_between_1_2_order, time_between_2_3_order, \"Net_units\", \"Total_revenue\", aov, \"Return_percentage\", \"Discount%\", \"Cancel_percentage\", \"Total_discount\", recommended_size, cod_percentage, prepaid_percentage, frequently_purchased_productcategory, frequently_purchased_sku_group, average_selling_price, recency_category AS recency, frequency_category AS frequency, monetary_category AS monetary, CASE WHEN frequency = \'High\' AND monetary = \'High\' AND recency = \'High\' THEN \'Best\' WHEN frequency = \'Medium\' AND monetary = \'High\' AND recency = \'High\' THEN \'Big_spenders\' WHEN frequency = \'High\' AND monetary = \'High\' AND recency = \'Medium\' THEN \'Consistent_spenders\' WHEN frequency = \'Medium\' AND monetary = \'Medium\' AND recency = \'High\' THEN \'Recent_buyers_high_spenders\' WHEN frequency = \'High\' AND monetary = \'Medium\' AND recency = \'High\' THEN \'Loyal_medium_spenders\' WHEN frequency = \'Medium\' AND monetary = \'Low\' AND recency = \'High\' THEN \'Recent_buyers_low_spenders\' WHEN frequency = \'High\' AND monetary = \'Low\' AND recency = \'High\' THEN \'Loyal_low_spenders\' WHEN frequency = \'High\' AND monetary = \'Low\' AND recency = \'Medium\' THEN \'Potential_loyalists_high_spenders\' WHEN frequency = \'High\' AND monetary = \'Medium\' AND recency = \'Medium\' THEN \'Potential_loyalists_low_spenders\' WHEN frequency = \'Low\' AND monetary = \'High\' AND recency = \'High\' THEN \'Recent_big_spenders\' WHEN frequency = \'Low\' AND monetary = \'Low\' AND recency = \'High\' THEN \'New_customers_low_spenders\' WHEN frequency = \'Low\' AND monetary = \'Medium\' AND recency = \'High\' THEN \'New_customers_medium_spenders\' WHEN frequency = \'High\' AND monetary = \'High\' AND recency = \'Low\' THEN \'Dormant_VIPs\' WHEN frequency = \'Medium\' AND monetary = \'High\' AND recency = \'Low\' THEN \'High_potential_lapsed\' WHEN frequency = \'High\' AND monetary = \'Low\' AND recency = \'Low\' THEN \'Dormant_loyalists_low_spenders\' WHEN frequency = \'High\' AND monetary = \'Medium\' AND recency = \'Low\' THEN \'Dormant_loyalists_medium_spenders\' WHEN frequency = \'Low\' AND monetary = \'High\' AND recency = \'Medium\' THEN \'High_value_infrequent_buyers\' WHEN frequency = \'Medium\' AND monetary = \'High\' AND recency = \'Medium\' THEN \'Occassional_big_spenders\' WHEN frequency = \'Medium\' AND monetary = \'Low\' AND recency = \'Medium\' THEN \'Active_customers_low_spenders\' WHEN frequency = \'Low\' AND monetary = \'Medium\' AND recency = \'Medium\' THEN \'Lapsed_customers\' WHEN frequency = \'Medium\' AND monetary = \'Medium\' AND recency = \'Medium\' THEN \'Active_customers_medium_spenders\' WHEN frequency = \'Low\' AND monetary = \'High\' AND recency = \'Low\' THEN \'High_value_lost_customers\' WHEN frequency = \'Low\' AND monetary = \'Low\' AND recency = \'Low\' THEN \'Lost_causes\' WHEN frequency = \'Medium\' AND monetary = \'Low\' AND recency = \'Low\' THEN \'Inactive_customers\' WHEN frequency = \'Very_Low\' AND monetary = \'Low\' AND recency = \'Low\' THEN \'Inactive_customers\' WHEN frequency = \'Low\' AND monetary = \'Medium\' AND recency = \'Low\' THEN \'Inactive_customers\' WHEN frequency = \'Medium\' AND monetary = \'Medium\' AND recency = \'Low\' THEN \'Inactive_customers\' WHEN frequency = \'Low\' AND monetary = \'Low\' AND recency = \'Medium\' THEN \'Inactive_customers\' END AS customer_category FROM main_data ) SELECT \"id_name\", \"id_email\" as \"identity\", \"id_phone\", customer_category, recency_score as Last_purchased_days, frequency_score as Net_orders, monetary_score as total_revenue, \"Pincode\", \"District\", \"State_name\", \"Last_name\", last1_months_orders, last3_months_orders, last6_months_orders, last12_months_orders, average_time_duration_between_purchase, time_between_1_2_order, time_between_2_3_order, \"Net_units\", aov, \"Return_percentage\", \"Discount%\", \"Cancel_percentage\", \"Total_discount\", recommended_size, cod_percentage, prepaid_percentage, frequently_purchased_productcategory, frequently_purchased_sku_group, average_selling_price from categorized_data where trim(lower(\"id_email\")) like \'%@%\' and length(\"id_phone\") = 13 and REGEXP_LIKE(\"id_phone\", \'^[0-9\+]+$\') and \"id_name\" IS NOT NULL AND \"identity\" IS NOT NULL AND \"id_phone\" IS NOT NULL AND customer_category IS NOT NULL AND recency_score IS NOT NULL AND frequency_score IS NOT NULL AND monetary_score IS NOT NULL AND \"Pincode\" IS NOT NULL AND \"District\" IS NOT NULL AND \"State_name\" IS NOT NULL AND \"Last_name\" IS NOT NULL );",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            