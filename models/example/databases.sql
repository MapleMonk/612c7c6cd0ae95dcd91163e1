{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table snitch_db.maplemonk.Fabric_orders as SELECT \'PF\' AS Vendor, \"SKU name\", LINK, METERS, \"DC COPY\" AS \"DC COPY\", FACTORY, \"RATE/MTR\" AS \"RATE/MTR\", \"BILL COPY\" AS \"BILL COPY\", \"LEAD TIME\" AS \"LEAD TIME\", DISPATCHED, \"SNITCH SKU\" AS \"SNITCH SKU\", to_date(\"Order Placed\",\'DD/MM/YYYY\') AS \"Order Placed\", CONFIRMATION AS CONFIRMATION, \"FABRIC DESIGN\" AS \"FABRIC DESIGN\", \"dispatch ready\" AS \"Goods Ready\" FROM snitch_db.maplemonk.consol_pf UNION SELECT \'Artex\' AS Vendor, \"SKU name\", LINK, METERS, \"DC COPY\" AS \"DC COPY\", FACTORY, \"RATE/MTR\" AS \"RATE/MTR\", \"BILL COPY\" AS \"BILL COPY\", \"LEAD TIME\" AS \"LEAD TIME\", DISPATCHED, \"SNITCH SKU\" AS \"SNITCH SKU\", to_date(\"Order Placed\",\'DD/MM/YYYY\') AS \"Order Placed\", \"Order Confirmation\" AS CONFIRMATION, \"FABRIC DESIGN\" AS \"FABRIC DESIGN\", \"Goods Ready\" AS \"Goods Ready\" FROM snitch_db.maplemonk.CONSOL_ARTEX where \"Order Placed\" != \'Order Placed\'; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.EOQ_TABLE_V2 AS SELECT eoq.*, shipped_eoq.shipped_from_factory, shipped_eoq.expected_del_date AS shipped_expected_del_date, shipped_eoq.dispatched_qty, factory_up_ytbc_eoq.YTBC_factory, factory_up_ytbc_eoq.YTBC_expected_del_date, factory_up_ytbc_eoq.YTBC_cut_qty, factory_up_ytbc_eoq.YTBC_status, Fabric_orders.Vendor as Mill, Fabric_orders.\"Order Placed\", Fabric_orders.CONFIRMATION, Fabric_orders.METERS, CASE WHEN LOWER(Fabric_orders.CONFIRMATION) = \'no\' THEN \'Fabric Order Placed Yet To be Confirmed\' WHEN LOWER(Fabric_orders.CONFIRMATION) = \'yes\' THEN \'Fabric Order Placed & Confirmed\' WHEN Fabric_orders.CONFIRMATION IS NULL THEN \'Fabric Order Yet to be Placed\' END AS Fabric_Status, BEST_CHANNELS.\"Best Seller Channel\", FACTORY_SUGGESTION.factory_ AS FACTORY_SUGGESTION FROM snitch_db.maplemonk.eoq LEFT JOIN ( Select \"SKU_NO.\" as Sku_group, factory as shipped_from_factory, expected_del_date , total_online_qty as dispatched_qty from ( Select \"SKU_NO.\",factory,total_online_qty,TO_DATE(delivery_planned_date, \'DD/MM/YYYY\') as expected_del_date from snitch_db.maplemonk.hsk_inventory where STATUS IS NULL UNION ALL Select \"SKU_NO.\",factory,total_online_qty,TO_DATE(delivery_planned_date, \'DD-MM-YYYY\') as expected_del_date from snitch_db.maplemonk.YLK_INVENTORY where REMARK IS NULL UNION ALL Select \"SKU_NO.\",factory,total_online_qty,TO_DATE(delivery_planned_date, \'DD/MM/YYYY\') as expected_del_date from snitch_db.maplemonk.EMIZA_INVENTORY where REMARK IS NULL ) ) shipped_eoq ON eoq.sku_group = shipped_eoq.Sku_group LEFT JOIN ( SELECT adjusted_sku AS sku_group, factory_ AS YTBC_factory, expected_del_date AS YTBC_expected_del_date, CUT_QTY AS YTBC_cut_qty, \'YTBC\' AS YTBC_status FROM ( SELECT SKU_Number, CASE WHEN SKU_Number LIKE \'R%\' THEN SUBSTR(SKU_Number, 2) ELSE SKU_Number END AS adjusted_sku, factory_, CASE WHEN Expected_Delivery_Date IS NULL THEN CASE WHEN TRY_TO_DATE(DATE_ISSUED, \'DD-MM-YYYY\') IS NOT NULL THEN TO_DATE(DATE_ISSUED, \'DD-MM-YYYY\') + INTERVAL \'60 DAY\' WHEN TRY_TO_DATE(DATE_ISSUED, \'YYYY-MM-DD\') IS NOT NULL THEN TO_DATE(DATE_ISSUED, \'YYYY-MM-DD\') + INTERVAL \'60 DAY\' ELSE NULL END ELSE CASE WHEN TRY_TO_DATE(Expected_Delivery_Date, \'YYYY-MM-DD\') IS NOT NULL THEN TO_DATE(Expected_Delivery_Date, \'YYYY-MM-DD\') WHEN TRY_TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\') IS NOT NULL THEN TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\') ELSE NULL END END AS expected_del_date, CUT_QTY, \'YTBC\' AS Status, COUNT(CASE WHEN TRY_CAST(CUT_QTY AS INT) IS NULL THEN SKU_Number END) AS Yet_to_be_cut, CASE WHEN COUNT(CASE WHEN TRY_CAST(CUT_QTY AS INT) IS NULL THEN SKU_Number END) = 1 THEN \'YTBC\' ELSE \'DONE\' END AS STATUS_1 FROM snitch_db.maplemonk.PRODUCT_TRACKING_HIDDEN_MAIN GROUP BY SKU_Number, adjusted_sku, factory_, expected_del_date, CUT_QTY ) sub WHERE STATUS_1 = \'YTBC\' ) factory_up_ytbc_eoq ON eoq.sku_group = factory_up_ytbc_eoq.sku_group LEFT JOIN ( SELECT \"SNITCH SKU\", Vendor, \"Order Placed\", CONFIRMATION, METERS FROM snitch_db.maplemonk.Fabric_orders ) Fabric_orders ON eoq.sku_group = Fabric_orders.\"SNITCH SKU\" LEFT JOIN ( SELECT SKU_GROUP AS sku_group, MARKETPLACE_MAPPED AS \"Best Seller Channel\" FROM ( SELECT SKU_GROUP, MARKETPLACE_MAPPED, SKU_CLASS, ROUND(SUM(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) / 100, 0) AS PRICE_POINT, SUM(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) AS SELLING_PRICE_TOTAL, SUM(NULLIF(SHIPPING_QUANTITY, 0)) AS total_quantity, ROUND(SUM(NULLIF(SHIPPING_QUANTITY, 0)) / 10, 0) AS QUANTITY_POINT, MAX(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) AS MAX, MIN(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) AS MIN, AVG(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END / NULLIF(SHIPPING_QUANTITY, 0)) AS average_asp, ROUND((AVG(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END / NULLIF(SHIPPING_QUANTITY, 0))) / 100, 0) AS average_asp_POINT, ROW_NUMBER() OVER (PARTITION BY SKU_GROUP ORDER BY QUANTITY_POINT DESC, average_asp_POINT DESC) AS marketplace_rank, MAX(MRP) AS MRP FROM snitch_db.maplemonk.unicommerce_fact_items_snitch WHERE ORDER_STATUS = \'COMPLETE\' AND ORDER_DATE > DATEADD(DAY, -120, CURRENT_DATE()) AND SELLING_PRICE > 0 GROUP BY SKU_GROUP, MARKETPLACE_MAPPED, SKU_CLASS ) sub WHERE marketplace_rank = 1 ) BEST_CHANNELS ON eoq.sku_group = BEST_CHANNELS.sku_group LEFT JOIN ( SELECT adjusted_sku, factory_ FROM ( SELECT CASE WHEN \"SKU Number\" LIKE \'R%\' THEN SUBSTR(\"SKU Number\", 2) ELSE \"SKU Number\" END AS adjusted_sku, case when \"Factory Vendor Code\" in (\'01 - SSTC\', \'03 - Leandro\', \'13 - Kharva\', \'18 - Expert\', \'16 - Thandeshwara\', \'09 - Nalanda\', \'05 - Sai Textiles\', \'06 - Alagesh\', \'MQ - M Square\', \'14 - Lohith Creations\', \'IN - Mohit\', \'19 - S R Apparels\', \'Navkar\', \'02 - Kasturi Creation\', \'08 - Vignesh\', \'21-BLUE MONKEY\', \'KU - Kunal\', \'AC - Asian Clothing\', \'07 - K P\', \'15 - Prestige\', \'VN - Vanitha Garments\', \'10 - Adeep \') then \"Factory Vendor Code\" else factory end as factory_, TO_DATE(\"Date Issued\", \'DD-MM-YYYY\') AS DATE, ROW_NUMBER() OVER (PARTITION BY CASE WHEN \"SKU Number\" LIKE \'R%\' THEN SUBSTR(\"SKU Number\", 2) ELSE \"SKU Number\" END ORDER BY TO_DATE(\"Date Issued\", \'DD-MM-YYYY\') DESC) AS RN FROM snitch_db.maplemonk.PRODUCT_TRACKING_HIDDEN_SHIPPED ) sub WHERE RN = 1 ) FACTORY_SUGGESTION ON eoq.sku_group = FACTORY_SUGGESTION.adjusted_sku ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.EOQ_TABLE_V3 AS SELECT EOQ_Test.*, shipped_eoq.shipped_from_factory, shipped_eoq.expected_del_date AS shipped_expected_del_date, shipped_eoq.dispatched_qty, factory_up_ytbc_eoq.YTBC_factory, factory_up_ytbc_eoq.YTBC_expected_del_date, factory_up_ytbc_eoq.YTBC_cut_qty, factory_up_ytbc_eoq.YTBC_status, Fabric_orders.Vendor as Mill, Fabric_orders.\"Order Placed\", Fabric_orders.CONFIRMATION, Fabric_orders.METERS, CASE WHEN LOWER(Fabric_orders.CONFIRMATION) = \'no\' THEN \'Fabric Order Placed Yet To be Confirmed\' WHEN LOWER(Fabric_orders.CONFIRMATION) = \'yes\' THEN \'Fabric Order Placed & Confirmed\' WHEN Fabric_orders.CONFIRMATION IS NULL THEN \'Fabric Order Yet to be Placed\' END AS Fabric_Status, BEST_CHANNELS.\"Best Seller Channel\", FACTORY_SUGGESTION.factory_ AS FACTORY_SUGGESTION FROM snitch_db.maplemonk.EOQ_Test LEFT JOIN ( Select \"SKU_NO.\" as Sku_group, factory as shipped_from_factory, expected_del_date , total_online_qty as dispatched_qty from ( Select \"SKU_NO.\",factory,total_online_qty,TO_DATE(delivery_planned_date, \'DD/MM/YYYY\') as expected_del_date from snitch_db.maplemonk.hsk_inventory where STATUS IS NULL UNION ALL Select \"SKU_NO.\",factory,total_online_qty,TO_DATE(delivery_planned_date, \'DD-MM-YYYY\') as expected_del_date from snitch_db.maplemonk.YLK_INVENTORY where REMARK IS NULL UNION ALL Select \"SKU_NO.\",factory,total_online_qty,TO_DATE(delivery_planned_date, \'DD/MM/YYYY\') as expected_del_date from snitch_db.maplemonk.EMIZA_INVENTORY where REMARK IS NULL ) ) shipped_eoq ON EOQ_Test.sku_group = shipped_eoq.Sku_group LEFT JOIN ( SELECT adjusted_sku AS sku_group, factory_ AS YTBC_factory, expected_del_date AS YTBC_expected_del_date, CUT_QTY AS YTBC_cut_qty, \'YTBC\' AS YTBC_status FROM ( SELECT SKU_Number, CASE WHEN SKU_Number LIKE \'R%\' THEN SUBSTR(SKU_Number, 2) ELSE SKU_Number END AS adjusted_sku, factory_, CASE WHEN Expected_Delivery_Date IS NULL THEN CASE WHEN TRY_TO_DATE(DATE_ISSUED, \'DD-MM-YYYY\') IS NOT NULL THEN TO_DATE(DATE_ISSUED, \'DD-MM-YYYY\') + INTERVAL \'60 DAY\' WHEN TRY_TO_DATE(DATE_ISSUED, \'YYYY-MM-DD\') IS NOT NULL THEN TO_DATE(DATE_ISSUED, \'YYYY-MM-DD\') + INTERVAL \'60 DAY\' ELSE NULL -- Handle unexpected date format END ELSE CASE WHEN TRY_TO_DATE(Expected_Delivery_Date, \'YYYY-MM-DD\') IS NOT NULL THEN TO_DATE(Expected_Delivery_Date, \'YYYY-MM-DD\') WHEN TRY_TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\') IS NOT NULL THEN TO_DATE(Expected_Delivery_Date, \'DD-MM-YYYY\') ELSE NULL -- Handle unexpected date format END END AS expected_del_date, CUT_QTY, \'YTBC\' AS Status, COUNT(CASE WHEN TRY_CAST(CUT_QTY AS INT) IS NULL THEN SKU_Number END) AS Yet_to_be_cut, CASE WHEN COUNT(CASE WHEN TRY_CAST(CUT_QTY AS INT) IS NULL THEN SKU_Number END) = 1 THEN \'YTBC\' ELSE \'DONE\' END AS STATUS_1 FROM snitch_db.maplemonk.PRODUCT_TRACKING_HIDDEN_MAIN GROUP BY SKU_Number, adjusted_sku, factory_, expected_del_date, CUT_QTY ) sub WHERE STATUS_1 = \'YTBC\' ) factory_up_ytbc_eoq ON EOQ_Test.sku_group = factory_up_ytbc_eoq.sku_group LEFT JOIN ( SELECT \"SNITCH SKU\", Vendor, \"Order Placed\", CONFIRMATION, METERS FROM snitch_db.maplemonk.Fabric_orders ) Fabric_orders ON EOQ_Test.sku_group = Fabric_orders.\"SNITCH SKU\" LEFT JOIN ( SELECT SKU_GROUP AS sku_group, MARKETPLACE_MAPPED AS \"Best Seller Channel\" FROM ( SELECT SKU_GROUP, MARKETPLACE_MAPPED, SKU_CLASS, ROUND(SUM(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) / 100, 0) AS PRICE_POINT, SUM(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) AS SELLING_PRICE_TOTAL, SUM(NULLIF(SHIPPING_QUANTITY, 0)) AS total_quantity, ROUND(SUM(NULLIF(SHIPPING_QUANTITY, 0)) / 10, 0) AS QUANTITY_POINT, MAX(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) AS MAX, MIN(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END) AS MIN, AVG(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END / NULLIF(SHIPPING_QUANTITY, 0)) AS average_asp, ROUND((AVG(CASE WHEN MARKETPLACE_MAPPED = \'AJIO\' THEN (SELLING_PRICE * 1.5) ELSE SELLING_PRICE END / NULLIF(SHIPPING_QUANTITY, 0))) / 100, 0) AS average_asp_POINT, ROW_NUMBER() OVER (PARTITION BY SKU_GROUP ORDER BY QUANTITY_POINT DESC, average_asp_POINT DESC) AS marketplace_rank, MAX(MRP) AS MRP FROM snitch_db.maplemonk.unicommerce_fact_items_snitch WHERE ORDER_STATUS = \'COMPLETE\' AND ORDER_DATE > DATEADD(DAY, -120, CURRENT_DATE()) AND SELLING_PRICE > 0 GROUP BY SKU_GROUP, MARKETPLACE_MAPPED, SKU_CLASS ) sub WHERE marketplace_rank = 1 ) BEST_CHANNELS ON EOQ_Test.sku_group = BEST_CHANNELS.sku_group LEFT JOIN ( SELECT adjusted_sku, factory_ FROM ( SELECT CASE WHEN \"SKU Number\" LIKE \'R%\' THEN SUBSTR(\"SKU Number\", 2) ELSE \"SKU Number\" END AS adjusted_sku, case when \"Factory Vendor Code\" in (\'01 - SSTC\', \'03 - Leandro\', \'13 - Kharva\', \'18 - Expert\', \'16 - Thandeshwara\', \'09 - Nalanda\', \'05 - Sai Textiles\', \'06 - Alagesh\', \'MQ - M Square\', \'14 - Lohith Creations\', \'IN - Mohit\', \'19 - S R Apparels\', \'Navkar\', \'02 - Kasturi Creation\', \'08 - Vignesh\', \'21-BLUE MONKEY\', \'KU - Kunal\', \'AC - Asian Clothing\', \'07 - K P\', \'15 - Prestige\', \'VN - Vanitha Garments\', \'10 - Adeep \') then \"Factory Vendor Code\" else factory end as factory_, TO_DATE(\"Date Issued\", \'DD-MM-YYYY\') AS DATE, ROW_NUMBER() OVER (PARTITION BY CASE WHEN \"SKU Number\" LIKE \'R%\' THEN SUBSTR(\"SKU Number\", 2) ELSE \"SKU Number\" END ORDER BY TO_DATE(\"Date Issued\", \'DD-MM-YYYY\') DESC) AS RN FROM snitch_db.maplemonk.PRODUCT_TRACKING_HIDDEN_SHIPPED ) sub WHERE RN = 1 ) FACTORY_SUGGESTION ON EOQ_Test.sku_group = FACTORY_SUGGESTION.adjusted_sku;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        