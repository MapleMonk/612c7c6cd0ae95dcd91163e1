{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ORDER_ID as With Refund as (Select POSTEDDATE ,AMAZONORDERID ,SELLERSKU ,sum(ifnull(Tax,0)) Refund_Tax ,sum(ifnull(Principal,0)) Refund_Principal ,sum(ifnull(Refund_Promotion,0)) Refund_Promotion ,sum(ifnull(ShippingTax,0)) Refund_ShippingTax ,sum(ifnull(ShippingCharge,0)) Refund_ShippingCharge ,sum(ifnull(GiftWrap,0)) Refund_GiftWrap ,sum(ifnull(GiftWrapTax,0)) Refund_GiftWrapTax ,sum(ifnull(ExportCharge,0)) Refund_ExportCharge ,sum(ifnull(Commission,0)) Refund_Commission ,sum(ifnull(RefundCommission,0)) Refund_RefundCommission ,sum(ifnull(GiftwrapChargeback,0)) Refund_GiftwrapChargeback ,sum(ifnull(ShippingChargeback,0)) Refund_ShippingChargeback ,sum(ifnull(Quantity,0)) Refund_Quantity ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Principal,0)) as Refund_MarketplaceFacilitatorTax_Principal ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Shipping,0)) as Refund_MarketplaceFacilitatorTax_Shipping ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Other,0)) as Refund_MarketplaceFacilitatorTax_Other ,sum(ifnull(Refund_MarketplaceFacilitatorVat_Shipping,0)) as Refund_MarketplaceFacilitatorVat_Shipping ,sum(ifnull(Refund_MarketplaceFacilitatorVat_Principal,0)) as Refund_MarketplaceFacilitatorVat_Principal from vahdam_db.maplemonk.vahdam_refund_event_list group by 1,2,3), Shipment as (select POSTEDDATE ,AMAZONORDERID ,SELLERSKU ,MarketplaceName ,sum(QUANTITY) QUANTITY ,sum(PRINCIPAL) PRINCIPAL ,sum(FBAPERUNITFULFILLMENTFEE) FBAPERUNITFULFILLMENTFEE ,sum(COMMISSION) COMMISSION ,sum(PROMOTION) PROMOTION ,sum(TAX) TAX ,sum(GIFTWRAP) GIFTWRAP ,sum(GIFTWRAPTAX) GIFTWRAPTAX ,sum(SHIPPINGCHARGE) SHIPPINGCHARGE ,sum(SHIPPINGTAX) SHIPPINGTAX ,sum(MARKETPLACEFACILITATORTAXPRINCIPAL) MARKETPLACEFACILITATORTAXPRINCIPAL ,sum(MARKETPLACEFACILITATORTAXSHIPPING) MARKETPLACEFACILITATORTAXSHIPPING ,sum(MARKETPLACEFACILITATORTAXOTHER) MARKETPLACEFACILITATORTAXOTHER ,sum(MARKETPLACEFACILITATORVATSHIPPING) MARKETPLACEFACILITATORVATSHIPPING ,sum(MARKETPLACEFACILITATORVATPRINCIPAL) MARKETPLACEFACILITATORVATPRINCIPAL ,sum(FBAPERORDERFULFILLMENTFEE) FBAPERORDERFULFILLMENTFEE ,sum(FBAWEIGHTBASEDFEE) FBAWEIGHTBASEDFEE ,sum(FIXEDCLOSINGFEE) FIXEDCLOSINGFEE ,sum(GIFTWRAPCHARGEBACK) GIFTWRAPCHARGEBACK ,sum(SHIPPINGCHARGEBACK) SHIPPINGCHARGEBACK ,sum(VARIABLECLOSINGFEE) VARIABLECLOSINGFEE ,sum(SALESTAXCOLLECTIONFEE) SALESTAXCOLLECTIONFEE ,sum(GIFTWRAPCOMMISSION) GIFTWRAPCOMMISSION ,sum(SHIPPINGHB) SHIPPINGHB from vahdam_db.maplemonk.vahdam_shipment_event_list group by 1,2,3,4) select coalesce(S.POSTEDDATE,R.POSTEDDATE)::date POSTEDDATE ,coalesce(S.AMAZONORDERID,R.AMAZONORDERID) AMAZONORDERID ,coalesce(S.SELLERSKU,R.SELLERSKU) SELLERSKU ,S.MarketplaceName MarketplaceName ,S.QUANTITY ,S.PRINCIPAL ,S.FBAPERUNITFULFILLMENTFEE ,S.COMMISSION ,S.PROMOTION ,S.TAX ,ifnull(R.Refund_Tax,0) Refund_Tax ,ifnull(R.Refund_Principal,0) Refund_Principal ,ifnull(R.Refund_Promotion,0) Refund_Promotion ,ifnull(R.Refund_ShippingTax,0) Refund_ShippingTax ,ifnull(R.Refund_ShippingCharge,0) Refund_ShippingCharge ,ifnull(R.Refund_GiftWrap,0) Refund_GiftWrap ,ifnull(R.Refund_GiftWrapTax,0) Refund_GiftWrapTax ,ifnull(R.Refund_ExportCharge,0) Refund_ExportCharge ,ifnull(R.Refund_Commission,0) Refund_Commission ,ifnull(R.Refund_RefundCommission,0) Refund_RefundCommission ,ifnull(R.Refund_GiftwrapChargeback,0) Refund_GiftwrapChargeback ,ifnull(R.Refund_ShippingChargeback,0) Refund_ShippingChargeback ,ifnull(R.Refund_Quantity,0) Refund_Quantity ,ifnull(R.Refund_MarketplaceFacilitatorTax_Principal,0) as Refund_MarketplaceFacilitatorTax_Principal ,ifnull(R.Refund_MarketplaceFacilitatorTax_Shipping,0) as Refund_MarketplaceFacilitatorTax_Shipping ,ifnull(R.Refund_MarketplaceFacilitatorTax_Other,0) as Refund_MarketplaceFacilitatorTax_Other ,ifnull(R.Refund_MarketplaceFacilitatorVat_Shipping,0) as Refund_MarketplaceFacilitatorVat_Shipping ,ifnull(R.Refund_MarketplaceFacilitatorVat_Principal,0)as Refund_MarketplaceFacilitatorVat_Principal ,S.GIFTWRAP ,S.GIFTWRAPTAX ,S.SHIPPINGCHARGE ,S.SHIPPINGTAX ,S.MARKETPLACEFACILITATORTAXPRINCIPAL ,S.MARKETPLACEFACILITATORTAXSHIPPING ,S.MARKETPLACEFACILITATORTAXOTHER ,S.MARKETPLACEFACILITATORVATSHIPPING ,S.MARKETPLACEFACILITATORVATPRINCIPAL ,S.FBAPERORDERFULFILLMENTFEE ,S.FBAWEIGHTBASEDFEE ,S.FIXEDCLOSINGFEE ,S.GIFTWRAPCHARGEBACK ,S.SHIPPINGCHARGEBACK ,S.VARIABLECLOSINGFEE ,ifnull(S.SALESTAXCOLLECTIONFEE,0) as SALESTAXCOLLECTIONFEE ,ifnull(S.GIFTWRAPCOMMISSION,0) as GIFTWRAPCOMMISSION ,ifnull(S.SHIPPINGHB,0) as SHIPPINGHB from Shipment S full outer join Refund R on S.AMAZONORDERID = R.AMAZONORDERID and lower(S.SELLERSKU) = lower(R.SELLERSKU) where MarketplaceName <> \'Amazon.com.mx\' order by POSTEDDATE desc; create or replace table vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ADJUSTMENT_SKU as with Adjustment as (select POSTEDDATE::date DATE ,SELLERSKU ,sum(ifnull(COMPENSATED_CLAWBACK_QUANTITY,0)) COMPENSATED_CLAWBACK_QUANTITY ,sum(ifnull(COMPENSATED_CLAWBACK_TOTAL_AMOUNT,0)) COMPENSATED_CLAWBACK_TOTAL_AMOUNT ,sum(ifnull(WAREHOUSE_DAMAGE_QUANTITY,0)) WAREHOUSE_DAMAGE_QUANTITY ,sum(ifnull(WAREHOUSE_DAMAGE_TOTAL_AMOUNT,0)) WAREHOUSE_DAMAGE_TOTAL_AMOUNT ,sum(ifnull(REVERSAL_REIMBURSEMENT_QUANTITY,0)) REVERSAL_REIMBURSEMENT_QUANTITY ,sum(ifnull(REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT,0)) REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT ,sum(ifnull(WAREHOUSE_LOST_MANUAL_QUANTITY,0)) WAREHOUSE_LOST_MANUAL_QUANTITY ,sum(ifnull(WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT,0)) WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT ,sum(ifnull(FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY,0)) FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY ,sum(ifnull(FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT,0)) FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT from vahdam_db.maplemonk.vahdam_adjustment_event_list group by 1,2), SHIPREFUND as (select POSTEDDATE as DATE ,SELLERSKU ,sum(ifnull(QUANTITY,0)) QUANTITY ,sum(ifnull(PRINCIPAL,0)) PRINCIPAL ,sum(ifnull(FBAPERUNITFULFILLMENTFEE,0)) FBAPERUNITFULFILLMENTFEE ,sum(ifnull(COMMISSION,0)) COMMISSION ,sum(ifnull(PROMOTION,0)) PROMOTION ,sum(ifnull(TAX,0)) TAX ,sum(ifnull(Refund_Tax,0)) Refund_Tax ,sum(ifnull(Refund_Principal,0)) Refund_Principal ,sum(ifnull(Refund_Promotion,0)) Refund_Promotion ,sum(ifnull(Refund_ShippingTax,0)) Refund_ShippingTax ,sum(ifnull(Refund_ShippingCharge,0)) Refund_ShippingCharge ,sum(ifnull(Refund_GiftWrap,0)) Refund_GiftWrap ,sum(ifnull(Refund_GiftWrapTax,0)) Refund_GiftWrapTax ,sum(ifnull(Refund_ExportCharge,0)) Refund_ExportCharge ,sum(ifnull(Refund_Commission,0)) Refund_Commission ,sum(ifnull(Refund_RefundCommission,0)) Refund_RefundCommission ,sum(ifnull(Refund_GiftwrapChargeback,0)) Refund_GiftwrapChargeback ,sum(ifnull(Refund_ShippingChargeback,0)) Refund_ShippingChargeback ,sum(ifnull(Refund_Quantity,0)) Refund_Quantity ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Principal,0)) as Refund_MarketplaceFacilitatorTax_Principal ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Shipping,0)) as Refund_MarketplaceFacilitatorTax_Shipping ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Other,0)) as Refund_MarketplaceFacilitatorTax_Other ,sum(ifnull(Refund_MarketplaceFacilitatorVat_Shipping,0)) as Refund_MarketplaceFacilitatorVat_Shipping ,sum(ifnull(Refund_MarketplaceFacilitatorVat_Principal,0))as Refund_MarketplaceFacilitatorVat_Principal ,sum(ifnull(GIFTWRAP,0)) GIFTWRAP ,sum(ifnull(GIFTWRAPTAX,0)) GIFTWRAPTAX ,sum(ifnull(SHIPPINGCHARGE,0)) SHIPPINGCHARGE ,sum(ifnull(SHIPPINGTAX,0)) SHIPPINGTAX ,sum(ifnull(MARKETPLACEFACILITATORTAXPRINCIPAL,0)) MARKETPLACEFACILITATORTAXPRINCIPAL ,sum(ifnull(MARKETPLACEFACILITATORTAXSHIPPING,0)) MARKETPLACEFACILITATORTAXSHIPPING ,sum(ifnull(MARKETPLACEFACILITATORTAXOTHER,0)) MARKETPLACEFACILITATORTAXOTHER ,sum(ifnull(MARKETPLACEFACILITATORVATSHIPPING,0)) MARKETPLACEFACILITATORVATSHIPPING ,sum(ifnull(MARKETPLACEFACILITATORVATPRINCIPAL,0)) MARKETPLACEFACILITATORVATPRINCIPAL ,sum(ifnull(FBAPERORDERFULFILLMENTFEE,0)) FBAPERORDERFULFILLMENTFEE ,sum(ifnull(FBAWEIGHTBASEDFEE,0)) FBAWEIGHTBASEDFEE ,sum(ifnull(FIXEDCLOSINGFEE,0)) FIXEDCLOSINGFEE ,sum(ifnull(GIFTWRAPCHARGEBACK,0)) GIFTWRAPCHARGEBACK ,sum(ifnull(SHIPPINGCHARGEBACK,0)) SHIPPINGCHARGEBACK ,sum(ifnull(VARIABLECLOSINGFEE,0)) VARIABLECLOSINGFEE ,sum(ifnull(SALESTAXCOLLECTIONFEE,0)) SALESTAXCOLLECTIONFEE ,sum(ifnull(GIFTWRAPCOMMISSION,0)) GIFTWRAPCOMMISSION ,sum(ifnull(SHIPPINGHB,0)) SHIPPINGHB from vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ORDER_ID group by 1,2) select coalesce(S.DATE,A.DATE) as DATE ,coalesce(S.SELLERSKU,A.SELLERSKU) as SELLERSKU ,ifnull(S.QUANTITY,0) QUANTITY ,ifnull(S.PRINCIPAL,0) PRINCIPAL ,ifnull(S.FBAPERUNITFULFILLMENTFEE,0) FBAPERUNITFULFILLMENTFEE ,ifnull(S.COMMISSION,0) COMMISSION ,ifnull(S.PROMOTION,0) PROMOTION ,ifnull(S.TAX,0) TAX ,ifnull(S.Refund_Tax,0) Refund_Tax ,ifnull(S.Refund_Principal,0) Refund_Principal ,ifnull(S.Refund_Promotion,0) Refund_Promotion ,ifnull(S.Refund_ShippingTax,0) Refund_ShippingTax ,ifnull(S.Refund_ShippingCharge,0) Refund_ShippingCharge ,ifnull(S.Refund_GiftWrap,0) Refund_GiftWrap ,ifnull(S.Refund_GiftWrapTax,0) Refund_GiftWrapTax ,ifnull(S.Refund_ExportCharge,0) Refund_ExportCharge ,ifnull(S.Refund_Commission,0) Refund_Commission ,ifnull(S.Refund_RefundCommission,0) Refund_RefundCommission ,ifnull(S.Refund_GiftwrapChargeback,0) Refund_GiftwrapChargeback ,ifnull(S.Refund_ShippingChargeback,0) Refund_ShippingChargeback ,ifnull(S.Refund_Quantity,0) Refund_Quantity ,ifnull(S.Refund_MarketplaceFacilitatorTax_Principal,0) as Refund_MarketplaceFacilitatorTax_Principal ,ifnull(S.Refund_MarketplaceFacilitatorTax_Shipping,0) as Refund_MarketplaceFacilitatorTax_Shipping ,ifnull(S.Refund_MarketplaceFacilitatorTax_Other,0) as Refund_MarketplaceFacilitatorTax_Other ,ifnull(S.Refund_MarketplaceFacilitatorVat_Shipping,0) as Refund_MarketplaceFacilitatorVat_Shipping ,ifnull(S.Refund_MarketplaceFacilitatorVat_Principal,0)as Refund_MarketplaceFacilitatorVat_Principal ,ifnull(S.GIFTWRAP,0) GIFTWRAP ,ifnull(S.GIFTWRAPTAX,0) GIFTWRAPTAX ,ifnull(S.SHIPPINGCHARGE,0) SHIPPINGCHARGE ,ifnull(S.SHIPPINGTAX,0) SHIPPINGTAX ,ifnull(S.MARKETPLACEFACILITATORTAXPRINCIPAL,0) MARKETPLACEFACILITATORTAXPRINCIPAL ,ifnull(S.MARKETPLACEFACILITATORTAXSHIPPING,0) MARKETPLACEFACILITATORTAXSHIPPING ,ifnull(S.MARKETPLACEFACILITATORTAXOTHER,0) MARKETPLACEFACILITATORTAXOTHER ,ifnull(S.MARKETPLACEFACILITATORVATSHIPPING,0) MARKETPLACEFACILITATORVATSHIPPING ,ifnull(S.MARKETPLACEFACILITATORVATPRINCIPAL,0) MARKETPLACEFACILITATORVATPRINCIPAL ,ifnull(S.FBAPERORDERFULFILLMENTFEE,0) FBAPERORDERFULFILLMENTFEE ,ifnull(S.FBAWEIGHTBASEDFEE,0) FBAWEIGHTBASEDFEE ,ifnull(S.FIXEDCLOSINGFEE,0) FIXEDCLOSINGFEE ,ifnull(S.GIFTWRAPCHARGEBACK,0) GIFTWRAPCHARGEBACK ,ifnull(S.SHIPPINGCHARGEBACK,0) SHIPPINGCHARGEBACK ,ifnull(S.VARIABLECLOSINGFEE,0) VARIABLECLOSINGFEE ,ifnull(S.SALESTAXCOLLECTIONFEE,0) SALESTAXCOLLECTIONFEE ,ifnull(S.GIFTWRAPCOMMISSION,0) GIFTWRAPCOMMISSION ,ifnull(S.SHIPPINGHB,0) SHIPPINGHB ,ifnull(A.COMPENSATED_CLAWBACK_QUANTITY,0) as COMPENSATED_CLAWBACK_QUANTITY ,ifnull(A.COMPENSATED_CLAWBACK_TOTAL_AMOUNT,0) as COMPENSATED_CLAWBACK_TOTAL_AMOUNT ,ifnull(A.WAREHOUSE_DAMAGE_QUANTITY,0) as WAREHOUSE_DAMAGE_QUANTITY ,ifnull(A.WAREHOUSE_DAMAGE_TOTAL_AMOUNT,0) as WAREHOUSE_DAMAGE_TOTAL_AMOUNT ,ifnull(A.REVERSAL_REIMBURSEMENT_QUANTITY,0) as REVERSAL_REIMBURSEMENT_QUANTITY ,ifnull(A.REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT,0) as REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT ,ifnull(A.WAREHOUSE_LOST_MANUAL_QUANTITY,0) as WAREHOUSE_LOST_MANUAL_QUANTITY ,ifnull(A.WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT,0) as WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT ,ifnull(A.FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY,0) as FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY ,ifnull(A.FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT,0) as FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT from SHIPREFUND S full outer join Adjustment A on lower(S.SELLERSKU) = lower(A.SELLERSKU) and S.DATE = A.DATE; Create or replace table vahdam_db.maplemonk.ASP_US_ASIN_Payment_Reports as With Payment as (select Date ,SKU_New ,ASIN ,COGS_USD ,Outbound_cost_usd ,Common_SKU ,Three_PL_Cost ,Storage_Cost ,Duty ,sum(ifnull(QUANTITY,0)) QUANTITY ,sum(ifnull(PRINCIPAL,0)) PRINCIPAL ,sum(ifnull(FBAPERUNITFULFILLMENTFEE,0)) FBAPERUNITFULFILLMENTFEE ,sum(ifnull(COMMISSION,0)) COMMISSION ,sum(ifnull(PROMOTION,0)) PROMOTION ,sum(ifnull(TAX,0)) TAX ,sum(ifnull(Refund_Tax,0)) Refund_Tax ,sum(ifnull(Refund_Principal,0)) Refund_Principal ,sum(ifnull(Refund_Promotion,0)) Refund_Promotion ,sum(ifnull(Refund_ShippingTax,0)) Refund_ShippingTax ,sum(ifnull(Refund_ShippingCharge,0)) Refund_ShippingCharge ,sum(ifnull(Refund_GiftWrap,0)) Refund_GiftWrap ,sum(ifnull(Refund_GiftWrapTax,0)) Refund_GiftWrapTax ,sum(ifnull(Refund_ExportCharge,0)) Refund_ExportCharge ,sum(ifnull(Refund_Commission,0)) Refund_Commission ,sum(ifnull(Refund_RefundCommission,0)) Refund_RefundCommission ,sum(ifnull(Refund_GiftwrapChargeback,0)) Refund_GiftwrapChargeback ,sum(ifnull(Refund_ShippingChargeback,0)) Refund_ShippingChargeback ,sum(ifnull(Refund_Quantity,0)) Refund_Quantity ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Principal,0)) as Refund_MarketplaceFacilitatorTax_Principal ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Shipping,0)) as Refund_MarketplaceFacilitatorTax_Shipping ,sum(ifnull(Refund_MarketplaceFacilitatorTax_Other,0)) as Refund_MarketplaceFacilitatorTax_Other ,sum(ifnull(Refund_MarketplaceFacilitatorVat_Shipping,0)) as Refund_MarketplaceFacilitatorVat_Shipping ,sum(ifnull(Refund_MarketplaceFacilitatorVat_Principal,0))as Refund_MarketplaceFacilitatorVat_Principal ,sum(ifnull(GIFTWRAP,0)) GIFTWRAP ,sum(ifnull(GIFTWRAPTAX,0)) GIFTWRAPTAX ,sum(ifnull(SHIPPINGCHARGE,0)) SHIPPINGCHARGE ,sum(ifnull(SHIPPINGTAX,0)) SHIPPINGTAX ,sum(ifnull(MARKETPLACEFACILITATORTAXPRINCIPAL,0)) MARKETPLACEFACILITATORTAXPRINCIPAL ,sum(ifnull(MARKETPLACEFACILITATORTAXSHIPPING,0)) MARKETPLACEFACILITATORTAXSHIPPING ,sum(ifnull(MARKETPLACEFACILITATORTAXOTHER,0)) MARKETPLACEFACILITATORTAXOTHER ,sum(ifnull(MARKETPLACEFACILITATORVATSHIPPING,0)) MARKETPLACEFACILITATORVATSHIPPING ,sum(ifnull(MARKETPLACEFACILITATORVATPRINCIPAL,0)) MARKETPLACEFACILITATORVATPRINCIPAL ,sum(ifnull(FBAPERORDERFULFILLMENTFEE,0)) FBAPERORDERFULFILLMENTFEE ,sum(ifnull(FBAWEIGHTBASEDFEE,0)) FBAWEIGHTBASEDFEE ,sum(ifnull(FIXEDCLOSINGFEE,0)) FIXEDCLOSINGFEE ,sum(ifnull(GIFTWRAPCHARGEBACK,0)) GIFTWRAPCHARGEBACK ,sum(ifnull(SHIPPINGCHARGEBACK,0)) SHIPPINGCHARGEBACK ,sum(ifnull(VARIABLECLOSINGFEE,0)) VARIABLECLOSINGFEE ,sum(ifnull(SALESTAXCOLLECTIONFEE,0)) SALESTAXCOLLECTIONFEE ,sum(ifnull(GIFTWRAPCOMMISSION,0)) GIFTWRAPCOMMISSION ,sum(ifnull(SHIPPINGHB,0)) SHIPPINGHB ,sum(ifnull(COMPENSATED_CLAWBACK_QUANTITY,0)) COMPENSATED_CLAWBACK_QUANTITY ,sum(ifnull(COMPENSATED_CLAWBACK_TOTAL_AMOUNT,0)) COMPENSATED_CLAWBACK_TOTAL_AMOUNT ,sum(ifnull(WAREHOUSE_DAMAGE_QUANTITY,0)) WAREHOUSE_DAMAGE_QUANTITY ,sum(ifnull(WAREHOUSE_DAMAGE_TOTAL_AMOUNT,0)) WAREHOUSE_DAMAGE_TOTAL_AMOUNT ,sum(ifnull(REVERSAL_REIMBURSEMENT_QUANTITY,0)) REVERSAL_REIMBURSEMENT_QUANTITY ,sum(ifnull(REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT,0)) REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT ,sum(ifnull(WAREHOUSE_LOST_MANUAL_QUANTITY,0)) WAREHOUSE_LOST_MANUAL_QUANTITY ,sum(ifnull(WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT,0)) WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT ,sum(ifnull(FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY,0)) FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY ,sum(ifnull(FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT,0)) FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT from (select S.* ,M.Amzon_ASIN as ASIN ,M.\"COGS\" as COGS_USD ,M.\"Assumed Outbound Cost\" as Outbound_cost_usd ,M.\"Common SKU\" as Common_SKU ,M.\"3PL Cost\" as Three_PL_Cost ,M.\"Assumed Storage Cost (USD)\" as Storage_Cost ,M.DUTY as Duty ,coalesce(S.SELLERSKU,M.Amazon_SKU) as SKU_New from vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ADJUSTMENT_SKU S left join VAHDAM_DB.MAPLEMONK.GC_ASIN_SKU_MAPPING_ASIN_SKU_MAPPING M on S.SELLERSKU = M.Amazon_SKU) group by 1,2,3,4,5,6,7,8,9), Amazonads as (select date ,asin_new ,sum(ifnull(spend,0)) as Total_amazon_spend ,sum(ifnull(sales_usd,0)) as Total_amazon_sales from vahdam_db.maplemonk.amazonads_na_marketing group by 1,2) select coalesce(P.date,A.date) as Date ,coalesce(P.ASIN,A.asin_new) as ASIN ,P.SKU_New ,P.Common_SKU as Common_SKU ,cast(P.COGS_USD as float) as COGS_USD ,cast(P.Outbound_cost_usd as float) as Outbound_cost_usd ,cast(P.Three_PL_Cost as float) as Three_PL_Cost ,cast(P.Storage_Cost as float) as Storage_Cost ,casT(P.Duty as float) as Duty ,ifnull(P.QUANTITY,0) QUANTITY ,ifnull(P.PRINCIPAL,0) PRINCIPAL ,ifnull(P.FBAPERUNITFULFILLMENTFEE,0) FBAPERUNITFULFILLMENTFEE ,ifnull(P.COMMISSION,0) COMMISSION ,ifnull(P.PROMOTION,0) PROMOTION ,ifnull(P.TAX,0) TAX ,ifnull(P.Refund_Tax,0) Refund_Tax ,ifnull(P.Refund_Principal,0) Refund_Principal ,ifnull(P.Refund_Promotion,0) Refund_Promotion ,ifnull(P.Refund_ShippingTax,0) Refund_ShippingTax ,ifnull(P.Refund_ShippingCharge,0) Refund_ShippingCharge ,ifnull(P.Refund_GiftWrap,0) Refund_GiftWrap ,ifnull(P.Refund_GiftWrapTax,0) Refund_GiftWrapTax ,ifnull(P.Refund_ExportCharge,0) Refund_ExportCharge ,ifnull(P.Refund_Commission,0) Refund_Commission ,ifnull(P.Refund_RefundCommission,0) Refund_RefundCommission ,ifnull(P.Refund_GiftwrapChargeback,0) Refund_GiftwrapChargeback ,ifnull(P.Refund_ShippingChargeback,0) Refund_ShippingChargeback ,ifnull(P.Refund_Quantity,0) Refund_Quantity ,ifnull(P.Refund_MarketplaceFacilitatorTax_Principal,0) as Refund_MarketplaceFacilitatorTax_Principal ,ifnull(P.Refund_MarketplaceFacilitatorTax_Shipping,0) as Refund_MarketplaceFacilitatorTax_Shipping ,ifnull(P.Refund_MarketplaceFacilitatorTax_Other,0) as Refund_MarketplaceFacilitatorTax_Other ,ifnull(P.Refund_MarketplaceFacilitatorVat_Shipping,0) as Refund_MarketplaceFacilitatorVat_Shipping ,ifnull(P.Refund_MarketplaceFacilitatorVat_Principal,0)as Refund_MarketplaceFacilitatorVat_Principal ,ifnull(P.GIFTWRAP,0) GIFTWRAP ,ifnull(P.GIFTWRAPTAX,0) GIFTWRAPTAX ,ifnull(P.SHIPPINGCHARGE,0) SHIPPINGCHARGE ,ifnull(P.SHIPPINGTAX,0) SHIPPINGTAX ,ifnull(P.MARKETPLACEFACILITATORTAXPRINCIPAL,0) MARKETPLACEFACILITATORTAXPRINCIPAL ,ifnull(P.MARKETPLACEFACILITATORTAXSHIPPING,0) MARKETPLACEFACILITATORTAXSHIPPING ,ifnull(P.MARKETPLACEFACILITATORTAXOTHER,0) MARKETPLACEFACILITATORTAXOTHER ,ifnull(P.MARKETPLACEFACILITATORVATSHIPPING,0) MARKETPLACEFACILITATORVATSHIPPING ,ifnull(P.MARKETPLACEFACILITATORVATPRINCIPAL,0) MARKETPLACEFACILITATORVATPRINCIPAL ,ifnull(P.FBAPERORDERFULFILLMENTFEE,0) FBAPERORDERFULFILLMENTFEE ,ifnull(P.FBAWEIGHTBASEDFEE,0) FBAWEIGHTBASEDFEE ,ifnull(P.FIXEDCLOSINGFEE,0) FIXEDCLOSINGFEE ,ifnull(P.GIFTWRAPCHARGEBACK,0) GIFTWRAPCHARGEBACK ,ifnull(P.SHIPPINGCHARGEBACK,0) SHIPPINGCHARGEBACK ,ifnull(P.VARIABLECLOSINGFEE,0) VARIABLECLOSINGFEE ,ifnull(P.SALESTAXCOLLECTIONFEE,0) SALESTAXCOLLECTIONFEE ,ifnull(P.GIFTWRAPCOMMISSION,0) GIFTWRAPCOMMISSION ,ifnull(P.SHIPPINGHB,0) SHIPPINGHB ,ifnull(P.COMPENSATED_CLAWBACK_QUANTITY,0) COMPENSATED_CLAWBACK_QUANTITY ,ifnull(P.COMPENSATED_CLAWBACK_TOTAL_AMOUNT,0) COMPENSATED_CLAWBACK_TOTAL_AMOUNT ,ifnull(P.WAREHOUSE_DAMAGE_QUANTITY,0) WAREHOUSE_DAMAGE_QUANTITY ,ifnull(P.WAREHOUSE_DAMAGE_TOTAL_AMOUNT,0) WAREHOUSE_DAMAGE_TOTAL_AMOUNT ,ifnull(P.REVERSAL_REIMBURSEMENT_QUANTITY,0) REVERSAL_REIMBURSEMENT_QUANTITY ,ifnull(P.REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT,0) REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT ,ifnull(P.WAREHOUSE_LOST_MANUAL_QUANTITY,0) WAREHOUSE_LOST_MANUAL_QUANTITY ,ifnull(P.WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT,0) WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT ,ifnull(P.FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY,0) FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY ,ifnull(P.FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT,0) FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT ,ifnull(A.Total_amazon_spend,0) as Total_amazon_spend ,ifnull(A.Total_amazon_sales,0) as Total_amazon_sales from Payment P left join Amazonads A on P.ASIN = A.asin_new and P.date = A.date order by Date desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from VAHDAM_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        