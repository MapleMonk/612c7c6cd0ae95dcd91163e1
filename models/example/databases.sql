{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE Snitch_db.maplemonk.Customer_Retention_Snitch AS SELECT year(Acq_date) Acquisition_Year, monthname(Acq_date) Acquisition_Month, last_day(Acq_date) Year_Month, Acquisition_Product, Acquisition_material_colour, count(distinct customer_id) total_customers, count(distinct case when last_day(Acq_date)=last_day(order_timestamp) then order_id end) total_orders, sum(case when last_day(Acq_date)=last_day(order_timestamp) then NET_SALES end) total_sales, count(distinct case when last_day(Acq_date)<>last_day(order_timestamp) then customer_id end) mn_c, count(distinct case when last_day(Acq_date)<>last_day(order_timestamp) then order_id end) mn_o, sum(case when last_day(Acq_date)<>last_day(order_timestamp) then NET_SALES end) mn_s, count(distinct case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_timestamp) then customer_id end) product_mn_c, count(distinct case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_timestamp) then order_id end) product_mn_o, sum(case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_timestamp) then NET_SALES end) product_mn_s, count(distinct case when last_day(dateadd(month,0,Acq_date))=last_day(order_timestamp) then customer_id end) m1_c, count(distinct case when last_day(dateadd(month,1,Acq_date))=last_day(order_timestamp) then customer_id end) m2_c, count(distinct case when last_day(dateadd(month,2,Acq_date))=last_day(order_timestamp) then customer_id end) m3_c, count(distinct case when last_day(dateadd(month,3,Acq_date))=last_day(order_timestamp) then customer_id end) m4_c, count(distinct case when last_day(dateadd(month,4,Acq_date))=last_day(order_timestamp) then customer_id end) m5_c, count(distinct case when last_day(dateadd(month,5,Acq_date))=last_day(order_timestamp) then customer_id end) m6_c, count(distinct case when last_day(dateadd(month,6,Acq_date))=last_day(order_timestamp) then customer_id end) m7_c, count(distinct case when last_day(dateadd(month,7,Acq_date))=last_day(order_timestamp) then customer_id end) m8_c, count(distinct case when last_day(dateadd(month,8,Acq_date))=last_day(order_timestamp) then customer_id end) m9_c, count(distinct case when last_day(dateadd(month,9,Acq_date))=last_day(order_timestamp) then customer_id end) m10_c, count(distinct case when last_day(dateadd(month,10,Acq_date))=last_day(order_timestamp) then customer_id end) m11_c, count(distinct case when last_day(dateadd(month,11,Acq_date))=last_day(order_timestamp) then customer_id end) m12_c, count(distinct case when last_day(dateadd(month,12,Acq_date))=last_day(order_timestamp) then customer_id end) m13_c, count(distinct case when last_day(dateadd(month,13,Acq_date))=last_day(order_timestamp) then customer_id end) m14_c, count(distinct case when last_day(dateadd(month,14,Acq_date))=last_day(order_timestamp) then customer_id end) m15_c, count(distinct case when last_day(dateadd(month,15,Acq_date))=last_day(order_timestamp) then customer_id end) m16_c, count(distinct case when last_day(dateadd(month,16,Acq_date))=last_day(order_timestamp) then customer_id end) m17_c, count(distinct case when last_day(dateadd(month,17,Acq_date))=last_day(order_timestamp) then customer_id end) m18_c, count(distinct case when last_day(dateadd(month,18,Acq_date))=last_day(order_timestamp) then customer_id end) m19_c, count(distinct case when last_day(dateadd(month,19,Acq_date))=last_day(order_timestamp) then customer_id end) m20_c, count(distinct case when last_day(dateadd(month,20,Acq_date))=last_day(order_timestamp) then customer_id end) m21_c, count(distinct case when last_day(dateadd(month,21,Acq_date))=last_day(order_timestamp) then customer_id end) m22_c, count(distinct case when last_day(dateadd(month,22,Acq_date))=last_day(order_timestamp) then customer_id end) m23_c, count(distinct case when last_day(dateadd(month,23,Acq_date))=last_day(order_timestamp) then customer_id end) m24_c, count(distinct case when last_day(dateadd(month,24,Acq_date))=last_day(order_timestamp) then customer_id end) m25_c, count(distinct case when last_day(dateadd(month,25,Acq_date))=last_day(order_timestamp) then customer_id end) m26_c, count(distinct case when last_day(dateadd(month,26,Acq_date))=last_day(order_timestamp) then customer_id end) m27_c, count(distinct case when last_day(dateadd(month,27,Acq_date))=last_day(order_timestamp) then customer_id end) m28_c, count(distinct case when last_day(dateadd(month,28,Acq_date))=last_day(order_timestamp) then customer_id end) m29_c, count(distinct case when last_day(dateadd(month,29,Acq_date))=last_day(order_timestamp) then customer_id end) m30_c, count(distinct case when last_day(dateadd(month,30,Acq_date))=last_day(order_timestamp) then customer_id end) m31_c, count(distinct case when last_day(dateadd(month,31,Acq_date))=last_day(order_timestamp) then customer_id end) m32_c, count(distinct case when last_day(dateadd(month,32,Acq_date))=last_day(order_timestamp) then customer_id end) m33_c, count(distinct case when last_day(dateadd(month,33,Acq_date))=last_day(order_timestamp) then customer_id end) m34_c, count(distinct case when last_day(dateadd(month,34,Acq_date))=last_day(order_timestamp) then customer_id end) m35_c, count(distinct case when last_day(dateadd(month,35,Acq_date))=last_day(order_timestamp) then customer_id end) m36_c, count(distinct case when last_day(dateadd(month,0,Acq_date))=last_day(order_timestamp) then order_id end) m1_o, count(distinct case when last_day(dateadd(month,1,Acq_date))=last_day(order_timestamp) then order_id end) m2_o, count(distinct case when last_day(dateadd(month,2,Acq_date))=last_day(order_timestamp) then order_id end) m3_o, count(distinct case when last_day(dateadd(month,3,Acq_date))=last_day(order_timestamp) then order_id end) m4_o, count(distinct case when last_day(dateadd(month,4,Acq_date))=last_day(order_timestamp) then order_id end) m5_o, count(distinct case when last_day(dateadd(month,5,Acq_date))=last_day(order_timestamp) then order_id end) m6_o, count(distinct case when last_day(dateadd(month,6,Acq_date))=last_day(order_timestamp) then order_id end) m7_o, count(distinct case when last_day(dateadd(month,7,Acq_date))=last_day(order_timestamp) then order_id end) m8_o, count(distinct case when last_day(dateadd(month,8,Acq_date))=last_day(order_timestamp) then order_id end) m9_o, count(distinct case when last_day(dateadd(month,9,Acq_date))=last_day(order_timestamp) then order_id end) m10_o, count(distinct case when last_day(dateadd(month,10,Acq_date))=last_day(order_timestamp) then order_id end) m11_o, count(distinct case when last_day(dateadd(month,11,Acq_date))=last_day(order_timestamp) then order_id end) m12_o, count(distinct case when last_day(dateadd(month,12,Acq_date))=last_day(order_timestamp) then order_id end) m13_o, count(distinct case when last_day(dateadd(month,13,Acq_date))=last_day(order_timestamp) then order_id end) m14_o, count(distinct case when last_day(dateadd(month,14,Acq_date))=last_day(order_timestamp) then order_id end) m15_o, count(distinct case when last_day(dateadd(month,15,Acq_date))=last_day(order_timestamp) then order_id end) m16_o, count(distinct case when last_day(dateadd(month,16,Acq_date))=last_day(order_timestamp) then order_id end) m17_o, count(distinct case when last_day(dateadd(month,17,Acq_date))=last_day(order_timestamp) then order_id end) m18_o, count(distinct case when last_day(dateadd(month,18,Acq_date))=last_day(order_timestamp) then order_id end) m19_o, count(distinct case when last_day(dateadd(month,19,Acq_date))=last_day(order_timestamp) then order_id end) m20_o, count(distinct case when last_day(dateadd(month,20,Acq_date))=last_day(order_timestamp) then order_id end) m21_o, count(distinct case when last_day(dateadd(month,21,Acq_date))=last_day(order_timestamp) then order_id end) m22_o, count(distinct case when last_day(dateadd(month,22,Acq_date))=last_day(order_timestamp) then order_id end) m23_o, count(distinct case when last_day(dateadd(month,23,Acq_date))=last_day(order_timestamp) then order_id end) m24_o, count(distinct case when last_day(dateadd(month,24,Acq_date))=last_day(order_timestamp) then order_id end) m25_o, count(distinct case when last_day(dateadd(month,25,Acq_date))=last_day(order_timestamp) then order_id end) m26_o, count(distinct case when last_day(dateadd(month,26,Acq_date))=last_day(order_timestamp) then order_id end) m27_o, count(distinct case when last_day(dateadd(month,27,Acq_date))=last_day(order_timestamp) then order_id end) m28_o, count(distinct case when last_day(dateadd(month,28,Acq_date))=last_day(order_timestamp) then order_id end) m29_o, count(distinct case when last_day(dateadd(month,29,Acq_date))=last_day(order_timestamp) then order_id end) m30_o, count(distinct case when last_day(dateadd(month,30,Acq_date))=last_day(order_timestamp) then order_id end) m31_o, count(distinct case when last_day(dateadd(month,31,Acq_date))=last_day(order_timestamp) then order_id end) m32_o, count(distinct case when last_day(dateadd(month,32,Acq_date))=last_day(order_timestamp) then order_id end) m33_o, count(distinct case when last_day(dateadd(month,33,Acq_date))=last_day(order_timestamp) then order_id end) m34_o, count(distinct case when last_day(dateadd(month,34,Acq_date))=last_day(order_timestamp) then order_id end) m35_o, count(distinct case when last_day(dateadd(month,35,Acq_date))=last_day(order_timestamp) then order_id end) m36_o, sum(case when last_day(dateadd(month,0,Acq_date))=last_day(order_timestamp) then NET_SALES end) m1_s, sum(case when last_day(dateadd(month,1,Acq_date))=last_day(order_timestamp) then NET_SALES end) m2_s, sum(case when last_day(dateadd(month,2,Acq_date))=last_day(order_timestamp) then NET_SALES end) m3_s, sum(case when last_day(dateadd(month,3,Acq_date))=last_day(order_timestamp) then NET_SALES end) m4_s, sum(case when last_day(dateadd(month,4,Acq_date))=last_day(order_timestamp) then NET_SALES end) m5_s, sum(case when last_day(dateadd(month,5,Acq_date))=last_day(order_timestamp) then NET_SALES end) m6_s, sum(case when last_day(dateadd(month,6,Acq_date))=last_day(order_timestamp) then NET_SALES end) m7_s, sum(case when last_day(dateadd(month,7,Acq_date))=last_day(order_timestamp) then NET_SALES end) m8_s, sum(case when last_day(dateadd(month,8,Acq_date))=last_day(order_timestamp) then NET_SALES end) m9_s, sum(case when last_day(dateadd(month,9,Acq_date))=last_day(order_timestamp) then NET_SALES end) m10_s, sum(case when last_day(dateadd(month,10,Acq_date))=last_day(order_timestamp) then NET_SALES end) m11_s, sum(case when last_day(dateadd(month,11,Acq_date))=last_day(order_timestamp) then NET_SALES end) m12_s, sum(case when last_day(dateadd(month,12,Acq_date))=last_day(order_timestamp) then NET_SALES end) m13_s, sum(case when last_day(dateadd(month,13,Acq_date))=last_day(order_timestamp) then NET_SALES end) m14_s, sum(case when last_day(dateadd(month,14,Acq_date))=last_day(order_timestamp) then NET_SALES end) m15_s, sum(case when last_day(dateadd(month,15,Acq_date))=last_day(order_timestamp) then NET_SALES end) m16_s, sum(case when last_day(dateadd(month,16,Acq_date))=last_day(order_timestamp) then NET_SALES end) m17_s, sum(case when last_day(dateadd(month,17,Acq_date))=last_day(order_timestamp) then NET_SALES end) m18_s, sum(case when last_day(dateadd(month,18,Acq_date))=last_day(order_timestamp) then NET_SALES end) m19_s, sum(case when last_day(dateadd(month,19,Acq_date))=last_day(order_timestamp) then NET_SALES end) m20_s, sum(case when last_day(dateadd(month,20,Acq_date))=last_day(order_timestamp) then NET_SALES end) m21_s, sum(case when last_day(dateadd(month,21,Acq_date))=last_day(order_timestamp) then NET_SALES end) m22_s, sum(case when last_day(dateadd(month,22,Acq_date))=last_day(order_timestamp) then NET_SALES end) m23_s, sum(case when last_day(dateadd(month,23,Acq_date))=last_day(order_timestamp) then NET_SALES end) m24_s, sum(case when last_day(dateadd(month,24,Acq_date))=last_day(order_timestamp) then NET_SALES end) m25_s, sum(case when last_day(dateadd(month,25,Acq_date))=last_day(order_timestamp) then NET_SALES end) m26_s, sum(case when last_day(dateadd(month,26,Acq_date))=last_day(order_timestamp) then NET_SALES end) m27_s, sum(case when last_day(dateadd(month,27,Acq_date))=last_day(order_timestamp) then NET_SALES end) m28_s, sum(case when last_day(dateadd(month,28,Acq_date))=last_day(order_timestamp) then NET_SALES end) m29_s, sum(case when last_day(dateadd(month,29,Acq_date))=last_day(order_timestamp) then NET_SALES end) m30_s, sum(case when last_day(dateadd(month,30,Acq_date))=last_day(order_timestamp) then NET_SALES end) m31_s, sum(case when last_day(dateadd(month,31,Acq_date))=last_day(order_timestamp) then NET_SALES end) m32_s, sum(case when last_day(dateadd(month,32,Acq_date))=last_day(order_timestamp) then NET_SALES end) m33_s, sum(case when last_day(dateadd(month,33,Acq_date))=last_day(order_timestamp) then NET_SALES end) m34_s, sum(case when last_day(dateadd(month,34,Acq_date))=last_day(order_timestamp) then NET_SALES end) m35_s, sum(case when last_day(dateadd(month,35,Acq_date))=last_day(order_timestamp) then NET_SALES end) m36_s, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,0,Acq_date))=last_day(order_timestamp) then customer_id end) product_m1_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))=last_day(order_timestamp) then customer_id end) product_m2_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))=last_day(order_timestamp) then customer_id end) product_m3_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))=last_day(order_timestamp) then customer_id end) product_m4_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))=last_day(order_timestamp) then customer_id end) product_m5_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))=last_day(order_timestamp) then customer_id end) product_m6_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))=last_day(order_timestamp) then customer_id end) product_m7_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))=last_day(order_timestamp) then customer_id end) product_m8_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))=last_day(order_timestamp) then customer_id end) product_m9_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))=last_day(order_timestamp) then customer_id end) product_m10_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))=last_day(order_timestamp) then customer_id end) product_m11_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))=last_day(order_timestamp) then customer_id end) product_m12_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,0,Acq_date))=last_day(order_timestamp) then order_id end) product_m1_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))=last_day(order_timestamp) then order_id end) product_m2_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))=last_day(order_timestamp) then order_id end) product_m3_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))=last_day(order_timestamp) then order_id end) product_m4_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))=last_day(order_timestamp) then order_id end) product_m5_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))=last_day(order_timestamp) then order_id end) product_m6_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))=last_day(order_timestamp) then order_id end) product_m7_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))=last_day(order_timestamp) then order_id end) product_m8_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))=last_day(order_timestamp) then order_id end) product_m9_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))=last_day(order_timestamp) then order_id end) product_m10_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))=last_day(order_timestamp) then order_id end) product_m11_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))=last_day(order_timestamp) then order_id end) product_m12_o, sum(case when acquisition_product=product_name and last_day(dateadd(month,0,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m1_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m2_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m3_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m4_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m5_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m6_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m7_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m8_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m9_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m10_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m11_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))=last_day(order_timestamp) then NET_SALES end) product_m12_s from ( select customer_id, order_id, acquisition_product, acquisition_material_colour, product_name, order_timestamp, NET_SALES, (min(order_timestamp) over (partition by customer_id)) Acq_date from snitch_db.maplemonk.FACT_ITEMS_snitch where customer_id is not null and lower(order_status) not in (\'cancelled\') and is_refund <> 1 )res group by year(Acq_date), monthname(Acq_date), last_day(Acq_date), Acquisition_Product, Acquisition_material_colour; create or replace table snitch_db.maplemonk.customer_retention_calendar_snitch as select acquisition_month, purchase_month, count(distinct a.customer_id) customers, sum(gross_sales) gross_sales, sum(orders) orders from ( select customer_id,last_day(order_timestamp::date) purchase_month, sum(gross_sales) gross_sales, count(distinct ordeR_id) orders from snitch_db.maplemonk.FACT_ITEMS_snitch where customer_id is not null group by 1,2 )a left join ( select customer_id, last_day(min(order_timestamp)) Acquisition_month from snitch_db.maplemonk.FACT_ITEMS_snitch where customer_id is not null group by 1 )b on a.customer_id = b.customer_id group by 1,2 order by acquisition_month, purchase_month ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        