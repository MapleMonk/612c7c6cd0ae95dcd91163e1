{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE Anveshan_db.maplemonk.Customer_Retention_Anveshan AS SELECT year(Acq_date) Acquisition_Year, monthname(Acq_date) Acquisition_Month, last_day(Acq_date) Year_Month, Acquisition_channel, Acquisition_Product, count(distinct customer_id_final) total_customers, count(distinct case when last_day(Acq_date)=last_day(order_date) then order_id end) total_orders, sum(case when last_day(Acq_date)=last_day(order_date) then selling_price end) total_sales, count(distinct case when last_day(Acq_date)<>last_day(order_date) then customer_id_final end) mn_c, count(distinct case when last_day(Acq_date)<>last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) mn_c_Shopify, count(distinct case when last_day(Acq_date)<>last_day(order_date) then order_id end) mn_o, count(distinct case when last_day(Acq_date)<>last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) mn_o_Shopify, sum(case when last_day(Acq_date)<>last_day(order_date) then selling_price end) mn_s, sum(case when last_day(Acq_date)<>last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) mn_s_Shopify, count(distinct case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_date) then customer_id_final end) product_mn_c, count(distinct case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_mn_c_Shopify count(distinct case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_date) then order_id end) product_mn_o, count(distinct case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_mn_o_Shopify, sum(case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_date) then selling_price end) product_mn_s, sum(case when acquisition_product=product_name and last_day(Acq_date)<>last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_mn_s_Shopify, count(distinct case when last_day(dateadd(month,1,Acq_date))=last_day(order_date) then customer_id_final end) m2_c, count(distinct case when last_day(dateadd(month,2,Acq_date))=last_day(order_date) then customer_id_final end) m3_c, count(distinct case when last_day(dateadd(month,3,Acq_date))=last_day(order_date) then customer_id_final end) m4_c, count(distinct case when last_day(dateadd(month,4,Acq_date))=last_day(order_date) then customer_id_final end) m5_c, count(distinct case when last_day(dateadd(month,5,Acq_date))=last_day(order_date) then customer_id_final end) m6_c, count(distinct case when last_day(dateadd(month,6,Acq_date))=last_day(order_date) then customer_id_final end) m7_c, count(distinct case when last_day(dateadd(month,7,Acq_date))=last_day(order_date) then customer_id_final end) m8_c, count(distinct case when last_day(dateadd(month,8,Acq_date))=last_day(order_date) then customer_id_final end) m9_c, count(distinct case when last_day(dateadd(month,9,Acq_date))=last_day(order_date) then customer_id_final end) m10_c, count(distinct case when last_day(dateadd(month,10,Acq_date))=last_day(order_date) then customer_id_final end) m11_c, count(distinct case when last_day(dateadd(month,11,Acq_date))=last_day(order_date) then customer_id_final end) m12_c, count(distinct case when last_day(dateadd(month,1,Acq_date))=last_day(order_date) then order_id end) m2_o, count(distinct case when last_day(dateadd(month,2,Acq_date))=last_day(order_date) then order_id end) m3_o, count(distinct case when last_day(dateadd(month,3,Acq_date))=last_day(order_date) then order_id end) m4_o, count(distinct case when last_day(dateadd(month,4,Acq_date))=last_day(order_date) then order_id end) m5_o, count(distinct case when last_day(dateadd(month,5,Acq_date))=last_day(order_date) then order_id end) m6_o, count(distinct case when last_day(dateadd(month,6,Acq_date))=last_day(order_date) then order_id end) m7_o, count(distinct case when last_day(dateadd(month,7,Acq_date))=last_day(order_date) then order_id end) m8_o, count(distinct case when last_day(dateadd(month,8,Acq_date))=last_day(order_date) then order_id end) m9_o, count(distinct case when last_day(dateadd(month,9,Acq_date))=last_day(order_date) then order_id end) m10_o, count(distinct case when last_day(dateadd(month,10,Acq_date))=last_day(order_date) then order_id end) m11_o, count(distinct case when last_day(dateadd(month,11,Acq_date))=last_day(order_date) then order_id end) m12_o, sum(case when last_day(dateadd(month,1,Acq_date))=last_day(order_date) then selling_price end) m2_s, sum(case when last_day(dateadd(month,2,Acq_date))=last_day(order_date) then selling_price end) m3_s, sum(case when last_day(dateadd(month,3,Acq_date))=last_day(order_date) then selling_price end) m4_s, sum(case when last_day(dateadd(month,4,Acq_date))=last_day(order_date) then selling_price end) m5_s, sum(case when last_day(dateadd(month,5,Acq_date))=last_day(order_date) then selling_price end) m6_s, sum(case when last_day(dateadd(month,6,Acq_date))=last_day(order_date) then selling_price end) m7_s, sum(case when last_day(dateadd(month,7,Acq_date))=last_day(order_date) then selling_price end) m8_s, sum(case when last_day(dateadd(month,8,Acq_date))=last_day(order_date) then selling_price end) m9_s, sum(case when last_day(dateadd(month,9,Acq_date))=last_day(order_date) then selling_price end) m10_s, sum(case when last_day(dateadd(month,10,Acq_date))=last_day(order_date) then selling_price end) m11_s, sum(case when last_day(dateadd(month,11,Acq_date))=last_day(order_date) then selling_price end) m12_s, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))= last_day(order_date) then customer_id_final end) product_m2_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))= last_day(order_date) then customer_id_final end) product_m3_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))= last_day(order_date) then customer_id_final end) product_m4_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))= last_day(order_date) then customer_id_final end) product_m5_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))= last_day(order_date) then customer_id_final end) product_m6_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))= last_day(order_date) then customer_id_final end) product_m7_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))= last_day(order_date) then customer_id_final end) product_m8_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))= last_day(order_date) then customer_id_final end) product_m9_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))= last_day(order_date) then customer_id_final end) product_m10_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))= last_day(order_date) then customer_id_final end) product_m11_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))= last_day(order_date) then customer_id_final end) product_m12_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))= last_day(order_date) then order_id end) product_m2_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))= last_day(order_date) then order_id end) product_m3_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))= last_day(order_date) then order_id end) product_m4_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))= last_day(order_date) then order_id end) product_m5_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))= last_day(order_date) then order_id end) product_m6_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))= last_day(order_date) then order_id end) product_m7_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))= last_day(order_date) then order_id end) product_m8_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))= last_day(order_date) then order_id end) product_m9_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))= last_day(order_date) then order_id end) product_m10_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))= last_day(order_date) then order_id end) product_m11_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))= last_day(order_date) then order_id end) product_m12_o, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))=last_day(order_date) then selling_price end) product_m2_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))=last_day(order_date) then selling_price end) product_m3_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))=last_day(order_date) then selling_price end) product_m4_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))=last_day(order_date) then selling_price end) product_m5_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))=last_day(order_date) then selling_price end) product_m6_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))=last_day(order_date) then selling_price end) product_m7_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))=last_day(order_date) then selling_price end) product_m8_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))=last_day(order_date) then selling_price end) product_m9_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))=last_day(order_date) then selling_price end) product_m10_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))=last_day(order_date) then selling_price end) product_m11_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))=last_day(order_date) then selling_price end) product_m12_s, count(distinct case when last_day(dateadd(month,1,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m2_c_Shopify, count(distinct case when last_day(dateadd(month,2,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m3_c_Shopify, count(distinct case when last_day(dateadd(month,3,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m4_c_Shopify, count(distinct case when last_day(dateadd(month,4,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m5_c_Shopify, count(distinct case when last_day(dateadd(month,5,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m6_c_Shopify, count(distinct case when last_day(dateadd(month,6,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m7_c_Shopify, count(distinct case when last_day(dateadd(month,7,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m8_c_Shopify, count(distinct case when last_day(dateadd(month,8,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m9_c_Shopify, count(distinct case when last_day(dateadd(month,9,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m10_c_Shopify, count(distinct case when last_day(dateadd(month,10,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m11_c_Shopify, count(distinct case when last_day(dateadd(month,11,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) m12_c_Shopify, count(distinct case when last_day(dateadd(month,1,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m2_o_Shopify, count(distinct case when last_day(dateadd(month,2,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m3_o_Shopify, count(distinct case when last_day(dateadd(month,3,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m4_o_Shopify, count(distinct case when last_day(dateadd(month,4,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m5_o_Shopify, count(distinct case when last_day(dateadd(month,5,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m6_o_Shopify, count(distinct case when last_day(dateadd(month,6,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m7_o_Shopify, count(distinct case when last_day(dateadd(month,7,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m8_o_Shopify, count(distinct case when last_day(dateadd(month,8,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m9_o_Shopify, count(distinct case when last_day(dateadd(month,9,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m10_o_Shopify, count(distinct case when last_day(dateadd(month,10,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m11_o_Shopify, count(distinct case when last_day(dateadd(month,11,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) m12_o_Shopify, sum(case when last_day(dateadd(month,1,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m2_s_Shopify, sum(case when last_day(dateadd(month,2,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m3_s_Shopify, sum(case when last_day(dateadd(month,3,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m4_s_Shopify, sum(case when last_day(dateadd(month,4,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m5_s_Shopify, sum(case when last_day(dateadd(month,5,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m6_s_Shopify, sum(case when last_day(dateadd(month,6,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m7_s_Shopify, sum(case when last_day(dateadd(month,7,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m8_s_Shopify, sum(case when last_day(dateadd(month,8,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m9_s_Shopify, sum(case when last_day(dateadd(month,9,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m10_s_Shopify, sum(case when last_day(dateadd(month,10,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m11_s_Shopify, sum(case when last_day(dateadd(month,11,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) m12_s_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m2_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m3_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m4_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m5_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m6_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m7_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m8_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m9_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m10_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m11_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then customer_id_final end) product_m12_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m2_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m3_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m4_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m5_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m6_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m7_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m8_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m9_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m10_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m11_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))= last_day(order_date) and shop_name = \'Shopify_India\' then order_id end) product_m12_o_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m2_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m3_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m4_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m5_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m6_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m7_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m8_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m9_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m10_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m11_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acq_date))=last_day(order_date) and shop_name = \'Shopify_India\' then selling_price end) product_m12_s_Shopify from ( select customer_id_final, order_id, acquisition_product, acquisition_channel, shop_name, product_name, order_date, selling_price, acquisition_date::date as acq_Date from Anveshan_db.maplemonk.SALES_CONSOLIDATED_ANVESHAN where customer_id_final is not null and lower(order_status) <> \'cancelled\' )res group by year(Acq_date), monthname(Acq_date), last_day(Acq_date), acquisition_channel, Acquisition_Product;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from ANVESHAN_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        