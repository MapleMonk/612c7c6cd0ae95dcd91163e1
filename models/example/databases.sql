{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE snitch_db.maplemonk.ga_full_funnel_view AS with overall_session_data as ( select TO_DATE(DATE,\'YYYYMMDD\') AS Date, \'app\' as Type, activeusers as Users, sessions as Sessions, engagedsessions as Engaged_Sessions, addtocarts as Add_To_Carts, checkouts as Checkouts, sessionsperuser as Sessions_Per_User from snitch_db.maplemonk.GA__FUNNEL__VIEW__TABLE_1 UNION select TO_DATE(DATE,\'YYYYMMDD\') AS Date, \'web\' as Type, activeusers as Users, sessions as Sessions, engagedsessions as Engaged_Sessions, addtocarts as Add_To_Carts, checkouts as Checkouts, sessionsperuser as Sessions_Per_User from snitch_db.maplemonk.WEB_GA_FUNNEL_VIEW_TABLE1 ), clicks_impression_data as ( SELECT TO_DATE(DATE,\'YYYYMMDD\') AS Date, \'web\' AS Type, itemlistviewevents AS Impressions, itemviewevents AS Clicks, FROM snitch_db.maplemonk.WEB_GA_FUNNEL_VIEW_WEB_TABLE3 UNION SELECT TO_DATE(DATE,\'YYYYMMDD\') AS Date, \'app\' AS Type, itemlistviewevents AS Impressions, itemviewevents AS Clicks, FROM snitch_db.maplemonk.GA_FUNNEL_VIEW_TABLE2 ), sales_data as ( select order_timestamp::date as Date, CASE WHEN lower(webshopney) = \'appbrew\' THEN \'app\' ELSE webshopney end as type, count(distinct order_name) as Order_Count from snitch_db.maplemonk.fact_items_snitch where lower(ifnull(discount_code,\'n\')) not like \'%eco%\' and lower(ifnull(discount_code,\'n\')) not like \'%influ%\' and order_name not in (\'2431093\',\'2422140\',\'2425364\',\'2430652\',\'2422237\',\'2420623\',\'2429832\',\'2422378\',\'2428311\',\'2429064\',\'2428204\',\'2421343\',\'2431206\',\'2430491\',\'2426682\',\'2426487\',\'2426458\',\'2423575\',\'2422431\',\'2423612\',\'2426625\',\'2428117\',\'2426894\',\'2425461\',\'2426570\',\'2423455\',\'2430777\',\'2426009\',\'2428245\',\'2427269\',\'2430946\',\'2425821\',\'2429986\',\'2429085\',\'2422047\',\'2430789\',\'2420219\',\'2428341\',\'2430444\',\'2426866\',\'2431230\',\'2425839\',\'2430980\',\'2427048\',\'2430597\',\'2420499\',\'2431050\',\'2420271\',\'2426684\',\'2428747\',\'2423523\',\'2431171\',\'2430830\',\'2425325\',\'2428414\',\'2429054\',\'2423596\') and tags not in (\'FLITS_LOGICERP\') group by 1,2 ) SELECT osd.Date, osd.Type, osd.Users, osd.Sessions, osd.Engaged_Sessions, cid.Impressions, cid.Clicks, osd.Add_To_Carts, osd.Checkouts, osd.Sessions_Per_User, sd.Order_Count FROM overall_session_data osd LEFT JOIN sales_data sd ON osd.Date = sd.Date AND lower(osd.Type) = lower(sd.Type) left join clicks_impression_data cid on osd.Date = cid.Date and lower(osd.Type) = lower(cid.Type); CREATE OR REPLACE TABLE snitch_db.maplemonk.sku_group_timeseries_rptv AS ( with inventory_data as ( select sku_group, product_name, sum(available_units) as available_units from snitch_db.maplemonk.availability_master where available_units is not null group by 1,2 ), rptv as ( select sku_group, date, sum(gross_sales) as gross_sales, sum(clicks) as views, from SNITCH_DB.MAPLEMONK.FINAL_GA_clicks_impressions_by_itemid group by 1,2 order by date ), join_data as ( select r.date, r.sku_group, i.product_name, r.gross_sales, r.views, i.available_units, from rptv r left join inventory_data i on r.sku_group = i.sku_group ) select * from join_data order by date desc ); create or replace table snitch_db.maplemonk.ga_funnel_weekly_and_monthly as ( with w2w_data as ( SELECT Date, Type, ( SELECT SUM(users) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_users, ( SELECT SUM(sessions) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_sessions, ( SELECT SUM(engaged_sessions) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_engaged_sessions, ( SELECT SUM(impressions) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_impressions, ( SELECT SUM(clicks) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_clicks, ( SELECT SUM(add_to_carts) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_add_to_carts, ( SELECT SUM(checkouts) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_checkouts, ( SELECT SUM(order_count) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -6, s.Date) AND s.Date AND Type = s.Type ) AS lw_order_count FROM snitch_db.maplemonk.ga_full_funnel_view s ORDER BY Date DESC ), last5_week_funnel_data as ( SELECT Date, Type, LAG(lw_users, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_user, LAG(lw_users, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_user, LAG(lw_users, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_user, LAG(lw_users, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_user, LAG(lw_users, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_user, LAG(lw_sessions, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_sessions, LAG(lw_sessions, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_sessions, LAG(lw_sessions, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_sessions, LAG(lw_sessions, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_sessions, LAG(lw_sessions, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_sessions, LAG(lw_engaged_sessions, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_engaged_sessions, LAG(lw_engaged_sessions, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_engaged_sessions, LAG(lw_engaged_sessions, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_engaged_sessions, LAG(lw_engaged_sessions, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_engaged_sessions, LAG(lw_engaged_sessions, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_engaged_sessions, LAG(lw_impressions, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_impressions, LAG(lw_impressions, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_impressions, LAG(lw_impressions, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_impressions, LAG(lw_impressions, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_impressions, LAG(lw_impressions, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_impressions, LAG(lw_clicks, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_clicks, LAG(lw_clicks, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_clicks, LAG(lw_clicks, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_clicks, LAG(lw_clicks, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_clicks, LAG(lw_clicks, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_clicks, LAG(lw_add_to_carts, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_add_to_carts, LAG(lw_add_to_carts, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_add_to_carts, LAG(lw_add_to_carts, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_add_to_carts, LAG(lw_add_to_carts, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_add_to_carts, LAG(lw_add_to_carts, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_add_to_carts, LAG(lw_checkouts, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_checkouts, LAG(lw_checkouts, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_checkouts, LAG(lw_checkouts, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_checkouts, LAG(lw_checkouts, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_checkouts, LAG(lw_checkouts, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_checkouts, LAG(lw_order_count, 1) OVER (PARTITION BY Type ORDER BY Date) AS w1_orders, LAG(lw_order_count, 8) OVER (PARTITION BY Type ORDER BY Date) AS w2_orders, LAG(lw_order_count, 15) OVER (PARTITION BY Type ORDER BY Date) AS w3_orders, LAG(lw_order_count, 22) OVER (PARTITION BY Type ORDER BY Date) AS w4_orders, LAG(lw_order_count, 29) OVER (PARTITION BY Type ORDER BY Date) AS w5_orders FROM w2w_data ), m2m_data as ( SELECT Date, Type, ( SELECT SUM(users) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_users, ( SELECT SUM(sessions) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_sessions, ( SELECT SUM(engaged_sessions) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_engaged_sessions, ( SELECT SUM(impressions) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_impressions, ( SELECT SUM(clicks) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_clicks, ( SELECT SUM(add_to_carts) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_add_to_carts, ( SELECT SUM(checkouts) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_checkouts, ( SELECT SUM(order_count) FROM snitch_db.maplemonk.ga_full_funnel_view WHERE Date BETWEEN DATEADD(day, -29, s.Date) AND s.Date AND Type = s.Type ) AS lm_order_count FROM snitch_db.maplemonk.ga_full_funnel_view s ORDER BY Date DESC ), last2_month_funnel_data as ( SELECT Date, Type, LAG(lm_users, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_user, LAG(lm_users, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_user, LAG(lm_sessions, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_sessions, LAG(lm_sessions, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_sessions, LAG(lm_engaged_sessions, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_engaged_sessions, LAG(lm_engaged_sessions, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_engaged_sessions, LAG(lm_impressions, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_impressions, LAG(lm_impressions, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_impressions, LAG(lm_clicks, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_clicks, LAG(lm_clicks, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_clicks, LAG(lm_add_to_carts, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_add_to_carts, LAG(lm_add_to_carts, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_add_to_carts, LAG(lm_checkouts, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_checkouts, LAG(lm_checkouts, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_checkouts, LAG(lm_order_count, 1) OVER (PARTITION BY Type ORDER BY Date) AS m1_orders, LAG(lm_order_count, 31) OVER (PARTITION BY Type ORDER BY Date) AS m2_orders, FROM m2m_data ), main_data as ( select w.Date, w.type, w.w1_user, w.w2_user, ((w.w1_user-w.w2_user)/w.w2_user)*100 as w1_user_change, w.w3_user, ((w.w2_user-w.w3_user)/w.w3_user)*100 as w2_user_change, w.w4_user, ((w.w3_user-w.w4_user)/w.w4_user)*100 as w3_user_change, w.w5_user, ((w.w4_user-w.w5_user)/w.w5_user)*100 as w4_user_change, w.w1_sessions, w.w2_sessions, ((w.w1_sessions-w.w2_sessions)/w.w2_sessions)*100 as w1_sessions_change, w.w3_sessions, ((w.w2_sessions-w.w3_sessions)/w.w3_sessions)*100 as w2_sessions_change, w.w4_sessions, ((w.w3_sessions-w.w4_sessions)/w.w4_sessions)*100 as w3_sessions_change, w.w5_sessions, ((w.w4_sessions-w.w5_sessions)/w.w5_sessions)*100 as w4_sessions_change, w.w1_engaged_sessions, w.w2_engaged_sessions, ((w.w1_engaged_sessions-w.w2_engaged_sessions)/w.w2_engaged_sessions)*100 as w1_engaged_sessions_change, w.w3_engaged_sessions, ((w.w2_engaged_sessions-w.w3_engaged_sessions)/w.w3_engaged_sessions)*100 as w2_engaged_sessions_change, w.w4_engaged_sessions, ((w.w3_engaged_sessions-w.w4_engaged_sessions)/w.w4_engaged_sessions)*100 as w3_engaged_sessions_change, w.w5_engaged_sessions, ((w.w4_engaged_sessions-w.w5_engaged_sessions)/w.w5_engaged_sessions)*100 as w4_engaged_sessions_change, w.w1_impressions, w.w2_impressions, ((w.w1_impressions-w.w2_impressions)/w.w2_impressions)*100 as w1_impressions_change, w.w3_impressions, ((w.w2_impressions-w.w3_impressions)/w.w3_impressions)*100 as w2_impressions_change, w.w4_impressions, ((w.w3_impressions-w.w4_impressions)/w.w4_impressions)*100 as w3_impressions_change, w.w5_impressions, ((w.w4_impressions-w.w5_impressions)/w.w5_impressions)*100 as w4_impressions_change, w.w1_clicks, w.w2_clicks, ((w.w1_clicks-w.w2_clicks)/w.w2_clicks)*100 as w1_clicks_change, w.w3_clicks, ((w.w2_clicks-w.w3_clicks)/w.w3_clicks)*100 as w2_clicks_change, w.w4_clicks, ((w.w3_clicks-w.w4_clicks)/w.w4_clicks)*100 as w3_clicks_change, w.w5_clicks, ((w.w4_clicks-w.w5_clicks)/w.w5_clicks)*100 as w4_clicks_change, w.w1_add_to_carts, w.w2_add_to_carts, ((w.w1_add_to_carts-w.w2_add_to_carts)/w.w2_add_to_carts)*100 as w1_add_to_carts_change, w.w3_add_to_carts, ((w.w2_add_to_carts-w.w3_add_to_carts)/w.w3_add_to_carts)*100 as w2_add_to_carts_change, w.w4_add_to_carts, ((w.w3_add_to_carts-w.w4_add_to_carts)/w.w4_add_to_carts)*100 as w3_add_to_carts_change, w.w5_add_to_carts, ((w.w4_add_to_carts-w.w5_add_to_carts)/w.w5_add_to_carts)*100 as w4_add_to_carts_change, w.w1_checkouts, w.w2_checkouts, ((w.w1_checkouts-w.w2_checkouts)/w.w2_checkouts)*100 as w1_checkouts_change, w.w3_checkouts, ((w.w2_checkouts-w.w3_checkouts)/w.w3_checkouts)*100 as w2_checkouts_change, w.w4_checkouts, ((w.w3_checkouts-w.w4_checkouts)/w.w4_checkouts)*100 as w3_checkouts_change, w.w5_checkouts, ((w.w4_checkouts-w.w5_checkouts)/w.w4_checkouts)*100 as w4_checkouts_change, w.w1_orders, w.w2_orders, ((w.w1_orders-w.w2_orders)/w.w2_orders)*100 as w1_orders_change, w.w3_orders, ((w.w2_orders-w.w3_orders)/w.w3_orders)*100 as w2_orders_change, w.w4_orders, ((w.w3_orders-w.w4_orders)/w.w4_orders)*100 as w3_orders_change, w.w5_orders, ((w.w4_orders-w.w5_orders)/w.w5_orders)*100 as w4_orders_change, m.m1_user, m.m2_user, ((m.m1_user-m.m2_user)/m.m2_user)*100 as m1_user_change, m.m1_sessions, m.m2_sessions, ((m.m1_sessions-m.m2_sessions)/m.m2_sessions)*100 as m1_sessions_change, m.m1_engaged_sessions, m.m2_engaged_sessions, ((m.m1_engaged_sessions-m.m2_engaged_sessions)/m.m2_engaged_sessions)*100 as m1_engaged_sessions_change, m.m1_impressions, m.m2_impressions, ((m.m1_impressions-m.m2_impressions)/m.m2_impressions)*100 as m1_impressions_change, m.m1_clicks, m.m2_clicks, ((m.m1_clicks-m.m2_clicks)/m.m2_clicks)*100 as m1_clicks_change, m.m1_add_to_carts, m.m2_add_to_carts, ((m.m1_add_to_carts-m.m2_add_to_carts)/m.m2_add_to_carts)*100 as m1_add_to_carts_change, m.m1_checkouts, m.m2_checkouts, ((m.m1_checkouts-m.m2_checkouts)/m.m2_checkouts)*100 as m1_checkouts_change, m.m1_orders, m.m2_orders, ((m.m1_orders-m.m2_orders)/m.m2_orders)*100 as m1_orders_change, (w.w1_engaged_sessions/w.w1_sessions)*100 as w1_engaged_sessions_percentage, (w.w2_engaged_sessions/w.w2_sessions)*100 as w2_engaged_sessions_percentage, ((w1_engaged_sessions_percentage-w2_engaged_sessions_percentage)/w2_engaged_sessions_percentage)*100 as w1_engaged_sessions_percentage_change, (w.w3_engaged_sessions/w.w3_sessions)*100 as w3_engaged_sessions_percentage, ((w2_engaged_sessions_percentage-w3_engaged_sessions_percentage)/w3_engaged_sessions_percentage)*100 as w2_engaged_sessions_percentage_change, (w.w4_engaged_sessions/w.w4_sessions)*100 as w4_engaged_sessions_percentage, ((w3_engaged_sessions_percentage-w4_engaged_sessions_percentage)/w4_engaged_sessions_percentage)*100 as w3_engaged_sessions_percentage_change, (w.w5_engaged_sessions/w.w5_sessions)*100 as w5_engaged_sessions_percentage, ((w4_engaged_sessions_percentage-w5_engaged_sessions_percentage)/w5_engaged_sessions_percentage)*100 as w4_engaged_sessions_percentage_change, (m.m1_sessions/m.m1_engaged_sessions)*100 as m1_engaged_sessions_percentage, (m.m2_sessions/m.m2_engaged_sessions)*100 as m2_engaged_sessions_percentage, ((m1_engaged_sessions_percentage-m2_engaged_sessions_percentage)/m2_engaged_sessions_percentage)*100 as m1_engaged_sessions_percentage_change, (w.w1_clicks/w.w1_impressions)*100 as w1_impressions_to_clicks, (w.w2_clicks/w.w2_impressions)*100 as w2_impressions_to_clicks, ((w1_impressions_to_clicks-w2_impressions_to_clicks)/w2_impressions_to_clicks)*100 as w1_impressions_to_clicks_change, (w.w3_clicks/w.w3_impressions)*100 as w3_impressions_to_clicks, ((w2_impressions_to_clicks-w3_impressions_to_clicks)/w3_impressions_to_clicks)*100 as w2_impressions_to_clicks_change, (w.w4_clicks/w.w4_impressions)*100 as w4_impressions_to_clicks, ((w3_impressions_to_clicks-w4_impressions_to_clicks)/w4_impressions_to_clicks)*100 as w3_impressions_to_clicks_change, (w.w5_clicks/w.w5_impressions)*100 as w5_impressions_to_clicks, ((w4_impressions_to_clicks-w5_impressions_to_clicks)/w5_impressions_to_clicks)*100 as w4_impressions_to_clicks_change, (m.m1_clicks/m.m1_impressions)*100 as m1_impressions_to_clicks, (m.m2_clicks/m.m2_impressions)*100 as m2_impressions_to_clicks, ((m1_impressions_to_clicks-m2_impressions_to_clicks)/m2_impressions_to_clicks)*100 as m1_impressions_to_clicks_change, (w.w1_add_to_carts/w.w1_clicks)*100 as w1_clicks_to_a2c, (w.w2_add_to_carts/w.w2_clicks)*100 as w2_clicks_to_a2c, ((w1_clicks_to_a2c-w2_clicks_to_a2c)/w2_clicks_to_a2c)*100 as w1_clicks_to_a2c_change, (w.w3_add_to_carts/w.w3_clicks)*100 as w3_clicks_to_a2c, ((w2_clicks_to_a2c-w3_clicks_to_a2c)/w3_clicks_to_a2c)*100 as w2_clicks_to_a2c_change, (w.w4_add_to_carts/w.w4_clicks)*100 as w4_clicks_to_a2c, ((w3_clicks_to_a2c-w4_clicks_to_a2c)/w4_clicks_to_a2c)*100 as w3_clicks_to_a2c_change, (w.w5_add_to_carts/w.w5_clicks)*100 as w5_clicks_to_a2c, ((w4_clicks_to_a2c-w5_clicks_to_a2c)/w5_clicks_to_a2c)*100 as w4_clicks_to_a2c_change, (m.m1_add_to_carts/m.m1_clicks)*100 as m1_clicks_to_a2c, (m.m2_add_to_carts/m.m2_clicks)*100 as m2_clicks_to_a2c, ((m1_clicks_to_a2c-m2_clicks_to_a2c)/m2_clicks_to_a2c)*100 as m1_clicks_to_a2c_change, (w.w1_checkouts/w.w1_add_to_carts)*100 as w1_a2c_to_checkout, (w.w2_checkouts/w.w2_add_to_carts)*100 as w2_a2c_to_checkout, ((w1_a2c_to_checkout-w2_a2c_to_checkout)/w2_a2c_to_checkout)*100 as w1_a2c_to_checkout_change, (w.w3_checkouts/w.w3_add_to_carts)*100 as w3_a2c_to_checkout, ((w2_a2c_to_checkout-w3_a2c_to_checkout)/w3_a2c_to_checkout)*100 as w2_a2c_to_checkout_change, (w.w4_checkouts/w.w4_add_to_carts)*100 as w4_a2c_to_checkout, ((w3_a2c_to_checkout-w4_a2c_to_checkout)/w4_a2c_to_checkout)*100 as w3_a2c_to_checkout_change, (w.w5_checkouts/w.w5_add_to_carts)*100 as w5_a2c_to_checkout, ((w4_a2c_to_checkout-w5_a2c_to_checkout)/w5_a2c_to_checkout)*100 as w4_a2c_to_checkout_change, (m.m1_checkouts/m.m1_add_to_carts)*100 as m1_a2c_to_checkout, (m.m2_checkouts/m.m2_add_to_carts)*100 as m2_a2c_to_checkout, ((m1_a2c_to_checkout-m2_a2c_to_checkout)/m2_a2c_to_checkout)*100 as m1_a2c_to_checkout_change, (w.w1_orders/w.w1_checkouts)*100 as w1_checkout_to_order, (w.w2_orders/w.w2_checkouts)*100 as w2_checkout_to_order, ((w1_checkout_to_order-w2_checkout_to_order)/w2_checkout_to_order)*100 as w1_checkout_to_order_change, (w.w3_orders/w.w3_checkouts)*100 as w3_checkout_to_order, ((w2_checkout_to_order-w3_checkout_to_order)/w3_checkout_to_order)*100 as w2_checkout_to_order_change, (w.w4_orders/w.w4_checkouts)*100 as w4_checkout_to_order, ((w3_checkout_to_order-w4_checkout_to_order)/w4_checkout_to_order)*100 as w3_checkout_to_order_change, (w.w5_orders/w.w5_checkouts)*100 as w5_checkout_to_order, ((w4_checkout_to_order-w5_checkout_to_order)/w5_checkout_to_order)*100 as w4_checkout_to_order_change, (m.m1_orders/m.m1_checkouts)*100 as m1_checkout_to_order, (m.m2_orders/m.m2_checkouts)*100 as m2_checkout_to_order, ((m1_checkout_to_order-m2_checkout_to_order)/m2_checkout_to_order)*100 as m1_checkout_to_order_change from last5_week_funnel_data w left join last2_month_funnel_data m on w.date = m.date and w.type = m.type order by w.date desc limit 100 ), pivot_data as ( SELECT date, type, \'user\' AS metric, s.w1_user AS w1, s.w2_user AS w2, s.w3_user AS w3, s.w4_user AS w4, s.w5_user AS w5, s.w1_user_change as wow1_change, s.w2_user_change as wow2_change, s.w3_user_change as wow3_change, s.w4_user_change as wow4_change, s.m1_user as m1, s.m2_user as m2, s.m1_user_change as mom1_change FROM main_data s union all SELECT date, type, \'sessions\' AS metric, s.w1_sessions AS w1, s.w2_sessions AS w2, s.w3_sessions AS w3, s.w4_sessions AS w4, s.w5_sessions AS w5, s.w1_sessions_change as wow1_change, s.w2_sessions_change as wow2_change, s.w3_sessions_change as wow3_change, s.w4_sessions_change as wow4_change, s.m1_sessions as m1, s.m2_sessions as m2, s.m1_sessions_change as mom1_change FROM main_data s union all SELECT date, type, \'engaged_sessions\' AS metric, s.w1_engaged_sessions as w1, s.w2_engaged_sessions as w2, s.w3_engaged_sessions as w3, s.w4_engaged_sessions as w4, s.w5_engaged_sessions as w5, s.w1_engaged_sessions_change as wow1_change, s.w2_engaged_sessions_change as wow2_change, s.w3_engaged_sessions_change as wow3_change, s.w4_engaged_sessions_change as wow4_change, s.m1_engaged_sessions as m1, s.m2_engaged_sessions as m2, s.m1_engaged_sessions_change as mom1_change FROM main_data s union all SELECT date, type, \'impressions\' AS metric, s.w1_impressions as w1, s.w2_impressions as w2, s.w3_impressions as w3, s.w4_impressions as w4, s.w5_impressions as w5, s.w1_impressions_change as wow1_change, s.w2_impressions_change as wow2_change, s.w3_impressions_change as wow3_change, s.w4_impressions_change as wow4_change, s.m1_impressions as m1, s.m2_impressions as m2, s.m1_impressions_change as mom1_change FROM main_data s union all SELECT date, type, \'clicks\' AS metric, s.w1_clicks as w1, s.w2_clicks as w2, s.w3_clicks as w3, s.w4_clicks as w4, s.w5_clicks as w5, s.w1_clicks_change as wow1_change, s.w2_clicks_change as wow2_change, s.w3_clicks_change as wow3_change, s.w4_clicks_change as wow4_change, s.m1_clicks as m1, s.m2_clicks as m2, s.m1_clicks_change as mom1_change FROM main_data s union all SELECT date, type, \'add_to_carts\' AS metric, s.w1_add_to_carts as w1, s.w2_add_to_carts as w2, s.w3_add_to_carts as w3, s.w4_add_to_carts as w4, s.w5_add_to_carts as w5, s.w1_add_to_carts_change as wow1_change, s.w2_add_to_carts_change as wow2_change, s.w3_add_to_carts_change as wow3_change, s.w4_add_to_carts_change as wow4_change, s.m1_add_to_carts as m1, s.m2_add_to_carts as m2, s.m1_add_to_carts_change as mom1_change FROM main_data s union all SELECT date, type, \'checkouts\' AS metric, s.w1_checkouts as w1, s.w2_checkouts as w2, s.w3_checkouts as w3, s.w4_checkouts as w4, s.w5_checkouts as w5, s.w1_checkouts_change as wow1_change, s.w2_checkouts_change as wow2_change, s.w3_checkouts_change as wow3_change, s.w4_checkouts_change as wow4_change, s.m1_checkouts as m1, s.m2_checkouts as m2, s.m1_checkouts_change as mom1_change FROM main_data s union all SELECT date, type, \'orders\' AS metric, s.w1_orders as w1, s.w2_orders as w2, s.w3_orders as w3, s.w4_orders as w4, s.w5_orders as w5, s.w1_orders_change as wow1_change, s.w2_orders_change as wow2_change, s.w3_orders_change as wow3_change, s.w4_orders_change as wow4_change, s.m1_orders as m1, s.m2_orders as m2, s.m1_orders_change as mom1_change FROM main_data s union all SELECT date, type, \'engaged_sessions_percentage\' AS metric, s.w1_engaged_sessions_percentage as w1, s.w2_engaged_sessions_percentage as w2, s.w3_engaged_sessions_percentage as w3, s.w4_engaged_sessions_percentage as w4, s.w5_engaged_sessions_percentage as w5, s.w1_engaged_sessions_percentage_change as wow1_change, s.w2_engaged_sessions_percentage_change as wow2_change, s.w3_engaged_sessions_percentage_change as wow3_change, s.w4_engaged_sessions_percentage_change as wow4_change, s.m1_engaged_sessions_percentage as m1, s.m2_engaged_sessions_percentage as m2, s.m1_engaged_sessions_percentage_change as mom1_change FROM main_data s union all SELECT date, type, \'impressions_to_clicks\' AS metric, s.w1_impressions_to_clicks as w1, s.w2_impressions_to_clicks as w2, s.w3_impressions_to_clicks as w3, s.w4_impressions_to_clicks as w4, s.w5_impressions_to_clicks as w5, s.w1_impressions_to_clicks_change as wow1_change, s.w2_impressions_to_clicks_change as wow2_change, s.w3_impressions_to_clicks_change as wow3_change, s.w4_impressions_to_clicks_change as wow4_change, s.m1_impressions_to_clicks as m1, s.m2_impressions_to_clicks as m2, s.m1_impressions_to_clicks_change as mom1_change FROM main_data s union all SELECT date, type, \'clicks_to_a2c\' AS metric, s.w1_clicks_to_a2c as w1, s.w2_clicks_to_a2c as w2, s.w3_clicks_to_a2c as w3, s.w4_clicks_to_a2c as w4, s.w5_clicks_to_a2c as w5, s.w1_clicks_to_a2c_change as wow1_change, s.w2_clicks_to_a2c_change as wow2_change, s.w3_clicks_to_a2c_change as wow3_change, s.w4_clicks_to_a2c_change as wow4_change, s.m1_clicks_to_a2c as m1, s.m2_clicks_to_a2c as m2, s.m1_clicks_to_a2c_change as mom1_change FROM main_data s union all SELECT date, type, \'a2c_to_checkout\' AS metric, s.w1_a2c_to_checkout as w1, s.w2_a2c_to_checkout as w2, s.w3_a2c_to_checkout as w3, s.w4_a2c_to_checkout as w4, s.w5_a2c_to_checkout as w5, s.w1_a2c_to_checkout_change as wow1_change, s.w2_a2c_to_checkout_change as wow2_change, s.w3_a2c_to_checkout_change as wow3_change, s.w4_a2c_to_checkout_change as wow4_change, s.m1_a2c_to_checkout as m1, s.m2_a2c_to_checkout as m2, s.m1_a2c_to_checkout_change as mom1_change FROM main_data s union all SELECT date, type, \'checkout_to_order\' AS metric, s.w1_checkout_to_order as w1, s.w2_checkout_to_order as w2, s.w3_checkout_to_order as w3, s.w4_checkout_to_order as w4, s.w5_checkout_to_order as w5, s.w1_checkout_to_order_change as wow1_change, s.w2_checkout_to_order_change as wow2_change, s.w3_checkout_to_order_change as wow3_change, s.w4_checkout_to_order_change as wow4_change, s.m1_checkout_to_order as m1, s.m2_checkout_to_order as m2, s.m1_checkout_to_order_change as mom1_change from main_data s ) select * from pivot_data ); create or replace table snitch_db.maplemonk.source_medium_campaign_ga_funnel_data as ( WITH sessions_data AS ( SELECT TO_DATE(w.date, \'YYYYMMDD\') AS ga_date, \'web\' AS type, w.sessionsource, w.sessionmedium, w.sessioncampaignname, COALESCE( CASE WHEN LOWER(w.sessionsource) LIKE \'%facebook%\' AND LOWER(w.sessionmedium) = \'paid\' THEN \'Facebook_Ads\' WHEN LOWER(w.sessionmedium) = \'affiliate\' THEN \'Affiliate\' WHEN LOWER(w.sessionsource) = \'whatsapp\' AND LOWER(w.sessionmedium) = \'sms\' THEN \'Whatsapp\' WHEN LOWER(w.sessionsource) = \'email\' AND LOWER(w.sessionmedium) = \'mailmodo\' THEN \'Email\' WHEN LOWER(w.sessionsource) = \'google\' AND LOWER(w.sessionmedium) = \'cpc\' THEN \'Google_Ads\' WHEN LOWER(w.sessioncampaignname) = \'affiliate_bajaj\' THEN \'Affiliate\' WHEN (LOWER(w.sessionsource) = \'bing\' OR LOWER(w.sessionsource) = \'duckduckgo\' OR LOWER(w.sessionsource) = \'yahoo\') AND LOWER(w.sessionmedium) = \'organic\' THEN \'Direct\' WHEN LOWER(w.sessionsource) = \'facebookads\' AND w.sessionmedium = \'Custom Ads - Cost Cap - Prospect\' THEN \'Facebook_Ads\' WHEN LOWER(w.sessionsource) = \'google\' AND w.sessionmedium = \'cpc\' THEN \'Google_Ads\' WHEN w.sessionsource IN (\'mailmodo\', \'email_amp\') THEN \'Email\' WHEN w.sessionsource = \'(not set)\' THEN \'Direct\' WHEN w.sessionsource = \'Limechat\' AND w.sessionmedium = \'Whatsapp\' THEN \'Direct\' when lower(w.sessionmedium) = \'referral\' then \'Direct\' ELSE m.channel END, m.channel ) AS channel, w.sessions, w.engagedsessions, w.addtocarts, w.checkouts, w.totalrevenue FROM snitch_db.maplemonk.WEB_SESSION_A2C_CHECKOUT_CONVERSION_SMC w LEFT JOIN snitch_db.maplemonk.GA_CHANNEL_MAPPING m ON LOWER(w.sessionsource) = LOWER(m.source) AND LOWER(w.sessionmedium) = LOWER(m.medium) AND LOWER(w.sessioncampaignname) = LOWER(m.sessioncampaignname) UNION SELECT TO_DATE(w.date, \'YYYYMMDD\') AS ga_date, \'app\' AS type, w.sessionsource, w.sessionmedium, w.sessioncampaignname, COALESCE( CASE WHEN LOWER(w.sessionsource) LIKE \'%facebook%\' AND LOWER(w.sessionmedium) = \'paid\' THEN \'Facebook_Ads\' WHEN LOWER(w.sessionmedium) = \'affiliate\' THEN \'Affiliate\' WHEN LOWER(w.sessionsource) = \'whatsapp\' AND LOWER(w.sessionmedium) = \'sms\' THEN \'Whatsapp\' WHEN LOWER(w.sessionsource) = \'email\' AND LOWER(w.sessionmedium) = \'mailmodo\' THEN \'Email\' WHEN LOWER(w.sessionsource) = \'google\' AND LOWER(w.sessionmedium) = \'cpc\' THEN \'Google_Ads\' WHEN LOWER(w.sessioncampaignname) = \'affiliate_bajaj\' THEN \'Affiliate\' WHEN (LOWER(w.sessionsource) = \'bing\' OR LOWER(w.sessionsource) = \'duckduckgo\' OR LOWER(w.sessionsource) = \'yahoo\') AND LOWER(w.sessionmedium) = \'organic\' THEN \'Direct\' WHEN LOWER(w.sessionsource) = \'facebookads\' AND w.sessionmedium = \'Custom Ads - Cost Cap - Prospect\' THEN \'Facebook_Ads\' WHEN LOWER(w.sessionsource) = \'google\' AND w.sessionmedium = \'cpc\' THEN \'Google_Ads\' WHEN w.sessionsource IN (\'mailmodo\', \'email_amp\') THEN \'Email\' WHEN w.sessionsource = \'(not set)\' THEN \'Direct\' WHEN w.sessionsource = \'Limechat\' AND w.sessionmedium = \'Whatsapp\' THEN \'Direct\' when w.sessionsource = \'direct\' then \'Direct\' when w.sessionsource = \'(direct)\' then \'Direct\' when w.sessionmedium is null and w.sessionsource is null and w.sessioncampaignname is null then \'Direct\' when w.sessionmedium = \'organic\' then \'Direct\' when w.sessionmedium = \'email_html\' and w.sessionsource = \'mailmodo\' then \'Email\' when w.sessionmedium = \'email\' then \'Email\' when w.sessionmedium = \'WhatsApp\' then \'WhatsApp\' when w.sessionmedium = \'SMS \' or w.sessionmedium = \'SMS\' then \'SMS\' when lower(w.sessionmedium) = \'push\' then \'Push\' when w.sessionsource = \'wishlink\' then \'Affiliate\' when w.sessionmedium = \'cpc_EMAIL\' or w.sessionmedium = \'Email\' then \'Email\' ELSE m.channel END, m.channel ) AS channel, w.sessions, w.engagedsessions, w.addtocarts, w.checkouts, w.totalrevenue FROM snitch_db.maplemonk.APP_SESSIONS_A2C_CHECKOUTS_CONVERSIONS_SMC w LEFT JOIN snitch_db.maplemonk.app_mapping m ON LOWER(w.sessionsource) = LOWER(m.source) AND LOWER(w.sessionmedium) = LOWER(m.medium) AND LOWER(w.sessioncampaignname) = LOWER(m.sessioncampaignname) ), views_data AS ( SELECT TO_DATE(date, \'YYYYMMDD\') AS ga_date, \'web\' AS type, sessionsource, sessionmedium, sessioncampaignname, itemsviewedinlist AS views, itemsviewed AS clicks FROM snitch_db.maplemonk.WEB_VIEWS_CLICKS_SMC UNION SELECT TO_DATE(date, \'YYYYMMDD\') AS ga_date, \'app\' AS type, sessionsource, sessionmedium, sessioncampaignname, itemsviewedinlist AS views, itemsviewed AS clicks FROM snitch_db.maplemonk.APP_VIEWS_CLICKS_SMC ) SELECT s.ga_date, s.sessionsource, s.type, s.sessionmedium, s.sessioncampaignname, COALESCE(s.channel, \'Others\') AS channel, s.sessions, s.engagedsessions, COALESCE(v.views,0) as views, COALESCE(v.clicks,0) as clicks, s.addtocarts, s.checkouts, s.totalrevenue FROM sessions_data s LEFT JOIN views_data v ON s.ga_date = v.ga_date AND s.type = v.type AND s.sessionsource = v.sessionsource AND s.sessionmedium = v.sessionmedium AND s.sessioncampaignname = v.sessioncampaignname );",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        