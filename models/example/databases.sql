{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table faballey_db.Maplemonk.Order_Fulfillment_Report_fab as select order_id ,product_id ,product_name ,product_category ,marketplace ,max(order_date::timestamp) Order_Date ,max(dispatch_date) as Order_manifest_date ,max(coalesce(delivered_date ,shipping_last_update_date) ) Order_Shipping_Last_Update_Date ,delivered_date ,sku ,sku_code ,order_status ,shipping_status ,item_status ,coalesce(pm.\"Mapped Status\",am.\"Mapped Status\") as final_status ,city ,state ,country ,courier ,source ,shipping_price_inr ,return_flag ,case when lower(final_status) = \'delivered\' then 1 else 0 end as delivered_order, case when final_status = \'Order Yet To sync\' then 1 else 0 end as Order_yet_to_Sync_Order, case when final_status = \'Confirmed\' then 1 else 0 end as Confirmed_Order, case when final_status = \'Assigned\' then 1 else 0 end as Assigned_Order, case when final_status = \'Open\' then 1 else 0 end as Open_Order, case when final_status = \'Printed\' then 1 else 0 end as Printed_Order, case when final_status = \'Pending\' then 1 else 0 end as Pending_Order, case when final_status = \'In Transit\' then 1 else 0 end as In_Transit_order, case when final_status = \'RTO\' then 1 else 0 end as RTO_Order, case when final_status = \'RTS\' then 1 else 0 end as RTS_Order, case when final_status = \'Returned\' then 1 else 0 end as Returned_order, case when final_status = \'Pickup Error\' then 1 else 0 end as Pickup_Error, case when final_status = \'Lost\' then 1 else 0 end as Lost_Order, case when final_status = \'Exception\' then 1 else 0 end as Exception_Order, case when final_status = \'Misrouted\' then 1 else 0 end as Misrouted_Order, case when final_status = \'Underprocess\' then 1 else 0 end as Underprocess_Order, case when final_status = \'Damaged\' then 1 else 0 end as Damaged_Order, case when final_status = \'Indian Speed Post\' then 1 else 0 end as Indian_Speed_Post_Order, case when final_status = \'Cancelled\' then 1 else 0 end as cancelled_order, case when delivered_order = 1 then datediff(\'hour\',Order_Date::timestamp ,Order_Shipping_Last_Update_Date ) else datediff(\'hour\',order_date::timestamp ,convert_timezone(\'America/Los_Angeles\', \'Asia/Kolkata\', current_timestamp())) end as Time_From_Order, case when Time_from_Order <= 24 then \'1. <24 hours\' when Time_from_Order <= 48 then \'2. 25 - 48 hours\' when Time_from_Order <= 72 then \'3. 49 - 72 hours\' when Time_from_Order <= 96 then \'4. 73 - 96 hours\' when Time_from_Order <= 120 then \'5. 97 - 120 hours\' when Time_from_Order <= 144 then \'6. 121 - 144 hours\' when Time_from_Order <= 144 then \'7. 145 - 168 hours\' else \'8. More than a week\' end as Time_From_Order_Category, datediff(\'hour\',order_date::timestamp ,order_manifest_date) Dispatch_Speed, case when Dispatch_Speed < 2 then \'0- 2 hours\' when Dispatch_Speed < 6 then \'2 - 6 hours\' when Dispatch_Speed < 12 then \'6 - 12 hours\' when Dispatch_Speed < 24 then \'12 - 24 hours\' when Dispatch_Speed < 48 then \'24-48 hours\' when Dispatch_Speed < 72 then \'48-72 hours\' when Dispatch_Speed < 96 then \'72-96 hours\' when order_manifest_date is not NULL then \'> 96 hours\' when order_manifest_date is NULL then \'Not Dispatched\' end as Dispatch_Speed_flag, case when delivered_order = 1 then datediff(\'hour\',order_manifest_date , order_shipping_last_update_date ) end as Delivery_Speed, case when delivered_order = 1 then datediff(\'hour\',order_manifest_date ,order_shipping_last_update_date ) else datediff(\'hour\',order_manifest_date ,convert_timezone(\'America/Los_Angeles\', \'Asia/Kolkata\', current_timestamp())) end as deliver_time, case when delivered_order = 1 and datediff(\'hour\',order_manifest_date,order_shipping_last_update_date ) < 24 then \'0-24 hours\' when delivered_order = 1 and datediff(\'hour\',order_manifest_date,order_shipping_last_update_date ) < 48 then \'24-48 hours\' when delivered_order = 1 and datediff(\'hour\',order_manifest_date,order_shipping_last_update_date ) < 72 then \'48-72 hours\' when delivered_order = 1 and datediff(\'hour\',order_manifest_date,order_shipping_last_update_date ) < 96 then \'72-96 hours\' when delivered_order = 1 then \'> 96 hours\' else \'Not Delivered\' end as delivery_time_flag, case when order_manifest_date is NULL then \'Before Dispatch\' else \'After Dispatch\' end as dispatch_status from faballey_db.maplemonk.unicommerce_fact_items_faballey_final a left join faballey_shipment_status_mapping am on lower(a.item_status) = lower(am.status) left join faballey_shipment_status_mapping pm on lower(a.shipping_status) = lower(pm.status) where lower(marketplace) = \'custom\' group by order_id ,order_date ,product_id ,product_name ,product_category ,marketplace ,delivered_date ,sku ,sku_code ,order_status ,shipping_status ,item_status ,final_status ,city ,state ,country ,courier ,source ,shipping_price_inr ,return_flag",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from FABALLEY_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        