{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table snitch_db.maplemonk.Inventory_summary_marketplace_snitch as with last90_days as ( select a.sku ,product_name ,c.category ,b.first_order_date first_order_date ,a.marketplace ,sum(suborder_quantity) as quantity from snitch_db.maplemonk.unicommerce_fact_items_snitch a left join (select sku, min(order_date) first_order_date from snitch_db.maplemonk.unicommerce_fact_items_snitch group by 1) b on a.sku = b.sku left join (select distinct sku, category from snitch_db.maplemonk.fact_items_snitch where category is not null) c on a.sku = c.sku where order_date::date <= current_timestamp()::date and order_date::date >= dateadd(\'day\',-90,current_timestamp()::date) and lower(order_status) <> \'cancelled\' and lower(shipping_status) <> \'returned\' and a.source not in (\'SHOPIFY\') group by 1,2,3,4,5 ) ,last30_days as ( select sku ,product_name ,marketplace ,sum(suborder_quantity) as quantity from snitch_db.maplemonk.unicommerce_fact_items_snitch where order_date::date <= current_timestamp()::date and order_date::date >= dateadd(\'day\',-30,current_timestamp()::date) and lower(order_status) <> \'cancelled\' and lower(shipping_status) <> \'returned\' and source not in (\'SHOPIFY\') group by 1,2,3 ),last7_days as( select sku ,product_name ,marketplace ,sum(suborder_quantity) as quantity from snitch_db.maplemonk.unicommerce_fact_items_snitch where order_date::date <= current_timestamp()::date and order_date::date >= dateadd(\'day\',-7,current_timestamp()::date) and lower(order_status) <> \'cancelled\' and lower(shipping_status) <> \'returned\' and source not in (\'SHOPIFY\') group by 1,2,3 ),last3_days as( select sku ,product_name ,marketplace ,sum(suborder_quantity) as quantity from snitch_db.maplemonk.unicommerce_fact_items_snitch where order_date::date <= current_timestamp()::date and order_date::date >= dateadd(\'day\',-3,current_timestamp()::date) and lower(order_status) <> \'cancelled\' and lower(shipping_status) <> \'returned\' and source not in (\'SHOPIFY\') group by 1,2,3 ), inventory as( select distinct a.sku, a.inventory_quantity, a.updated_at from (select * from snitch_db.maplemonk.shopifyindia_products_variants where inventory_item_id in (select distinct inventory_item_id from (select sku, inventory_item_id, row_number() over(partition by sku order by updated_at desc) rw from snitch_db.maplemonk.shopifyindia_products_variants) where rw=1)) a left join (select sku, max(updated_at) date from (select * from snitch_db.maplemonk.shopifyindia_products_variants where inventory_item_id in (select distinct inventory_item_id from (select sku, inventory_item_id, row_number() over(partition by sku order by updated_at desc) rw from snitch_db.maplemonk.shopifyindia_products_variants) where rw=1)) group by sku) b on a.sku=b.sku and a.updated_at = b.date where b.date is not null ) select max(i.updated_at ::date) Inventory_last_updated_at ,min(first_order_Date) first_order_date ,case when right(a.sku,2) = \'-S\' then left(a.sku,len(a.sku)-2) else replace(a.sku,concat(\'-\',split_part(a.sku,\'-\',-1)),\'\') end as SKU_group ,a.product_name product_name ,category ,a.marketplace ,sum(ifnull(a.quantity,0)) as units_sold_L90 ,sum(ifnull(b.quantity,0)) as units_sold_L30 ,sum(ifnull(c.quantity,0)) as units_sold_L7 ,sum(ifnull(d.quantity,0)) as units_sold_L3 ,sum(inventory_quantity) as inventory_available ,case when sum(ifnull(a.quantity,0))=0 then 0 else round(sum(inventory_quantity)/((sum(a.quantity) /90)*7),2) end as Weeks_of_Supply_L90 ,case when sum(ifnull(b.quantity,0))=0 then 0 else round(sum(inventory_quantity)/((sum(b.quantity) /30)*7),2) end as Weeks_of_Supply_L30 ,case when sum(ifnull(c.quantity,0))=0 then 0 else round(sum(inventory_quantity)/((sum(c.quantity) /7)*7),2) end as Weeks_of_Supply_L7 from last90_days a left join inventory i on a.sku = i.sku left join last30_days b on a.sku = b.sku and a.marketplace = b.marketplace left join last7_days c on a.sku = c.sku and a.marketplace = c.marketplace left join last3_days d on a.sku = d.sku and a.marketplace = d.marketplace group by 3,4,5,6 order by 1,2 desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        