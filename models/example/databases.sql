{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table Vahdam_db.maplemonk.D2C_Summary_Vahdam as with Sales_Metric as ( Select order_date ,upper(shop_name) as Region ,Upper(Final_Channel) as channel ,upper(case when lower(FINAL_CAMPAIGN) like any(\'%sc%\',\'%vt%\',\'%vm%\',\'%global%\') and lower(Final_Channel) like \'%facebook%\' then \'FB Main\' when lower(FINAL_CAMPAIGN) like \'%prospecting%\' and lower(Final_Channel) like \'%facebook%\' then \'FB Whitelisting\' when lower(FINAL_CAMPAIGN) like \'%discovery%\' and lower(Final_Channel) like \'%facebook%\' then \'FB Content\' when lower(CAMPAIGN_TYPE) like \'%search%\' and lower(Final_Channel) like \'%google%\' then \'Search\' when lower(CAMPAIGN_TYPE) like \'%shopping%\' and lower(Final_Channel) like \'%google%\' then \'Shopping\' when lower(CAMPAIGN_TYPE) like \'%display%\' and lower(Final_Channel) like \'%google%\' then \'Display\' when lower(CAMPAIGN_TYPE) like \'%video%\' and lower(Final_Channel) like \'%google%\' then \'Video\' when lower(CAMPAIGN_TYPE) like \'%performance_max%\' and lower(Final_Channel) like \'%google%\' then \'PERFORMANCE_MAX\' else Final_Channel end) as Account ,sum(total_sales) as total_sales ,count (distinct order_id) as total_orders ,case when count (distinct order_id) = 0 then 0 else sum(total_sales)/count (distinct order_id) end as avg_order_value ,count (distinct case when new_customer_flag = \'New\' then customer_id else 0 end) as new_customers from (select ORDER_TIMESTAMP::date order_date ,FI.shop_name ,FI.ORDER_NAME ,FI.ORDER_ID ,fi.customer_id ,fi.new_customer_flag ,fi.final_utm_channel Shopify_Channel ,fi.LANDING_UTM_CAMPAIGN Shopify_Campaign ,GAOS.GA_Mapped_Channel as GA_Channel ,GAOS.GA_CAMPAIGN as GA_Campaign ,coalesce(GAOS.GA_Mapped_Channel, case when lower(final_utm_channel) like \'%facebook%\' then \'Facebook\' when lower(final_utm_channel) like \'%google%\' then \'Google\' else fi.final_utm_channel end) Final_Channel ,coalesce(GAOS.GA_CAMPAIGN,fi.LANDING_UTM_CAMPAIGN) Final_Campaign ,\"campaign.advertising_channel_type\" as CAMPAIGN_TYPE ,sum(fi.total_sales) Total_Sales from vahdam_db.maplemonk.fact_items FI left join (select * from (select * ,row_number() over (partition by GA_TRANSACTIONID,region order by ga_date desc) rw from vahdam_db.maplemonk.GA_orders_consolidated_Vahdam) where rw=1 ) GAOS on FI.order_name=GAOS.GA_TRANSACTIONID and lower(fi.shop_name) = lower(GAOS.region) left join (select * from (select *, row_number() over (partition by \"campaign.name\",region order by \"segments.date\" desc) rw from VAHDAM_DB.MAPLEMONK.google_ads_campaign_consolidated_vahdam) where rw=1) GADSC on lower(GADSC.\"campaign.name\")=lower(coalesce(GAOS.GA_CAMPAIGN,fi.LANDING_UTM_CAMPAIGN)) and lower(GADSC.region) = lower(fi.shop_name) where lower(fi.shop_name) like \'%shopify%\' group by 1,2,3,4,5,6,7,8,9,10,11,12,13 ) group by 1,2,3,4 ), marketing_metrics as ( select MC.region ,date ,Upper(case when lower(channel) like \'%google%\' then \'Google\' when lower(channel) like \'%facebook%\' then \'Facebook\' else CHANNEL end) as Channel ,UPPER(case when lower(account) like \'%main%\' then \'FB Main\' when lower(account) like \'%influencer%\' then \'FB Whitelisting\' when lower(account) like \'%bmg%\' then \'FB Content\' when lower(account) like \'%social media%\' then \'FB Social Media\' else lower(coalesce(GADSC.\"campaign.advertising_channel_type\",MC.AD_NETWORK_TYPE)) end) as Account ,sum(impressions) as impr ,sum(clicks) as clic ,sum(ifnull(OUTBOUND_CLICKS,0)) as Outclic ,sum(spend) as spe from vahdam_db.maplemonk.all_regions_marketing_consolidated_vahdam MC left join (select * from (select *, row_number() over (partition by \"campaign.name\",region order by \"segments.date\" desc) rw from VAHDAM_DB.MAPLEMONK.google_ads_campaign_consolidated_vahdam) where rw=1) GADSC on lower(GADSC.\"campaign.name\") = lower(MC.campaign_name) and lower(GADSC.region) = lower(MC.region) group by 1,2,3,4 order by 2 desc ), Traffic_Metrics as ( select GASF.Region ,GASF.ga_date ,GASF.Final_Channel ,upper(case when lower(GASF.GA_CAMPAIGN) like \'%sc%\' and lower(GASF.Final_Channel) like \'%facebook%\' then \'FB Main\' when lower(GASF.GA_CAMPAIGN) like \'%prospecting%\' and lower(GASF.Final_Channel) like \'%facebook%\' then \'FB Whitelisting\' when lower(GASF.GA_CAMPAIGN) like \'%discovery%\' and lower(GASF.Final_Channel) like \'%facebook%\' then \'FB Content\' when lower(GASF.CAMPAIGN_TYPE) like \'%search%\' and lower(GASF.Final_Channel) like \'%google%\' then \'Search\' when lower(GASF.CAMPAIGN_TYPE) like \'%shopping%\' and lower(GASF.Final_Channel) like \'%google%\' then \'Shopping\' when lower(GASF.CAMPAIGN_TYPE) like \'%display%\' and lower(GASF.Final_Channel) like \'%google%\' then \'Display\' when lower(GASF.CAMPAIGN_TYPE) like \'%video%\' and lower(GASF.Final_Channel) like \'%google%\' then \'Video\' when lower(GASF.CAMPAIGN_TYPE) like \'%performance_max%\' and lower(GASF.Final_Channel) like \'%google%\' then \'PERFORMANCE_MAX\' else GASF.Final_Channel end) as Account ,sum(GASF.ga_sessions) as ga_sessions from (select GASE.* ,coalesce(GADSC.\"campaign.advertising_channel_type\",MC.AD_NETWORK_TYPE) CAMPAIGN_TYPE from VAHDAM_DB.MAPLEMONK.GA_SESSIONS_CONSOLIDATED GASE left join (select * from (select *, row_number() over (partition by \"campaign.name\",region order by \"segments.date\" desc) rw from VAHDAM_DB.MAPLEMONK.google_ads_campaign_consolidated_vahdam) where rw=1) GADSC on lower(GADSC.\"campaign.name\") = lower(GASE.ga_campaign) and lower(GADSC.region) = lower(GASE.region) left join (select * from (select *, row_number() over (partition by campaign_name,region order by date desc) rw from VAHDAM_DB.MAPLEMONK.all_regions_marketing_consolidated_vahdam) where rw=1) MC on lower(GASE.ga_campaign) = lower(MC.campaign_name) and lower(GASE.region) = lower(MC.region) ) GASF group by 1,2,3,4 order by 2 desc ) Select upper(coalesce(sm.region,mm.region,tm.region)) as Region ,coalesce(sm.order_date,mm.date, tm.ga_date) as date ,Upper(coalesce(sm.channel,mm.channel, tm.final_channel)) as Channel ,Upper(coalesce(sm.account,mm.account, tm.account)) as Account ,sm.total_sales as Total_sales ,sm.total_orders as Total_orders ,sm.new_customers as New_customers ,mm.impr as Impressions ,mm.clic as Clicks ,mm.outclic as Outbound_clicks ,mm.spe as Spend ,tm.ga_sessions as Sessions from Sales_Metric sm full outer join Traffic_Metrics tm on sm.order_date::date = tm.ga_date::date and lower(sm.channel) = lower(tm.final_channel) and lower(sm.account) = lower(tm.account) and lower(sm.region) = lower(tm.region) full outer join marketing_metrics mm on sm.order_date = mm.date and lower(sm.channel) = lower(mm.channel) and lower(sm.account) = lower(mm.account) and lower(sm.region) = lower(mm.region) order by coalesce(sm.order_date,mm.date, tm.ga_date) desc ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from VAHDAM_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        