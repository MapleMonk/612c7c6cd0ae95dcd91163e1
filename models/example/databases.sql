{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_clicks_impressions_by_itemid AS WITH GA_DATA AS( SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'WEB\' AS TYPE, case when length(ITEMID)>14 then replace(SPLIT(itemid, \'_\')[2],\'\"\',\'\') else itemid end as itemid, itemsViewedInList AS IMPRESSIONS, itemsViewed AS CLICKS, itemsAddedToCart FROM snitch_db.maplemonk.ga4_web_jan24_clicks_impressions_by_itemid WHERE GA_DATE>\'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'WEB\' AS TYPE, case when length(ITEMID)>14 then replace(SPLIT(itemid, \'_\')[2],\'\"\',\'\') else itemid end as itemid, itemsViewedInList AS IMPRESSIONS, itemsViewed AS CLICKS, itemsAddedToCart FROM snitch_db.maplemonk.ga4_web_clicks_impressions_by_itemid WHERE GA_DATE <=\'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, case when length(ITEMID)>14 then replace(SPLIT(itemid, \'_\')[2],\'\"\',\'\') else itemid end as itemid, itemsViewedInList AS IMPRESSIONS, itemsViewed AS CLICKS, itemsAddedToCart FROM snitch_db.maplemonk.ga4_APP_clicks_impressions_by_itemid ) , sales_data as ( select order_timestamp::date as order_Date, product_id, SUM(quantity) AS quantity, sum(gross_sales) as gross_sales from snitch_db.maplemonk.fact_items_snitch where webshopney != \'Web\' and order_timestamp >= \'2024-01-01\' group by 1,2 ), join_tables as (select coalesce(ga_date,order_date) ga_order_date,div0(s.quantity,count(*) over(partition by product_id,s.order_date order by 1) )normalised_quantity,s.*,ga.* from GA_DATA ga full outer join sales_data s on ga.ga_date = s.order_date and ga.itemid = s.product_id ) select * ,sum(impressions_share) over (partition by ga_order_date, type order by impressions_share desc rows between unbounded preceding and current row) cumulative_impressions_share from ( select j.*,pn.SKU_GROUP,pn.product_title ,div0(impressions,sum(impressions) over (partition by ga_order_date, type)) impressions_share from Join_tables j left join ( select * from (select *,row_number() over(partition by product_id order by PRODUCT_UPDATED desc ) rw from snitch_db.snitch.product_dim) where rw=1)pn on j.itemid = pn.product_id ) ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.sessions_impressions_by_date_source AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'WEB\' AS TYPE, SESSIONSOURCEMEDIUM, itemsViewedInList AS IMPRESSIONS, SESSIONS FROM snitch_db.maplemonk.ga4_web_jan24_sessions_impressions_by_date_source WHERE GA_DATE>\'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'WEB\' AS TYPE, SESSIONSOURCEMEDIUM, itemsViewedInList AS IMPRESSIONS, SESSIONS FROM snitch_db.maplemonk.ga4_web_sessions_impressions_by_date_source WHERE GA_DATE<=\'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, SESSIONSOURCEMEDIUM, itemsViewedInList AS IMPRESSIONS, SESSIONS FROM snitch_db.maplemonk.ga4_APP_sessions_impressions_by_date_source ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_sessions_conversions_by_landingpage AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, landingPage, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_JAN24_sessions_conversions_by_landingpage WHERE GA_DATE > \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, landingPage, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_sessions_conversions_by_landingpage WHERE GA_DATE <= \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, landingPage, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_APP_sessions_conversions_by_landingpage ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_sessions_conversions_by_CAMPAIGN AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_JAN24_session_conversions_by_CAMPAIGN WHERE GA_DATE > \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_session_conversions_by_CAMPAIGN WHERE GA_DATE <= \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, SESSIONCAMPAIGNNAME, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_APP_session_conversions_by_CAMPAIGN ; CREATE OR REPLACE TABLE SNITCH_DB.MAPLEMONK.FINAL_GA_session_conversions_by_landingpage_campaign AS SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, LANDINGPAGE, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_JAN24_sessionS_conversions_by_landingpage_campaign WHERE GA_DATE > \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'web\' AS TYPE, SESSIONCAMPAIGNNAME, LANDINGPAGE, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_WEB_session_conversions_by_landingpage_campaign WHERE GA_DATE <= \'2024-02-27\' UNION SELECT TO_DATE(DATE,\'YYYYMMDD\')AS GA_DATE, \'APP\' AS TYPE, SESSIONCAMPAIGNNAME, LANDINGPAGE, sessions, addToCarts, conversions FROM SNITCH_DB.MAPLEMONK.GA4_APP_session_conversions_by_landingpage_campaign",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        