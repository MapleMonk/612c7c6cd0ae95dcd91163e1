{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table eggozdb.maplemonk.batch_data as select pb.id as batch_id, bz.zone_name, ff.farm_name, ww.name as warehouse, cast(timestampadd(minute,660,pp.po_date) as date) bill_date, pb.type, pb.batch_status, pb.egg_type, case when pb.actual_egg_price=0 then pb.expected_egg_price else pb.actual_egg_price end as procured_price from eggozdb.maplemonk.my_sql_procurement_procurement pp left join eggozdb.maplemonk.my_sql_farmer_farm ff on pp.farm_id = ff.id left join eggozdb.maplemonk.my_sql_warehouse_warehouse ww on ww.id = pp.warehouse_id left join eggozdb.maplemonk.my_sql_procurement_batchmodel pb on pp.id = pb.procurement_id join eggozdb.maplemonk.my_sql_base_zone bz on bz.id = ww.zone_id group by pb.id, bz.zone_name, ff.farm_name, cast(timestampadd(minute,660,pp.po_date) as date), expected_egg_price, pb.type, pb.batch_status, pb.egg_type, pb.actual_egg_price, ww.name ; create or replace table eggozdb.maplemonk.processing_data as select bd.*, tt.* from eggozdb.maplemonk.batch_data bd left join ( select batch_id as processing_batch_id, cast(timestampadd(minute, 660, start_time) as date) processing_date, sum(egg_chatki) processing_egg_chatki, sum(egg_loss) processing_egg_loss, sum(egg_count) processing_egg_count, sum(black_spot_loss) processing_black_spot_loss, sum(blood_spot_loss) processing_blood_spot_loss, sum(damaged_loss) processing_damaged_loss, sum(color_spot_loss) processing_color_spot_loss, sum(egg_air_gap) processing_egg_air_gap, sum(egg_dirty) processing_egg_dirty, sum(egg_hairline) processing_egg_hairline, sum(short_loss) processing_short_loss, sum(egg_blood_spot) processing_egg_blood_spot, sum(egg_good) processing_egg_good, sum(egg_melted) processing_egg_melted, sum(egg_small) processing_egg_small, sum(egg_very_dirty) processing_egg_very_dirty, sum(egg_shape_size) processing_egg_shape_size, sum(no_of_eggs) processing_no_of_eggs, sum(processing_loss) processing_processing_loss, sum(egg_other) processing_egg_other, sum(egg_other_ub) processing_egg_other_ub, sum(egg_pid) processing_egg_pid, sum(egg_rtv) processing_egg_rtv, sum(egg_hairline+egg_chatki+egg_dirty+egg_small+egg_pid+egg_air_gap+egg_blood_spot+egg_melted+egg_very_dirty+egg_shape_size+egg_other+egg_other_ub) total_processing_ub, sum(blood_spot_loss+damaged_loss+processing_loss+short_loss+color_spot_loss+egg_loss+black_spot_loss) total_processing_loss from eggozdb.maplemonk.my_sql_procurement_eggcleaning group by batch_id, cast(timestampadd(minute, 660, start_time) as date) ) tt on tt.processing_batch_id = bd.batch_id where tt.processing_batch_id is not null ; create or replace table eggozdb.maplemonk.procurement_data as select bd.*, tt.* from eggozdb.maplemonk.batch_data bd left join ( select batch_id procurement_batch_id, CAST(TIMESTAMPADD(MINUTE, 660, date) AS DATE) AS grn_date, sum(egg_chatki) procurement_egg_chatki, sum(egg_tray) procurement_egg_tray, sum(egg_loss) procurement_egg_loss, sum(egg_missing) procurement_egg_missing, sum(egg_air_gap) procurement_egg_air_gap, sum(egg_blood_spot) procurement_egg_blood_spot, sum(egg_dirty) procurement_egg_dirty, sum(egg_good) procurement_egg_good, sum(egg_hairline) procurement_egg_hairline, sum(egg_melted) procurement_egg_melted, sum(egg_small) procurement_egg_small, sum(egg_very_dirty) procurement_egg_very_dirty, sum(egg_pid) procurement_egg_pid, sum(egg_handling_loss) procurement_egg_handling_loss, sum(egg_loss+egg_missing+egg_handling_loss) total_procurement_loss, sum(egg_dirty+egg_chatki+egg_air_gap+egg_blood_spot+egg_hairline+egg_melted+egg_small+egg_very_dirty+egg_pid) total_procurement_ub from eggozdb.maplemonk.my_sql_procurement_eggsin group by batch_id, cast(timestampadd(minute, 660, date) as date) ) tt on tt.procurement_batch_id = bd.batch_id where tt.procurement_batch_id is not null ; create or replace table eggozdb.maplemonk.packaging_data as select bd.*, tt.* from eggozdb.maplemonk.batch_data bd left join ( select t1.batch_id package_batch_id, cast(timestampadd(minute, 660, t1.start_time) as date) packaging_date, sum(t1.egg_chatki) packaging_egg_chatki, sum(t1.egg_loss) packaging_egg_loss, sum(t1.egg_air_gap) packaging_egg_air_gap, sum(t1.egg_blood_spot) packaging_egg_blood_spot, sum(t1.egg_dirty) packaging_egg_dirty, sum(t1.egg_good) packaging_egg_good, sum(t1.egg_hairline) packaging_egg_hairline, sum(t1.egg_melted) packaging_egg_melted, sum(t1.egg_small) packaging_egg_small, sum(t1.egg_very_dirty) packaging_egg_very_dirty, sum(t1.egg_pid) packaging_egg_pid, sum(t1.egg_shape_size) packaging_egg_shape_size, sum(t1.eggs_used) packaging_eggs_used, sum(t1.egg_loss) total_packaging_loss, sum(t1.egg_chatki+t1.egg_dirty+t1.egg_air_gap+t1.egg_blood_spot+t1.egg_hairline+t1.egg_melted+t1.egg_small+t1.egg_very_dirty+t1.egg_shape_size+t1.egg_pid) total_packaging_ub from eggozdb.maplemonk.my_sql_procurement_package t1 left join eggozdb.maplemonk.my_sql_product_product pp on pp.id = t1.product_id group by t1.batch_id, cast(timestampadd(minute, 660, t1.start_time) as date) ) tt on tt.package_batch_id = bd.batch_id where tt.package_batch_id is not null ; create or replace table eggozdb.maplemonk.rmstore_data as select bd.*, tt.* from eggozdb.maplemonk.batch_data bd left join ( select cast(timestampadd(minute, 660, date) as date) rmstore_date, batch_id as eggrmstore_batch_id, sum(egg_pid)+sum(egg_good)+sum(egg_dirty)+sum(egg_small)+sum(egg_chatki) eggrmstore_egg_good from eggozdb.maplemonk.my_sql_procurement_eggrmstore group by cast(timestampadd(minute, 660, date) as date), batch_id ) tt on tt.eggrmstore_batch_id = bd.batch_id where tt.eggrmstore_batch_id is not null ; create or replace table eggozdb.maplemonk.qc_data as select bd.*, tt.* from eggozdb.maplemonk.batch_data bd left join ( select cast(timestampadd(minute, 660, start_time) as date) qc_date, batch_id as eggqualitycheck_batch_id, sum(egg_loss) eggqualitycheck_egg_loss from eggozdb.maplemonk.my_sql_procurement_eggqualitycheck group by batch_id, cast(timestampadd(minute, 660, start_time) as date) ) tt on tt.eggqualitycheck_batch_id = bd.batch_id where tt.eggqualitycheck_batch_id is not null ; create or replace table eggozdb.maplemonk.epc_dc_transfer as SELECT dt.id, dt.material_type, dt.transfer_status, dt.transfer_type, cast(timestampadd(minute,660,dt.beat_date) as date) beat_date, cast(timestampadd(minute,660,dt.transferred_at) as time) transferred_at, cast(timestampadd(minute,660,dt.vehicle_assigned_at) as datetime) vehicle_assigned_at, cast(timestampadd(minute,660,dt.received_at) as datetime) received_at, ww1.name from_warehouse, ww2.name to_warehouse, rrb1.beat_number from_beat_number, rrb2.beat_number to_beat_number, sum(dts.quantity*pp.SKU_Count) as sent_eggs_ims, pp.sku_count, concat(pp.SKU_Count,pp.short_name) sku, pp.short_name, sum(dts.receive_quantity*pp.SKU_Count) as received_eggs_ims, wd.driver_name, wv.vehicle_no, wv.per_day_charge, wv.per_day_distance, wv.per_day_duration, wv.vehicle_identifier_type, bz.zone_name, pp.name as egg_type, pp.brand_type as type FROM eggozdb.maplemonk.my_sql_distributionchain_tripskutransfer dt right join eggozdb.maplemonk.my_sql_distributionchain_transfersku dts on dt.id = dts.tripSKUTransfer_id left join eggozdb.maplemonk.my_sql_product_product pp on dts.product_id = pp.id left join eggozdb.maplemonk.my_sql_warehouse_warehouse ww1 on ww1.id = dt.from_warehouse_id left join eggozdb.maplemonk.my_sql_warehouse_warehouse ww2 on ww2.id = dt.to_warehouse_id left join eggozdb.maplemonk.my_sql_retailer_retailerbeat rrb1 on dt.from_beat_id = rrb1.id left join eggozdb.maplemonk.my_sql_retailer_retailerbeat rrb2 on dt.to_beat_id = rrb2.id left join eggozdb.maplemonk.my_sql_warehouse_driver wd on wd.id = dt.driver_id left join eggozdb.maplemonk.my_sql_warehouse_vehicle wv on wv.id = dt.vehicle_id left join eggozdb.maplemonk.my_sql_base_zone bz on bz.id = ww1.zone_id where cast(timestampadd(minute,660,dt.beat_date) as date)>=\'2023-01-01\' group by dt.id, cast(timestampadd(minute,660,dt.beat_date) as date), cast(timestampadd(minute,660,dt.transferred_at) as time), cast(timestampadd(minute,660,dt.vehicle_assigned_at) as datetime), cast(timestampadd(minute,660,dt.received_at) as datetime), ww1.name, ww2.name, wd.driver_name, wv.vehicle_no, wv.per_day_charge, wv.per_day_distance, wv.per_day_duration, wv.vehicle_identifier_type,pp.sku_count,pp.short_name, rrb1.beat_number, rrb2.beat_number, dt.material_type, dt.transfer_status, dt.transfer_type, bz.zone_name, pp.name, pp.brand_type ; create or replace table eggozdb.maplemonk.fg_to_unbranded as select cast(timestampadd(minute, 660, t1.modified_at) as date) date, cast(timestampadd(minute, 660, t1.created_at) as date) created_date, concat(pp.SKU_Count,pp.short_name) sku, pp.sku_count*t1.received_in_qty received_eggs, pp.sku_count*t1.qty sent_eggs, ww.name warehouse, t1.qty sku_quantity, t1.received_in_qty sku_received_in_quantity, t1.status, t1.type, pp.sku_count, bz.zone_name from eggozdb.maplemonk.my_sql_procurement_fgmovetounbranded t1 left join eggozdb.maplemonk.my_sql_product_product pp on pp.id = t1.product_id_id left join eggozdb.maplemonk.my_sql_warehouse_warehouse ww on ww.id = t1.warehouse_id left join eggozdb.maplemonk.my_sql_base_zone bz on bz.id = ww.zone_id ; create or replace table eggozdb.maplemonk.batch_procurement_processing_packaging as select bd.*, tt1.procurement_batch_id, tt1.grn_date, ifnull(tt1.procurement_egg_chatki,0) procurement_egg_chatki, ifnull(tt1.procurement_egg_tray,0) procurement_egg_tray, ifnull(tt1.procurement_egg_loss,0) procurement_egg_loss, ifnull(tt1.procurement_egg_missing,0) procurement_egg_missing, ifnull(tt1.procurement_egg_air_gap,0) procurement_egg_air_gap, ifnull(tt1.procurement_egg_blood_spot,0) procurement_egg_blood_spot, ifnull(tt1.procurement_egg_dirty,0) procurement_egg_dirty, ifnull(tt1.procurement_egg_good,0) procurement_egg_good, ifnull(tt1.procurement_egg_hairline,0) procurement_egg_hairline, ifnull(tt1.procurement_egg_melted,0) procurement_egg_melted, ifnull(tt1.procurement_egg_small,0) procurement_egg_small, ifnull(tt1.procurement_egg_very_dirty,0) procurement_egg_very_dirty, ifnull(tt1.procurement_egg_pid,0) procurement_egg_pid, ifnull(tt1.procurement_egg_handling_loss,0) procurement_egg_handling_loss, ifnull(tt1.total_procurement_loss,0) total_procurement_loss, ifnull(tt1.total_procurement_ub,0) total_procurement_ub, tt2.processing_batch_id, tt2.processing_date, ifnull(tt2.processing_egg_chatki,0) processing_egg_chatki, ifnull(tt2.processing_egg_loss,0) processing_egg_loss, ifnull(tt2.processing_egg_count,0) processing_egg_count, ifnull(tt2.processing_black_spot_loss,0) processing_black_spot_loss, ifnull(tt2.processing_blood_spot_loss,0) processing_blood_spot_loss, ifnull(tt2.processing_damaged_loss,0) processing_damaged_loss, ifnull(tt2.processing_color_spot_loss,0) processing_color_spot_loss, ifnull(tt2.processing_egg_air_gap,0) processing_egg_air_gap, ifnull(tt2.processing_egg_dirty,0) processing_egg_dirty, ifnull(tt2.processing_egg_hairline,0) processing_egg_hairline, ifnull(tt2.processing_short_loss,0) processing_short_loss, ifnull(tt2.processing_egg_blood_spot,0) processing_egg_blood_spot, ifnull(tt2.processing_egg_good,0) processing_egg_good, ifnull(tt2.processing_egg_melted,0) processing_egg_melted, ifnull(tt2.processing_egg_small,0) processing_egg_small, ifnull(tt2.processing_egg_very_dirty,0) processing_egg_very_dirty, ifnull(tt2.processing_egg_shape_size,0) processing_egg_shape_size, ifnull(tt2.processing_no_of_eggs,0) processing_no_of_eggs, ifnull(tt2.processing_processing_loss,0) processing_processing_loss, ifnull(tt2.processing_egg_other,0) processing_egg_other, ifnull(tt2.processing_egg_other_ub,0) processing_egg_other_ub, ifnull(tt2.processing_egg_pid,0) processing_egg_pid, ifnull(tt2.processing_egg_rtv,0) processing_egg_rtv, ifnull(tt2.total_processing_ub,0) total_processing_ub, ifnull(tt2.total_processing_loss,0) total_processing_loss, tt3.package_batch_id, tt3.packaging_date, ifnull(tt3.packaging_egg_chatki,0) packaging_egg_chatki, ifnull(tt3.packaging_egg_loss,0) packaging_egg_loss, ifnull(tt3.packaging_egg_air_gap,0) packaging_egg_air_gap, ifnull(tt3.packaging_egg_blood_spot,0) packaging_egg_blood_spot, ifnull(tt3.packaging_egg_dirty,0) packaging_egg_dirty, ifnull(tt3.packaging_egg_good,0) packaging_egg_good, ifnull(tt3.packaging_egg_hairline,0) packaging_egg_hairline, ifnull(tt3.packaging_egg_melted,0) packaging_egg_melted, ifnull(tt3.packaging_egg_small,0) packaging_egg_small, ifnull(tt3.packaging_egg_very_dirty,0) packaging_egg_very_dirty, ifnull(tt3.packaging_egg_pid,0) packaging_egg_pid, ifnull(tt3.packaging_egg_shape_size,0) packaging_egg_shape_size, ifnull(tt3.packaging_eggs_used,0) packaging_eggs_used, ifnull(tt3.total_packaging_loss,0) total_packaging_loss, ifnull(tt3.total_packaging_ub,0) total_packaging_ub, tt4.eggqualitycheck_batch_id, ifnull(tt4.eggqualitycheck_egg_loss,0) eggqualitycheck_egg_loss, tt5.eggrmstore_batch_id, ifnull(tt5.eggrmstore_egg_good,0) eggrmstore_egg_good from eggozdb.maplemonk.batch_data bd left join ( select batch_id procurement_batch_id, CAST(TIMESTAMPADD(MINUTE, 660, date) AS DATE) AS grn_date, sum(egg_chatki) procurement_egg_chatki, sum(egg_tray) procurement_egg_tray, sum(egg_loss) procurement_egg_loss, sum(egg_missing) procurement_egg_missing, sum(egg_air_gap) procurement_egg_air_gap, sum(egg_blood_spot) procurement_egg_blood_spot, sum(egg_dirty) procurement_egg_dirty, sum(egg_good) procurement_egg_good, sum(egg_hairline) procurement_egg_hairline, sum(egg_melted) procurement_egg_melted, sum(egg_small) procurement_egg_small, sum(egg_very_dirty) procurement_egg_very_dirty, sum(egg_pid) procurement_egg_pid, sum(egg_handling_loss) procurement_egg_handling_loss, sum(egg_loss+egg_missing+egg_handling_loss) total_procurement_loss, sum(egg_dirty+egg_chatki+egg_air_gap+egg_blood_spot+egg_hairline+egg_melted+egg_small+egg_very_dirty+egg_pid) total_procurement_ub from eggozdb.maplemonk.my_sql_procurement_eggsin group by batch_id, cast(timestampadd(minute, 660, date) as date) ) tt1 on tt1.procurement_batch_id = bd.batch_id left join ( select batch_id as processing_batch_id, min(cast(timestampadd(minute, 660, start_time) as date)) processing_date, sum(egg_chatki) processing_egg_chatki, sum(egg_loss) processing_egg_loss, sum(egg_count) processing_egg_count, sum(black_spot_loss) processing_black_spot_loss, sum(blood_spot_loss) processing_blood_spot_loss, sum(damaged_loss) processing_damaged_loss, sum(color_spot_loss) processing_color_spot_loss, sum(egg_air_gap) processing_egg_air_gap, sum(egg_dirty) processing_egg_dirty, sum(egg_hairline) processing_egg_hairline, sum(short_loss) processing_short_loss, sum(egg_blood_spot) processing_egg_blood_spot, sum(egg_good) processing_egg_good, sum(egg_melted) processing_egg_melted, sum(egg_small) processing_egg_small, sum(egg_very_dirty) processing_egg_very_dirty, sum(egg_shape_size) processing_egg_shape_size, sum(no_of_eggs) processing_no_of_eggs, sum(processing_loss) processing_processing_loss, sum(egg_other) processing_egg_other, sum(egg_other_ub) processing_egg_other_ub, sum(egg_pid) processing_egg_pid, sum(egg_rtv) processing_egg_rtv, sum(egg_hairline+egg_chatki+egg_dirty+egg_small+egg_pid+egg_air_gap+egg_blood_spot+egg_melted+egg_very_dirty+egg_shape_size+egg_other+egg_other_ub) total_processing_ub, sum(blood_spot_loss+damaged_loss+processing_loss+short_loss+color_spot_loss+egg_loss+black_spot_loss) total_processing_loss from eggozdb.maplemonk.my_sql_procurement_eggcleaning group by batch_id ) tt2 on tt2.processing_batch_id = bd.batch_id left join ( select t1.batch_id package_batch_id, min(cast(timestampadd(minute, 660, t1.start_time) as date)) packaging_date, sum(t1.egg_chatki) packaging_egg_chatki, sum(t1.egg_loss) packaging_egg_loss, sum(t1.egg_air_gap) packaging_egg_air_gap, sum(t1.egg_blood_spot) packaging_egg_blood_spot, sum(t1.egg_dirty) packaging_egg_dirty, sum(t1.egg_good) packaging_egg_good, sum(t1.egg_hairline) packaging_egg_hairline, sum(t1.egg_melted) packaging_egg_melted, sum(t1.egg_small) packaging_egg_small, sum(t1.egg_very_dirty) packaging_egg_very_dirty, sum(t1.egg_pid) packaging_egg_pid, sum(t1.egg_shape_size) packaging_egg_shape_size, sum(t1.eggs_used) packaging_eggs_used, sum(t1.egg_loss) total_packaging_loss, sum(t1.egg_chatki+t1.egg_dirty+t1.egg_air_gap+t1.egg_blood_spot+t1.egg_hairline+t1.egg_melted+t1.egg_small+t1.egg_very_dirty+t1.egg_shape_size+t1.egg_pid) total_packaging_ub from eggozdb.maplemonk.my_sql_procurement_package t1 group by t1.batch_id ) tt3 on tt3.package_batch_id = bd.batch_id left join ( select batch_id as eggqualitycheck_batch_id, sum(egg_loss) eggqualitycheck_egg_loss from eggozdb.maplemonk.my_sql_procurement_eggqualitycheck group by batch_id ) tt4 on tt4.eggqualitycheck_batch_id = bd.batch_id left join ( select batch_id as eggrmstore_batch_id, sum(egg_pid)+sum(egg_good)+sum(egg_dirty)+sum(egg_small)+sum(egg_chatki) eggrmstore_egg_good from eggozdb.maplemonk.my_sql_procurement_eggrmstore group by batch_id ) tt5 on tt5.eggrmstore_batch_id = bd.batch_id ; create or replace table eggozdb.maplemonk.epm_packaged_eggs_sku_on_grn_date as select pe.batch_id batch_id, CAST(TIMESTAMPADD(MINUTE, 660, pe.date) AS DATE) AS grn_date, CAST(TIMESTAMPADD(MINUTE, 660, ppg.start_time) AS DATE) packaging_date, ppg.batch_id packaging_batch_id, pp.sku_count, pp.short_name, concat(pp.sku_count,pp.short_name) sku, ppi.package_count, pp.name, bd.zone_name, ppi.package_count*pp.sku_count as packaged_eggs from eggozdb.maplemonk.my_sql_procurement_eggsin pe left join eggozdb.maplemonk.my_sql_procurement_package ppg on ppg.batch_id = pe.batch_id left join eggozdb.maplemonk.my_sql_procurement_packageinline ppi on ppi.package_id = ppg.id left join eggozdb.maplemonk.my_sql_product_product pp on pp.id = ppi.product_id left join eggozdb.maplemonk.batch_data bd on bd.batch_id = pe.batch_id ; create or replace table eggozdb.maplemonk.epm_packaged_eggs_sku as select cast(timestampadd(minute, 660, start_time) as date) packaging_date, ppg.batch_id, ppi.package_id, ppi.product_id, ppi.package_count, pp.SKU_Count, ppi.package_count*pp.SKU_Count as packaged_eggs, pp.name, pp.short_name, concat(pp.SKU_Count,pp.short_name) sku, bd.zone_name from eggozdb.maplemonk.my_sql_procurement_packageinline ppi left join eggozdb.maplemonk.my_sql_procurement_package ppg on ppg.id = ppi.package_id left join eggozdb.maplemonk.my_sql_product_product pp on pp.id = ppi.product_id left join eggozdb.maplemonk.batch_data bd on bd.batch_id = ppg.batch_id ; create or replace table eggozdb.maplemonk.ppp_datewise as with procurement_data_cte as ( select grn_date, zone_name, warehouse, sum(procurement_egg_tray) procurement_egg_tray, sum(total_procurement_ub) total_procurement_ub, sum(total_procurement_loss) total_procurement_loss from eggozdb.maplemonk.procurement_data group by grn_date, zone_name, warehouse ), processing_data_cte as ( select processing_date, zone_name, warehouse, sum(processing_no_of_eggs) processing_no_of_eggs, sum(total_processing_ub) total_processing_ub, sum(total_processing_loss) total_processing_loss, sum(processing_egg_rtv) processing_egg_rtv from eggozdb.maplemonk.processing_data group by processing_date, zone_name, warehouse ), packaging_data_cte as ( select packaging_date, zone_name, warehouse, sum(packaging_eggs_used) packaging_eggs_used, sum(total_packaging_loss) total_packaging_loss, sum(total_packaging_ub) total_packaging_ub from eggozdb.maplemonk.packaging_data group by packaging_date, zone_name, warehouse ), rmstore_data_cte as ( select rmstore_date, zone_name, warehouse, sum(eggrmstore_egg_good) eggrmstore_egg_good from eggozdb.maplemonk.rmstore_data group by rmstore_date, zone_name, warehouse ), qc_data_cte as ( select qc_date, zone_name, warehouse, sum(eggqualitycheck_egg_loss) eggqualitycheck_egg_loss from eggozdb.maplemonk.qc_data group by qc_date, zone_name, warehouse ), fresh_epc_to_dc_cte as ( select beat_date as transfer_date, from_warehouse fresh_epc_to_dc, sum(sent_eggs_ims) fresh_sent_to_dc_eggs, zone_name from eggozdb.maplemonk.epc_dc_transfer where from_warehouse like \'%EPC\' and to_warehouse like \'%DC\' and material_type = \'Fresh\' and transfer_type = \'satellite\' group by beat_date, from_warehouse, zone_name ), fresh_dc_to_epc_cte as ( select beat_date as transfer_date, to_warehouse fresh_dc_to_epc, sum(received_eggs_ims) fresh_received_from_dc_eggs, zone_name from eggozdb.maplemonk.epc_dc_transfer where from_warehouse like \'%DC%\' and to_warehouse like \'%EPC%\' and material_type = \'Fresh\' and transfer_type = \'satellite\' group by beat_date, to_warehouse, zone_name ), old_epc_to_dc_cte as ( select beat_date as transfer_date, from_warehouse old_epc_to_dc, sum(sent_eggs_ims) old_sent_to_dc_eggs, zone_name from eggozdb.maplemonk.epc_dc_transfer where from_warehouse like \'%EPC\' and to_warehouse like \'%DC\' and material_type = \'Old\' and transfer_type = \'satellite\' group by beat_date, from_warehouse, zone_name ), old_dc_to_epc_cte as ( select beat_date as transfer_date, to_warehouse old_dc_to_epc, sum(received_eggs_ims) old_received_from_dc_eggs, zone_name from eggozdb.maplemonk.epc_dc_transfer where from_warehouse like \'%DC\' and to_warehouse like \'%EPC\' and material_type = \'Old\' and transfer_type = \'satellite\' group by beat_date, to_warehouse, zone_name ), epc_to_beats_fresh_out_cte as ( select date as epc_to_beat_date, loading_point, zone_name, sum(out_eggs) epc_to_beat_out_eggs from eggozdb.maplemonk.beat_material_kpi where loading_point like \'%EPC\' group by date, loading_point, zone_name ), beats_to_epc_fresh_in_cte as ( select date as beat_to_epc_date, loading_point, zone_name, sum(fresh_in_eggs) beat_to_epc_fresh_in_eggs from eggozdb.maplemonk.beat_material_kpi where loading_point like \'%EPC\' group by date, loading_point, zone_name ), beats_to_epc_old_in_cte as ( select date as beat_to_epc_date, loading_point, zone_name, sum(old_in_eggs) beat_to_epc_old_in_eggs from eggozdb.maplemonk.beat_material_kpi where loading_point like \'%EPC\' group by date, loading_point, zone_name ), old_fg_ub_epc_cte as ( select date, warehouse, zone_name, sum(sent_eggs) old_fg_ub_epc_sent_eggs from eggozdb.maplemonk.fg_to_unbranded where type = \'Old\' and status = \'Pending\' group by date, warehouse, zone_name ), old_damage_fg_ub_epc_cte as ( select date, warehouse, zone_name, sum(sent_eggs) old_damage_fg_ub_epc_sent_eggs from eggozdb.maplemonk.fg_to_unbranded where type = \'Old_Damage\' and status = \'Pending\' group by date, warehouse, zone_name ), fresh_fg_ub_epc_cte as ( select date, warehouse, zone_name, sum(sent_eggs) fresh_fg_ub_epc_sent_eggs from eggozdb.maplemonk.fg_to_unbranded where type = \'Fresh\' and status = \'Pending\' group by date, warehouse, zone_name ), fresh_damage_fg_ub_epc_cte as ( select date, warehouse, zone_name, sum(sent_eggs) fresh_damage_fg_ub_epc_sent_eggs from eggozdb.maplemonk.fg_to_unbranded where type = \'Fresh_Damage\' and status = \'Pending\' group by date, warehouse, zone_name ), dimension_table as ( select dd.date::date date, t1.zone_name, t1.warehouse from eggozdb.maplemonk.date_dim dd cross join (select name as warehouse, zone_name from eggozdb.maplemonk.my_sql_warehouse_warehouse ww left join eggozdb.maplemonk.my_sql_base_zone bz on bz.id = ww.zone_id where warehouse_type = \'EPC\') t1 where year(dd.date::date) >= 2023 ) select dd.date::date date, dd.zone_name, dd.warehouse, t1.grn_date, t1.procurement_egg_tray, t1.total_procurement_ub, t1.total_procurement_loss, t2.processing_date, ifnull(t2.processing_no_of_eggs,0) processing_no_of_eggs, ifnull(t2.total_processing_ub,0) total_processing_ub, ifnull(t2.total_processing_loss,0) total_processing_loss, ifnull(t2.processing_egg_rtv,0) processing_egg_rtv, t3.packaging_date, ifnull(t3.packaging_eggs_used,0) packaging_eggs_used, ifnull(t3.total_packaging_loss,0) total_packaging_loss, ifnull(t3.total_packaging_ub,0) total_packaging_ub, t4.rmstore_date, ifnull(t4.eggrmstore_egg_good,0) eggrmstore_egg_good, t5.qc_date, ifnull(t5.eggqualitycheck_egg_loss,0) eggqualitycheck_egg_loss, ifnull(t6.fresh_sent_to_dc_eggs,0) fresh_sent_to_dc_eggs, ifnull(t7.fresh_received_from_dc_eggs,0) fresh_received_from_dc_eggs, ifnull(t8.old_sent_to_dc_eggs,0) old_sent_to_dc_eggs, ifnull(t9.old_received_from_dc_eggs,0) old_received_from_dc_eggs, ifnull(t10.epc_to_beat_out_eggs,0) epc_to_beat_out_eggs, ifnull(t11.beat_to_epc_fresh_in_eggs,0) beat_to_epc_fresh_in_eggs, ifnull(t12.beat_to_epc_old_in_eggs,0) beat_to_epc_old_in_eggs, ifnull(t13.old_fg_ub_epc_sent_eggs,0) old_fg_ub_epc_sent_eggs, ifnull(t14.old_damage_fg_ub_epc_sent_eggs,0) old_damage_fg_ub_epc_sent_eggs, ifnull(t15.fresh_fg_ub_epc_sent_eggs,0) fresh_fg_ub_epc_sent_eggs, ifnull(t16.fresh_damage_fg_ub_epc_sent_eggs,0) fresh_damage_fg_ub_epc_sent_eggs from dimension_table dd left join procurement_data_cte t1 on t1.grn_date = dd.date and t1.zone_name = dd.zone_name and t1.warehouse = dd.warehouse left join processing_data_cte t2 on t2.processing_date = dd.date and t2.zone_name = dd.zone_name and t2.warehouse = dd.warehouse left join packaging_data_cte t3 on t3.packaging_date = dd.date and t3.zone_name = dd.zone_name and t3.warehouse = dd.warehouse left join rmstore_data_cte t4 on t4.rmstore_date = dd.date and t4.zone_name = dd.zone_name and t4.warehouse = dd.warehouse left join qc_data_cte t5 on t5.qc_date = dd.date and t5.zone_name = dd.zone_name and t5.warehouse = dd.warehouse left join fresh_epc_to_dc_cte t6 on t6.transfer_date = dd.date and t6.zone_name = dd.zone_name and t6.fresh_epc_to_dc = dd.warehouse left join fresh_dc_to_epc_cte t7 on t7.transfer_date = dd.date and t7.zone_name = dd.zone_name and t7.fresh_dc_to_epc = dd.warehouse left join old_epc_to_dc_cte t8 on t8.transfer_date = dd.date and t8.zone_name = dd.zone_name and t8.old_epc_to_dc = dd.warehouse left join old_dc_to_epc_cte t9 on t9.transfer_date = dd.date and t9.zone_name = dd.zone_name and t9.old_dc_to_epc = dd.warehouse left join epc_to_beats_fresh_out_cte t10 on t10.epc_to_beat_date = dd.date and t10.zone_name = dd.zone_name and t10.loading_point = dd.warehouse left join beats_to_epc_fresh_in_cte t11 on t11.beat_to_epc_date = dd.date and t11.zone_name = dd.zone_name and t11.loading_point = dd.warehouse left join beats_to_epc_old_in_cte t12 on t12.beat_to_epc_date = dd.date and t12.zone_name = dd.zone_name and t12.loading_point = dd.warehouse left join old_fg_ub_epc_cte t13 on t13.date = dd.date and t13.zone_name = dd.zone_name and t13.warehouse = dd.warehouse left join old_damage_fg_ub_epc_cte t14 on t14.date = dd.date and t14.zone_name = dd.zone_name and t14.warehouse = dd.warehouse left join fresh_fg_ub_epc_cte t15 on t15.date = dd.date and t15.zone_name = dd.zone_name and t15.warehouse = dd.warehouse left join fresh_damage_fg_ub_epc_cte t16 on t16.date = dd.date and t16.zone_name = dd.zone_name and t16.warehouse = dd.warehouse where t1.grn_date is not null order by dd.date::date desc ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from EGGOZDB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        