{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table hox_db.maplemonk.HOX_exotel_call_summary as select distinct o.*, case when lower(DIRECTION) = \'inbound\' and lower(FINAL_STATUS) in (\'missed call\', \'call attempt\') then lead(case when lower(DIRECTION) = \'outbound\' then FINAL_STATUS end) over (order by STARTTIME) end as next_outbound_status, case when lower(DIRECTION) = \'inbound\' and lower(FINAL_STATUS) in (\'missed call\', \'call attempt\') then datediff(second, STARTTIME, lead(case when lower(DIRECTION) = \'outbound\' then STARTTIME end) over (order by STARTTIME)) end as time_gap_between_missed_outbound_calls from ( select distinct o.*, case when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'completed\' and DURATION > 0 and ConversationDuration > 0 then \'completed\' when lower(Leg1Status) = \'busy\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and TONAME is null and lower(DIRECTION) like \'%inbound%\' then \'call attempt\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and TONAME is null and DURATION < 10 and lower(DIRECTION) like \'%inbound%\' then \'call attempt\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'completed\' and DURATION > 0 and ConversationDuration = 0 and TONAME is null and lower(DIRECTION) like \'%inbound%\' then \'call attempt\' when lower(Leg1Status) = \'failed\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and TONAME is null and lower(DIRECTION) like \'%inbound%\' then \'call attempt\' when lower(Leg1Status) = \'no-answer\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and TONAME is null and lower(DIRECTION) like \'%inbound%\' then \'call attempt\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'no-answer\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'no-answer\' when lower(Leg1Status) = \'no-answer\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'no-answer\' when lower(Leg1Status) = \'no-answer\' and lower(Leg2Status) like \'cancel%\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'no-answer\' when lower(Leg1Status) = \'busy\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'busy\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'busy\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'busy\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) like \'cancel%\' and DURATION >= 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'failed\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'failed\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'failed\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'failed\' when lower(Leg1Status) = \'failed\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'failed\' when lower(Leg1Status) = \'n/a\' and lower(Leg2Status) = \'n/a\' and DURATION = 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%outbound%\' then \'failed\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'n/a\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%inbound%\' then \'missed call\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) like \'cancel%\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%inbound%\' then \'missed call\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'busy\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%inbound%\' then \'missed call\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'no-answer\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%inbound%\' then \'missed call\' when lower(Leg1Status) = \'completed\' and lower(Leg2Status) = \'failed\' and DURATION > 0 and ConversationDuration = 0 and lower(DIRECTION) like \'%inbound%\' then \'missed call\' end as final_Status, coalesce(FROMNAME, TONAME) as agent from ( select SID, case when lower(DIRECTION) like \'%outbound%\' then \'outbound\' else \'inbound\' end as DIRECTION, PHONENUMBER AS Exotel_number, \"From\" as From_number, case when \"From\" = \'09661661047\' then \'Kumar Sourav\' when \"From\" = \'06360288328\' then \'Namra Farooq\' when \"From\" = \'09880641861\' then \'Rajesh Shetty\' when \"From\" = \'09986066215\' then \'Shivam Kohli\' when \"From\" in (\'09901329428\', \'07338569921\') then \'Syeda Afifa\' end as FromName, \"To\" as To_number, case when \"To\" = \'09661661047\' then \'Kumar Sourav\' when \"To\" = \'06360288328\' then \'Namra Farooq\' when \"To\" = \'09880641861\' then \'Rajesh Shetty\' when \"To\" = \'09986066215\' then \'Shivam Kohli\' when \"To\" in (\'09901329428\', \'07338569921\') then \'Syeda Afifa\' end as ToName, DETAILS, STATUS as API_status, STARTTIME:: timestamp as STARTTIME, date_trunc(\'month\',date(STARTTIME::timestamp)) as month_date, date_trunc(\'week\',date(STARTTIME::timestamp)) as week_date, dayname(date(STARTTIME::timestamp)) as day_name, extract(hour from (STARTTIME:: timestamp)) as hour_part, ENDTIME:: timestamp as ENDTIME, date(STARTTIME:: timestamp) as START_date, DURATION, PRICE, trim(replace((details: Leg1Status), \'\"\',\'\')) as Leg1Status, case when trim(replace((details: Leg2Status), \'\"\',\'\')) = \'\' then \'N/A\' else trim(replace((details: Leg2Status), \'\"\',\'\')) end as Leg2Status, cast((details: ConversationDuration)as float) as ConversationDuration from HOX_DB.MAPLEMONK.HOX_EXOTEL_BULK_CALLS order by DATEUPDATED desc )as o )as o",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from HOX_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        