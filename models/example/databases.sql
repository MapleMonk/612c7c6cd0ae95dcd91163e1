{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ORDER_ID as With Refund as (Select POSTEDDATE ,AMAZONORDERID ,SELLERSKU ,sum(REFUNDCOMMISSION) Refund_commission from vahdam_db.maplemonk.vahdam_refund_event_list group by 1,2,3), Shipment as (select POSTEDDATE ,AMAZONORDERID ,SELLERSKU ,sum(QUANTITY) QUANTITY ,sum(PRINCIPAL) PRINCIPAL ,sum(FBAPERUNITFULFILLMENTFEE) FBAPERUNITFULFILLMENTFEE ,sum(COMMISSION) COMMISSION ,sum(PROMOTION) PROMOTION ,sum(TAX) TAX ,sum(GIFTWRAP) GIFTWRAP ,sum(GIFTWRAPTAX) GIFTWRAPTAX ,sum(SHIPPINGCHARGE) SHIPPINGCHARGE ,sum(SHIPPINGTAX) SHIPPINGTAX ,sum(MARKETPLACEFACILITATORTAXPRINCIPAL) MARKETPLACEFACILITATORTAXPRINCIPAL ,sum(MARKETPLACEFACILITATORTAXSHIPPING) MARKETPLACEFACILITATORTAXSHIPPING ,sum(MARKETPLACEFACILITATORTAXOTHER) MARKETPLACEFACILITATORTAXOTHER ,sum(MARKETPLACEFACILITATORVATSHIPPING) MARKETPLACEFACILITATORVATSHIPPING ,sum(MARKETPLACEFACILITATORVATPRINCIPAL) MARKETPLACEFACILITATORVATPRINCIPAL ,sum(FBAPERORDERFULFILLMENTFEE) FBAPERORDERFULFILLMENTFEE ,sum(FBAWEIGHTBASEDFEE) FBAWEIGHTBASEDFEE ,sum(FIXEDCLOSINGFEE) FIXEDCLOSINGFEE ,sum(GIFTWRAPCHARGEBACK) GIFTWRAPCHARGEBACK ,sum(SHIPPINGCHARGEBACK) SHIPPINGCHARGEBACK ,sum(VARIABLECLOSINGFEE) VARIABLECLOSINGFEE ,sum(SALESTAXCOLLECTIONFEE) SALESTAXCOLLECTIONFEE ,sum(GIFTWRAPCOMMISSION) GIFTWRAPCOMMISSION ,sum(SHIPPINGHB) SHIPPINGHB from vahdam_db.maplemonk.vahdam_shipment_event_list group by 1,2,3) select coalesce(R.POSTEDDATE,S.POSTEDDATE)::date POSTEDDATE ,coalesce(R.AMAZONORDERID,S.AMAZONORDERID) AMAZONORDERID ,coalesce(R.SELLERSKU,S.SELLERSKU) SELLERSKU ,S.QUANTITY ,S.PRINCIPAL ,S.FBAPERUNITFULFILLMENTFEE ,S.COMMISSION ,S.PROMOTION ,S.TAX ,ifnull(R.Refund_commission,0) Refund_commission ,S.GIFTWRAP ,S.GIFTWRAPTAX ,S.SHIPPINGCHARGE ,S.SHIPPINGTAX ,S.MARKETPLACEFACILITATORTAXPRINCIPAL ,S.MARKETPLACEFACILITATORTAXSHIPPING ,S.MARKETPLACEFACILITATORTAXOTHER ,S.MARKETPLACEFACILITATORVATSHIPPING ,S.MARKETPLACEFACILITATORVATPRINCIPAL ,S.FBAPERORDERFULFILLMENTFEE ,S.FBAWEIGHTBASEDFEE ,S.FIXEDCLOSINGFEE ,S.GIFTWRAPCHARGEBACK ,S.SHIPPINGCHARGEBACK ,S.VARIABLECLOSINGFEE ,ifnull(S.SALESTAXCOLLECTIONFEE,0) as SALESTAXCOLLECTIONFEE ,ifnull(S.GIFTWRAPCOMMISSION,0) as GIFTWRAPCOMMISSION ,ifnull(S.SHIPPINGHB,0) as SHIPPINGHB from Shipment S full outer join Refund R on S.AMAZONORDERID = R.AMAZONORDERID and lower(S.SELLERSKU) = lower(R.SELLERSKU); create or replace table vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ADJUSTMENT_SKU as with Adjustment as (select POSTEDDATE::date DATE ,SELLERSKU ,sum(ifnull(COMPENSATED_CLAWBACK_QUANTITY,0)) COMPENSATED_CLAWBACK_QUANTITY ,sum(ifnull(COMPENSATED_CLAWBACK_TOTAL_AMOUNT,0)) COMPENSATED_CLAWBACK_TOTAL_AMOUNT ,sum(ifnull(WAREHOUSE_DAMAGE_QUANTITY,0)) WAREHOUSE_DAMAGE_QUANTITY ,sum(ifnull(WAREHOUSE_DAMAGE_TOTAL_AMOUNT,0)) WAREHOUSE_DAMAGE_TOTAL_AMOUNT ,sum(ifnull(REVERSAL_REIMBURSEMENT_QUANTITY,0)) REVERSAL_REIMBURSEMENT_QUANTITY ,sum(ifnull(REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT,0)) REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT ,sum(ifnull(WAREHOUSE_LOST_MANUAL_QUANTITY,0)) WAREHOUSE_LOST_MANUAL_QUANTITY ,sum(ifnull(WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT,0)) WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT ,sum(ifnull(FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY,0)) FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY ,sum(ifnull(FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT,0)) FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT from vahdam_db.maplemonk.vahdam_adjustment_event_list group by 1,2), SHIPREFUND as (select POSTEDDATE as DATE ,SELLERSKU ,sum(ifnull(QUANTITY,0)) as QUANTITY ,sum(ifnull(PRINCIPAL,0)) as PRINCIPAL ,sum(ifnull(FBAPERUNITFULFILLMENTFEE,0)) as FBAPERUNITFULFILLMENTFEE ,sum(ifnull(COMMISSION,0)) as COMMISSION ,sum(ifnull(PROMOTION,0)) as PROMOTION ,sum(ifnull(TAX,0)) as TAX ,sum(ifnull(Refund_commission,0)) as Refund_commission ,sum(ifnull(GIFTWRAP,0)) as GIFTWRAP ,sum(ifnull(GIFTWRAPTAX,0)) as GIFTWRAPTAX ,sum(ifnull(SHIPPINGCHARGE,0)) as SHIPPINGCHARGE ,sum(ifnull(SHIPPINGTAX,0)) as SHIPPINGTAX ,sum(ifnull(MARKETPLACEFACILITATORTAXPRINCIPAL,0)) as MARKETPLACEFACILITATORTAXPRINCIPAL ,sum(ifnull(MARKETPLACEFACILITATORTAXSHIPPING,0)) as MARKETPLACEFACILITATORTAXSHIPPING ,sum(ifnull(MARKETPLACEFACILITATORTAXOTHER,0)) as MARKETPLACEFACILITATORTAXOTHER ,sum(ifnull(MARKETPLACEFACILITATORVATSHIPPING,0)) as MARKETPLACEFACILITATORVATSHIPPING ,sum(ifnull(MARKETPLACEFACILITATORVATPRINCIPAL,0)) as MARKETPLACEFACILITATORVATPRINCIPAL ,sum(ifnull(FBAPERORDERFULFILLMENTFEE,0)) as FBAPERORDERFULFILLMENTFEE ,sum(ifnull(FBAWEIGHTBASEDFEE,0)) as FBAWEIGHTBASEDFEE ,sum(ifnull(FIXEDCLOSINGFEE,0)) as FIXEDCLOSINGFEE ,sum(ifnull(GIFTWRAPCHARGEBACK,0)) as GIFTWRAPCHARGEBACK ,sum(ifnull(SHIPPINGCHARGEBACK,0)) as SHIPPINGCHARGEBACK ,sum(ifnull(VARIABLECLOSINGFEE,0)) as VARIABLECLOSINGFEE ,sum(ifnull(SALESTAXCOLLECTIONFEE,0)) as SALESTAXCOLLECTIONFEE ,sum(ifnull(GIFTWRAPCOMMISSION,0)) as GIFTWRAPCOMMISSION ,sum(ifnull(SHIPPINGHB,0)) as SHIPPINGHB from vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ORDER_ID group by 1,2) select coalesce(A.DATE,S.DATE) as DATE ,coalesce(A.SELLERSKU,S.SELLERSKU) as SELLERSKU ,ifnull(S.QUANTITY,0) as QUANTITY ,ifnull(S.PRINCIPAL,0) as PRINCIPAL ,ifnull(S.FBAPERUNITFULFILLMENTFEE,0) as FBAPERUNITFULFILLMENTFEE ,ifnull(S.COMMISSION,0) as COMMISSION ,ifnull(S.PROMOTION,0) as PROMOTION ,ifnull(S.TAX,0) as TAX ,ifnull(S.Refund_commission,0) as Refund_commission ,ifnull(S.GIFTWRAP,0) as GIFTWRAP ,ifnull(S.GIFTWRAPTAX,0) as GIFTWRAPTAX ,ifnull(S.SHIPPINGCHARGE,0) as SHIPPINGCHARGE ,ifnull(S.SHIPPINGTAX,0) as SHIPPINGTAX ,ifnull(S.MARKETPLACEFACILITATORTAXPRINCIPAL,0) as MARKETPLACEFACILITATORTAXPRINCIPAL ,ifnull(S.MARKETPLACEFACILITATORTAXSHIPPING,0) as MARKETPLACEFACILITATORTAXSHIPPING ,ifnull(S.MARKETPLACEFACILITATORTAXOTHER,0) as MARKETPLACEFACILITATORTAXOTHER ,ifnull(S.MARKETPLACEFACILITATORVATSHIPPING,0) as MARKETPLACEFACILITATORVATSHIPPING ,ifnull(S.MARKETPLACEFACILITATORVATPRINCIPAL,0) as MARKETPLACEFACILITATORVATPRINCIPAL ,ifnull(S.FBAPERORDERFULFILLMENTFEE,0) as FBAPERORDERFULFILLMENTFEE ,ifnull(S.FBAWEIGHTBASEDFEE,0) as FBAWEIGHTBASEDFEE ,ifnull(S.FIXEDCLOSINGFEE,0) as FIXEDCLOSINGFEE ,ifnull(S.GIFTWRAPCHARGEBACK,0) as GIFTWRAPCHARGEBACK ,ifnull(S.SHIPPINGCHARGEBACK,0) as SHIPPINGCHARGEBACK ,ifnull(S.VARIABLECLOSINGFEE,0) as VARIABLECLOSINGFEE ,ifnull(S.SALESTAXCOLLECTIONFEE,0) as SALESTAXCOLLECTIONFEE ,ifnull(S.GIFTWRAPCOMMISSION,0) as GIFTWRAPCOMMISSION ,ifnull(S.SHIPPINGHB,0) as SHIPPINGHB ,ifnull(A.COMPENSATED_CLAWBACK_QUANTITY,0) as COMPENSATED_CLAWBACK_QUANTITY ,ifnull(A.COMPENSATED_CLAWBACK_TOTAL_AMOUNT,0) as COMPENSATED_CLAWBACK_TOTAL_AMOUNT ,ifnull(A.WAREHOUSE_DAMAGE_QUANTITY,0) as WAREHOUSE_DAMAGE_QUANTITY ,ifnull(A.WAREHOUSE_DAMAGE_TOTAL_AMOUNT,0) as WAREHOUSE_DAMAGE_TOTAL_AMOUNT ,ifnull(A.REVERSAL_REIMBURSEMENT_QUANTITY,0) as REVERSAL_REIMBURSEMENT_QUANTITY ,ifnull(A.REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT,0) as REVERSAL_REIMBURSEMENT_TOTAL_AMOUNT ,ifnull(A.WAREHOUSE_LOST_MANUAL_QUANTITY,0) as WAREHOUSE_LOST_MANUAL_QUANTITY ,ifnull(A.WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT,0) as WAREHOUSE_LOST_MANUAL_TOTAL_AMOUNT ,ifnull(A.FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY,0) as FREE_REPLACEMENT_REFUND_ITEMS_QUANTITY ,ifnull(A.FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT,0) as FREE_REPLACEMENT_REFUND_ITEMS_TOTAL_AMOUNT from SHIPREFUND S full outer join Adjustment A on lower(S.SELLERSKU) = lower(A.SELLERSKU) and S.DATE = A.DATE; Create or replace table vahdam_db.maplemonk.ASP_US_ASIN_Payment_Reports as With Payment as (select Date ,SKU_New ,ASIN ,COGS_USD ,Outbound_cost_usd ,sum(ifnull(QUANTITY,0)) as Units ,sum(ifnull(principal,0)) as Principal ,sum(ifnull(fbaperunitfulfillmentfee,0)) as FBA_Fees ,sum(ifnull(commission,0)) as Commission ,sum(ifnull(promotion,0)) as Promotion ,sum(ifnull(tax,0)) as Tax ,sum(ifnull(refund_commission,0)) as Refund_commission ,sum(ifnull(giftwrap,0)) as Giftwrap ,sum(ifnull(giftwraptax,0)) as Giftwraptax ,sum(ifnull(shippingcharge,0)) as Shippingcharge ,sum(ifnull(shippingtax,0)) as Shippingtax ,sum(ifnull(shippingchargeback,0)) as Shippingchargeback from (select S.* ,M.Amzon_ASIN as ASIN ,M.\"COGS (USD)\" as COGS_USD ,M.\"Outbound Cost (USD)\" as Outbound_cost_usd ,coalesce(S.SELLERSKU,M.Amazon_SKU) as SKU_New from vahdam_db.maplemonk.VAHDAM_ASP_US_REFUND_SHIPMENT_ADJUSTMENT_SKU S left join VAHDAM_DB.MAPLEMONK.GC_ASIN_SKU_MAPPING_ASIN_SKU_MAPPING M on S.SELLERSKU = M.Amazon_SKU) group by 1,2,3,4,5), Amazonads as (select date ,asin_new ,sum(ifnull(spend,0)) as Total_amazon_spend ,sum(ifnull(sales_usd,0)) as Total_amazon_sales from vahdam_db.maplemonk.amazonads_na_marketing group by 1,2) select coalesce(P.date,A.date) as Date ,coalesce(P.ASIN,A.asin_new) as ASIN ,P.SKU_New ,P.COGS_USD ,P.Outbound_cost_usd ,ifnull(P.Units,0) as Units ,ifnull(P.Principal,0) as Principal ,ifnull(P.FBA_Fees,0) as FBA_Fees ,ifnull(P.Commission,0) as Commission ,ifnull(P.Promotion,0) as Promotion ,ifnull(P.Tax,0) as Tax ,ifnull(P.Refund_commission,0) as Refund_commission ,ifnull(P.Giftwrap,0) as Giftwrap ,ifnull(P.Giftwraptax,0) as Giftwraptax ,ifnull(P.Shippingcharge,0) as Shippingcharge ,ifnull(P.Shippingtax,0) as Shippingtax ,ifnull(P.Shippingchargeback,0) as Shippingchargeback ,ifnull(A.Total_amazon_spend,0) as Total_amazon_spend ,ifnull(A.Total_amazon_sales,0) as Total_amazon_sales from Payment P left join Amazonads A on P.ASIN = A.asin_new and P.date = A.date order by Date desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from VAHDAM_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        