{{ config(
            materialized='table',
                post_hook={
                    "sql": "create or replace table snitch_db.maplemonk.plus_size_summary as ( with shopify_sales as ( SELECT order_timestamp::date as Date, \'Shopify\' as type, webshopney as channel, sum(gross_sales) as gross_sales, sum(quantity) AS gross_quantity, round(div0(sum(discount),sum(discount+gross_sales))*100, 2) AS discount_percentage, sum(discount) AS discount_amount, sum(CASE WHEN new_customer_flag != \'Repeated\' THEN gross_sales ELSE 0 END) AS new_customers_revenue, sum(CASE WHEN new_customer_flag = \'Repeated\' THEN gross_sales ELSE 0 END) AS repeat_customers_revenue, COUNT(DISTINCT CASE WHEN new_customer_flag != \'Repeated\' THEN customer_id ELSE 0 END) - 1 AS new_customers, (COUNT(DISTINCT CASE WHEN new_customer_flag != \'Repeated\' THEN customer_id ELSE NULL END) - 1)/count(distinct order_name)*100 AS new_customers_percentage, div0(sum(gross_sales),sum(quantity)) AS ASP FROM snitch_db.maplemonk.fact_items_snitch WHERE ((size in (\'3XL\',\'4XL\',\'5XL\',\'6XL\',\'40\',\'42\',\'44\',\'46\') or SKU_GROUP like \'4MBG%\') AND (lower(ifnull(discount_code, \'n\')) not like \'%eco%\' and lower(ifnull(discount_code, \'n\')) not like \'%influ%\' and order_name not in (\'2431093\',\'2422140\',\'2425364\',\'2430652\',\'2422237\',\'2420623\',\'2429832\',\'2422378\',\'2428311\',\'2429064\',\'2428204\',\'2421343\',\'2431206\',\'2430491\',\'2426682\',\'2426487\',\'2426458\',\'2423575\',\'2422431\',\'2423612\',\'2426625\',\'2428117\',\'2426894\',\'2425461\',\'2426570\',\'2423455\',\'2430777\',\'2426009\',\'2428245\',\'2427269\',\'2430946\',\'2425821\',\'2429986\',\'2429085\',\'2422047\',\'2430789\',\'2420219\',\'2428341\',\'2430444\',\'2426866\',\'2431230\',\'2425839\',\'2430980\',\'2427048\',\'2430597\',\'2420499\',\'2431050\',\'2420271\',\'2426684\',\'2428747\',\'2423523\',\'2431171\',\'2430830\',\'2425325\',\'2428414\',\'2429054\',\'2423596\') and tags not in (\'FLITS_LOGICERP\'))) and order_timestamp::date >= \'2024-07-11\' GROUP BY order_timestamp::date,type,channel ), marketplace_pre_data as ( select order_date as Date, CASE WHEN marketplace IN (\'SNITCH VR MALL\', \'SNITCH - FOCO - VR MALL\') THEN \'Store_Vr_Mall\' WHEN marketplace IN (\'FLIPKART\', \'FLIPKART_SAPL\', \'FLIPKART_SAPLWH2\', \'FLIPKART_SAPL_EMIZA\', \'FLIPKART_SAPL_SR\') THEN \'Marketplace_Flipkart\' WHEN marketplace IN (\'SNITCH BRIGADE ROAD\', \'SNITCH - COFO - BRIGADE ROAD\',\'SNITCH - COFO - BRIGADE ROAD\') THEN \'Store_Brigade_Road\' WHEN marketplace IN (\'SNITCH MBH\', \'SNITCH - FOCO - MBH\') THEN \'Store_Mbh\' WHEN marketplace IN (\'SAPL_AJIO_OMNI_SR\', \'SAPL_AJIO_OMNI\', \'SAPL_AJIO_OMNI_EMIZA\', \'SAPL_AJIO_OMNI_2\', \'AJIO_OMNI\') THEN \'Marketplace_Ajio\' WHEN marketplace = \'SNITCH - FOCO - TRION\' THEN \'Store_Trion\' WHEN marketplace = \'SNITCH - FOCO - EVA\' THEN \'Store_Eva\' WHEN marketplace IN (\'SAPL_MYNTRA_EMIZA\', \'MYNTRAPPMP\', \'SAPL_MYNTRAPPMP_SR\', \'SAPL_MYNTRAPPMP\', \'MYNTRAPPMP_SAPL_WH2\') THEN \'Marketplace_Myntra\' WHEN marketplace = \'NYKAA_FASHION\' THEN \'Marketplace_Nykaa\' WHEN marketplace = \'SNITCH - FOCO - GANDHI NAGAR\' THEN \'Store_Gandhi_Nagar\' WHEN marketplace = \'SNITCH - COCO - BEL ROAD\' THEN \'Store_Bel_Road\' WHEN marketplace IN (\'AMAZON_FLEX_API_EMIZA\', \'AMAZON_FLEX_API_SR\', \'AMAZON_FLEX_API_SAPL\', \'AMAZON\') THEN \'Marketplace_Amazon\' WHEN marketplace = \'SNITCH - COCO - HSR LAYOUT\' THEN \'Store_Hsr\' WHEN marketplace = \'SHOPIFY\' THEN \'Shopify\' WHEN marketplace IN (\'SNITCH - JAYANAGAR\', \'SNITCH - COCO - JAYANAGAR\') THEN \'Store_Jayanagar\' WHEN marketplace = \'SNITCH - COFO - SARATH CITY\' THEN \'Store_Sarath_City\' END AS channel, \'Marketplace\' as type, sum(selling_price) as gross_sales, sum(shipping_quantity) as gross_quantity, round(div0(sum(discount),sum(discount+selling_price))*100, 2) AS discount_percentage, sum(discount) as discount_amount, sum(CASE WHEN new_customer_flag != \'Repeated\' THEN selling_price ELSE 0 END) AS new_customers_revenue, sum(CASE WHEN new_customer_flag = \'Repeated\' THEN selling_price ELSE 0 END) AS repeat_customers_revenue, COUNT(DISTINCT CASE WHEN new_customer_flag != \'Repeated\' THEN customer_id ELSE 0 END) - 1 AS new_customers, div0((COUNT(DISTINCT CASE WHEN new_customer_flag != \'Repeated\' THEN customer_id ELSE NULL END) - 1),count(distinct customer_id))*100 AS new_customers_percentage, div0(sum(selling_price),sum(shipping_quantity)) AS ASP from snitch_db.maplemonk.unicommerce_fact_items_snitch where order_date >= \'2024-07-11\' and sku_group = \'4MBG%\' group by 1,2,3 ), marketplace_data as ( select * from marketplace_pre_data where channel like \'Marketplace%\' ), stores_data as ( select order_date as Date, \'Store\' as type, MARKETPLACE_MAPPED as type, sum(selling_price) as gross_sales, sum(shipping_quantity) as gross_quantity, round(div0(sum(discount),sum(discount+selling_price))*100, 2) AS discount_percentage, sum(discount) as discount_amount, sum(CASE WHEN new_customer_flag != \'Repeated\' THEN selling_price ELSE 0 END) AS new_customers_revenue, sum(CASE WHEN new_customer_flag = \'Repeated\' THEN selling_price ELSE 0 END) AS repeat_customers_revenue, COUNT(DISTINCT CASE WHEN new_customer_flag != \'Repeated\' THEN phone ELSE 0 END) - 1 AS new_customers, div0((COUNT(DISTINCT CASE WHEN new_customer_flag != \'Repeated\' THEN phone ELSE NULL END) - 1),count(distinct phone))*100 AS new_customers_percentage, div0(sum(selling_price),sum(shipping_quantity)) AS ASP from snitch_db.maplemonk.STORE_fact_items_offline where order_date >= \'2024-07-11\' and sku_group like \'4MBG%\' group by 1,2,3 ) select * from shopify_sales union select * from marketplace_data union select * from stores_data );",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            