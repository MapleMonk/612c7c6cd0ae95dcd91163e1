{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table dunatura_db.maplemonk.dunatura_db_retention_by_month as select c.month, c.year, LTM_all_cust, LTM_new_cust, TM_new_cust, TM_old_cust, TM_new_cust_sales, TM_old_cust_sales, LTM_new_cust_sales, LTM_all_cust_sales, LTM_new_cust_all_sales from( select month(date_start) month , year(date_Start) year , count(distinct b.Shopify_customer_id_final ) LTM_all_cust , sum(total_sales) LTM_all_cust_sales from (select distinct date_trunc(\'month\',order_timestamp::date) date_start from dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS) a left join dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS b on b.order_timestamp::date < a.date_start and b.order_timestamp::date > a.date_start - 365 where lower(b.order_status) <> \'cancelled\' group by 1,2 order by 2,1 desc )c left join (select month(order_timestamp::date) month , year(order_timestamp::date) year , count(distinct case when shopify_new_customer_flag_month = \'New\' then Shopify_customer_id_final end) TM_new_cust , count(distinct case when shopify_new_customer_flag_month <> \'New\' then Shopify_customer_id_final end) TM_old_cust , sum( case when shopify_new_customer_flag_month = \'New\' then total_sales end) TM_new_cust_sales , sum( case when shopify_new_customer_flag_month <> \'New\' then total_sales end) TM_old_cust_sales from dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS where lower(order_status) <> \'cancelled\' group by 1,2 order by 2,1 desc) d on c.month=d.month and c.year=d.year left join ( select month(date_start) month , year(date_Start) year , count(distinct b.Shopify_customer_id_final ) LTM_new_cust , sum(b.total_sales) LTM_new_cust_sales from (select distinct date_trunc(\'month\',order_timestamp::date) date_start from dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS) a left join dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS b on b.order_timestamp::date < a.date_start and b.order_timestamp::date > a.date_start - 365 where shopify_new_customer_flag = \'New\' and lower(order_status) <> \'cancelled\' group by 1,2 order by 2,1 desc )e on e.month = c.month and e.year = c.year left join ( select a.month, a.year, sum(total_sales) LTM_new_cust_all_sales from (select month(a.date_Start) month, year(a.date_start) year, Shopify_customer_id_final from (select distinct date_trunc(\'month\',order_timestamp::date) date_start from dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS) a left join dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS b on b.order_timestamp::date < a.date_start and b.order_timestamp::date > a.date_start - 365 where shopify_new_customer_flag = \'New\' and lower(order_status) <> \'cancelled\' )a left join (select month(a.date_Start) month, year(a.date_start) year, Shopify_customer_id_final, sum(total_sales) total_sales from (select distinct date_trunc(\'month\',order_timestamp::date) date_start from dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS) a left join dunatura_db.maplemonk.dunatura_db_SHOPIFY_FACT_ITEMS b on b.order_timestamp::date < a.date_start and b.order_timestamp::date > a.date_start - 365 where lower(order_status) <> \'cancelled\' group by 1,2,3 )b on a.month = b.month and a.year = b.year and a.Shopify_customer_id_final = b.Shopify_customer_id_final where a.Shopify_customer_id_final is not null group by 1,2 ) f on c.month = f.month and c.year = f.year ; CREATE OR REPLACE TABLE dunatura_db.maplemonk.dunatura_db_CUSTOMER_RETENTION AS SELECT year(Acquisition_Date) Acquisition_Year, monthname(Acquisition_Date) Acquisition_Month, last_day(Acquisition_Date) Acquisition_Month_LastDate, Acquisition_Channel, Acquisition_Marketplace, Acquisition_Product, Shop_Name as Purchase_Marketplace, count(distinct customer_id_final) total_customers, count(distinct case when lower(Acquisition_Marketplace) like \'%shopify%\' then customer_id_final end) Shopify_Acquired_Customers, count(distinct case when lower(Acquisition_Marketplace) like \'%cred%\' then customer_id_final end) CRED_Acquired_Customers, count(distinct case when last_day(Acquisition_Date)=last_day(order_date) then order_id end) total_orders, sum(case when last_day(Acquisition_Date)=last_day(order_date) then selling_price end) total_sales, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) then customer_id_final end) mn_c, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) mn_c_Shopify, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) then order_id end) mn_o, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) mn_o_Shopify, sum(case when last_day(Acquisition_Date)<>last_day(order_date) then selling_price end) mn_s, sum(case when last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) mn_s_Shopify, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) then customer_id_final end) product_mn_c, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_mn_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) then order_id end) product_mn_o, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_mn_o_Shopify, sum(case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) then selling_price end) product_mn_s, sum(case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_mn_s_Shopify, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then customer_id_final end) m2_c, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then customer_id_final end) m3_c, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then customer_id_final end) m4_c, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then customer_id_final end) m5_c, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then customer_id_final end) m6_c, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then customer_id_final end) m7_c, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then customer_id_final end) m8_c, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then customer_id_final end) m9_c, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then customer_id_final end) m10_c, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then customer_id_final end) m11_c, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then customer_id_final end) m12_c, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then order_id end) m2_o, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then order_id end) m3_o, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then order_id end) m4_o, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then order_id end) m5_o, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then order_id end) m6_o, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then order_id end) m7_o, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then order_id end) m8_o, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then order_id end) m9_o, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then order_id end) m10_o, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then order_id end) m11_o, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then order_id end) m12_o, sum(case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then selling_price end) m2_s, sum(case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then selling_price end) m3_s, sum(case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then selling_price end) m4_s, sum(case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then selling_price end) m5_s, sum(case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then selling_price end) m6_s, sum(case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then selling_price end) m7_s, sum(case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then selling_price end) m8_s, sum(case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then selling_price end) m9_s, sum(case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then selling_price end) m10_s, sum(case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then selling_price end) m11_s, sum(case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then selling_price end) m12_s, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m2_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m3_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m4_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m5_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m6_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m7_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m8_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m9_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m10_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m11_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m12_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) then order_id end) product_m2_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) then order_id end) product_m3_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) then order_id end) product_m4_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) then order_id end) product_m5_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) then order_id end) product_m6_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) then order_id end) product_m7_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) then order_id end) product_m8_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) then order_id end) product_m9_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) then order_id end) product_m10_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) then order_id end) product_m11_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) then order_id end) product_m12_o, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then selling_price end) product_m2_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then selling_price end) product_m3_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then selling_price end) product_m4_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then selling_price end) product_m5_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then selling_price end) product_m6_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then selling_price end) product_m7_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then selling_price end) product_m8_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then selling_price end) product_m9_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then selling_price end) product_m10_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then selling_price end) product_m11_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then selling_price end) product_m12_s, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m2_c_Shopify, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m3_c_Shopify, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m4_c_Shopify, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m5_c_Shopify, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m6_c_Shopify, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m7_c_Shopify, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m8_c_Shopify, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m9_c_Shopify, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m10_c_Shopify, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m11_c_Shopify, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m12_c_Shopify, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m2_o_Shopify, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m3_o_Shopify, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m4_o_Shopify, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m5_o_Shopify, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m6_o_Shopify, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m7_o_Shopify, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m8_o_Shopify, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m9_o_Shopify, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m10_o_Shopify, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m11_o_Shopify, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m12_o_Shopify, sum(case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m2_s_Shopify, sum(case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m3_s_Shopify, sum(case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m4_s_Shopify, sum(case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m5_s_Shopify, sum(case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m6_s_Shopify, sum(case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m7_s_Shopify, sum(case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m8_s_Shopify, sum(case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m9_s_Shopify, sum(case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m10_s_Shopify, sum(case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m11_s_Shopify, sum(case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m12_s_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m2_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m3_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m4_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m5_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m6_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m7_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m8_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m9_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m10_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m11_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m12_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m2_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m3_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m4_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m5_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m6_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m7_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m8_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m9_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m10_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m11_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m12_o_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m2_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m3_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m4_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m5_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m6_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m7_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m8_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m9_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m10_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m11_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m12_s_Shopify from ( select customer_id_final, order_id, acquisition_product, acquisition_channel, acquisition_marketplace, shop_name, product_name as product_name, order_date, selling_price, first_complete_order_date::date as Acquisition_Date from dunatura_db.maplemonk.dunatura_db_SALES_CONSOLIDATED where customer_id_final is not null and lower(order_status) <> \'cancelled\' )res group by year(Acquisition_Date), monthname(Acquisition_Date), last_day(Acquisition_Date), Acquisition_channel, acquisition_marketplace, Acquisition_Product, shop_name union all SELECT year(Acquisition_Date) Acquisition_Year, monthname(Acquisition_Date) Acquisition_Month, last_day(Acquisition_Date) Acquisition_Month_LastDate, Acquisition_Channel Marketing_channel, Acquisition_Marketplace, Acquisition_Product, \'All\' as Purchase_Marketplace, count(distinct customer_id_final) total_customers, count(distinct case when lower(Acquisition_Marketplace) like \'%shopify%\' then customer_id_final end) Shopify_Acquired_Customers, count(distinct case when lower(Acquisition_Marketplace) like \'%cred%\' then customer_id_final end) CRED_Acquired_Customers, count(distinct case when last_day(Acquisition_Date)=last_day(order_date) then order_id end) total_orders, sum(case when last_day(Acquisition_Date)=last_day(order_date) then selling_price end) total_sales, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) then customer_id_final end) mn_c, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) mn_c_Shopify, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) then order_id end) mn_o, count(distinct case when last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) mn_o_Shopify, sum(case when last_day(Acquisition_Date)<>last_day(order_date) then selling_price end) mn_s, sum(case when last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) mn_s_Shopify, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) then customer_id_final end) product_mn_c, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_mn_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) then order_id end) product_mn_o, count(distinct case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_mn_o_Shopify, sum(case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) then selling_price end) product_mn_s, sum(case when acquisition_product=product_name and last_day(Acquisition_Date)<>last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_mn_s_Shopify, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then customer_id_final end) m2_c, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then customer_id_final end) m3_c, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then customer_id_final end) m4_c, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then customer_id_final end) m5_c, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then customer_id_final end) m6_c, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then customer_id_final end) m7_c, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then customer_id_final end) m8_c, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then customer_id_final end) m9_c, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then customer_id_final end) m10_c, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then customer_id_final end) m11_c, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then customer_id_final end) m12_c, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then order_id end) m2_o, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then order_id end) m3_o, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then order_id end) m4_o, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then order_id end) m5_o, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then order_id end) m6_o, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then order_id end) m7_o, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then order_id end) m8_o, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then order_id end) m9_o, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then order_id end) m10_o, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then order_id end) m11_o, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then order_id end) m12_o, sum(case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then selling_price end) m2_s, sum(case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then selling_price end) m3_s, sum(case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then selling_price end) m4_s, sum(case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then selling_price end) m5_s, sum(case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then selling_price end) m6_s, sum(case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then selling_price end) m7_s, sum(case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then selling_price end) m8_s, sum(case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then selling_price end) m9_s, sum(case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then selling_price end) m10_s, sum(case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then selling_price end) m11_s, sum(case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then selling_price end) m12_s, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m2_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m3_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m4_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m5_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m6_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m7_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m8_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m9_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m10_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m11_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) then customer_id_final end) product_m12_c, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) then order_id end) product_m2_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) then order_id end) product_m3_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) then order_id end) product_m4_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) then order_id end) product_m5_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) then order_id end) product_m6_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) then order_id end) product_m7_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) then order_id end) product_m8_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) then order_id end) product_m9_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) then order_id end) product_m10_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) then order_id end) product_m11_o, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) then order_id end) product_m12_o, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) then selling_price end) product_m2_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) then selling_price end) product_m3_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) then selling_price end) product_m4_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) then selling_price end) product_m5_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) then selling_price end) product_m6_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) then selling_price end) product_m7_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) then selling_price end) product_m8_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) then selling_price end) product_m9_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) then selling_price end) product_m10_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) then selling_price end) product_m11_s, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) then selling_price end) product_m12_s, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m2_c_Shopify, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m3_c_Shopify, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m4_c_Shopify, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m5_c_Shopify, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m6_c_Shopify, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m7_c_Shopify, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m8_c_Shopify, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m9_c_Shopify, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m10_c_Shopify, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m11_c_Shopify, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) m12_c_Shopify, count(distinct case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m2_o_Shopify, count(distinct case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m3_o_Shopify, count(distinct case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m4_o_Shopify, count(distinct case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m5_o_Shopify, count(distinct case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m6_o_Shopify, count(distinct case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m7_o_Shopify, count(distinct case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m8_o_Shopify, count(distinct case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m9_o_Shopify, count(distinct case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m10_o_Shopify, count(distinct case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m11_o_Shopify, count(distinct case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) m12_o_Shopify, sum(case when last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m2_s_Shopify, sum(case when last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m3_s_Shopify, sum(case when last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m4_s_Shopify, sum(case when last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m5_s_Shopify, sum(case when last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m6_s_Shopify, sum(case when last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m7_s_Shopify, sum(case when last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m8_s_Shopify, sum(case when last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m9_s_Shopify, sum(case when last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m10_s_Shopify, sum(case when last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m11_s_Shopify, sum(case when last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) m12_s_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m2_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m3_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m4_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m5_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m6_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m7_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m8_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m9_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m10_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m11_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then customer_id_final end) product_m12_c_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m2_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m3_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m4_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m5_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m6_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m7_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m8_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m9_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m10_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m11_o_Shopify, count(distinct case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))= last_day(order_date) and lower(shop_name) like \'%shopify%\' then order_id end) product_m12_o_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,1,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m2_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,2,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m3_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,3,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m4_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,4,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m5_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,5,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m6_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,6,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m7_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,7,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m8_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,8,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m9_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,9,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m10_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,10,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m11_s_Shopify, sum(case when acquisition_product=product_name and last_day(dateadd(month,11,Acquisition_Date))=last_day(order_date) and lower(shop_name) like \'%shopify%\' then selling_price end) product_m12_s_Shopify from ( select customer_id_final, order_id, acquisition_product, Acquisition_channel, acquisition_marketplace, shop_name, product_name as product_name, order_date, selling_price, first_complete_order_date::date as Acquisition_Date from dunatura_db.maplemonk.dunatura_db_SALES_CONSOLIDATED where customer_id_final is not null and lower(order_status) <> \'cancelled\' )res group by year(Acquisition_Date), monthname(Acquisition_Date), last_day(Acquisition_Date), Acquisition_channel, acquisition_marketplace, Acquisition_Product; create or replace table dunatura_db.maplemonk.dunatura_db_monthly_retention as with cust as ( select date_trunc(\'month\',order_date::date) Date_Start ,month(date_start) month ,year(date_Start) year ,customer_id_final ,max(case when lower(new_customer_flag_month) = \'new\' then 1 else 0 end) as new_flag ,max(case when lower(new_customer_flag_month) = \'repeat\' then 1 else 0 end) as repeat_flag from dunatura_db.maplemonk.dunatura_db_SALES_CONSOLIDATED where lower(shop_name) like any (\'%shopify%\',\'%cred%\') and lower(order_status) <> \'cancelled\' group by 1,2,3,4 ), months as ( select distinct date_trunc(\'month\',order_date::date) date_start from dunatura_db.maplemonk.dunatura_db_SALES_CONSOLIDATED where lower(shop_name) like any (\'%shopify%\',\'%cred%\') ), All_Customers as ( select date_trunc(\'month\',Date_Start::date) Date_Start ,month(date_start) month ,year(date_Start) year ,count(distinct customer_id_final) All_customers ,sum(new_flag) TM_New_Customers ,sum(repeat_flag) TM_Repeat_Customers from cust group by 1,2,3 ) ,All_Customers_Till_LM as ( select a.month ,a.year ,a.date_start ,All_customers_Till_LM ,count(distinct c.customer_id_final ) All_customers_LTM ,count(distinct case when c.new_flag = 1 then c.customer_id_final end) as New_customers_LTM from ( select month(a.date_start) month ,year(a.date_Start) year ,a.date_start ,count(distinct b.customer_id_final ) All_customers_Till_LM from months a left join cust b on b.Date_Start < a.date_start group by 1,2,3 ) a left join cust c on c.Date_Start < a.date_start and c.date_start >= date_trunc(\'month\',a.date_start -365) group by 1,2,3,4 ) Select TM.Date_Start ,TM.month ,TM.year ,TM.All_customers TM_All_customers ,(sum(TM.all_customers) over (partition by 1 order by TM.date_start asc rows between 1 preceding and current row) - TM.All_customers) All_Customers_LM ,TM.TM_New_Customers ,(sum(TM.TM_New_Customers) over (partition by 1 order by TM.date_start asc rows between 1 preceding and current row) - TM.TM_New_Customers) LM_New_Customers ,TM.TM_Repeat_Customers ,TLM.All_customers_Till_LM ,TLM.All_customers_LTM ,TLM.New_customers_LTM from All_customers TM left join All_Customers_Till_LM TLM on TM.date_Start = TLM.date_Start;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from dunatura_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        