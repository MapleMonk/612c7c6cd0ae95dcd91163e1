{{ config(
            materialized='table',
                post_hook={
                    "sql": "Create or replace table sleepycat_db.maplemonk.sleepycat_db_Product_Marketing_Consolidated as ( with facebook_spend as ( select date ,CAMPAIGN_NAME ,CAMPAIGN_ID ,AD_NAME ,sum(ifnull(Clicks,0)) as Clicks ,sum(ifnull(Spend,0)) as Spend ,sum(ifnull(Impressions,0)) as Impressions ,sum(ifnull(Conversions,0)) as Conversions ,sum(ifnull(Conversion_Value,0)) as Conversion_Value from SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_FACEBOOK_CONSOLIDATED where date >= \'2024-01-01\' group by 1,2,3,4 ), ad_name_mapping_from_googlesheet as ( select date ,CAMPAIGN_NAME ,CAMPAIGN_ID ,fs.AD_NAME ,sub_category ,div0(CLICKS,count(*) over(partition by date,lower(fs.AD_NAME))) as clicks, div0(Spend,count(*) over(partition by date,lower(fs.AD_NAME))) as Spend, div0(Impressions,count(*) over(partition by date,lower(fs.AD_NAME))) as Impressions, div0(Conversions,count(*) over(partition by date,lower(fs.AD_NAME))) as Conversions, div0(Conversion_Value,count(*) over(partition by date,lower(fs.AD_NAME))) as Conversion_Value from facebook_spend fs left join (select distinct ad_name, sub_category from sleepycat_db.maplemonk.facebook_marketing_campaigns_category_ma )cm on lower(cm.ad_name) = lower(fs.AD_NAME) ), final_facebook_data as ( select * from ad_name_mapping_from_googlesheet where sub_category is not null union all select date ,CAMPAIGN_NAME ,CAMPAIGN_ID ,AD_NAME ,b.sub_category ,clicks, Spend, Impressions, Conversions, Conversion_Value from (select * from ad_name_mapping_from_googlesheet where sub_category is null) a left join ( select distinct sub_category from sleepycat_db.maplemonk.final_sku_master )b on lower(a.ad_name) like \'%\' || lower(b.SUB_CATEGORY) || \'%\' qualify row_number() over(partition by date,a.ad_name order by length(b.SUB_CATEGORY) desc) = 1 ) select date ,skucode ,\'FACEBOOK\' as channel ,sum(ifnull(clicks,0)) as clicks ,sum(ifnull(Spend,0)) as Spend ,sum(ifnull(Impressions,0)) as Impressions ,sum(ifnull(Conversions,0)) as Conversions ,sum(ifnull(Conversion_Value,0)) as Conversion_Value from (select date ,item.skucode ,CAMPAIGN_NAME ,CAMPAIGN_ID ,AD_NAME ,scm.sub_category ,div0(CLICKS,count(*) over(partition by date,lower(scm.sub_category))) as clicks, div0(Spend,count(*) over(partition by date,lower(scm.sub_category))) as Spend, div0(Impressions,count(*) over(partition by date,lower(scm.sub_category))) as Impressions, div0(Conversions,count(*) over(partition by date,lower(scm.sub_category))) as Conversions, div0(Conversion_Value,count(*) over(partition by date,lower(scm.sub_category))) as Conversion_Value from final_facebook_data scm left join ( select distinct sub_category,skucode from sleepycat_db.maplemonk.final_sku_master )item on lower(scm.sub_category) = lower(item.sub_category) )group by 1,2 ) UNION ALL ( with google_spend as ( select \"segments.date\"::date as date ,\"campaign.id\" as campaign_id, \"campaign.name\" campaign_name, \"landing_page_view.unexpanded_final_url\" as landing_page ,SUM(ifnull(\"metrics.clicks\",0)) Clicks ,SUM(ifnull(\"metrics.cost_micros\",0))/1000000 Spend ,SUM(ifnull(\"metrics.impressions\",0)) Impressions ,SUM(ifnull(\"metrics.conversions\",0)) Conversions ,SUM(ifnull(\"metrics.conversions_value\",0)) Conversion_Value from sleepycat_db.maplemonk.sleepycat_db_gads_campaign_landing_page_data where not(lower(\"campaign.advertising_channel_type\") like \'%video%\') group by 1,2,3,4 union select ld.* from ( select \"segments.date\"::date as date, \"campaign.id\" as campaign_id, \"campaign.name\" as campaign_name, \"landing_page_view.unexpanded_final_url\" ,SUM(ifnull(\"metrics.clicks\",0)) Clicks ,SUM(ifnull(\"metrics.cost_micros\",0))/1000000 Spend ,SUM(ifnull(\"metrics.impressions\",0)) Impressions ,SUM(ifnull(\"metrics.conversions\",0)) Conversions ,SUM(ifnull(\"metrics.conversions_value\",0)) Conversion_Value from sleepycat_db.maplemonk.sleepycat_db_gads_campaign_landing_page_data where (lower(\"campaign.advertising_channel_type\") like \'%video%\') group by 1,2,3,4 )ld left join ( select date ,campaign_id ,campaign_name ,ceil(sum(ifnull(spend,0)))spend from sleepycat_db.maplemonk.sleepycat_db_marketing_consolidated where lower(channel) like \'%google%\' group by 1,2,3 )cd on ld.date = cd.date and lower(ld.campaign_name) = lower(cd.campaign_name) qualify row_number() over(partition by ld.date, lower(ld.campaign_name) order by abs(ifnull(ld.spend,0) - ifnull(cd.spend,0)) asc ) = 1 ), Google_Final_Result as ( select gs.date, gs.CAMPAIGN_ID, gs.CAMPAIGN_NAME, gs.LANDING_PAGE, scm.sub_category, item.skucode, div0(CLICKS,count(*) over(partition by date,lower(CAMPAIGN_NAME),lower(gs.LANDING_PAGE),lower(scm.sub_category))) as clicks, div0(Spend,count(*) over(partition by date,lower(CAMPAIGN_NAME),lower(gs.LANDING_PAGE),lower(scm.sub_category))) as Spend, div0(Impressions,count(*) over(partition by date,lower(CAMPAIGN_NAME),lower(gs.LANDING_PAGE),lower(scm.sub_category))) as Impressions, div0(Conversions,count(*) over(partition by date,lower(CAMPAIGN_NAME),lower(gs.LANDING_PAGE),lower(scm.sub_category))) as Conversions, div0(Conversion_Value,count(*) over(partition by date,lower(CAMPAIGN_NAME),lower(gs.LANDING_PAGE),lower(scm.sub_category))) as Conversion_Value from google_spend gs left join ( select distinct subcategory as sub_category ,landing_page from sleepycat_db.maplemonk.google_landingpage_category_mapping )scm on lower(scm.landing_page) = lower(gs.landing_page) left join ( select distinct sub_category,skucode from sleepycat_db.maplemonk.final_sku_master )item on lower(scm.sub_category) = lower(item.sub_category) ) select date ,skucode ,\'GOOGLE\' as channel ,sum(ifnull(clicks,0)) as clicks ,sum(ifnull(Spend,0)) as Spend ,sum(ifnull(Impressions,0)) as Impressions ,sum(ifnull(Conversions,0)) as Conversions ,sum(ifnull(Conversion_Value,0)) as Conversion_Value from Google_Final_Result group by 1,2 ) UNION ALL ( Select date ,skucode ,\'AMAZON\' as channel ,sum(ifnull(CLICKS,0)) as CLICKS ,sum(ifnull(SPEND,0)) as SPEND ,sum(ifnull(IMPRESSIONS,0)) as IMPRESSIONS ,sum(ifnull(CONVERSIONS,0)) as CONVERSIONS ,sum(ifnull(AdSales,0)) as AdSales FROM SLEEPYCAT_DB.MAPLEMONK.SLEEPYCAT_DB_AMAZONADS_MARKETING AM left join ( select * from sleepycat_db.maplemonk.final_sku_master qualify row_number() over(partition by lower(marketplace_sku) order by 1 ) = 1 )sm on lower(AM.asin) = lower(sm.marketplace_sku) group by 1,2 ) UNION ALL ( with flipkart_data as ( select date ,null as sub_Category ,sum(ifnull(CLICKS,0)) as CLICKS ,sum(ifnull(SPEND,0)) as SPEND ,sum(ifnull(VIEWS,0)) as IMPRESSIONS ,sum(ifnull(TOTAL_UNITS_SOLD,0)) as Conversions ,sum(ifnull(TOTAL_REVENUE,0)) as Conversion_Value from sleepycat_db.maplemonk.sleepycat_db_flipkart_ads_fact_items group by 1,2 ), final_flipkart_result as ( select scm.date, item.skucode, scm.sub_category, div0(CLICKS,count(*) over(partition by date,lower(scm.sub_category))) as clicks, div0(Spend,count(*) over(partition by date,lower(scm.sub_category))) as Spend, div0(Impressions,count(*) over(partition by date,lower(scm.sub_category))) as Impressions, div0(Conversions,count(*) over(partition by date,lower(scm.sub_category))) as Conversions, div0(Conversion_Value,count(*) over(partition by date,lower(scm.sub_category))) as Conversion_Value from flipkart_data scm left join ( select distinct sub_category,skucode from sleepycat_db.maplemonk.final_sku_master )item on lower(scm.sub_category) = lower(item.sub_category) ) select date ,skucode ,\'FLIPKART\' as channel ,sum(ifnull(clicks,0)) as clicks ,sum(ifnull(Spend,0)) as Spend ,sum(ifnull(Impressions,0)) as Impressions ,sum(ifnull(Conversions,0)) as Conversions ,sum(ifnull(Conversion_Value,0)) as Conversion_Value from final_flipkart_result group by 1,2 );",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from SLEEPYCAT_DB.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            