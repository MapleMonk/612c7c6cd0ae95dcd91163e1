{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE OR REPLACE TABLE snitch_db.maplemonk.category_visibility AS ( WITH cat_sales AS ( SELECT order_timestamp::date AS date, sku_group, SUM(gross_sales) AS total_sales, SUM(quantity) AS total_quant FROM snitch_db.maplemonk.fact_items_snitch WHERE LOWER(IFNULL(discount_code, \'n\')) NOT LIKE \'%eco%\' AND LOWER(IFNULL(discount_code, \'n\')) NOT LIKE \'%influ%\' AND order_name NOT IN (\'2431093\',\'2422140\',\'2425364\',\'2430652\',\'2422237\',\'2420623\',\'2429832\',\'2422378\',\'2428311\',\'2429064\',\'2428204\',\'2421343\',\'2431206\',\'2430491\',\'2426682\',\'2426487\',\'2426458\',\'2423575\',\'2422431\',\'2423612\',\'2426625\',\'2428117\',\'2426894\',\'2425461\',\'2426570\',\'2423455\',\'2430777\',\'2426009\',\'2428245\',\'2427269\',\'2430946\',\'2425821\',\'2429986\',\'2429085\',\'2422047\',\'2430789\',\'2420219\',\'2428341\',\'2430444\',\'2426866\',\'2431230\',\'2425839\',\'2430980\',\'2427048\',\'2430597\',\'2420499\',\'2431050\',\'2420271\',\'2426684\',\'2428747\',\'2423523\',\'2431171\',\'2430830\',\'2425325\',\'2428414\',\'2429054\',\'2423596\') AND tags NOT IN (\'FLITS_LOGICERP\') GROUP BY 1, 2 ), inventory AS ( SELECT date, REVERSE(SUBSTRING(REVERSE(\"Item SkuCode\"), CHARINDEX(\'-\', REVERSE(\"Item SkuCode\")) + 1, LEN(\"Item SkuCode\"))) AS sku_group, SUM(inventory) AS sellable_inventory FROM snitch_db.maplemonk.snitch_final_inventory_wh2 GROUP BY 1, 2 ), inventory_status AS ( SELECT sku_group, sku_class FROM snitch_db.maplemonk.availability_master_v2 ), main_data AS ( SELECT a.date, a.sku_group, a.sellable_inventory, b.sku_class FROM inventory a LEFT JOIN inventory_status b ON LOWER(a.sku_group) = LOWER(b.sku_group) ), combined_data AS ( SELECT a.date, a.sku_group, a.sellable_inventory, a.sku_class, b.total_sales, b.total_quant FROM main_data a LEFT JOIN cat_sales b ON a.sku_group = b.sku_group AND a.date = b.date ), metafileds AS ( SELECT sku_group, CASE WHEN product_type IN (\'Shirt\', \'Shirts\') THEN \'Shirts\' ELSE product_type END AS new_category, occassion, print_design, collar, material, sleeve_type, fit, color, designs, collar_new, material_new, occassion_new FROM snitch_db.maplemonk.Product_info ), clicks as ( select date, sku_group, sum(clicks) as total_clicks from snitch_db.maplemonk.FINAL_GA_clicks_impressions_by_itemid group by 1,2 ), date_clicks as ( select date,sum(total_clicks) as daywise_total_clicks from clicks group by 1 ), spends as ( select date, sum(clicks) as paid_clicks, div0(sum(spend),sum(clicks)) as spend_per_click, from snitch_db.maplemonk.marketing_consolidated_snitch where channel in (\'Google\',\'Facebook\') group by 1 ), paid_clicks_ratio as ( select a.date, div0(b.paid_clicks,a.daywise_total_clicks) as paid_ratio from date_clicks a left join spends b on a.date = b.date ), main_data2 as ( select a.date, a.sku_group, a.total_clicks*b.paid_ratio*c.spend_per_click as calculated_spend from clicks a left join paid_clicks_ratio b on a.date=b.date left join spends c on a.date=c.date ), main_data3 as ( SELECT b.sku_group, b.date, b.sellable_inventory, b.sku_class, b.total_sales, b.total_quant, a.new_category, a.occassion, a.print_design, a.collar, a.material, a.sleeve_type, a.fit, a.color, a.designs, a.collar_new, a.material_new, a.occassion_new FROM combined_data b LEFT JOIN metafileds a ON b.sku_group = a.sku_group ) select a.*,b.calculated_spend from main_data3 a left join main_data2 b on a.date = b.date and a.sku_group = b.sku_group );",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            