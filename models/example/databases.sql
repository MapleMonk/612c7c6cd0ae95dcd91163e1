{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table hilodesign_db.MAPLEMONK.Sales_Cost_Source_hilo as with sales as ( select marketplace,sales_channel ,order_date::date as ORDER_DATE ,count(distinct case when new_customer_flag = 1 and lower(order_status) <> \'cancelled\' then order_id end) as orders_new ,coalesce(sum(case when new_customer_flag = 1 and lower(order_status) <> \'cancelled\' then selling_price end),0) as gross_sales_new ,sum(case when new_customer_flag = 1 then suborder_quantity end ) as total_quantity_new ,sum(case when new_customer_flag = 1 then returned_quantity end ) as returned_quantity_new ,sum(case when new_customer_flag = 1 then cancelled_quantity end ) as cancelled_quantity_new ,sum(case when new_customer_flag = 1 then return_sales end ) as return_sales_new ,sum(case when new_customer_flag = 1 then cancel_sales end ) as cancel_sales_new ,ifnull(gross_sales_new,0) - ifnull(return_sales_new,0) as net_sales_new ,count(distinct case when new_customer_flag = 0 and lower(order_status) <> \'cancelled\' then order_id end) as orders_repeat ,coalesce(sum(case when new_customer_flag = 0 and lower(order_status) <> \'cancelled\' then selling_price end),0) as gross_sales_repeat ,sum(case when new_customer_flag = 0 then suborder_quantity end ) as total_quantity_repeat ,sum(case when new_customer_flag = 0 then returned_quantity end ) as returned_quantity_repeat ,sum(case when new_customer_flag = 0 then cancelled_quantity end ) as cancelled_quantity_repeat ,sum(case when new_customer_flag = 0 then return_sales end ) as return_sales_repeat ,sum(case when new_customer_flag = 0 then cancel_sales end ) as cancel_sales_repeat ,ifnull(gross_sales_repeat,0) - ifnull(return_sales_repeat,0) as net_sales_repeat ,count(distinct case when lower(order_status) in (\'cancelled\') then order_id end) as orders_cancelled ,count(distinct case when lower(order_status) not in (\'cancelled\') then customer_id_final end) as Unique_Customers ,count(distinct case when new_customer_flag = 1 and lower(order_status) not in (\'cancelled\') then customer_id_final end) as New_Customers ,ifnull(sum(case when lower(order_status) <> \'cancelled\' then cogs::float end),0) as COGS from hilodesign_db.maplemonk.sales_consolidated_hilo group by 1,2,3 ), marketing as ( select date,\'Shopify_India\' as marketplace ,sum(spend) as spend, avg(orders) orders,avg(Sales) Sales from hilodesign_db.MAPLEMONK.MARKETING_CONSOLIDATED_HILO a left join (select order_timestamp::date as order_date, count(distinct order_id) as orders, sum(total_sales) as Sales from hilodesign_db.maplemonk.FACT_ITEMS where shop_name like \'%hop%\' and final_utm_channel not in (\'Others\',\'Direct\') and lower(order_status) not in (\'cancelled\') group by 1 ) b on a.date::date = b.order_date::date group by 1,2 ) select coalesce(s.marketplace,m.marketplace) as marketplace ,sales_channel ,coalesce(s.order_date,m.date) as order_date ,orders_new ,gross_sales_new ,total_quantity_new ,returned_quantity_new ,cancelled_quantity_new ,return_sales_new ,cancel_sales_new ,net_sales_new ,orders_repeat ,gross_sales_repeat ,total_quantity_repeat ,returned_quantity_repeat ,cancelled_quantity_repeat ,return_sales_repeat ,cancel_sales_repeat ,net_sales_repeat ,orders_cancelled ,Unique_Customers ,New_Customers ,cogs ,m.spend as spend ,m.sales as ads_sales ,m.orders as ads_orders from sales s full join marketing m on s.order_date::date = m.date::date and s.marketplace in (\'Shopify\',\'Shopify_India\') order by s.order_date::date desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from HILODESIGN_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        