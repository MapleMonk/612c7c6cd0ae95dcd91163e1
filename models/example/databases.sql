{{ config(
            materialized='table',
                post_hook={
                    "sql": "CREATE TABLE IF NOT EXISTS MAPLEMONK.sku_master ( skucode STRING, name STRING, category STRING, sub_category STRING ); CREATE TABLE IF NOT EXISTS MAPLEMONK.Custom_Amazon_Seller_Partner_ASP_ZOUK_GET_FLAT_FILE_ALL_ORDERS_DATA_BY_ORDER_DATE_GENERAL ( Sku STRING, Currency STRING, item_tax STRING, order_id STRING, ship_city STRING, buyer_name STRING, item_price STRING, ship_state STRING, buyer_email STRING, address_type STRING, product_name STRING, ship_country STRING, gift_wrap_tax STRING, license_state STRING, licensee_name STRING, order_channel STRING, order_item_id STRING, payments_date STRING, purchase_date STRING, gift_wrap_type STRING, license_number STRING, recipient_name STRING, ship_address_1 STRING, ship_address_2 STRING, ship_address_3 STRING, shipping_price STRING, number_of_items STRING, gift_wrap_price STRING, ship_postal_code STRING, gift_message_text STRING, is_business_order STRING, is_global_express STRING, item_promotion_id STRING, price_designation STRING, buyer_company_name STRING, quantity_purchased STRING, ship_service_level STRING, delivery_instructions STRING, purchase_order_number STRING, shipping_promotion_id STRING, order_channel_instance STRING, item_promotion_discount STRING, license_expiration_date STRING, actual_ship_from_address_1 STRING, shipping_promotion_discount STRING, actual_ship_from_address_city STRING, actual_ship_from_address_name STRING, actual_ship_from_address_state STRING, default_ship_from_address_city STRING, default_ship_from_address_name STRING, default_ship_from_address_state STRING, actual_ship_from_address_country STRING, actual_ship_from_address_field_2 STRING, actual_ship_from_address_field_3 STRING, default_ship_from_address_country STRING, default_ship_from_address_field_1 STRING, default_ship_from_address_field_2 STRING, default_ship_from_address_field_3 STRING, dctual_ship_from_address_postal_code STRING, default_ship_from_address_postal_code STRING, order_status STRING, shipping_tax STRING, ship_promotion_discount STRING ); CREATE OR REPLACE TABLE MAPLEMONK.zouk_AMAZON_FACT_ITEMS AS SELECT \'Custom_Amazon_Seller_Partner_ASP_ZOUK\' AS shop_name, cast(amazon_order_id as string) order_id, cast(amazon_order_id AS string) order_name, NULL AS customer_id, NULL AS phone, NULL AS tags, NULL AS line_item_id, cast(Sku as string ) sku, ASIN AS product_id, cast(Currency as string) Currency, CASE WHEN order_status IN (\'Shipped - Returned to Seller\', \'Shipped - Returning to Seller\', \'Shipped - Rejected by Buyer\', \'Shipped - Damaged\') THEN 1 ELSE 0 END AS is_refund, cast(UPPER(ship_city) as string) AS city, cast(UPPER(ship_state) as string) AS state, cast(ship_postal_code as string) AS pincode, upper(cast(product_name as string)) AS product_name, NULL AS category, cast(order_status as string )order_status, CAST(FORMAT_TIMESTAMP(\'%Y-%m-%d %H:%M:%S\', PARSE_TIMESTAMP(\'%Y-%m-%dT%H:%M:%S%Ez\', purchase_date)) AS DATETIME) AS order_timestamp, IFNULL(SAFE_CAST(item_price AS FLOAT64), 0) AS line_item_sales, IFNULL(SAFE_CAST(shipping_price AS FLOAT64), 0) AS shipping_price, IFNULL(SAFE_CAST(quantity AS FLOAT64), 0) AS quantity, IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0) AS tax, SAFE_DIVIDE(IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0), IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0) + IFNULL(SAFE_CAST(item_price AS FLOAT64), 0)) AS tax_rate, IFNULL(safe_CAST(item_promotion_discount AS FLOAT64), 0) AS discount, SAFE_DIVIDE(IFNULL(SAFE_CAST(item_promotion_discount AS FLOAT64), 0), (1 - (SAFE_DIVIDE(IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0), IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0) + IFNULL(SAFE_CAST(item_price AS FLOAT64), 0))) )) AS discount_before_tax, NULL AS gross_sales_after_tax, IFNULL(SAFE_CAST(item_price AS FLOAT64), 0) - (SAFE_DIVIDE(IFNULL(SAFE_CAST(item_promotion_discount AS FLOAT64), 0), (1 - (SAFE_DIVIDE(IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0), IFNULL(SAFE_CAST(item_tax AS FLOAT64), 0) + IFNULL(SAFE_CAST(item_price AS FLOAT64), 0))) ))) AS gross_sales_before_tax, NULL AS net_sales_before_tax, IFNULL(SAFE_CAST(item_price AS FLOAT64), 0) - IFNULL(SAFE_CAST(item_promotion_discount AS FLOAT64), 0) AS total_sales, \'Amazon\' AS source, NULL AS landing_utm_medium, NULL AS landing_utm_source, NULL AS landing_utm_campaign, NULL AS referring_utm_medium, NULL AS referring_utm_source, NULL AS landing_utm_channel, NULL AS referring_utm_channel, NULL AS final_utm_channel, NULL AS new_customer_flag, NULL AS acquisition_channel, NULL AS acquisition_product, IFNULL(SAFE_CAST(shipping_tax AS FLOAT64), 0) AS shipping_tax, IFNULL(SAFE_CAST(ship_promotion_discount AS FLOAT64), 0) AS ship_promotion_discount, IFNULL(SAFE_CAST(gift_wrap_price AS FLOAT64), 0) AS gift_wrap_price, IFNULL(SAFE_CAST(gift_wrap_tax AS FLOAT64), 0) AS gift_wrap_tax FROM ( SELECT *, purchase_date AS Purchase_datetime_PDT FROM MAPLEMONK.Custom_Amazon_Seller_Partner_ASP_ZOUK_GET_FLAT_FILE_ALL_ORDERS_DATA_BY_LAST_UPDATE_GENERAL ) X; CREATE OR REPLACE TABLE MAPLEMONK.amazon_orders_fact_items AS SELECT * FROM MAPLEMONK.Custom_Amazon_Seller_Partner_ASP_ZOUK_GET_FLAT_FILE_ALL_ORDERS_DATA_BY_ORDER_DATE_GENERAL; CREATE OR REPLACE TABLE MAPLEMONK.amazon_fact_items_TEMP_Category AS SELECT fi.* ,p.name AS product_name_final ,COALESCE(UPPER(cast(p.CATEGORY as string)), UPPER(cast(fi.category as string))) AS product_category ,UPPER(cast(p.sub_category as string)) AS product_sub_category ,Upper(p.collection) Collection ,upper(p.print) PRINT ,upper(category_code) category_code ,upper(P.product_type) PRODUCT_TYPE ,p.BAU_OFFLINE ,p.BAU_ONLINE ,p.TAX_RATE FINAL_TAX_RATE ,p.commonsku ,AmazonOrdersBuyer.Buyer_email AS Email ,AmazonOrdersBuyer.Buyer_name AS Name ,AmazonOrdersBuyer.Recipient_Name FROM MAPLEMONK.zouk_amazon_fact_items fi left join (select * from (select marketplace_sku skucode, name, category, sub_category, category_code, collection, print, PRODUCT_TYPE, commonsku, BAU_OFFLINE, BAU_ONLINE, TAX_RATE , row_number()over (partition by marketplace_sku order by 1) rw from zouk-wh.maplemonk.final_sku_master where lower(marketplace) like \'%amazon%\') where rw = 1 ) p on lower(fi.sku) = lower(p.skucode) LEFT JOIN ( SELECT order_id, purchase_date AS Purchase_date, payments_date AS Payments_date, buyer_email AS Buyer_email, buyer_name AS Buyer_name, recipient_name AS Recipient_Name FROM MAPLEMONK.amazon_orders_fact_items ) AmazonOrdersBuyer ON fi.order_id = AmazonOrdersBuyer.order_id; CREATE OR REPLACE TABLE MAPLEMONK.zouk_AMAZON_FACT_ITEMS AS SELECT * FROM MAPLEMONK.amazon_fact_items_TEMP_Category;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from maplemonk.INFORMATION_SCHEMA.TABLES
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            