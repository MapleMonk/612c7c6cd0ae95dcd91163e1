{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table snitch_db.maplemonk.affiliate_snitch as WITH fact_revenue AS ( SELECT discount_code, order_id, order_name, final_utm_source, customer_flag, line_item_id, phone, email, final_utm_medium, SUM(gross_sales) AS total_sales, SUM(discount) AS total_discount FROM SNITCH_DB.maplemonk.fact_items_snitch GROUP BY 1, 2, 3, 4, 5, 6,7,8,9 ), affiliates AS ( SELECT source, upper(partner) as partner, discount_code FROM snitch_db.maplemonk.marketing_affiliates ), fact_returns AS ( SELECT order_date, order_id, saleorderitemcode, SUM(CASE WHEN return_quantity <> 0 AND cancelled_quantity = 0 THEN selling_price END) AS return_sales, SUM(CASE WHEN cancelled_quantity <> 0 THEN selling_price END) AS cancelled_sales FROM SNITCH_DB.MAPLEMONK.unicommerce_fact_items_snitch GROUP BY 1, 2, 3 ), fact_monthly_target AS ( SELECT date, partner as src, REPLACE(\"Monthly Cost\", \',\', \'\')::float AS monthly_cost, REPLACE(monthly_target, \',\', \'\')::float AS monthly_target FROM snitch_db.maplemonk.affiliates_target ), fact_merge AS ( SELECT DISTINCT ma.source, fis.final_utm_source, 1 AS utm_flag, ma.partner FROM snitch_db.maplemonk.marketing_affiliates ma LEFT JOIN snitch_db.maplemonk.fact_items_snitch fis ON LOWER(ma.source) = LOWER(fis.final_utm_source) GROUP BY 1,2,3,4 ), discount_code_merge AS ( SELECT frt.order_date, af.discount_code, fr.order_name, af.partner, af.source, fr.phone, fr.email, fr.customer_flag, fr.final_utm_medium, CASE WHEN lower(partner) = \'grabon\' then 80 WHEN lower(partner) = \'admitad\'and lower(customer_flag) = \'new\' then 0.05*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'admitad\'and lower(customer_flag) = \'repeated\' then 0.05*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'kickcash\' then 0.05*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'unstop\' then 0.08*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'cred\' then 200 WHEN lower(partner) = \'wishlink\'and lower(customer_flag) = \'new\' then 0.18*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'wishlink\'and lower(customer_flag) = \'repeated\' then 0.1*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'unstop\' then 0.08*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'icubewire\' then 0.07*COALESCE(SUM(fr.total_sales), 0)::float end cost, COALESCE(SUM(fr.total_sales), 0) AS sales, COALESCE(SUM(fr.total_discount), 0) AS discount, COALESCE(SUM(frt.return_sales), 0) AS returns, COALESCE(SUM(frt.cancelled_sales), 0) AS cancelled, NULL AS utm_flag, \'discount_code\' AS source_type FROM affiliates af LEFT JOIN fact_revenue fr ON LOWER(af.discount_code) = LOWER(fr.discount_code) LEFT JOIN fact_returns frt ON fr.order_id = frt.order_id AND fr.line_item_id = SPLIT_PART(frt.saleorderitemcode, \'-\', 1) WHERE af.discount_code IS NOT NULL GROUP BY 1, 2, 3, 4, 5,6,7,8,9 ), utm_source_merge AS ( SELECT frt.order_date, fr.discount_code, fr.order_name, fr.final_utm_source as source, upper(fr.final_utm_source) as partner, fr.phone, fr.email, fr.customer_flag, fr.final_utm_medium, CASE WHEN lower(fr.final_utm_source) = \'grabon\' then 80 WHEN lower(fr.final_utm_source) = \'admitad\'and lower(customer_flag) = \'new\' then 0.05*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(fr.final_utm_source) = \'admitad\'and lower(customer_flag) = \'repeated\' then 0.05*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(fr.final_utm_source) = \'kickcash\' then 0.05*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(fr.final_utm_source) = \'unstop\' then 0.08*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(fr.final_utm_source) = \'cred\' then 200 WHEN lower(fr.final_utm_source) = \'wishlink\'and lower(customer_flag) = \'new\' then 0.18*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(fr.final_utm_source) = \'wishlink\'and lower(customer_flag) = \'repeated\' then 0.1*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(fr.final_utm_source) = \'unstop\' then 0.08*COALESCE(SUM(fr.total_sales), 0)::float WHEN lower(partner) = \'icubewire\' then 0.07*COALESCE(SUM(fr.total_sales), 0)::float end cost, COALESCE(SUM(fr.total_sales), 0) AS sales, COALESCE(SUM(fr.total_discount), 0) AS discount, COALESCE(SUM(frt.return_sales), 0) AS returns, COALESCE(SUM(frt.cancelled_sales), 0) AS cancelled, fm.utm_flag, \'utm_source\' AS source_type FROM fact_revenue fr LEFT JOIN fact_merge fm ON LOWER(fm.source) = lower(fr.final_utm_source) LEFT JOIN fact_returns frt ON fr.order_id = frt.order_id AND fr.line_item_id = SPLIT_PART(frt.saleorderitemcode, \'-\', 1) WHERE fm.utm_flag = 1 GROUP BY 1, 2, 3, 4, 5,6,7,8, 9,fm.utm_flag ), union_merge AS ( SELECT * FROM discount_code_merge UNION SELECT * FROM utm_source_merge ) SELECT * FROM union_merge um LEFT JOIN fact_monthly_target fmt on date_trunc(\'month\',um.order_date::Date) = date_trunc(\'month\',fmt.date::date) and lower(um.partner) = lower(fmt.src)",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        