{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table sleepycat_db.maplemonk.sleepycat_db_traffic_funnel_fact_items as with sales as ( select order_date:: date as order_date, case when upper(source) = \'WOOCOMMERCE\' then \'DIRECT\' else source end as source, case when upper(channel) = \'WOOCOMMERCE\' then \'DIRECT\' else channel end as channel, count(distinct order_id) as total_orders, sum(quantity) as total_quantity, sum(selling_price) as total_selling_price from sleepycat_db.maplemonk.sleepycat_db_sales_consolidated where lower(marketplace) like \'woocommerce\' and order_date::date = \'2023-12-18\' group by 1,2,3 order by 1 desc ), pf_map as ( with sessions_users as ( select TO_DATE(date, \'YYYYMMDD\')date, sessions, totalusers, SCREENPAGEVIEWS, ENGAGEDSESSIONS, SESSIONSOURCEMEDIUM, replace(SPLIT(SESSIONSOURCEMEDIUM, \' / \')[0],\'\"\',\'\') AS source, replace(SPLIT(SESSIONSOURCEMEDIUM, \' / \')[1],\'\"\',\'\') AS medium from sleepycat_db.maplemonk.ga4_sc_ga4_sessions_users_by_date ), GA_CHANNEL_MAPPING as ( select * from ( select *, row_number() over (partition by lower(concat(lower(ifnull(ga_source,\'\')),lower(ifnull(ga_medium,\'\')))) order by 1) rw from SLEEPYCAT_DB.MAPLEMONK.GA_CHANNEL_MAPPING ) where rw=1 and lower(concat(ifnull(ga_source,\'\'),ifnull(ga_medium,\'\'))) is not null ), joined_table as ( select pf.date, pf.sessions, pf.totalusers, pf.SCREENPAGEVIEWS, pf.ENGAGEDSESSIONS, pf.source, pf.medium, SESSIONSOURCEMEDIUM, GA_MAPPING.FINAL_SOURCE as ga_mapped_source, ga_mapping.FINAL_channel as ga_mapped_channel from sessions_users as pf left join GA_CHANNEL_MAPPING as ga_mapping on lower(concat(ifnull(pf.SOURCE,\'\'),ifnull(pf.MEDIUM,\'\'))) = lower(concat(ifnull(GA_MAPPING.ga_source,\'\'),ifnull(GA_MAPPING.ga_medium,\'\'))) ) select date, upper(ga_mapped_source) as ga_mapped_source, upper(ga_mapped_channel) as ga_mapped_channel, sum(totalusers) as totalusers, sum(SCREENPAGEVIEWS) as SCREENPAGEVIEWS, sum(sessions) as sessions, sum(ENGAGEDSESSIONS)as ENGAGEDSESSIONS from joined_table group by 1,2,3 ), pf_map1 as ( with sessions_users as ( select TO_DATE(date, \'YYYYMMDD\')date, ITEMSCHECKEDOUT, ITEMSADDEDTOCART, SESSIONSOURCEMEDIUM, replace(SPLIT(SESSIONSOURCEMEDIUM, \' / \')[0],\'\"\',\'\') AS source, replace(SPLIT(SESSIONSOURCEMEDIUM, \' / \')[1],\'\"\',\'\') AS medium from sleepycat_db.maplemonk.ga4_sc_ga4_products_funnel_metrics ), GA_CHANNEL_MAPPING as( select * from ( select *, row_number() over (partition by lower(concat(lower(ifnull(ga_source,\'\')),lower(ifnull(ga_medium,\'\')))) order by 1) rw from SLEEPYCAT_DB.MAPLEMONK.GA_CHANNEL_MAPPING ) where rw=1 and lower(concat(ifnull(ga_source,\'\'),ifnull(ga_medium,\'\'))) is not null ), joined_table as( select pf.date, pf.ITEMSCHECKEDOUT, pf.ITEMSADDEDTOCART, pf.source, pf.medium, SESSIONSOURCEMEDIUM, GA_MAPPING.FINAL_SOURCE as ga_mapped_source, ga_mapping.FINAL_channel as ga_mapped_channel from sessions_users as pf left join GA_CHANNEL_MAPPING as ga_mapping on lower(concat(ifnull(pf.SOURCE,\'\'),ifnull(pf.MEDIUM,\'\'))) = lower(concat(ifnull(GA_MAPPING.ga_source,\'\'),ifnull(GA_MAPPING.ga_medium,\'\'))) ) select date, upper(ga_mapped_source) as ga_mapped_source , upper(ga_mapped_channel) as ga_mapped_channel, sum(ITEMSADDEDTOCART) as ITEMSADDEDTOCART, sum(ITEMSCHECKEDOUT) as ITEMSCHECKEDOUT from joined_table group by 1,2,3 ) select coalesce(s_c.order_date,pf_map.date,pf_map1.date) as order_date, coalesce(s_c.source,pf_map.ga_mapped_source,pf_map1.ga_mapped_source) as source, coalesce(s_c.channel,pf_map.ga_mapped_channel,pf_map1.ga_mapped_channel) as channel, s_c.total_orders, s_c.total_quantity, s_c.total_selling_price, pf_map.totalusers, pf_map.SCREENPAGEVIEWS, pf_map.sessions, pf_map.ENGAGEDSESSIONS, pf_map1.ITEMSADDEDTOCART, pf_map1.ITEMSCHECKEDOUT FROM sales s_c full outer JOIN pf_map on s_c.order_date = pf_map.date and lower( s_c.source ) = lower(pf_map.ga_mapped_source) and lower(s_c.channel) = lower(pf_map.ga_mapped_channel) full outer join pf_map1 on pf_map1.date = coalesce(s_c.order_date,pf_map.date) and lower(pf_map1.ga_mapped_source) = lower(coalesce(s_c.source,pf_map.ga_mapped_source)) and lower(pf_map1.ga_mapped_channel) = lower(coalesce(s_c.channel,pf_map.ga_mapped_channel))",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from SLEEPYCAT_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        