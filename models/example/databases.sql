{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table snitch_db.maplemonk.discoverability as with source_wise_clicks AS ( SELECT CAST(a.itemid AS VARCHAR) AS itemid, TO_DATE(a.date, \'YYYYMMDD\')::date AS formatted_date, \'web\' AS type, SUM(a.itemsviewed) AS clicks, a.sessionmedium, a.sessionsource, a.sessioncampaignname, COALESCE( CASE WHEN LOWER(a.sessionmedium) = \'affiliate\' THEN \'Affiliate\' WHEN LOWER(a.sessionsource) = \'google\' AND LOWER(a.sessionmedium) = \'cpc\' THEN \'Google_Ads\' WHEN LOWER(a.sessionsource) = \'organic\' OR LOWER(a.sessionmedium) = \'organic\' OR LOWER(a.sessionsource) = \'(not set)\' OR LOWER(a.sessionmedium) = \'referral\' THEN \'Direct\' WHEN LOWER(a.sessionsource) = \'facebook\' OR LOWER(a.sessionsource) = \'facebookads\' AND LOWER(a.sessionmedium) = \'paid\' THEN \'Facebook_Ads\' WHEN a.sessionsource = \'(direct)\' THEN \'Direct\' WHEN a.sessionsource = \'Facebookads\' THEN \'Facebook_Ads\' ELSE b.channel END, b.channel ) AS channel FROM snitch_db.maplemonk.web_sku_group_clicks_source_medium a LEFT JOIN snitch_db.maplemonk.GA_CHANNEL_MAPPING b ON LOWER(a.sessionsource) = LOWER(b.source) AND LOWER(a.sessionmedium) = LOWER(b.medium) AND LOWER(a.sessioncampaignname) = LOWER(b.sessioncampaignname) GROUP BY CAST(a.itemid AS VARCHAR), type, a.sessionmedium, a.sessionsource, a.sessioncampaignname, b.channel, a.date UNION SELECT CAST(a.itemid AS VARCHAR) AS itemid, TO_DATE(a.date, \'YYYYMMDD\')::date AS formatted_date, \'app\' AS type, SUM(a.itemsviewed) AS clicks, a.sessionmedium, a.sessionsource, a.sessioncampaignname, COALESCE( CASE WHEN LOWER(a.sessionmedium) = \'(not set)\' AND LOWER(a.sessionsource) = \'(not set)\' AND LOWER(a.sessioncampaignname) = \'(not set)\' THEN \'Direct\' WHEN LOWER(a.sessionmedium) = \'push\' THEN \'Push\' WHEN LOWER(a.sessionsource) = \'adcanapous\' OR LOWER(a.sessionmedium) = \'affiliate\' THEN \'Affiliate\' WHEN LOWER(a.sessionsource) = \'facebookads\' THEN \'Facebook_Ads\' WHEN LOWER(a.sessionsource) = \'facebook\' THEN \'Facebook_Ads\' WHEN LOWER(a.sessionmedium) = \'email\' THEN \'Email\' WHEN LOWER(a.sessionmedium) = \'push\' THEN \'Push\' WHEN LOWER(a.sessionmedium) = \'cpc\' AND LOWER(a.sessionsource) = \'google\' THEN \'Google_Ads\' WHEN LOWER(a.sessionmedium) = \'whatsapp\' THEN \'WhatsApp\' WHEN LOWER(a.sessionsource) = \'sms\' OR LOWER(a.sessionmedium) = \'sms\' THEN \'SMS\' WHEN LOWER(a.sessionmedium) = \'organic\' THEN \'Direct\' ELSE b.channel END, b.channel ) AS channel FROM snitch_db.maplemonk.app_sku_clicks_source_medium a LEFT JOIN snitch_db.maplemonk.GA_CHANNEL_MAPPING b ON LOWER(a.sessionsource) = LOWER(b.source) AND LOWER(a.sessionmedium) = LOWER(b.medium) AND LOWER(a.sessioncampaignname) = LOWER(b.sessioncampaignname) GROUP BY CAST(a.itemid AS VARCHAR), type, a.sessionmedium, a.sessionsource, a.sessioncampaignname, b.channel, a.date ), main_data as ( select type,formatted_date, COALESCE(channel, \'Others\') AS channel, CASE WHEN channel = \'Direct\' OR channel = \'organic\' THEN \'Organic\' ELSE \'Paid\' END AS source, sum(clicks) as clicks from source_wise_clicks group by 1,2,3,4 ), total_clicks as ( select formatted_date, type, sum(clicks) as total_clicks from main_data where source = \'Paid\' group by 1,2 ) select a.type,a.formatted_date, a.channel, a.source, a.clicks, (a.clicks/b.total_clicks)*100 as clicks_percentage from main_data a left join total_clicks b on a.type = b.type and a.formatted_date = b.formatted_date",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from snitch_db.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        