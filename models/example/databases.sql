{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "Create or replace table vahdam_db.maplemonk.AVP_amaozn_ads_SPA_intermediate as select primary_key ,REPORTDATE ,RECORDTYPE ,PROFILEID ,campaignId ,campaignName ,adGroupId ,adGroupName ,campaignStatus ,keywordId ,keywordText ,adId ,matchType ,targetId ,targetingType ,targetingExpression ,targetingText ,currency ,asin ,otherAsin ,sku ,impressions ,clicks ,cost ,attributedSales14d ,attributedConversions14d ,attributedSales7d ,attributedConversions7d ,attributedConversions14dSameSKU ,attributedSales14dSameSKU ,attributedSales14dOtherSKU from ( select *,row_number()over(partition by primary_key order by _AIRBYTE_EMITTED_AT desc) as rw2 from (select array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int ,metric:campaignStatus::varchar,metric:keywordId::int,metric:matchType::varchar ,metric:targetId::int,metric:targetingType::varchar,metric:asin,metric:otherAsin::varchar,metric:sku::varchar)),\'\') primary_key ,REPORTDATE ,RECORDTYPE ,PROFILEID ,metric:campaignId::int as campaignId ,metric:campaignName::varchar as campaignName ,metric:adGroupId::int adGroupId ,metric:adGroupName::varchar as adGroupName ,metric:campaignStatus::varchar campaignStatus ,metric:keywordId::int keywordId ,metric:keywordText::varchar keywordText ,metric:adId::int adId ,metric:matchType::varchar matchType ,metric:targetId::int targetId ,metric:targetingType::varchar targetingType ,metric:targetingExpression::varchar targetingExpression ,metric:targetingText::varchar targetingText ,metric:currency::varchar currency ,metric:asin::varchar asin ,metric:otherAsin::varchar otherAsin ,metric:sku::varchar sku ,metric:impressions::float impressions ,metric:clicks::float clicks ,metric:cost::float cost ,metric:attributedSales14d::float attributedSales14d ,metric:attributedConversions14d::float attributedConversions14d ,metric:attributedSales7d::float attributedSales7d ,metric:attributedConversions7d::float attributedConversions7d ,metric:attributedConversions14dSameSKU::float attributedConversions14dSameSKU ,metric:attributedSales14dSameSKU::float attributedSales14dSameSKU ,metric:attributedSales14dOtherSKU::float attributedSales14dOtherSKU ,metric:impressions::float +metric:clicks::float +metric:cost::float +metric:attributedSales14d::float +metric:attributedConversions14d::float+metric:attributedSales7d::float +metric:attributedConversions7d::float as tt ,_AIRBYTE_EMITTED_AT ,row_number()over(partition by array_to_string(array_compact(array_construct( REPORTDATE,RECORDTYPE,PROFILEID,metric:campaignId::int,metric:adGroupId::int ,metric:campaignStatus::varchar,metric:keywordId::int,metric:matchType::varchar ,metric:targetId::int,metric:targetingType::varchar,metric:asin,metric:otherAsin::varchar,metric:sku::varchar)),\'\') order by metric:impressions::float +metric:clicks::float +metric:cost::float +metric:attributedSales14d::float +metric:attributedConversions14d::float+metric:attributedSales7d::float +metric:attributedConversions7d::float desc) as rw from VAHDAM_DB.MAPLEMONK.AA_NA_SPONSORED_PRODUCTS_REPORT_STREAM where PROFILEID = \'1466997913324443\' and RECORDTYPE = \'productAds\' ) a where rw =1 or tt>0 ) b where rw2 =1; create or replace table vahdam_db.maplemonk.amazon1pads_na_marketing as With Orders as ( select startdate::date as Date ,ASIN as ASIN ,sum(SHIPPEDCOGS:amount::float) as SHIPPEDCOGS_Amount ,sum(ORDEREDREVENUE:amount::float) as ORDEREDREVENUE_Amount ,sum(SHIPPEDREVENUE:amount::float) as SHIPPEDREVENUE_Amount ,sum(orderedunits) as Ordered_units ,sum(shippedunits) as Shipped_units from vahdam_db.maplemonk.avp_man_us_get_vendor_sales_report group by 1,2 ), Primaryorders as ( select startdate::date as Date ,ASIN as ASIN ,sum(SHIPPEDCOGS:amount::float) as Primary_SHIPPEDCOGS_Amount ,sum(ORDEREDREVENUE:amount::float) as Primary_ORDEREDREVENUE_Amount ,sum(SHIPPEDREVENUE:amount::float) as Primary_SHIPPEDREVENUE_Amount ,sum(orderedunits) as Primary_Ordered_units ,sum(shippedunits) as Primary_Shipped_units from vahdam_db.maplemonk.avp_us_get_vendor_sales_report group by 1,2 ), Sessions as ( select startdate::date as Date, asin as ASIN, sum(glanceviews) as Sessions from vahdam_db.maplemonk.avp_man_us_get_vendor_traffic_report group by 1,2 ), Amazon as ( SELECT TO_DATE(sp.REPORTDATE,\'YYYYMMDD\') - 1 AS Date ,sp.ASIN as ASIN ,sum(sp.impressions) as Impressions ,sum(sp.clicks) as Clicks ,sum(sp.cost) as Spend ,sum(sp.attributedSales7d) as Sales ,sum(sp.attributedConversions7d) as Conversions ,sum(sp.attributedConversions14dSameSKU) as ConversionsSameSKU ,sum(sp.attributedSales14dSameSKU) as SalesSameSKU ,sum(sp.attributedSales14dOtherSKU) as OtherSKUSales ,(sum(sp.attributedConversions14d) - sum(sp.attributedConversions14dSameSKU)) as ConversionsOtherSKU FROM vahdam_db.maplemonk.AVP_amaozn_ads_SPA_intermediate sp WHERE sp.RECORDTYPE = \'productAds\' and sp.PROFILEID = \'1466997913324443\' and not (ifnull(cost,0) = 0 and ifnull(Impressions,0) = 0 and ifnull(Clicks,0) = 0 and ifnull(attributedSales7d,0) = 0 and ifnull(attributedConversions7d,0) = 0 and ifnull(attributedConversions14dSameSKU,0) = 0 and ifnull(attributedSales14dSameSKU,0) = 0 and ifnull(attributedSales14dOtherSKU,0) = 0 and ifnull(attributedConversions14d,0) = 0) GROUP BY sp.REPORTDATE, sp.ASIN ), Mapping as ( select * from (select \"Amazon US 1P\" ,weight ,brand ,\"Mother SKU\" ,\"Common Name\" ,category ,\"SUB CATEGORY\" ,\"LOOSE/TEA BAG/ POWDER\" ,\"Common SKU Description\" ,\"COMMON SKU ID\" ,row_number() over (partition by \"Amazon US 1P\" order by \"Amazon US 1P\") as rw from vahdam_db.maplemonk.sku_mapping_raw_data) where rw = 1 or rw is null ) select coalesce(O.Date, S.Date, A.Date,P.Date) as Date ,coalesce(O.ASIN, S.ASIN, A.ASIN,P.ASIN,M.\"Amazon US 1P\") as ASIN ,O.SHIPPEDCOGS_Amount ,O.ORDEREDREVENUE_Amount ,O.SHIPPEDREVENUE_Amount ,O.Ordered_units ,O.Shipped_units ,P.Primary_SHIPPEDCOGS_Amount ,P.Primary_ORDEREDREVENUE_Amount ,P.Primary_SHIPPEDREVENUE_Amount ,P.Primary_Ordered_units ,P.Primary_Shipped_units ,S.Sessions ,A.Impressions ,A.Clicks ,A.Spend ,A.Sales ,A.Conversions ,A.ConversionsSameSKU ,A.SalesSameSKU ,A.ConversionsOtherSKU ,M.weight ,M.brand ,M.\"Mother SKU\" ,M.\"Common Name\" ,M.category ,M.\"SUB CATEGORY\" ,M.\"LOOSE/TEA BAG/ POWDER\" ,M.\"Common SKU Description\" ,M.\"COMMON SKU ID\" from Orders O full outer join SESSIONS S on O.Date=S.Date and O.ASIN=S.ASIN full outer join AMAZON A on O.Date=A.Date and O.ASIN=A.ASIN full outer join primaryorders P on O.Date=P.Date and O.ASIN=P.ASIN left join MAPPING M on coalesce(O.ASIN, S.ASIN, A.ASIN,P.ASIN) = M.\"Amazon US 1P\" order by 1 desc;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from VAHDAM_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        