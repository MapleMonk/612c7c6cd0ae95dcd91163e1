{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "CREATE OR REPLACE TABLE ugaoo_db.maplemonk.Marketplace_REPORT_Ugaoo AS WITH sales AS (SELECT Marketplace , order_date::date AS ORDER_DATE , COUNT(DISTINCT order_id) AS Total_Orders , (count(DISTINCT order_id) - COUNT(DISTINCT CASE WHEN lower(order_status) in (\'cancelled\') AND return_flag =0 THEN order_id END)) AS Gross_Orders, COUNT(DISTINCT CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN order_id END) AS Net_Orders, count(DISTINCT CASE WHEN lower(order_status) in (\'cancelled\') AND return_flag =0 THEN order_id END) AS Cancelled_Orders , (sum(ifnull(selling_price, 0))+sum(ifnull(shipping_price, 0))+sum(ifnull(discount, 0))+sum(ifnull(tax, 0))) AS Total_Sales , sum(ifnull(selling_price, 0))+sum(ifnull(shipping_price, 0))+sum(ifnull(discount, 0))+sum(ifnull(tax, 0)) - sum(case when lower(order_status) in (\'cancelled\') and return_flag = 0 then ifnull(selling_price, 0)+ifnull(shipping_price, 0)+ifnull(discount, 0)+ifnull(tax, 0) end) as gross_sales, --(sum(ifnull(selling_price, 0))+sum(ifnull(shipping_price, 0))+sum(ifnull(discount, 0)+sum(ifnull(tax, 0))) - (ifnull(sum(CASE WHEN lower(order_status) in (\'cancelled\') AND return_flag = 0 THEN ifnull(selling_price, 0)+ifnull(shipping_price, 0)+ifnull(discount, 0)+(ifnull(tax, 0)) END),0)) AS Gross_Sales , (SUM(CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN ifnull(selling_price, 0)+ifnull(shipping_price, 0) END)) AS Net_Sales, (ifnull(sum(CASE WHEN lower(order_status) in (\'cancelled\') AND return_flag =0 THEN ifnull(selling_price, 0)+ifnull(shipping_price, 0)+ifnull(discount, 0) END), 0)) AS Cancelled_Value , (ifnull(sum(CASE WHEN return_flag =1 THEN ifnull(selling_price, 0)+ifnull(shipping_price, 0)+ifnull(discount, 0) END), 0)) AS Return_Value , ifnull(SUM(CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN discount END), 0) AS Discount_On_Net_Sales , CASE WHEN ifnull(SUM(CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN ifnull(selling_price, 0)+ifnull(shipping_price, 0)+ifnull(discount, 0) END), 0)=0 THEN 0 ELSE (ifnull(SUM(CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN discount END), 0)/ifnull(SUM(CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN ifnull(selling_price, 0)+ifnull(shipping_price,0)+ifnull(discount, 0) END), 0)) END AS Discount_Percent_On_Net_Sales, (ifnull(sum(CASE WHEN return_flag =0 THEN discount END), 0) - ifnull(sum(CASE WHEN lower(order_status) in (\'cancelled\') AND return_flag = 0 THEN discount END), 0)) AS Discount_on_Gross_Sales , CASE WHEN COUNT(DISTINCT CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN order_id END)=0 THEN 0 ELSE (ifnull(SUM(CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN ifnull(selling_price, 0)+ifnull(shipping_price, 0) END), 0)/COUNT(DISTINCT CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN order_id END)) END AS Net_AOV , count(DISTINCT CASE WHEN lower(new_customer_flag) = \'new\' AND lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN order_id END) AS Net_Orders_New , ifnull(SUM(CASE WHEN lower(new_customer_flag) = \'new\' AND lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN discount END), 0) AS Discount_On_Net_Sales_New , count(DISTINCT CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 AND lower(new_customer_flag) = \'new\' THEN customer_id END) AS New_Customers , count(DISTINCT CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 AND lower(new_customer_flag) = \'Repeat\' THEN customer_id END) AS Repeat_Customers , count(DISTINCT CASE WHEN lower(order_status) not in (\'cancelled\') AND return_flag =0 THEN customer_id END) AS Total_Customers FROM ugaoo_db.maplemonk.unicommerce_fact_items GROUP BY 1,2), marketing AS (SELECT date,\'Website\' AS Marketplace, sum(spend) AS Spend, avg(conversions) orders, avg(conversion_value) Sales FROM Ugaoo_db.MAPLEMONK.MARKETING_CONSOLIDATED a --LEFT JOIN -- (SELECT order_timestamp::date AS order_date, -- count(DISTINCT order_id) AS orders, -- sum(total_sales) AS Sales -- FROM XYXX_db.maplemonk.FACT_ITEMS_XYXX -- WHERE shop_name like \'%hop%\' -- AND final_utm_channel not in (\'Others\', -- \'Direct\') -- AND order_status = \'Shopify_Processed\' -- GROUP BY 1) b ON a.date = b.order_date GROUP BY 1,2), Amazon_ads AS (SELECT date,\'Amazon\' AS marketplace, sum(spend) AS spend, sum(sales) AS amazon_ads_sales, sum(conversions) AS amazon_ads_orders FROM ugaoo_db.maplemonk.amazonads_in_marketing_ugaoo GROUP BY 1, 2) SELECT coalesce(s.marketplace, m.marketplace, a.marketplace) AS marketplace, coalesce(s.order_date, m.date, a.date) AS order_date, Total_Orders, Gross_Orders, Net_Orders, Cancelled_Orders, Total_Sales, Gross_Sales, Net_Sales, Cancelled_Value, Return_Value, Discount_On_Net_Sales, Discount_Percent_On_Net_Sales, Discount_on_Gross_Sales, Net_AOV, Net_Orders_New, Discount_On_Net_Sales_New, New_Customers, Repeat_Customers, Total_Customers, coalesce(m.spend, a.spend) AS Spend, coalesce(amazon_ads_sales, m.sales) AS Ad_Sales, coalesce(amazon_ads_orders, m.orders) AS Ad_Orders FROM sales s FULL JOIN marketing m ON s.order_date = m.date AND s.marketplace in (\'Website\') FULL JOIN amazon_ads a ON a.date = coalesce(s.order_date, m.date) AND s.marketplace in (\'Amazon\') ORDER BY s.order_date DESC;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from UGAOO_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        