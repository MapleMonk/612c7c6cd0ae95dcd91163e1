{{ config(
                        materialized='table',
                            post_hook={
                                "sql": "create or replace table GYNOVEDA_DB.maplemonk.spends as select m.date, ifnull(m.spend,0) GF_spend, ifnull(a.spend,0) A_spend,ifnull(m.spend,0)+ifnull(a.spend,0) as spend from (select DATE,sum(ifnull(spend,0)) as spend from Gynoveda_DB.MAPLEMONK.MARKETING_CONSOLIDATED_GYNOVEDA group by 1)m left join (select date, sum(ifnull(spend,0)) as spend from GYNOVEDA_DB.MAPLEMONK.AMAZONADS_IN_MARKETING_GYNOVEDA group by 1)a on a.date = m.date ; create or replace table GYNOVEDA_DB.maplemonk.website_gross as select order_timestamp::date as order_date ,sum(case when shop_name not like \'%mazon%\' then total_sales end) as website_gross_sales from FACT_ITEMS_gynoveda group by 1 ; create or replace table GYNOVEDA_DB.maplemonk.website_net as select shipping_last_update_date::date date, sum(selling_price)/1.12 website_net_sales from GYNOVEDA_DB.maplemonk.fact_items_easyecom_in_gynoveda where lower(shipping_Status) = \'delivered\' and lower(marketplace) = \'shopify\' group by shipping_last_update_date::date, marketplace ; create or replace table GYNOVEDA_DB.maplemonk.dates as select distinct order_date from ( select order_date from website_gross union all select Date from website_net union all select DATE from spends ); create or replace table GYNOVEDA_DB.maplemonk.temp_sales as select * ,sum(website_gross_sales) over(partition by year(order_date),month(order_date)) as website_gross_sales_mtd ,sum(website_net_sales) over(partition by year(order_date),month(order_date)) as website_net_sales_mtd ,sum(spend) over(partition by year(order_date),month(order_date)) as spend_mtd ,sum(gf_spend) over(partition by year(order_date),month(order_date)) as GF_spend_mtd ,sum(a_spend) over(partition by year(order_date),month(order_date)) as a_spend_mtd from (select d.order_date,website_gross_sales,website_net_sales,gf_spend, a_spend,spend from dates d left join website_gross w on d.order_date = w.order_date left join spends s on d.order_date = s.date left join website_net wn on d.order_date = wn.date ) ; create or replace table GYNOVEDA_DB.maplemonk.month_sales as select year(order_date) as year,month(order_date) as month, min(order_date)as prev_month_start_date ,sum(website_gross_sales) as website_gross_sales_prev_month ,sum(website_net_sales) as website_net_sales_prev_month ,sum(spend) as spend_prev_month ,sum(gf_spend) as gf_spend_prev_month ,sum(a_spend) as a_spend_prev_month from temp_sales group by 1,2 ; create or replace table GYNOVEDA_DB.maplemonk.gynopulse_intermediate as select ts.*, ms.* from GYNOVEDA_DB.maplemonk.temp_sales ts join GYNOVEDA_DB.maplemonk.month_sales ms on date_trunc(\'month\',ts.order_date) = add_months(date_trunc(\'month\',ms.prev_month_start_date),1) ; create or replace table GYNOVEDA_DB.maplemonk.gynopulse as with cte1 as ( select a.date , sum(b.orders) orders_11_30 , sum(b.rto_orders) rto_orders_11_30 , case when orders_11_30 = 0 or orders_11_30 is null then 0 else (rto_orders_11_30::float)/( orders_11_30::float) end as percentage_rto_11_30 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) like \'%rto%\' then order_id end) rto_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-11 and b.date>=a.date-30 group by a.date ) , cte2 as ( select a.date , sum(b.orders) orders_31_60 , sum(b.rto_orders) rto_orders_31_60 ,case when orders_31_60 = 0 or orders_31_60 is null then 0 else (rto_orders_31_60::float)/( orders_31_60::float) end as percentage_rto_31_60 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) like \'%rto%\' then order_id end) rto_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-31 and b.date>=a.date-60 group by a.date ) , cte3 as ( select a.date , sum(b.orders) orders_11_30 , sum(b.rto_orders) rto_delivered_orders_11_30 ,case when orders_11_30 = 0 or orders_11_30 is null then 0 else (rto_delivered_orders_11_30::float)/( orders_11_30::float) end as percentage_rto_delivered_11_30 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) = \'rto delivered\' then order_id end) rto_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-11 and b.date>=a.date-30 group by a.date ) ,cte4 as ( select a.date , sum(b.orders) orders_31_60 , sum(b.rto_orders) rto_delivered_orders_31_60 ,case when orders_31_60 = 0 or orders_31_60 is null then 0 else (rto_delivered_orders_31_60::float)/( orders_31_60::float) end as percentage_rto_delivered_31_60 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) = \'rto delivered\' then order_id end) rto_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-31 and b.date>=a.date-60 group by a.date ) , cte8 as ( select a.date , sum(b.orders) orders_11_30 , sum(b.rto_orders) rto_cod_orders_11_30 ,case when orders_11_30 = 0 or orders_11_30 is null then 0 else (rto_cod_orders_11_30::float)/( orders_11_30::float) end as percentage_rto_cod_11_30 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) like \'%rto%\' and lower(payment_mode) = \'cod\' then order_id end) rto_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-11 and b.date>=a.date-30 group by a.date ) , cte9 as ( select a.date , sum(b.orders) orders_31_60 , sum(b.rto_orders) rto_cod_orders_31_60 , case when orders_31_60 = 0 or orders_31_60 is null then 0 else (rto_cod_orders_31_60::float)/( orders_31_60::float) end as percentage_rto_cod_31_60 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) like \'%rto%\' and lower(payment_mode)= \'cod\' then order_id end) rto_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-31 and b.date>=a.date-60 group by a.date ) , cte10 as ( select a.date , sum(b.orders) orders_11_30 , sum(b.rto_inward_orders) rto_inward_orders_11_30 , case when orders_11_30 = 0 or orders_11_30 is null then 0 else (rto_inward_orders_11_30::float)/( orders_11_30::float) end as percentage_rto_inward_orders_11_30 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct case when lower(order_status) = \'returned\' then order_id end ) orders , count(distinct case when lower(order_status) = \'returned\' and lower(shipping_status) like \'rto delivered\' then order_id end) rto_inward_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-11 and b.date>=a.date-30 group by a.date ) , cte11 as ( select a.date , sum(b.orders) orders_31_60 , sum(b.rto_inward_orders) rto_inward_orders_31_60 , case when orders_31_60 = 0 or orders_31_60 is null then 0 else (rto_inward_orders_31_60::float)/( orders_31_60::float) end as percentage_rto_inward_orders_31_60 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct case when lower(order_status) = \'returned\' then order_id end ) orders , count(distinct case when lower(order_status) = \'returned\' and lower(shipping_status) like \'rto delivered\' then order_id end) rto_inward_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-31 and b.date>=a.date-60 group by a.date ) , cte5 as ( select a.date , sum(b.delivered_orders_0_5) delivered_orders_in5 , sum(b.delivered_orders) delivered_orders_0_10 , case when delivered_orders_0_10 = 0 or delivered_orders_0_10 is null then 0 else (delivered_orders_in5::float)/(delivered_orders_0_10::float) end as Percentage_delivered_in5days_0_10 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct case when lower(shipping_status)= \'delivered\' and datediff(\'day\',order_date::date,last_update_date::date) <=5 then order_id end ) as delivered_orders_0_5 , count(distinct case when lower(shipping_status) = \'delivered\' then order_id end) delivered_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date and b.date>=a.date-10 group by a.date ) ,cte6 as ( select a.date , sum(b.delivered_orders_0_5) delivered_orders_in5 , sum(b.delivered_orders) delivered_orders_11_30 , case when delivered_orders_11_30 = 0 or delivered_orders_11_30 is null then 0 else (delivered_orders_in5::float)/(delivered_orders_11_30::float) end as Percentage_delivered_in5days_11_30 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct case when lower(shipping_status)= \'delivered\' and datediff(\'day\',order_date,last_update_date) <=5 then order_id end ) as delivered_orders_0_5 , count(distinct case when lower(shipping_status) = \'delivered\' then order_id end) delivered_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-11 and b.date>=a.date-30 group by a.date ) , cte7 as( select a.date , sum(b.Unfulfilled_orders) Unfulfilled_11_30 , sum(b.orders) orders_11_30 , case when orders_11_30 = 0 or orders_11_30 is null then 0 else (Unfulfilled_11_30::float)/( orders_11_30::float) end as Unfulfilled_percentage_11_30 from ( select order_date::date date from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) a left join ( select order_date::date date , count(distinct order_id) orders , count(distinct case when lower(shipping_status) not in (\'cancelled\',\'delivered\',\'rto delivered\',\'reached at destination\',\'reached at origin\') and datediff(\'day\',order_date,case when last_update_date = \'\' then date(getdate()) else last_update_date end ) > 10 then order_id end ) as Unfulfilled_orders from gynoveda_db.maplemonk.fact_items_easyecom_in_gynoveda group by 1 ) b on b.date<=a.date-11 and b.date>=a.date-30 group by a.date ) select a.* , percentage_rto_11_30 , percentage_rto_31_60 , percentage_rto_delivered_11_30 , percentage_rto_delivered_31_60 , percentage_rto_cod_11_30 , percentage_rto_cod_31_60 , Percentage_delivered_in5days_0_10 , Percentage_delivered_in5days_11_30 , cte7.Unfulfilled_percentage_11_30 ,cte10.percentage_rto_inward_orders_11_30 ,cte11.percentage_rto_inward_orders_31_60 from GYNOVEDA_DB.maplemonk.gynopulse_intermediate a left join cte1 on a.order_date = cte1.date left join cte2 on a.order_date = cte2.date left join cte3 on a.order_date = cte3.date left join cte4 on a.order_date = cte4.date left join cte5 on a.order_date = cte5.date left join cte6 on a.order_date = cte6.date left join cte7 on a.order_date = cte7.date left join cte8 on a.order_date = cte8.date left join cte9 on a.order_date = cte9.date left join cte10 on a.order_date = cte10.date left join cte11 on a.order_date = cte11.date ;",
                                "transaction": true
                            }
                        ) }}
                        with sample_data as (

                            select * from GYNOVEDA_DB.information_schema.databases
                        ),
                        
                        final as (
                            select * from sample_data
                        )
                        select * from final
                        