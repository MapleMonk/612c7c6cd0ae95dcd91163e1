{{ config(
            materialized='table',
                post_hook={
                    "sql": "ALTER SESSION SET TIMEZONE = \'Asia/Kolkata\'; create or replace table snitch_db.maplemonk.availability_master_v2 as WITH PivotTable AS ( Select sku_group , sum(Sellable_Inventory) as Sellable_Inventory, sum(XS_units) as XS_units, sum(S_units) as S_units, sum(M_units) as M_units, sum(L_units) as L_units, sum(XL_units) as XL_units, sum(XXL_units) as XXL_units, sum(XL3_units) as XL3_units, sum(XL4_units) as XL4_units, sum(XL5_units) as XL5_units, sum(XL6_units) as XL6_units from ( SELECT REVERSE(SUBSTRING(REVERSE(\"Item SkuCode\"), CHARINDEX(\'-\', REVERSE(\"Item SkuCode\")) + 1, LEN(\"Item SkuCode\"))) AS sku_group, sum(inventory) AS Sellable_Inventory, COALESCE(SUM(CASE WHEN SIZE = \'XS\' OR SIZE = \'28\' THEN INVENTORY ELSE 0 END), 0) AS XS_units, COALESCE(SUM(CASE WHEN SIZE = \'S\' OR SIZE = \'30\' THEN INVENTORY ELSE 0 END), 0) AS S_units, COALESCE(SUM(CASE WHEN SIZE = \'M\' OR SIZE = \'32\' THEN INVENTORY ELSE 0 END), 0) AS M_units, COALESCE(SUM(CASE WHEN SIZE = \'L\' OR SIZE = \'34\' THEN INVENTORY ELSE 0 END), 0) AS L_units, COALESCE(SUM(CASE WHEN SIZE = \'XL\' OR SIZE = \'36\' THEN INVENTORY ELSE 0 END), 0) AS XL_units, COALESCE(SUM(CASE WHEN SIZE IN (\'XXL\', \'XXl\', \'2XL\', \'38\') THEN INVENTORY ELSE 0 END), 0) AS XXL_units, COALESCE(SUM(CASE WHEN SIZE = \'3XL\' THEN INVENTORY ELSE 0 END), 0) AS XL3_units, COALESCE(SUM(CASE WHEN SIZE = \'4XL\' THEN INVENTORY ELSE 0 END), 0) AS XL4_units, COALESCE(SUM(CASE WHEN SIZE = \'5XL\' THEN INVENTORY ELSE 0 END), 0) AS XL5_units, COALESCE(SUM(CASE WHEN SIZE = \'6XL\' THEN INVENTORY ELSE 0 END), 0) AS XL6_units FROM snitch_db.maplemonk.snitch_final_inventory_wh2 WHERE date = current_date and facility not in (\'SAPL-EMIZA\') GROUP BY REVERSE(SUBSTRING(REVERSE(\"Item SkuCode\"), CHARINDEX(\'-\', REVERSE(\"Item SkuCode\")) + 1, LEN(\"Item SkuCode\"))) ) where sku_group not like\'CB%\' GROUP BY SKU_GROUP ), EOQ_Test as ( SELECT a.SKU_GROUP, product_name, category, final_ros, eoq_new, total_units_on_hand, op, first_order_date, natural_ros,sales_last_7_days,sales_last_15_days,sales_last_30_days, FROM snitch_db.maplemonk.EOQ_Test a ), products as ( select sku_group,id,price,status from (SELECT id, status, published_at::date as live_date, replace(A.value:price,\'\"\',\'\') as price, REVERSE(SUBSTRING(REVERSE(replace(A.value:sku,\'\"\',\'\')),CHARINDEX(\'-\', REVERSE(replace(A.value:sku,\'\"\',\'\'))) + 1)) AS sku_group, row_number()over (partition by id order by published_at desc) as rw from snitch_db.maplemonk.shopifyindia_new_products, lateral flatten (input => variants) A ) where rw = 1) SELECT PivotTable.SKU_GROUP, Products.id, Products.price, EOQ_Test.product_name, EOQ_Test.category, EOQ_Test.final_ros, ROUND(coalesce(SUM(EOQ_Test.eoq_new),0),0) as total_eoq, coalesce(SUM(EOQ_Test.total_units_on_hand),0) as available_units, ROUND(coalesce(SUM(EOQ_Test.op),0),0) as order_point, EOQ_Test.natural_ros,EOQ_Test.sales_last_7_days,EOQ_Test.sales_last_15_days,EOQ_Test.sales_last_30_days, CASE WHEN EOQ_Test.final_ros >= 15 THEN \'1-Head\' WHEN EOQ_Test.final_ros < 15 AND EOQ_Test.final_ros >= 5 THEN \'2-Belly\' WHEN EOQ_Test.first_order_date > cast(getdate() as date)-75 THEN \'4-New\' WHEN EOQ_Test.first_order_date is not null and EOQ_Test.final_ros <5 then \'3-Tail\' WHEN EOQ_Test.first_order_date is null and products.status = \'active\' then \'4-New-Not-Sold\' WHEN EOQ_Test.first_order_date is null and products.status = \'draft\' then \'Draft\' WHEN products.status is null then \'Not-Cataloged\' ELSE \'Others\' END AS sku_class, PivotTable.Sellable_inventory, PivotTable.XS_units, PivotTable.S_units, PivotTable.M_units, PivotTable.L_units, PivotTable.XL_units, PivotTable.XXL_units, PivotTable.XL3_units, PivotTable.XL4_units, PivotTable.XL5_units, PivotTable.XL6_units, (CASE WHEN PivotTable.XS_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.S_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.M_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.L_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.XL_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.XXL_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.XL3_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.XL4_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.XL5_units > 0 THEN 1 ELSE 0 END) + (CASE WHEN PivotTable.XL6_units > 0 THEN 1 ELSE 0 END) AS num_size_available, products.status FROM EOQ_TEST FULL OUTER JOIN PivotTable ON EOQ_TEST.SKU_GROUP = PivotTable.SKU_GROUP LEFT JOIN PRODUCTS ON PivotTable.sku_group = PRODUCTS.sku_group GROUP BY sku_class, PivotTable.sku_group, EOQ_Test.product_name, EOQ_Test.final_ros, EOQ_Test.category, PivotTable.XS_units, products.id, Products.Price, PivotTable.Sellable_inventory, PivotTable.S_units, PivotTable.M_units, PivotTable.L_units, PivotTable.XXL_units, PivotTable.XL_units, PivotTable.XL3_units, PivotTable.XL4_units, PivotTable.XL5_units, PivotTable.XL6_units, EOQ_Test.natural_ros,EOQ_Test.sales_last_7_days,EOQ_Test.sales_last_15_days,EOQ_Test.sales_last_30_days,Products.status ORDER BY sku_class, EOQ_Test.final_ros DESC;",
                    "transaction": true
                }
            ) }}
            with sample_data as (

                select * from snitch_db.information_schema.databases
            ),
            
            final as (
                select * from sample_data
            )
            select * from final
            